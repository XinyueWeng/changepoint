<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Simulation – changepoint</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">

<script src="site_libs/datatables-binding-0.33/datatables.js"></script>

<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>

<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">

<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">

<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>

<link href="site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">

<script src="site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">changepoint</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./Simulation.html" aria-current="page"> 
<span class="menu-text">Simulation</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#proposed-method" id="toc-proposed-method" class="nav-link active" data-scroll-target="#proposed-method">proposed method</a>
  <ul class="collapse">
  <li><a href="#binary-segmentation" id="toc-binary-segmentation" class="nav-link" data-scroll-target="#binary-segmentation">Binary Segmentation</a></li>
  </ul></li>
  <li><a href="#absadaptive_binary_segmentation" id="toc-absadaptive_binary_segmentation" class="nav-link" data-scroll-target="#absadaptive_binary_segmentation">（ABS）adaptive_binary_segmentation</a></li>
  <li><a href="#proposed-vs-逐维法" id="toc-proposed-vs-逐维法" class="nav-link" data-scroll-target="#proposed-vs-逐维法">Proposed VS 逐维法</a></li>
  <li><a href="#评测指标" id="toc-评测指标" class="nav-link" data-scroll-target="#评测指标">评测指标</a></li>
  <li><a href="#稠密模式" id="toc-稠密模式" class="nav-link" data-scroll-target="#稠密模式">稠密模式</a></li>
  <li><a href="#code" id="toc-code" class="nav-link" data-scroll-target="#code">code:</a>
  <ul class="collapse">
  <li><a href="#数据生成" id="toc-数据生成" class="nav-link" data-scroll-target="#数据生成">数据生成：</a></li>
  <li><a href="#func-逐维abs-vs-高维" id="toc-func-逐维abs-vs-高维" class="nav-link" data-scroll-target="#func-逐维abs-vs-高维">func: 逐维（ABS） vs 高维</a>
  <ul class="collapse">
  <li><a href="#跑评价" id="toc-跑评价" class="nav-link" data-scroll-target="#跑评价">(跑评价)</a></li>
  <li><a href="#跑可视化" id="toc-跑可视化" class="nav-link" data-scroll-target="#跑可视化">(跑可视化)</a></li>
  </ul></li>
  <li><a href="#func-逐维cpt-vs-高维" id="toc-func-逐维cpt-vs-高维" class="nav-link" data-scroll-target="#func-逐维cpt-vs-高维">func: 逐维（Cpt） vs 高维</a>
  <ul class="collapse">
  <li><a href="#跑可视化-1" id="toc-跑可视化-1" class="nav-link" data-scroll-target="#跑可视化-1">(跑可视化)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#稀疏模式" id="toc-稀疏模式" class="nav-link" data-scroll-target="#稀疏模式">稀疏模式</a></li>
  <li><a href="#table" id="toc-table" class="nav-link" data-scroll-target="#table">Table</a></li>
  <li><a href="#各维度时间抖动" id="toc-各维度时间抖动" class="nav-link" data-scroll-target="#各维度时间抖动">各维度时间抖动</a>
  <ul class="collapse">
  <li><a href="#跑评价-1" id="toc-跑评价-1" class="nav-link" data-scroll-target="#跑评价-1">跑评价</a></li>
  <li><a href="#跑可视化-2" id="toc-跑可视化-2" class="nav-link" data-scroll-target="#跑可视化-2">跑可视化</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Simulation</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>abs算法code</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 0) 工具与可重复性</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 内部加速工具（不改变对外 API）</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 说明：</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="do">## - 通过一次性构建按行的列累积和 (cumsums) 来将任意区间均值计算从 O(k) 降到 O(1)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="do">## - 所有优化均以隐式属性附着在 Y 上（attr(Y, "._csum")），</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   若缺失则在首次调用时自动构建；对外函数名、参数与用法保持不变</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>.ensure_cumsum <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cs)) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 构建 n+1 x p 的累计和矩阵：第 1 行是 0，便于用差分快速得到任意区间和</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    cs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(Y)),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(Y, <span class="dv">2</span>, cumsum))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>) <span class="ot">&lt;-</span> cs</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>.segment_means_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(cs, t_left, t_mid, t_right) {</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cs 的行索引与时间点对齐：第 0 个时间点位于行 1</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 区间 (t_left+1):t_mid 与 (t_mid+1):t_right</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  sum1 <span class="ot">&lt;-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_left <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  sum2 <span class="ot">&lt;-</span> cs[t_right <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> sum1 <span class="sc">/</span> n1</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> sum2 <span class="sc">/</span> n2</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">mean1 =</span> mean1, <span class="at">mean2 =</span> mean2, <span class="at">n1 =</span> n1, <span class="at">n2 =</span> n2)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 代价函数 &amp; 二元分割（保持 API，不改变名称/参数）</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 尝试使用累计和加速；若不可用则回退到原始实现</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cs)) {</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    seg <span class="ot">&lt;-</span> <span class="fu">.segment_means_fast</span>(cs, t_left, t_mid, t_right)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    n1 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n1; n2 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n2; n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(seg<span class="sc">$</span>mean2 <span class="sc">-</span> seg<span class="sc">$</span>mean1)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weight <span class="sc">*</span> norm_p)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 回退路径（仅在未预先构建 cumsum 时触发）</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  diff  <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">*</span> norm_p</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 确保累计和已存在（若无则自动构建）</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">*</span> min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用累计和的 compute_cost，按扫描区间求最大增益</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain; best_t <span class="ot">&lt;-</span> t</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    left  <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 稳定路径：手肘 + 平台 (Kneedle + plateau)</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="do">##    （内部同样利用累计和以复用加速）</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>]); p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]); dy <span class="ot">&lt;-</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>(dy <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> dx <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span> denom</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx)</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i <span class="sc">-</span> <span class="dv">1</span>]) {</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start, <span class="at">end =</span> i <span class="sc">-</span> <span class="dv">1</span>, <span class="at">value =</span> y[i <span class="sc">-</span> <span class="dv">1</span>], <span class="at">length =</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start, <span class="at">end =</span> <span class="fu">length</span>(y), <span class="at">value =</span> y[<span class="fu">length</span>(y)], <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>  plateaus</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>adaptive_binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 预先构建累计和，加速所有后续成本评估</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>  bp_counts <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>    t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, b, <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>    bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>  left_bound <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>  best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound) <span class="sc">&amp;&amp;</span> (pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound)) {</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) best_plateau <span class="ot">&lt;-</span> pp</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) {</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>                  beta_list[pp<span class="sc">$</span>start], beta_list[pp<span class="sc">$</span>end], pp<span class="sc">$</span>length, pp<span class="sc">$</span>value))</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Elbow 候选 β = %.2f</span><span class="sc">\n</span><span class="st">"</span>, el<span class="sc">$</span>beta))</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span><span class="sc">\n\n</span><span class="st">"</span>, best_beta))</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_list =</span> beta_list,</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">bp_counts =</span> bp_counts,</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> results,</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">plateaus =</span> plateaus,</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">best_beta =</span> best_beta</span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>plot_segmentation_path <span class="ot">&lt;-</span> <span class="cf">function</span>(res) {</span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> res<span class="sc">$</span>beta_list; bp_counts <span class="ot">&lt;-</span> res<span class="sc">$</span>bp_counts</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>best_beta,  <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>数据导入</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义一个函数，读取指定文件夹中的所有 Excel 文件</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>read_excel_files_in_directory <span class="ot">&lt;-</span> <span class="cf">function</span>(directory_path) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 获取指定目录下的所有 Excel 文件（以 .xlsx 或 .xls 结尾）</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  excel_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(directory_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.xlsx$|</span><span class="sc">\\</span><span class="st">.xls$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 创建一个空的列表来存储读取的数据</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  data_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 遍历每个 Excel 文件</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (file <span class="cf">in</span> excel_files) {</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 读取 Excel 文件的数据</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">try</span>({</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(file)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      data_list[[file]] <span class="ot">&lt;-</span> df</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"成功读取文件:"</span>, file))</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 返回一个包含所有文件数据的列表</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_list)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 指定文件夹路径</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>directory_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/rawdata/per_game"</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 调用函数读取并存储所有 Excel 文件</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>pergame_list <span class="ot">&lt;-</span> <span class="fu">read_excel_files_in_directory</span>(directory_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2000_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2001_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2002_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2003_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2004_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2005_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2006_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2007_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2008_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2009_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2010_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2011_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2012_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2013_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2014_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2015_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2016_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2017_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2018_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2019_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2020_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2021_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2022_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game/2023_pergame.xlsx"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果需要将所有文件的数据合并为一个大的数据框</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>combinedpergame_data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, pergame_list)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出合并后的数据框</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(combinedpergame_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 740 × 46
      Rk Team      G    MP    FG   FGA `FG%`  `3P` `3PA` `3P%`  `2P` `2PA` `2P%`
 * &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1    26 Atla…    82  241.  35.1  81.3 0.431   4.1  11.4 0.357  31    69.9 0.443
 2    16 Bost…    82  242.  33.8  79.1 0.428   7.2  19.9 0.363  26.6  59.2 0.45 
 3    24 Char…    82  242.  34.1  79.3 0.431   4.1  12   0.346  30    67.3 0.446
 4    29 Chic…    82  242.  33.2  78.2 0.424   4    11.6 0.346  29.2  66.6 0.438
 5    22 Clev…    82  242.  35.2  79.7 0.442   2.7   8   0.334  32.6  71.6 0.455
 6     4 Dall…    82  242.  37.6  81.9 0.459   6.3  16.5 0.381  31.3  65.4 0.479
 7    11 Denv…    82  241.  36.3  83.9 0.433   6.2  17.6 0.355  30.1  66.3 0.454
 8    13 Detr…    82  242.  35.6  83.9 0.424   4.7  13.6 0.35   30.9  70.3 0.439
 9    21 Gold…    82  241.  35.8  87.5 0.409   3.4  11.8 0.293  32.4  75.7 0.427
10     9 Hous…    82  242.  35.9  79.2 0.453   6.1  17.2 0.357  29.7  62   0.48 
# ℹ 730 more rows
# ℹ 33 more variables: FT &lt;dbl&gt;, FTA &lt;dbl&gt;, `FT%` &lt;dbl&gt;, ORB &lt;dbl&gt;, DRB &lt;dbl&gt;,
#   TRB &lt;dbl&gt;, AST &lt;dbl&gt;, STL &lt;dbl&gt;, BLK &lt;dbl&gt;, TOV &lt;dbl&gt;, PF &lt;dbl&gt;, PTS &lt;dbl&gt;,
#   FG1 &lt;dbl&gt;, FGA1 &lt;dbl&gt;, `FG%1` &lt;dbl&gt;, `3P1` &lt;dbl&gt;, `3PA1` &lt;dbl&gt;,
#   `3P%1` &lt;dbl&gt;, `2P1` &lt;dbl&gt;, `2PA1` &lt;dbl&gt;, `2P%1` &lt;dbl&gt;, FT1 &lt;dbl&gt;,
#   FTA1 &lt;dbl&gt;, `FT%1` &lt;dbl&gt;, ORB1 &lt;dbl&gt;, DRB1 &lt;dbl&gt;, TRB1 &lt;dbl&gt;, AST1 &lt;dbl&gt;,
#   STL1 &lt;dbl&gt;, BLK1 &lt;dbl&gt;, TOV1 &lt;dbl&gt;, PF1 &lt;dbl&gt;, PTS1 &lt;dbl&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>combinedpergame_data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, pergame_list)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>subpergame <span class="ot">&lt;-</span> pergame_list[[<span class="dv">1</span>]][,<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(pergame_list[[<span class="dv">1</span>]])]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>pergame_mean <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(subpergame)))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(pergame_mean) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(subpergame)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(pergame_mean)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"year"</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>pergame_var <span class="ot">&lt;-</span> pergame_mean</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pergame_list)) {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  subpergame <span class="ot">&lt;-</span> pergame_list[[i]][,<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(pergame_list[[i]])]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  pergame_mean[i,] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(subpergame, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="cf">else</span> <span class="cn">NA</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  pergame_var[i,] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(subpergame, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">var</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="cf">else</span> <span class="cn">NA</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  pergame_mean[i,<span class="dv">1</span>] <span class="ot">&lt;-</span> i<span class="sc">+</span><span class="dv">1999</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  pergame_var[i,<span class="dv">1</span>] <span class="ot">&lt;-</span> i<span class="sc">+</span><span class="dv">1999</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>原始数据转化为张量tensor_nba:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义一个函数，读取指定文件夹中的所有 Excel 文件</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>read_excel_files_in_directory <span class="ot">&lt;-</span> <span class="cf">function</span>(directory_path) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 获取指定目录下的所有 Excel 文件（以 .xlsx 或 .xls 结尾）</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  excel_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(directory_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.xlsx$|</span><span class="sc">\\</span><span class="st">.xls$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 创建一个空的列表来存储读取的数据</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  data_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 遍历每个 Excel 文件</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (file <span class="cf">in</span> excel_files) {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 读取 Excel 文件的数据</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">try</span>({</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(file)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      data_list[[file]] <span class="ot">&lt;-</span> df</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"成功读取文件:"</span>, file))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 返回一个包含所有文件数据的列表</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_list)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 指定文件夹路径</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>directory_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 调用函数读取并存储所有 Excel 文件</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>pergame_list_re <span class="ot">&lt;-</span> <span class="fu">read_excel_files_in_directory</span>(directory_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2000_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2001_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2002_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2003_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2004_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2005_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2006_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2007_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2008_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2009_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2010_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2011_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2012_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2013_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2014_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2015_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2016_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2017_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2018_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2019_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2020_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2021_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2022_pergame.xlsx"
[1] "成功读取文件: C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete/2023_pergame.xlsx"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果需要将所有文件的数据合并为一个大的数据框</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>combinedpergame_data_re <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, pergame_list_re)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出合并后的数据框</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(combinedpergame_data_re)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 720 × 46
      Rk Team      G    MP    FG   FGA `FG%`  `3P` `3PA` `3P%`  `2P` `2PA` `2P%`
 * &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1    26 Atla…    82  241.  35.1  81.3 0.431   4.1  11.4 0.357  31    69.9 0.443
 2    16 Bost…    82  242.  33.8  79.1 0.428   7.2  19.9 0.363  26.6  59.2 0.45 
 3    23 Broo…    82  241.  33.9  79.9 0.425   4.4  13.2 0.333  29.5  66.7 0.443
 4     0 Char…    82  242   35.7  80.6 0.443   4.8  13.7 0.354  30.8  66.9 0.461
 5    29 Chic…    82  242.  33.2  78.2 0.424   4    11.6 0.346  29.2  66.6 0.438
 6    22 Clev…    82  242.  35.2  79.7 0.442   2.7   8   0.334  32.6  71.6 0.455
 7     4 Dall…    82  242.  37.6  81.9 0.459   6.3  16.5 0.381  31.3  65.4 0.479
 8    11 Denv…    82  241.  36.3  83.9 0.433   6.2  17.6 0.355  30.1  66.3 0.454
 9    13 Detr…    82  242.  35.6  83.9 0.424   4.7  13.6 0.35   30.9  70.3 0.439
10    21 Gold…    82  241.  35.8  87.5 0.409   3.4  11.8 0.293  32.4  75.7 0.427
# ℹ 710 more rows
# ℹ 33 more variables: FT &lt;dbl&gt;, FTA &lt;dbl&gt;, `FT%` &lt;dbl&gt;, ORB &lt;dbl&gt;, DRB &lt;dbl&gt;,
#   TRB &lt;dbl&gt;, AST &lt;dbl&gt;, STL &lt;dbl&gt;, BLK &lt;dbl&gt;, TOV &lt;dbl&gt;, PF &lt;dbl&gt;, PTS &lt;dbl&gt;,
#   FG1 &lt;dbl&gt;, FGA1 &lt;dbl&gt;, `FG%1` &lt;dbl&gt;, `3P1` &lt;dbl&gt;, `3PA1` &lt;dbl&gt;,
#   `3P%1` &lt;dbl&gt;, `2P1` &lt;dbl&gt;, `2PA1` &lt;dbl&gt;, `2P%1` &lt;dbl&gt;, FT1 &lt;dbl&gt;,
#   FTA1 &lt;dbl&gt;, `FT%1` &lt;dbl&gt;, ORB1 &lt;dbl&gt;, DRB1 &lt;dbl&gt;, TRB1 &lt;dbl&gt;, AST1 &lt;dbl&gt;,
#   STL1 &lt;dbl&gt;, BLK1 &lt;dbl&gt;, TOV1 &lt;dbl&gt;, PF1 &lt;dbl&gt;, PTS1 &lt;dbl&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#转为tensor</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 假设 pergame_list 是按年份顺序排列的列表（2000-2023），每个元素为 p×q 矩阵</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 检查所有矩阵维度是否一致</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">nrow</span>(pergame_list_re[[<span class="dv">1</span>]]) </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">ncol</span>(pergame_list_re[[<span class="dv">1</span>]])</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>n_years <span class="ot">&lt;-</span> <span class="fu">length</span>(pergame_list_re)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#检查每层的行列数是否一致</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(pergame_list_re)) {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(pergame_list_re[[i]]) <span class="sc">!=</span> p <span class="sc">||</span> <span class="fu">ncol</span>(pergame_list_re[[i]]) <span class="sc">!=</span> q) {</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"矩阵维度不一致，无法构建张量"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 直接合并为行×列×层的三维数组（维度顺序: p×q×n_years）</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>tensor <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">unlist</span>(pergame_list_re),</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">dim =</span> <span class="fu">c</span>(p, q, n_years)  <span class="co"># 行 × 列 × 层（年份）</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>tensor <span class="ot">&lt;-</span> tensor[, <span class="sc">-</span><span class="dv">1</span>, ] </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>column_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(tensor[, <span class="dv">1</span>, <span class="dv">1</span>]) </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>tensor <span class="ot">&lt;-</span> tensor[, <span class="sc">-</span><span class="dv">2</span><span class="sc">:-</span><span class="dv">1</span>, ] <span class="co">#删掉第一列(球队和G)</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>tensor_numeric <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="fu">as.numeric</span>(tensor), <span class="at">dim =</span> <span class="fu">dim</span>(tensor)) <span class="co">#转为数值型</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 验证维度</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"张量维度 (行 × 列 × 层):"</span>, <span class="fu">dim</span>(tensor))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>张量维度 (行 × 列 × 层): 30 43 24</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rTensor)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>tensor_nba <span class="ot">&lt;-</span> <span class="fu">as.tensor</span>(tensor_numeric)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(tensor, <span class="st">"column_names"</span>) <span class="ot">&lt;-</span> column_names  <span class="co">#取第一层第一列作为列名</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="proposed-method" class="level2">
<h2 class="anchored" data-anchor-id="proposed-method">proposed method</h2>
<section id="binary-segmentation" class="level3">
<h3 class="anchored" data-anchor-id="binary-segmentation">Binary Segmentation</h3>
<p>Given a multivariate time series <span class="math inline">\(Y_1, Y_2, \dots, Y_n \in \mathbb{R}^d\)</span>. For any candidate change point <span class="math inline">\(t \in (t_{k-1}, t_{k+1})\)</span>, we define the cost function as:</p>
<p><span class="math display">\[ c(y_{t_{k-1}..t_{k+1}}) = \sqrt{\frac{(t_k - t_{k-1})(t_{k+1} - t_k)}{t_{k+1} - t_{k-1}}} \cdot \left\| \bar{Y}_{(t_k, t_{k+1}]} - \bar{Y}_{(t_{k-1}, t_k]} \right\|_p \]</span></p>
<p>where <span class="math inline">\(\bar{Y}_{(a, b]}\)</span> is the mean of the data in the interval <span class="math inline">\((a, b]\)</span>, and <span class="math inline">\(\|\cdot\|_p\)</span> is the <span class="math inline">\(\ell_p\)</span>-norm.</p>
<p>Binary Segmentation: In the current interval <span class="math inline">\([t_0, t_1]\)</span>, enumerate all possible split points <span class="math inline">\(t \in (t_0 + \text{min_size}, t_1 - \text{min_size})\)</span>, compute the cost <span class="math inline">\(c(t)\)</span> for each split, and select the maximum cost <span class="math inline">\(c^*\)</span> with optimal point <span class="math inline">\(t^*\)</span>. If <span class="math inline">\(c^* &gt; \beta\)</span>, accept <span class="math inline">\(t^*\)</span> as a change point, and recursively apply the same procedure to <span class="math inline">\([t_0, t^*]\)</span> and <span class="math inline">\([t^*, t_1]\)</span>; If <span class="math inline">\(c^* \leq \beta\)</span>, do not split further.</p>
<section id="β网格搜索" class="level4">
<h4 class="anchored" data-anchor-id="β网格搜索">1.1 β网格搜索</h4>
<p><strong>伪代码：</strong></p>
<p>输入：</p>
<ul>
<li>数据矩阵 <span class="math inline">\(Y_{1:n}\)</span></li>
<li>子区间 <span class="math inline">\([t_0, t_1)\)</span></li>
<li>区间最小段长 <code>min_size</code></li>
<li>惩罚项强度 <span class="math inline">\(β\)</span></li>
<li>范数类型 <span class="math inline">\(\ell_p\)</span></li>
</ul>
<pre><code>Input
  Data matrix $Y_{1:n}$, 
  Interval $[t_0, t_1)$, 
  Minimum segment length $\mathtt{min\_size}$, 
  Penalty parameter $\beta$, 
  Norm type $\ell_p$
  
Function BinarySegmentation(Y, t0 = 0, t1 = n, β, min_size, p):

Initialize:
    best_gain ← -∞
    best_t ← NULL

For t in (t0 + min_size) to (t1 - min_size):
    Compute gain = c(Y[t0+1 : t1], split at t)
    If gain &gt; best_gain:
        best_gain ← gain
        best_t ← t

If best_gain &gt; β:
    # Accept split
    left_changes ← BinarySegmentation(Y, t0, best_t, β, min_size, p)
    right_changes ← BinarySegmentation(Y, best_t, t1, β, min_size, p)
    return left_changes ∪ {best_t} ∪ right_changes
Else:
    return ∅</code></pre>
<p>Binary Segmentation code:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>cp_decomp <span class="ot">&lt;-</span> <span class="fu">parafac</span>(tensor_numeric, <span class="at">nfac =</span> <span class="dv">2</span>, <span class="at">const=</span><span class="fu">c</span>(<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>), <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>cp_decomp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
3-way Parafac with 2 factors 

Constraints:
      A      B      C
 nonneg nonneg nonneg

Fit Information:
  SSE = 102990 
  R^2 = 0.999 
  GCV = 3.37 
  EDF = 190 
 
Converged: TRUE (3 iterations)
 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">const</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>uncons : unconstrained
nonneg : non-negative
period : periodic
pernon : periodic and non-negative
smooth : smooth
smonon : smooth and non-negative
smoper : smooth and periodic
smpeno : smooth, periodic, and non-negative
orthog : orthogonal
ortnon : orthogonal and non-negative
ortsmo : orthogonal and smooth
orsmpe : orthogonal, smooth, and periodic
moninc : monotonic increasing
monnon : monotonic increasing and non-negative
monsmo : monotonic increasing and smooth
mosmno : monotonic increasing, smooth, and non-negative
unimod : unimodal
uninon : unimodal and non-negative
uniper : unimodal and periodic
unpeno : unimodal, periodic, and non-negative
unismo : unimodal and smooth
unsmno : unimodal, smooth, and non-negative
unsmpe : unimodal, smooth, and periodic
unsmpn : unimodal, smooth, periodic, and non-negative</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取结果</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>A  <span class="co"># 第一模态因子矩阵</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>B  <span class="co"># 第二模态因子矩阵</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>C  <span class="co"># 时间模态因子矩阵</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> C</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>Y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]
 [1,] 49.12  2.32
 [2,] 46.95  4.52
 [3,] 47.48  3.92
 [4,] 47.40  3.62
 [5,] 45.10  6.43
 [6,] 44.24  7.05
 [7,] 42.05  9.53
 [8,] 39.70 12.15
 [9,] 39.53 12.20
[10,] 39.45 12.48
[11,] 39.88 11.88
[12,] 40.44 10.95
[13,] 37.05 14.58
[14,] 34.00 18.11
[15,] 33.12 18.94
[16,] 29.60 22.87
[17,] 23.68 29.07
[18,] 19.86 32.95
[19,] 14.54 39.32
[20,] 10.84 42.93
[21,]  8.82 44.80
[22,]  8.91 44.47
[23,]  9.11 44.85
[24,]  7.22 46.65</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义 cost 函数</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p=</span><span class="dv">2</span> ) {</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>   <span class="co">#p = 2范数类型</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  diff <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 用 sum(abs(diff)^p)^(1/p) 计算 p 范数</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p <span class="sc">==</span> <span class="st">"inf"</span>) {</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> weight <span class="sc">*</span> norm_p</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cost)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 二元分割函数（递归）</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size=</span><span class="dv">2</span>, <span class="at">p=</span><span class="dv">2</span>) {</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 先算扫描边界</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ★关键：如果无可扫范围，直接返回</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span><span class="sc">*</span>min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>      best_t <span class="ot">&lt;-</span> t</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    left <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Run the algorithm with a sequence of β values and observe how the number of change points changes.</p>
<p>p=2, min_size=2, β=seq(3, 30, length.out = 50), when β&gt;95, no changepoint</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 遍历多个 β 值</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">3</span>, <span class="dv">70</span>, <span class="at">length.out =</span> <span class="dv">90</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>bp_counts <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#beta_list: 遍历的 β 值序列，例如 seq(3, 30, length.out = 70), bp_counts: 对应每个 β 下检测到的变点数量（整型向量）</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, beta))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘图：β vs 变点数</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Number of Change Points"</span>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Simulation_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出变点结构供进一步分析</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f: changepoints = %s</span><span class="sc">\n</span><span class="st">"</span>, beta_list[i], <span class="fu">paste</span>(results[[i]], <span class="at">collapse =</span> <span class="st">", "</span>)))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>β = 3.00: changepoints = 4, 7, 13, 16, 18, 20
β = 3.75: changepoints = 4, 7, 13, 16, 18, 20
β = 4.51: changepoints = 4, 7, 13, 16, 18, 20
β = 5.26: changepoints = 4, 7, 13, 16, 18, 20
β = 6.01: changepoints = 4, 7, 13, 16, 18, 20
β = 6.76: changepoints = 4, 7, 13, 16, 18
β = 7.52: changepoints = 7, 13, 16, 18
β = 8.27: changepoints = 7, 13, 16, 18
β = 9.02: changepoints = 7, 13, 16, 18
β = 9.78: changepoints = 7, 13, 16, 18
β = 10.53: changepoints = 7, 13, 16, 18
β = 11.28: changepoints = 7, 13, 16, 18
β = 12.03: changepoints = 7, 13, 16, 18
β = 12.79: changepoints = 7, 13, 16, 18
β = 13.54: changepoints = 7, 13, 16, 18
β = 14.29: changepoints = 7, 13, 16, 18
β = 15.04: changepoints = 7, 16, 18
β = 15.80: changepoints = 7, 16, 18
β = 16.55: changepoints = 7, 16, 18
β = 17.30: changepoints = 7, 16, 18
β = 18.06: changepoints = 7, 16, 18
β = 18.81: changepoints = 7, 16, 18
β = 19.56: changepoints = 7, 16, 18
β = 20.31: changepoints = 7, 16, 18
β = 21.07: changepoints = 7, 16, 18
β = 21.82: changepoints = 7, 16
β = 22.57: changepoints = 7, 16
β = 23.33: changepoints = 7, 16
β = 24.08: changepoints = 7, 16
β = 24.83: changepoints = 7, 16
β = 25.58: changepoints = 7, 16
β = 26.34: changepoints = 16
β = 27.09: changepoints = 16
β = 27.84: changepoints = 16
β = 28.60: changepoints = 16
β = 29.35: changepoints = 16
β = 30.10: changepoints = 16
β = 30.85: changepoints = 16
β = 31.61: changepoints = 16
β = 32.36: changepoints = 16
β = 33.11: changepoints = 16
β = 33.87: changepoints = 16
β = 34.62: changepoints = 16
β = 35.37: changepoints = 16
β = 36.12: changepoints = 16
β = 36.88: changepoints = 16
β = 37.63: changepoints = 16
β = 38.38: changepoints = 16
β = 39.13: changepoints = 16
β = 39.89: changepoints = 16
β = 40.64: changepoints = 16
β = 41.39: changepoints = 16
β = 42.15: changepoints = 16
β = 42.90: changepoints = 16
β = 43.65: changepoints = 16
β = 44.40: changepoints = 16
β = 45.16: changepoints = 16
β = 45.91: changepoints = 16
β = 46.66: changepoints = 16
β = 47.42: changepoints = 16
β = 48.17: changepoints = 16
β = 48.92: changepoints = 16
β = 49.67: changepoints = 16
β = 50.43: changepoints = 16
β = 51.18: changepoints = 16
β = 51.93: changepoints = 16
β = 52.69: changepoints = 16
β = 53.44: changepoints = 16
β = 54.19: changepoints = 16
β = 54.94: changepoints = 16
β = 55.70: changepoints = 16
β = 56.45: changepoints = 16
β = 57.20: changepoints = 16
β = 57.96: changepoints = 16
β = 58.71: changepoints = 16
β = 59.46: changepoints = 16
β = 60.21: changepoints = 16
β = 60.97: changepoints = 16
β = 61.72: changepoints = 16
β = 62.47: changepoints = 16
β = 63.22: changepoints = 16
β = 63.98: changepoints = 16
β = 64.73: changepoints = 16
β = 65.48: changepoints = 16
β = 66.24: changepoints = 16
β = 66.99: changepoints = 16
β = 67.74: changepoints = 16
β = 68.49: changepoints = 16
β = 69.25: changepoints = 16
β = 70.00: changepoints = 16</code></pre>
</div>
</div>
<p>上述结果是遍历beta的nba数据变点结果：变点稳定在2016年</p>
<ul>
<li><p>β 怎么确定？</p>
<ol type="1">
<li><p><strong>先用手肘法</strong> 找到拐点 β（候选）：取第一点和最后一点把它们连成一条直线，对曲线上每个点计算它到直线的<strong>垂直距离</strong>，距离最大的那一点，就是和端点连线“偏得最远”的点，当作“肘部”</p></li>
<li><p><strong>在 elbow 附近（窗口内）搜索</strong>：找到一个区间里变点数稳定的“最长 plateau”（变点数相同的连续 β 区间），取该 plateau 的中点 β 作为最终beta</p></li>
<li><p>先在<strong>手肘附近窗口</strong>里找<strong>最长 plateau</strong>；</p>
<p>若窗口里<strong>找不到</strong>（极端/锯齿曲线）：则取<strong>全局最长 plateau</strong>；</p>
<p>若<strong>根本没有 plateau</strong>：直接用 <strong><code>elbow_beta</code></strong></p></li>
</ol></li>
</ul>
<p>code:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#先运行遍历beta,得到beta_list: 遍历的 β 值序列，例如 seq(3, 30, length.out = 70)和bp_counts: 对应每个 β 下检测到的变点数量（整型向量）</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 手肘法 (Kneedle)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>])</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>((p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>]) <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                        (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]) <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>                        p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sqrt</span>((p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 找 plateau 区间</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i<span class="dv">-1</span>]) {</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start,</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">end =</span> i<span class="dv">-1</span>,</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> y[i<span class="dv">-1</span>],</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">length =</span> (i<span class="dv">-1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 最后一个 plateau</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">end =</span> <span class="fu">length</span>(y),</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> y[<span class="fu">length</span>(y)],</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(plateaus)</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 主逻辑</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 手肘法</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>elbow <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>elbow_beta <span class="ot">&lt;-</span> elbow<span class="sc">$</span>beta</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>elbow_idx <span class="ot">&lt;-</span> elbow<span class="sc">$</span>index</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 在 elbow 附近找最长 plateau</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>window <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p <span class="cf">in</span> plateaus) {</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((p<span class="sc">$</span>start <span class="sc">&lt;=</span> elbow_idx <span class="sc">+</span> window) <span class="sc">&amp;&amp;</span> (p<span class="sc">$</span>end <span class="sc">&gt;=</span> elbow_idx <span class="sc">-</span> window)) {</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> p<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) {</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>      best_plateau <span class="ot">&lt;-</span> p</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end)<span class="sc">/</span><span class="dv">2</span>)]</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> best_beta, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="dv">2</span>, <span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Simulation_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印结果</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p <span class="cf">in</span> plateaus) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>              beta_list[p<span class="sc">$</span>start], beta_list[p<span class="sc">$</span>end],</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>              p<span class="sc">$</span>length, p<span class="sc">$</span>value))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>β = 3.00–6.01, 长度 = 5, 变点数 = 6
β = 6.76–6.76, 长度 = 1, 变点数 = 5
β = 7.52–14.29, 长度 = 10, 变点数 = 4
β = 15.04–21.07, 长度 = 9, 变点数 = 3
β = 21.82–25.58, 长度 = 6, 变点数 = 2
β = 26.34–70.00, 长度 = 59, 变点数 = 1</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Elbow 候选 β = %.2f</span><span class="sc">\n</span><span class="st">"</span>, elbow_beta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Elbow 候选 β = 26.34</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span><span class="sc">\n</span><span class="st">"</span>, best_beta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>最终推荐 β = 48.17 (在 elbow 附近 plateau 最长)</code></pre>
</div>
</div>
<p><strong>输出效果</strong></p>
<ol type="1">
<li><p>红线：手肘法选出的候选</p>
<p>蓝线：在 elbow 附近 plateau 区间里挑出的推荐<br>
会列出所有 plateau，例如：</p></li>
</ol>
<pre><code>所有 plateau 区间: 
β = 3.00–4.20, 长度 = 5, 变点数 = 10 
β = 4.60–6.00, 长度 = 4, 变点数 = 6 
β = 6.40–14.20, 长度 = 20, 变点数 = 4 
β = 14.60–21.40, 长度 = 15, 变点数 = 3 
β = 21.80–26.00, 长度 = 12, 变点数 = 2 
β = 26.40–30.00, 长度 = 10, 变点数 = 1  
Elbow 候选 β = 6.40 
最终推荐 β = 10.20 (在 elbow 附近 plateau 最长)</code></pre>
<ul>
<li>二元分割+上述beta选择方法结合：</li>
</ul>
</section>
</section>
</section>
<section id="absadaptive_binary_segmentation" class="level2">
<h2 class="anchored" data-anchor-id="absadaptive_binary_segmentation">（ABS）adaptive_binary_segmentation</h2>
<p><strong>主函数：</strong></p>
<p><strong>二元分割函数</strong>（自使用确定beta）<strong>adaptive_binary_segmentation</strong> &lt;- function(Y, beta_min = 3, beta_max = 30, beta_points = 70, min_size=2, p=2, elbow_window=10)</p>
<p>beta_min beta_max beta_points 遍历beta的区间和数量，min_size:变点最小间隔，p:范数，elbow_window:手肘法附近窗口大小</p>
<p><strong>可视化</strong>：plot_segmentation_path</p>
<p><strong>应用：</strong></p>
<p>假设数据矩阵 Y 已经准备好</p>
<p>res &lt;- adaptive_binary_segmentation(Y)</p>
<p>画图</p>
<p>plot_segmentation_path(res)</p>
<p>code：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 0) 工具与可重复性</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 内部加速工具（不改变对外 API）</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 说明：</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="do">## - 通过一次性构建按行的列累积和 (cumsums) 来将任意区间均值计算从 O(k) 降到 O(1)</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="do">## - 所有优化均以隐式属性附着在 Y 上（attr(Y, "._csum")），</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   若缺失则在首次调用时自动构建；对外函数名、参数与用法保持不变</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>.ensure_cumsum <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cs)) {</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    cs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(Y)), <span class="fu">apply</span>(Y, <span class="dv">2</span>, cumsum))</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>) <span class="ot">&lt;-</span> cs</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  Y</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>.segment_means_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(cs, t_left, t_mid, t_right) {</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cs 的行索引与时间点对齐：第 0 个时间点位于行 1</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 区间 (t_left+1):t_mid 与 (t_mid+1):t_right</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  sum1 <span class="ot">&lt;-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_left <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  sum2 <span class="ot">&lt;-</span> cs[t_right <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> sum1 <span class="sc">/</span> n1</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> sum2 <span class="sc">/</span> n2</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">mean1 =</span> mean1, <span class="at">mean2 =</span> mean2, <span class="at">n1 =</span> n1, <span class="at">n2 =</span> n2)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 代价函数 &amp; 二元分割（保持 API，不改变名称/参数）</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 尝试使用累计和加速；若不可用则回退到原始实现</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cs)) {</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    seg <span class="ot">&lt;-</span> <span class="fu">.segment_means_fast</span>(cs, t_left, t_mid, t_right)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    n1 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n1; n2 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n2; n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(seg<span class="sc">$</span>mean2 <span class="sc">-</span> seg<span class="sc">$</span>mean1)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weight <span class="sc">*</span> norm_p)</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 回退路径（仅在未预先构建 cumsum 时触发）</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>  diff  <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">*</span> norm_p</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 确保累计和已存在（若无则自动构建）</span></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">*</span> min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用累计和的 compute_cost，按扫描区间求最大增益</span></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain; best_t <span class="ot">&lt;-</span> t</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>    left  <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 稳定路径：手肘 + 平台 (Kneedle + plateau)</span></span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a><span class="do">##    （内部同样利用累计和以复用加速）</span></span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>]); p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]); dy <span class="ot">&lt;-</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>(dy <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> dx <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span> denom</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx)</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i <span class="sc">-</span> <span class="dv">1</span>]) {</span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start, <span class="at">end =</span> i <span class="sc">-</span> <span class="dv">1</span>, <span class="at">value =</span> y[i <span class="sc">-</span> <span class="dv">1</span>], <span class="at">length =</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start, <span class="at">end =</span> <span class="fu">length</span>(y), <span class="at">value =</span> y[<span class="fu">length</span>(y)], <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>  plateaus</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>adaptive_binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 预先构建累计和，加速所有后续成本评估</span></span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>  bp_counts <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>    t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, b, <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>    bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a>  left_bound <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a>  best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound) <span class="sc">&amp;&amp;</span> (pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound)) {</span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) best_plateau <span class="ot">&lt;-</span> pp</span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) {</span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span></span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span></span>
<span id="cb35-165"><a href="#cb35-165" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>,</span>
<span id="cb35-166"><a href="#cb35-166" aria-hidden="true" tabindex="-1"></a>                  beta_list[pp<span class="sc">$</span>start], beta_list[pp<span class="sc">$</span>end], pp<span class="sc">$</span>length, pp<span class="sc">$</span>value))</span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span></span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a><span class="st">Elbow 候选 β = %.2f</span></span>
<span id="cb35-170"><a href="#cb35-170" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, el<span class="sc">$</span>beta))</span>
<span id="cb35-171"><a href="#cb35-171" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span></span>
<span id="cb35-172"><a href="#cb35-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-173"><a href="#cb35-173" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, best_beta))</span>
<span id="cb35-174"><a href="#cb35-174" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-175"><a href="#cb35-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-176"><a href="#cb35-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb35-177"><a href="#cb35-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_list =</span> beta_list,</span>
<span id="cb35-178"><a href="#cb35-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">bp_counts =</span> bp_counts,</span>
<span id="cb35-179"><a href="#cb35-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> results,</span>
<span id="cb35-180"><a href="#cb35-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">plateaus =</span> plateaus,</span>
<span id="cb35-181"><a href="#cb35-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb35-182"><a href="#cb35-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">best_beta =</span> best_beta</span>
<span id="cb35-183"><a href="#cb35-183" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-184"><a href="#cb35-184" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-185"><a href="#cb35-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-186"><a href="#cb35-186" aria-hidden="true" tabindex="-1"></a>plot_segmentation_path <span class="ot">&lt;-</span> <span class="cf">function</span>(res) {</span>
<span id="cb35-187"><a href="#cb35-187" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> res<span class="sc">$</span>beta_list; bp_counts <span class="ot">&lt;-</span> res<span class="sc">$</span>bp_counts</span>
<span id="cb35-188"><a href="#cb35-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb35-189"><a href="#cb35-189" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb35-190"><a href="#cb35-190" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb35-191"><a href="#cb35-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb35-192"><a href="#cb35-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>best_beta,  <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb35-193"><a href="#cb35-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb35-194"><a href="#cb35-194" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb35-195"><a href="#cb35-195" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>应用(NBA数据)：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>cp_decomp <span class="ot">&lt;-</span> <span class="fu">parafac</span>(tensor_numeric, <span class="at">nfac =</span> <span class="dv">2</span>, <span class="at">const=</span><span class="fu">c</span>(<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>), <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># cp_decomp</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># const()</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取结果</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>A  <span class="co"># 第一模态因子矩阵</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>B  <span class="co"># 第二模态因子矩阵</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>C  <span class="co"># 时间模态因子矩阵</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> C</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 假设数据矩阵 Y 已经准备好</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(Y,<span class="at">beta_min =</span> <span class="dv">3</span>, </span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_max =</span> <span class="dv">50</span>, </span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size=</span><span class="dv">2</span>, </span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">p=</span><span class="dv">2</span>, </span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">elbow_window=</span><span class="dv">10</span>,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–6.41, 长度 = 6, 变点数 = 6
β = 7.09–7.09, 长度 = 1, 变点数 = 5
β = 7.77–14.58, 长度 = 11, 变点数 = 4
β = 15.26–21.39, 长度 = 10, 变点数 = 3
β = 22.07–26.16, 长度 = 7, 变点数 = 2
β = 26.84–50.00, 长度 = 35, 变点数 = 1

Elbow 候选 β = 26.84
最终推荐 β = 38.42 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#res #查看细节</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 画图</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_segmentation_path</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Simulation_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 用推荐 beta 获取最终变点</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>best_beta <span class="ot">&lt;-</span> res<span class="sc">$</span>best_beta</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>change_points <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, <span class="at">beta =</span>best_beta, <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"最终变点："</span>, <span class="fu">paste</span>(change_points, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>最终变点： 16 </code></pre>
</div>
</div>
<p>结果稳定在2016年（变点）</p>
</section>
<section id="proposed-vs-逐维法" class="level1">
<h1>Proposed VS 逐维法</h1>
</section>
<section id="评测指标" class="level1">
<h1>评测指标</h1>
<p>1.AnnotationError AnnotationError 是预测变点数量与真实变点数量之间的差异：</p>
<p><span class="math display">\[\text{ANNOtationError}:=\left\|\widehat{K}-K^{*}\right\|.\]</span> 指标用于区分在未知变点数量情况下的检测方法。</p>
<p>2.Hausdorff HAUSDORFF 距离衡量的是检测方法在不同变点位置上的最大误差：</p>
<p><span class="math display">\[ \operatorname{HAUSDORFF}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right):=\max\left\{\max_{\hat{t}\in\widehat{\mathcal{T}}}\min_{t^{*}\in\mathcal{T}^{*}}\left|\hat{t}-t^{*}\right|,\max_{t^{*}\in\mathcal{T}^{*}}\min_{\hat{t}\in\widehat{\mathcal{T}}}\left|\hat{t}-t^{*}\right|\right\}. \]</span></p>
<p>如果这个指标为零，说明两个变点集合完全相同；否则，说明存在较大的误差。</p>
<p>3.RandIndex RANDINDEX 用于衡量预测变点集合与真实变点集合之间的相似性：</p>
<p><span class="math display">\[ \operatorname{RANDINDEX}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right):=\frac{\left|\operatorname{gr}\left(\widehat{\mathcal{T}}\right)\cap\operatorname{gr}\left(\mathcal{T}^{*}\right)\right| + \left|\operatorname{ngr}\left(\widehat{\mathcal{T}}\right)\cap\operatorname{ngr}\left(\mathcal{T}^{*}\right)\right|}{T(T-1)} \]</span></p>
<p>其中</p>
<p><span class="math display">\[ \operatorname{gr}(\mathcal{T}) := \left\{ (s, t) \mid 1 \leq s &lt; t \leq T \text{ s.t. } s \text{ and } t \text{ belong to the same segment according to } \mathcal{T} \right\}, \]</span></p>
<p><span class="math display">\[ \operatorname{ngr}(\mathcal{T}) := \left\{ (s, t) \mid 1 \leq s &lt; t \leq T \text{ s.t. } s \text{ and } t \text{ belong to different segments according to } \mathcal{T} \right\}. \]</span></p>
<p>RANDINDEX 的取值范围在0到1之间，1表示完全一致，0表示完全不一致.</p>
<p>4.F1-score: F1-score 是精确率和召回率的调和平均值： <span class="math display">\[ F1\operatorname{ScoRE}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right):=2\times\frac{\operatorname{PREc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)\times\operatorname{REc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)}{\operatorname{PREc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)+\operatorname{REc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)}.  \]</span></p>
<p>F1-score 的取值范围也在0到1之间，1表示最佳性能，0表示最差性能。</p>
<p>评价函数code：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 评价函数（增强鲁棒性）</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>hausdorff <span class="ot">&lt;-</span> <span class="cf">function</span>(A, B) {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(A) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(B) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">Inf</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(A)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(B)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  max_A <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(A, <span class="cf">function</span>(a) <span class="fu">min</span>(<span class="fu">abs</span>(a <span class="sc">-</span> B))))</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  max_B <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(B, <span class="cf">function</span>(b) <span class="fu">min</span>(<span class="fu">abs</span>(b <span class="sc">-</span> A))))</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">max</span>(max_A, max_B))</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>f1_score <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, <span class="at">tol =</span> <span class="dv">1</span>) {</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 处理空输入</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(detected_cp) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">any</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&lt;=</span> tol)))</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(detected_cp, <span class="cf">function</span>(dc) <span class="fu">all</span>(<span class="fu">abs</span>(true_cp <span class="sc">-</span> dc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">all</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FP) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FP)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FN) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((precision <span class="sc">+</span> recall) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="dv">2</span> <span class="sc">*</span> precision <span class="sc">*</span> recall <span class="sc">/</span> (precision <span class="sc">+</span> recall))</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>rand_index <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, n) {</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(true_cp))</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(detected_cp))</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>  true_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, true_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>  detected_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, detected_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>  agree <span class="ot">&lt;-</span> <span class="fu">outer</span>(true_labels, true_labels, <span class="st">"=="</span>) <span class="sc">==</span> <span class="fu">outer</span>(detected_labels, detected_labels, <span class="st">"=="</span>)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(agree))</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>annotation_error <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp) {</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>(<span class="fu">length</span>(true_cp) <span class="sc">-</span> <span class="fu">length</span>(detected_cp))</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="稠密模式" class="level1">
<h1>稠密模式</h1>
<p>设观测为 <span class="math inline">\(d\)</span> 维时间序列 <span class="math inline">\(\{Y_t\}_{t=1}^n\)</span>，其中 <span class="math inline">\(Y_t\in\mathbb{R}^d\)</span>，是分段常数，给定分段端点 <span class="math display">\[
0=\tau_0&lt;\tau_1&lt;\cdots&lt;\tau_K=n,
\]</span> 在每个区间 <span class="math inline">\((\tau_{k-1},\tau_k]\)</span> 上有 <span class="math display">\[
Y_t=\mu_k+\varepsilon_t,\quad t\in(\tau_{k-1},\tau_k],\ k=1,\ldots,K.
\]</span></p>
<p>真变点集合记为 <span class="math display">\[
T^\*=\{\tau_1,\tau_2,\ldots,\tau_K\}.
\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>例</strong>：<span class="math inline">\(n=2000,\ d\in[100,200],\ T^\*=\{600,1200,1600\}\)</span></p>
</div>
</div>
<p>密集（dense）变点设定</p>
<p>在每个变点 <span class="math inline">\(\tau_k\)</span> 处，有比例为 <span class="math inline">\(\rho\)</span> 的坐标同时发生均值跃迁，跃迁幅度为 <span class="math inline">\(\Delta\)</span>。令 <span class="math inline">\(S_k\subset\{1,\ldots,d\}\)</span>，<span class="math inline">\(|S_k|=\lfloor \rho d\rfloor\)</span>，并令 <span class="math inline">\(s_k\in\{+1,-1\}\)</span> 表示跃迁方向（同一变点内方向一致）。则 <span class="math display">\[
\mu_k=\mu_{k-1}+s_k\,\Delta\,\mathbf{1}_{S_k},
\]</span> 其中 <span class="math inline">\(\mathbf{1}_{S_k}\in\mathbb{R}^d\)</span> 为在 <span class="math inline">\(S_k\)</span> 上取 <span class="math inline">\(1\)</span>、其余取 <span class="math inline">\(0\)</span> 的指示向量。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>例</strong>：<span class="math inline">\(\rho=0.7,\ \Delta=1.0\)</span></p>
</div>
</div>
<p>噪声过程 <span class="math inline">\(\{\varepsilon_t\}\)</span> 可取其一：</p>
<ol type="1">
<li><p><strong>独立同分布高斯噪声</strong>（各维独立同分布）： <span class="math display">\[
\varepsilon_t \overset{\text{i.i.d.}}{\sim}\mathcal{N}(0,\sigma^2 I_d).
\]</span></p></li>
<li><p><strong>各维独立的 AR(1) 噪声</strong>（刻画时间相关性）：</p>
<p><span class="math display">\[ \varepsilon_t=\phi\,\varepsilon_{t-1}+\eta_t,\qquad
\eta_t\overset{\text{i.i.d.}}{\sim}\mathcal{N}(0,\sigma_\eta^2 I_d).\]</span></p>
<p>其中</p>
<p><span class="math display">\[ \sigma_\eta^2 = \sigma^2(1-\phi^2). \]</span></p>
<p>例：<span class="math inline">\(\phi=0.2\)</span>.</p></li>
</ol>
</section>
<section id="code" class="level1">
<h1>code:</h1>
<section id="数据生成" class="level2">
<h2 class="anchored" data-anchor-id="数据生成">数据生成：</h2>
<p><span class="math inline">\(\{Y_t\}_{t=1}^n\)</span>是分段常数</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 密集模式数据生成</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>simulate_dense <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">100</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rho =</span> <span class="fl">0.6</span>,              <span class="co"># 每次跳变的受影响比例</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">delta =</span> <span class="fl">1.0</span>,            <span class="co"># 单次跳变幅度（同号）</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma =</span> <span class="fl">1.0</span>,            <span class="co"># 噪声标准差</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ar_phi =</span> <span class="fl">0.0</span>,           <span class="co"># AR(1) 噪声相关，0 表示独立</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">same_sign =</span> <span class="cn">TRUE</span>,       <span class="co"># TRUE：所有受影响维同号上升</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  Y  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 固定一个受影响子集（密集：每个变点都影响同一批维度）</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  jump_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d); jump_vec[S] <span class="ot">&lt;-</span> signs[S] <span class="sc">*</span> delta</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 累积式均值：每遇到一个变点，对 [cp+1, n] 段叠加 jump_vec</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (cp <span class="cf">in</span> cps) {</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, ] <span class="ot">&lt;-</span> <span class="fu">sweep</span>(mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, , <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="dv">2</span>, jump_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#嵌入噪声：独立或 AR(1)</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>      eps[t, ] <span class="ot">&lt;-</span> ar_phi <span class="sc">*</span> eps[t <span class="sc">-</span> <span class="dv">1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> mu <span class="sc">+</span> eps</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> Y, <span class="at">true_cp =</span> cps, <span class="at">mu =</span> mu, <span class="at">S =</span> S)</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="func-逐维abs-vs-高维" class="level2">
<h2 class="anchored" data-anchor-id="func-逐维abs-vs-高维">func: 逐维（ABS） vs 高维</h2>
<p>即一维一维做abs的结果和直接做高维abs结果的对比</p>
<p>code：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 逐维法：单维 BS + 合并</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="do">##    ——并配套“稳定路径 Elbow+Plateau”自适应选 β（与 ABS 公平）</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 把若干维度检出的变点合并：按 tol 聚簇，簇内取均值(四舍五入)为代表</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>merge_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(cplist, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>)) {</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  all <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.integer</span>(<span class="fu">unlist</span>(cplist)))</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(all) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  clusters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  curr <span class="ot">&lt;-</span> <span class="fu">c</span>(all[<span class="dv">1</span>])</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x <span class="cf">in</span> all[<span class="sc">-</span><span class="dv">1</span>]) {</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">-</span> curr[<span class="fu">length</span>(curr)] <span class="sc">&lt;=</span> tol) {</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(curr, x)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>      clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(x)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  rep_fun <span class="ot">&lt;-</span> <span class="cf">if</span> (representative <span class="sc">==</span> <span class="st">"mean"</span>) mean <span class="cf">else</span> median</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">vapply</span>(clusters, rep_fun, <span class="fu">numeric</span>(<span class="dv">1</span>))))</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 在单一维度上独立寻找合适的 β 和对应的变点=====================================================================</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>per_dim_single_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(y_vec,</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>) {</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  Yj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(y_vec, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  results   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  counts    <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    th <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Yj, b, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Yj), <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> th</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(th)</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(counts <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">best_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>                <span class="at">elbow_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>                <span class="at">plateaus =</span> <span class="fu">list</span>(), <span class="at">t_hat =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts))</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, counts)</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>  pls <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, counts)</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>  left_bound  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>  best_pl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> pls) {</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound <span class="sc">&amp;&amp;</span> pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound) {</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_pl) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_pl<span class="sc">$</span>length) best_pl <span class="ot">&lt;-</span> pp</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_pl<span class="sc">$</span>start <span class="sc">+</span> best_pl<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>  best_idx  <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(beta_list <span class="sc">-</span> best_beta))</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">best_beta =</span> best_beta,</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>       <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>       <span class="at">plateaus =</span> pls,</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>       <span class="at">t_hat =</span> <span class="fu">sort</span>(results[[best_idx]]),</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts)</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a><span class="do">##在多维数据上做逐维检出，再合并成一个整体的变点集合########</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>per_dim_individual_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>),</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>  dim_betas <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d)</span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>  dim_cps   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, d)</span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>    rj <span class="ot">&lt;-</span> <span class="fu">per_dim_single_adaptive</span>(Y[, j],</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>                                  beta_min, beta_max, beta_points,</span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>                                  min_size, p, elbow_window)</span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>    dim_betas[j] <span class="ot">&lt;-</span> rj<span class="sc">$</span>best_beta</span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>    dim_cps[[j]] <span class="ot">&lt;-</span> rj<span class="sc">$</span>t_hat</span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose) <span class="sc">&amp;&amp;</span> (j <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[per-dim] finished %d/%d"</span>, j, d))</span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>  merged <span class="ot">&lt;-</span> <span class="fu">merge_cps</span>(dim_cps, <span class="at">tol =</span> tol, <span class="at">representative =</span> representative)</span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">merged_cp =</span> <span class="fu">sort</span>(merged), <span class="at">per_dim_beta =</span> dim_betas, <span class="at">per_dim_cp =</span> dim_cps)</span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="跑评价" class="level3">
<h3 class="anchored" data-anchor-id="跑评价">(跑评价)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>run_one_trial <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="cn">NULL</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span>(n, d, cps, rho, delta, sigma, ar_phi, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> verbose</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  t_per <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    per_res <span class="ot">&lt;-</span> <span class="fu">per_dim_individual_adaptive</span>(</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> per_beta_min, <span class="at">beta_max =</span> per_beta_max, <span class="at">beta_points =</span> per_beta_points,</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_per, <span class="at">tol =</span> tol_match, <span class="at">elbow_window =</span> elbow_window,</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">representative =</span> representative, <span class="at">verbose =</span> verbose</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    cp_per <span class="ot">&lt;-</span> per_res<span class="sc">$</span>merged_cp</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 评估</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> tol_match)</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_per, <span class="at">tol =</span> tol_match)</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_per)</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> n)</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_per, <span class="at">n =</span> n)</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_per)</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp =</span> true_cp,</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_abs,</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> abs_f1, <span class="at">haus =</span> abs_haus, <span class="at">rand =</span> abs_rand, <span class="at">ann =</span> abs_ann,</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])),</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">per =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_per,</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> per_f1, <span class="at">haus =</span> per_haus, <span class="at">rand =</span> per_rand, <span class="at">ann =</span> per_ann,</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_per[<span class="st">"elapsed"</span>]))</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a><span class="do">##) 批量实验与汇总</span></span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>run_experiments <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">30</span>,</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>                            <span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>                            <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>                            <span class="at">seed0 =</span> <span class="dv">123</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed0)</span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, <span class="dv">1</span>)</span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>    results[[r]] <span class="ot">&lt;-</span> <span class="fu">run_one_trial</span>(</span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> n, <span class="at">d =</span> d, <span class="at">cps =</span> cps, <span class="at">rho =</span> rho, <span class="at">delta =</span> delta, <span class="at">sigma =</span> sigma, <span class="at">ar_phi =</span> ar_phi,</span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">tol_match =</span> tol_match,</span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">abs_beta_min =</span> abs_beta_min, <span class="at">abs_beta_max =</span> abs_beta_max, <span class="at">abs_beta_points =</span> abs_beta_points, <span class="at">p_abs =</span> p_abs,</span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">per_beta_min =</span> per_beta_min, <span class="at">per_beta_max =</span> per_beta_max, <span class="at">per_beta_points =</span> per_beta_points, <span class="at">p_per =</span> p_per,</span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">elbow_window =</span> elbow_window, <span class="at">representative =</span> representative,</span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> s, <span class="at">verbose =</span> verbose</span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[run] %d/%d done"</span>, r, R))</span>
<span id="cb44-76"><a href="#cb44-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-77"><a href="#cb44-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-78"><a href="#cb44-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 抽出指标</span></span>
<span id="cb44-79"><a href="#cb44-79" aria-hidden="true" tabindex="-1"></a>  to_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(key) <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o[[key]])</span>
<span id="cb44-80"><a href="#cb44-80" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1)</span>
<span id="cb44-81"><a href="#cb44-81" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>f1)</span>
<span id="cb44-82"><a href="#cb44-82" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus)</span>
<span id="cb44-83"><a href="#cb44-83" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>haus)</span>
<span id="cb44-84"><a href="#cb44-84" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand)</span>
<span id="cb44-85"><a href="#cb44-85" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>rand)</span>
<span id="cb44-86"><a href="#cb44-86" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann)</span>
<span id="cb44-87"><a href="#cb44-87" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>ann)</span>
<span id="cb44-88"><a href="#cb44-88" aria-hidden="true" tabindex="-1"></a>  abs_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time)</span>
<span id="cb44-89"><a href="#cb44-89" aria-hidden="true" tabindex="-1"></a>  per_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>time)</span>
<span id="cb44-90"><a href="#cb44-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-91"><a href="#cb44-91" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-92"><a href="#cb44-92" aria-hidden="true" tabindex="-1"></a>  sdv <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-93"><a href="#cb44-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-94"><a href="#cb44-94" aria-hidden="true" tabindex="-1"></a>  summary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb44-95"><a href="#cb44-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">ABS =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(abs_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(abs_f1),</span>
<span id="cb44-96"><a href="#cb44-96" aria-hidden="true" tabindex="-1"></a>            <span class="at">Haus_median =</span> <span class="fu">median</span>(abs_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-97"><a href="#cb44-97" aria-hidden="true" tabindex="-1"></a>            <span class="at">Rand_mean =</span> <span class="fu">m</span>(abs_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(abs_rand),</span>
<span id="cb44-98"><a href="#cb44-98" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ann_mean =</span> <span class="fu">m</span>(abs_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(abs_ann),</span>
<span id="cb44-99"><a href="#cb44-99" aria-hidden="true" tabindex="-1"></a>            <span class="at">Time_mean =</span> <span class="fu">m</span>(abs_t)),</span>
<span id="cb44-100"><a href="#cb44-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">PER_indivBeta =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(per_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(per_f1),</span>
<span id="cb44-101"><a href="#cb44-101" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Haus_median =</span> <span class="fu">median</span>(per_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-102"><a href="#cb44-102" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Rand_mean =</span> <span class="fu">m</span>(per_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(per_rand),</span>
<span id="cb44-103"><a href="#cb44-103" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Ann_mean =</span> <span class="fu">m</span>(per_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(per_ann),</span>
<span id="cb44-104"><a href="#cb44-104" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Time_mean =</span> <span class="fu">m</span>(per_t))</span>
<span id="cb44-105"><a href="#cb44-105" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-106"><a href="#cb44-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-107"><a href="#cb44-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 也给出逐次结果的 data.frame，便于出图</span></span>
<span id="cb44-108"><a href="#cb44-108" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb44-109"><a href="#cb44-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb44-110"><a href="#cb44-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1 =</span> abs_f1, <span class="at">per_f1 =</span> per_f1,</span>
<span id="cb44-111"><a href="#cb44-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> abs_haus, <span class="at">per_haus =</span> per_haus,</span>
<span id="cb44-112"><a href="#cb44-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> abs_rand, <span class="at">per_rand =</span> per_rand,</span>
<span id="cb44-113"><a href="#cb44-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann =</span> abs_ann, <span class="at">per_ann =</span> per_ann,</span>
<span id="cb44-114"><a href="#cb44-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> abs_t, <span class="at">per_time =</span> per_t</span>
<span id="cb44-115"><a href="#cb44-115" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-116"><a href="#cb44-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-117"><a href="#cb44-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">all =</span> results, <span class="at">summary =</span> summary, <span class="at">metrics =</span> df)</span>
<span id="cb44-118"><a href="#cb44-118" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>应用</p>
<p>n = 200, d = 10, cps = c(60, 120, 160)，rho = 0.7，ar_phi = 0.2，R=10，信噪比 snr=1，R=10</p>
<p>“abs_”结果是abs的评价分数，“per_”是逐维法的结果，可以看到结果明显是abs更好</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="do">## ) 示例运行</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">run_experiments</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">120</span>, <span class="dv">160</span>),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed0 =</span> <span class="dv">123</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 29
β = 3.39–3.39, 长度 = 1, 变点数 = 22
β = 3.78–3.78, 长度 = 1, 变点数 = 19
β = 4.17–4.17, 长度 = 1, 变点数 = 12
β = 4.57–4.57, 长度 = 1, 变点数 = 10
β = 4.96–4.96, 长度 = 1, 变点数 = 6
β = 5.35–5.35, 长度 = 1, 变点数 = 5
β = 5.74–6.13, 长度 = 2, 变点数 = 4
β = 6.52–10.43, 长度 = 11, 变点数 = 3
β = 10.83–16.30, 长度 = 15, 变点数 = 2
β = 16.70–30.00, 长度 = 35, 变点数 = 1

Elbow 候选 β = 6.52
最终推荐 β = 8.48 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 26
β = 3.39–3.39, 长度 = 1, 变点数 = 19
β = 3.78–3.78, 长度 = 1, 变点数 = 17
β = 4.17–4.17, 长度 = 1, 变点数 = 14
β = 4.57–4.57, 长度 = 1, 变点数 = 8
β = 4.96–4.96, 长度 = 1, 变点数 = 5
β = 5.35–5.35, 长度 = 1, 变点数 = 4
β = 5.74–13.17, 长度 = 20, 变点数 = 3
β = 13.57–15.13, 长度 = 5, 变点数 = 2
β = 15.52–30.00, 长度 = 38, 变点数 = 1

Elbow 候选 β = 5.74
最终推荐 β = 9.65 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 25
β = 3.39–3.39, 长度 = 1, 变点数 = 21
β = 3.78–3.78, 长度 = 1, 变点数 = 17
β = 4.17–4.17, 长度 = 1, 变点数 = 12
β = 4.57–4.57, 长度 = 1, 变点数 = 9
β = 4.96–12.78, 长度 = 21, 变点数 = 3
β = 13.17–13.57, 长度 = 2, 变点数 = 2
β = 13.96–30.00, 长度 = 42, 变点数 = 1

Elbow 候选 β = 4.96
最终推荐 β = 8.87 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 29
β = 3.39–3.39, 长度 = 1, 变点数 = 27
β = 3.78–3.78, 长度 = 1, 变点数 = 24
β = 4.17–4.17, 长度 = 1, 变点数 = 14
β = 4.57–4.57, 长度 = 1, 变点数 = 10
β = 4.96–4.96, 长度 = 1, 变点数 = 4
β = 5.35–13.57, 长度 = 22, 变点数 = 3
β = 13.96–15.13, 长度 = 4, 变点数 = 2
β = 15.52–30.00, 长度 = 38, 变点数 = 1

Elbow 候选 β = 5.35
最终推荐 β = 9.65 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 26
β = 3.39–3.39, 长度 = 1, 变点数 = 25
β = 3.78–3.78, 长度 = 1, 变点数 = 15
β = 4.17–4.17, 长度 = 1, 变点数 = 11
β = 4.57–4.57, 长度 = 1, 变点数 = 8
β = 4.96–4.96, 长度 = 1, 变点数 = 7
β = 5.35–5.74, 长度 = 2, 变点数 = 6
β = 6.13–6.13, 长度 = 1, 变点数 = 5
β = 6.52–12.39, 长度 = 16, 变点数 = 3
β = 12.78–13.17, 长度 = 2, 变点数 = 2
β = 13.57–30.00, 长度 = 43, 变点数 = 1

Elbow 候选 β = 6.52
最终推荐 β = 9.65 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 29
β = 3.39–3.39, 长度 = 1, 变点数 = 25
β = 3.78–3.78, 长度 = 1, 变点数 = 16
β = 4.17–4.17, 长度 = 1, 变点数 = 11
β = 4.57–4.57, 长度 = 1, 变点数 = 7
β = 4.96–4.96, 长度 = 1, 变点数 = 6
β = 5.35–11.61, 长度 = 17, 变点数 = 3
β = 12.00–15.52, 长度 = 10, 变点数 = 2
β = 15.91–30.00, 长度 = 37, 变点数 = 1

Elbow 候选 β = 5.35
最终推荐 β = 8.48 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 31
β = 3.39–3.39, 长度 = 1, 变点数 = 19
β = 3.78–3.78, 长度 = 1, 变点数 = 13
β = 4.17–4.17, 长度 = 1, 变点数 = 10
β = 4.57–4.96, 长度 = 2, 变点数 = 6
β = 5.35–5.74, 长度 = 2, 变点数 = 5
β = 6.13–6.13, 长度 = 1, 变点数 = 4
β = 6.52–10.43, 长度 = 11, 变点数 = 3
β = 10.83–14.35, 长度 = 10, 变点数 = 2
β = 14.74–30.00, 长度 = 40, 变点数 = 1

Elbow 候选 β = 6.52
最终推荐 β = 8.48 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 26
β = 3.39–3.39, 长度 = 1, 变点数 = 23
β = 3.78–3.78, 长度 = 1, 变点数 = 16
β = 4.17–4.17, 长度 = 1, 变点数 = 9
β = 4.57–4.57, 长度 = 1, 变点数 = 7
β = 4.96–4.96, 长度 = 1, 变点数 = 4
β = 5.35–12.00, 长度 = 18, 变点数 = 3
β = 12.39–16.30, 长度 = 11, 变点数 = 2
β = 16.70–30.00, 长度 = 35, 变点数 = 1

Elbow 候选 β = 5.35
最终推荐 β = 8.87 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 31
β = 3.39–3.39, 长度 = 1, 变点数 = 26
β = 3.78–3.78, 长度 = 1, 变点数 = 23
β = 4.17–4.17, 长度 = 1, 变点数 = 18
β = 4.57–4.57, 长度 = 1, 变点数 = 8
β = 4.96–4.96, 长度 = 1, 变点数 = 5
β = 5.35–5.35, 长度 = 1, 变点数 = 4
β = 5.74–10.43, 长度 = 13, 变点数 = 3
β = 10.83–13.57, 长度 = 8, 变点数 = 2
β = 13.96–30.00, 长度 = 42, 变点数 = 1

Elbow 候选 β = 5.74
最终推荐 β = 8.09 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>所有 plateau 区间:
β = 3.00–3.00, 长度 = 1, 变点数 = 27
β = 3.39–3.39, 长度 = 1, 变点数 = 23
β = 3.78–3.78, 长度 = 1, 变点数 = 17
β = 4.17–4.17, 长度 = 1, 变点数 = 10
β = 4.57–4.57, 长度 = 1, 变点数 = 9
β = 4.96–4.96, 长度 = 1, 变点数 = 7
β = 5.35–5.74, 长度 = 2, 变点数 = 5
β = 6.13–6.91, 长度 = 3, 变点数 = 4
β = 7.30–12.78, 长度 = 15, 变点数 = 3
β = 13.17–15.13, 长度 = 6, 变点数 = 2
β = 15.52–30.00, 长度 = 38, 变点数 = 1

Elbow 候选 β = 6.13
最终推荐 β = 10.04 (在 elbow 附近 plateau 最长)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(res$summary)</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># res$metrics</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    res<span class="sc">$</span>metrics,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-9f8c4fbb7c6c0acb7cc3" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9f8c4fbb7c6c0acb7cc3">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10],[1,1,1,0.6666666666666666,1,1,1,1,1,1],[0,0.4,0.4,0.4,0.4,0.4,0.5,0.3333333333333333,0.4,0.5],[0,0,2,6,1,0,0,0,1,0],[54,60,45,56,60,50,60,58,45,60],[1,1,0.9922,0.9718,0.99605,1,1,1,0.99605,1],[0.7178,0.74125,0.75125,0.7406,0.7408,0.745,0.74,0.74895,0.74995,0.74],[0,0,0,0,0,0,0,0,0,0],[2,1,1,1,1,1,2,0,1,2],[1.170000000000002,0.7200000000000131,0.8800000000000097,1.52000000000001,1.810000000000002,1.330000000000013,1.549999999999983,1.919999999999987,1.360000000000014,2.370000000000005],[4.159999999999997,4.030000000000001,6.039999999999992,8.700000000000003,10,10.82999999999998,7.639999999999986,8.950000000000017,6.840000000000003,12.17000000000002]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>trial<\/th>\n      <th>abs_f1<\/th>\n      <th>per_f1<\/th>\n      <th>abs_haus<\/th>\n      <th>per_haus<\/th>\n      <th>abs_rand<\/th>\n      <th>per_rand<\/th>\n      <th>abs_ann<\/th>\n      <th>per_ann<\/th>\n      <th>abs_time<\/th>\n      <th>per_time<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[0,1,2,3,4,5,6,7,8,9,10]},{"name":"trial","targets":0},{"name":"abs_f1","targets":1},{"name":"per_f1","targets":2},{"name":"abs_haus","targets":3},{"name":"per_haus","targets":4},{"name":"abs_rand","targets":5},{"name":"per_rand","targets":6},{"name":"abs_ann","targets":7},{"name":"per_ann","targets":8},{"name":"abs_time","targets":9},{"name":"per_time","targets":10}],"order":[],"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 若想查看某次 ABS 的稳定路径，可在 run_one_trial 中将 abs_res 暴露出来后调用：</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_segmentation_path(abs_res)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="跑可视化" class="level3">
<h3 class="anchored" data-anchor-id="跑可视化">(跑可视化)</h3>
<p>看到具体检测情况</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================================</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 逐次观察函数：1–10 次试验的真/检变点 + 指标（ABS vs 逐维-独立β）</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - Hausdorff 为 Inf 时友好打印</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - 可选导出 CSV</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================================</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>observe_trials <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">5</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seeds =</span> <span class="cn">NULL</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">export_csv =</span> <span class="cn">NULL</span>,   <span class="co"># 例如 "observe_trials.csv"</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">print_each =</span> <span class="cn">TRUE</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                           ...) {</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(R)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (R <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">||</span> R <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="fu">stop</span>(<span class="st">"R 必须在 1~10 之间。"</span>)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 生成/对齐随机种子</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(seeds)) {</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">20250911</span>)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, R)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(seeds) <span class="sc">&lt;</span> R) <span class="fu">stop</span>(<span class="st">"提供的 seeds 数量不足 R。"</span>)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(seeds[<span class="fu">seq_len</span>(R)])</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ... 透传给 run_one_trial()</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>  base_args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 小工具：把整数向量转为简洁字符串</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>  vec_to_str <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(x)</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="st">"∅"</span>)</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(x, <span class="at">collapse =</span> <span class="st">","</span>)</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>  digits  <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(digits)</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>    args_i <span class="ot">&lt;-</span> base_args</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>    args_i<span class="sc">$</span>seed <span class="ot">&lt;-</span> seeds[i]</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 单次试验，容错不中断</span></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>    res_i <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">do.call</span>(run_one_trial, args_i), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(res_i, <span class="st">"try-error"</span>)) {</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 记一条占位，后续表格里会是 NA/∅，并附上错误信息</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>      results[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">true_cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">per =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="fu">as.character</span>(res_i)</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"发生错误："</span>, results[[i]]<span class="sc">$</span>error, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> res_i</span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>      haus_abs <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a>      haus_per <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>per<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>per<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"True CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>true_cp), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"ABS  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"PER  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>per<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ABS  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>f1,</span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a>                  haus_abs,</span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>rand,</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a>                  res_i<span class="sc">$</span>abs<span class="sc">$</span>ann,</span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>time))</span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"PER  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>per<span class="sc">$</span>f1,</span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a>                  haus_per,</span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>per<span class="sc">$</span>rand,</span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a>                  res_i<span class="sc">$</span>per<span class="sc">$</span>ann,</span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>per<span class="sc">$</span>time))</span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 组织明细表</span></span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial    =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed     =</span> seeds,</span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>true_cp), <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>abs<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>per<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-99"><a href="#cb58-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb58-100"><a href="#cb58-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb58-101"><a href="#cb58-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-102"><a href="#cb58-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb58-103"><a href="#cb58-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb58-104"><a href="#cb58-104" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-105"><a href="#cb58-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-106"><a href="#cb58-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(export_csv)) {</span>
<span id="cb58-107"><a href="#cb58-107" aria-hidden="true" tabindex="-1"></a>    utils<span class="sc">::</span><span class="fu">write.csv</span>(df, <span class="at">file =</span> export_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-108"><a href="#cb58-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"已导出 CSV: %s"</span>, <span class="fu">normalizePath</span>(export_csv, <span class="at">winslash =</span> <span class="st">"/"</span>)))</span>
<span id="cb58-109"><a href="#cb58-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-110"><a href="#cb58-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-111"><a href="#cb58-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(</span>
<span id="cb58-112"><a href="#cb58-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">table  =</span> df,</span>
<span id="cb58-113"><a href="#cb58-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">trials =</span> results</span>
<span id="cb58-114"><a href="#cb58-114" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb58-115"><a href="#cb58-115" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>应用</p>
<ul>
<li>逐维法一旦信噪比比较低，那么一维一维的检查就容易误检，漏检，而高维检验更稳健</li>
</ul>
<p>n = 200, d = 12, cps = c(60), rho = 0.5，ar_phi = 0.2，信噪比=1</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Trial 1 (seed=264783846) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=6.4600000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=76.4300000000

--- Trial 2 (seed=742253299) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.3300000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=29.3200000000

--- Trial 3 (seed=481231186) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.1800000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=26.0600000000

--- Trial 4 (seed=126214081) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.1400000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=34.3300000000

--- Trial 5 (seed=572187700) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=2.2500000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=30.8900000000

--- Trial 6 (seed=183354659) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.3400000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=28.5600000000

--- Trial 7 (seed=100809883) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.4100000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=33.3600000000

--- Trial 8 (seed=325988686) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.3800000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=32.5200000000

--- Trial 9 (seed=630624868) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.4900000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=37.8400000000

--- Trial 10 (seed=970172043) ---
True CP : 60
ABS  CP : 60
PER  CP : ∅
ABS  | F1=1.0000000000  Haus=0.0000000000  Rand=1.0000000000  Ann=0  Time=1.4400000000
PER  | F1=0.0000000000  Haus=Inf  Rand=0.5800000000  Ann=1  Time=38.0900000000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-135987bb942456f05d10" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-135987bb942456f05d10">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10],[264783846,742253299,481231186,126214081,572187700,183354659,100809883,325988686,630624868,970172043],["60","60","60","60","60","60","60","60","60","60"],["60","60","60","60","60","60","60","60","60","60"],["","","","","","","","","",""],[1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[null,null,null,null,null,null,null,null,null,null],[1,1,1,1,1,1,1,1,1,1],[0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58],[0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1],[6.460000000000008,1.329999999999984,1.180000000000007,1.139999999999986,2.25,1.339999999999975,1.409999999999968,1.379999999999995,1.490000000000009,1.440000000000055],[76.43000000000004,29.32000000000005,26.06,34.32999999999998,30.89000000000004,28.56,33.36000000000001,32.52000000000004,37.84000000000003,38.09000000000003]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>trial<\/th>\n      <th>seed<\/th>\n      <th>true_cp<\/th>\n      <th>abs_cp<\/th>\n      <th>per_cp<\/th>\n      <th>abs_f1<\/th>\n      <th>per_f1<\/th>\n      <th>abs_haus<\/th>\n      <th>per_haus<\/th>\n      <th>abs_rand<\/th>\n      <th>per_rand<\/th>\n      <th>abs_ann<\/th>\n      <th>per_ann<\/th>\n      <th>abs_time<\/th>\n      <th>per_time<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[0,1,5,6,7,8,9,10,11,12,13,14]},{"name":"trial","targets":0},{"name":"seed","targets":1},{"name":"true_cp","targets":2},{"name":"abs_cp","targets":3},{"name":"per_cp","targets":4},{"name":"abs_f1","targets":5},{"name":"per_f1","targets":6},{"name":"abs_haus","targets":7},{"name":"per_haus","targets":8},{"name":"abs_rand","targets":9},{"name":"per_rand","targets":10},{"name":"abs_ann","targets":11},{"name":"per_ann","targets":12},{"name":"abs_time","targets":13},{"name":"per_time","targets":14}],"order":[],"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 访问第 i 次：</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$true_cp</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$abs$cp</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$per$cp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>n = 200, d = 12, cps = c(60,120,160), rho = 0.5，ar_phi = 0.2，信噪比=1</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">12</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Trial 1 (seed=264783846) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 117,148
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.890000000000
PER  | F1=0.400000000000  Haus=57.000000000000  Rand=0.775450000000  Ann=1  Time=32.570000000000

--- Trial 2 (seed=742253299) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 73,94,120
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.160000000000
PER  | F1=0.333333333333  Haus=40.000000000000  Rand=0.823150000000  Ann=0  Time=47.380000000000

--- Trial 3 (seed=481231186) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 84,121,153
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.720000000000
PER  | F1=0.666666666667  Haus=24.000000000000  Rand=0.855850000000  Ann=0  Time=42.660000000000

--- Trial 4 (seed=126214081) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 99,121
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.450000000000
PER  | F1=0.400000000000  Haus=39.000000000000  Rand=0.761050000000  Ann=1  Time=45.890000000000

--- Trial 5 (seed=572187700) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 62,115,142,160
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=2.110000000000
PER  | F1=0.857142857143  Haus=18.000000000000  Rand=0.949650000000  Ann=1  Time=32.830000000000

--- Trial 6 (seed=183354659) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 121
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.320000000000
PER  | F1=0.500000000000  Haus=61.000000000000  Rand=0.734050000000  Ann=2  Time=37.120000000000

--- Trial 7 (seed=100809883) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 118
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.880000000000
PER  | F1=0.500000000000  Haus=58.000000000000  Rand=0.732200000000  Ann=2  Time=47.740000000000

--- Trial 8 (seed=325988686) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 71,119,138
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.810000000000
PER  | F1=0.333333333333  Haus=22.000000000000  Rand=0.872950000000  Ann=0  Time=48.030000000000

--- Trial 9 (seed=630624868) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 60,117
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.800000000000
PER  | F1=0.800000000000  Haus=43.000000000000  Rand=0.899450000000  Ann=1  Time=53.480000000000

--- Trial 10 (seed=970172043) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 103,121
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.920000000000
PER  | F1=0.400000000000  Haus=43.000000000000  Rand=0.753650000000  Ann=1  Time=46.730000000000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-8c8666d4b1a9f51f75f0" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-8c8666d4b1a9f51f75f0">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10],[264783846,742253299,481231186,126214081,572187700,183354659,100809883,325988686,630624868,970172043],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160"],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160"],["117,148","73,94,120","84,121,153","99,121","62,115,142,160","121","118","71,119,138","60,117","103,121"],[1,1,1,1,1,1,1,1,1,1],[0.4,0.3333333333333333,0.6666666666666666,0.4,0.8571428571428571,0.5,0.5,0.3333333333333333,0.8,0.4],[0,0,0,0,0,0,0,0,0,0],[57,40,24,39,18,61,58,22,43,43],[1,1,1,1,1,1,1,1,1,1],[0.77545,0.82315,0.85585,0.76105,0.94965,0.73405,0.7322,0.87295,0.89945,0.75365],[0,0,0,0,0,0,0,0,0,0],[1,0,0,1,1,2,2,0,1,1],[1.889999999999986,1.159999999999968,1.720000000000027,1.449999999999932,2.110000000000014,1.32000000000005,1.879999999999995,1.810000000000059,1.799999999999955,1.919999999999959],[32.56999999999994,47.38,42.65999999999997,45.88999999999999,32.83000000000004,37.12,47.74000000000001,48.02999999999997,53.48000000000002,46.73000000000002]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>trial<\/th>\n      <th>seed<\/th>\n      <th>true_cp<\/th>\n      <th>abs_cp<\/th>\n      <th>per_cp<\/th>\n      <th>abs_f1<\/th>\n      <th>per_f1<\/th>\n      <th>abs_haus<\/th>\n      <th>per_haus<\/th>\n      <th>abs_rand<\/th>\n      <th>per_rand<\/th>\n      <th>abs_ann<\/th>\n      <th>per_ann<\/th>\n      <th>abs_time<\/th>\n      <th>per_time<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[0,1,5,6,7,8,9,10,11,12,13,14]},{"name":"trial","targets":0},{"name":"seed","targets":1},{"name":"true_cp","targets":2},{"name":"abs_cp","targets":3},{"name":"per_cp","targets":4},{"name":"abs_f1","targets":5},{"name":"per_f1","targets":6},{"name":"abs_haus","targets":7},{"name":"per_haus","targets":8},{"name":"abs_rand","targets":9},{"name":"per_rand","targets":10},{"name":"abs_ann","targets":11},{"name":"per_ann","targets":12},{"name":"abs_time","targets":13},{"name":"per_time","targets":14}],"order":[],"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 访问第 i 次：</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$true_cp</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$abs$cp</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$per$cp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>n = 200, d = 12, cps = c(60,120,160), rho = 0.5，ar_phi = 0.2，信噪比=0.5</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">12</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Trial 1 (seed=264783846) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : ∅
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.970000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=44.120000000000

--- Trial 2 (seed=742253299) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : ∅
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.780000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=39.780000000000

--- Trial 3 (seed=481231186) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : ∅
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.670000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=38.780000000000

--- Trial 4 (seed=126214081) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : 117
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.420000000000
PER  | F1=0.500000000000  Haus=57.000000000000  Rand=0.728450000000  Ann=2  Time=37.110000000000

--- Trial 5 (seed=572187700) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : ∅
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.400000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=32.200000000000

--- Trial 6 (seed=183354659) ---
True CP : 60,120,160
ABS  CP : 4,9,13,18,21,24,28,31,34,39,44,47,52,55,60,65,69,74,77,82,85,88,91,95,99,104,109,112,115,120,123,128,132,135,140,143,146,149,152,157,160,165,168,173,176,180,183,186,191,195
PER  CP : ∅
ABS  | F1=0.146341463415  Haus=56.000000000000  Rand=0.760650000000  Ann=47  Time=1.410000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=39.700000000000

--- Trial 7 (seed=100809883) ---
True CP : 60,120,160
ABS  CP : 3,8,11,15,18,21,24,28,31,35,38,42,46,50,53,57,60,64,67,71,75,78,83,86,89,93,98,101,106,109,112,115,120,123,126,130,134,139,143,146,149,152,156,160,163,166,169,172,175,178,183,186,190,194,197
PER  CP : ∅
ABS  | F1=0.139534883721  Haus=57.000000000000  Rand=0.758550000000  Ann=52  Time=1.150000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=37.930000000000

--- Trial 8 (seed=325988686) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PER  CP : ∅
ABS  | F1=1.000000000000  Haus=0.000000000000  Rand=1.000000000000  Ann=0  Time=1.970000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=42.340000000000

--- Trial 9 (seed=630624868) ---
True CP : 60,120,160
ABS  CP : 58,120,161
PER  CP : ∅
ABS  | F1=1.000000000000  Haus=2.000000000000  Rand=0.984250000000  Ann=0  Time=1.720000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=41.090000000000

--- Trial 10 (seed=970172043) ---
True CP : 60,120,160
ABS  CP : 60,121,160
PER  CP : ∅
ABS  | F1=1.000000000000  Haus=1.000000000000  Rand=0.995050000000  Ann=0  Time=1.900000000000
PER  | F1=0.000000000000  Haus=Inf  Rand=0.260000000000  Ann=3  Time=38.790000000000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-a9eeb6ce92631e8697bc" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a9eeb6ce92631e8697bc">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10],[264783846,742253299,481231186,126214081,572187700,183354659,100809883,325988686,630624868,970172043],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160"],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","4,9,13,18,21,24,28,31,34,39,44,47,52,55,60,65,69,74,77,82,85,88,91,95,99,104,109,112,115,120,123,128,132,135,140,143,146,149,152,157,160,165,168,173,176,180,183,186,191,195","3,8,11,15,18,21,24,28,31,35,38,42,46,50,53,57,60,64,67,71,75,78,83,86,89,93,98,101,106,109,112,115,120,123,126,130,134,139,143,146,149,152,156,160,163,166,169,172,175,178,183,186,190,194,197","60,120,160","58,120,161","60,121,160"],["","","","117","","","","","",""],[1,1,1,1,1,0.1463414634146341,0.1395348837209302,1,1,1],[0,0,0,0.5,0,0,0,0,0,0],[0,0,0,0,0,56,57,0,2,1],[null,null,null,57,null,null,null,null,null,null],[1,1,1,1,1,0.76065,0.7585499999999999,1,0.98425,0.99505],[0.26,0.26,0.26,0.72845,0.26,0.26,0.26,0.26,0.26,0.26],[0,0,0,0,0,47,52,0,0,0],[3,3,3,2,3,3,3,3,3,3],[1.970000000000027,1.779999999999973,1.670000000000073,1.420000000000073,1.399999999999864,1.410000000000082,1.150000000000091,1.970000000000027,1.7199999999998,1.900000000000091],[44.12000000000012,39.77999999999997,38.77999999999997,37.1099999999999,32.20000000000005,39.69999999999982,37.93000000000006,42.33999999999992,41.08999999999992,38.78999999999996]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>trial<\/th>\n      <th>seed<\/th>\n      <th>true_cp<\/th>\n      <th>abs_cp<\/th>\n      <th>per_cp<\/th>\n      <th>abs_f1<\/th>\n      <th>per_f1<\/th>\n      <th>abs_haus<\/th>\n      <th>per_haus<\/th>\n      <th>abs_rand<\/th>\n      <th>per_rand<\/th>\n      <th>abs_ann<\/th>\n      <th>per_ann<\/th>\n      <th>abs_time<\/th>\n      <th>per_time<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[0,1,5,6,7,8,9,10,11,12,13,14]},{"name":"trial","targets":0},{"name":"seed","targets":1},{"name":"true_cp","targets":2},{"name":"abs_cp","targets":3},{"name":"per_cp","targets":4},{"name":"abs_f1","targets":5},{"name":"per_f1","targets":6},{"name":"abs_haus","targets":7},{"name":"per_haus","targets":8},{"name":"abs_rand","targets":9},{"name":"per_rand","targets":10},{"name":"abs_ann","targets":11},{"name":"per_ann","targets":12},{"name":"abs_time","targets":13},{"name":"per_time","targets":14}],"order":[],"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 访问第 i 次：</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$true_cp</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$abs$cp</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$per$cp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>n = 200, d = 10,cps = c(10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190), rho = 0.5，ar_phi = 0.2，信噪比=1</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>,<span class="dv">60</span>,<span class="dv">70</span>,<span class="dv">80</span>,<span class="dv">90</span>,<span class="dv">100</span>,<span class="dv">110</span>,<span class="dv">120</span>,<span class="dv">130</span>,<span class="dv">140</span>,<span class="dv">150</span>,<span class="dv">160</span>,<span class="dv">170</span>,<span class="dv">180</span>,<span class="dv">190</span>),</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span><span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">50</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">50</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Trial 1 (seed=264783846) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 10,30,50,70,84,100,110,130,150,170,180
PER  CP : 50,99,149
ABS  | F1=1.0000000000  Haus=10.0000000000  Rand=0.9588000000  Ann=8  Time=1.7400000000
PER  | F1=0.5384615385  Haus=41.0000000000  Rand=0.7981500000  Ann=16  Time=65.3200000000

--- Trial 2 (seed=742253299) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 20,30,50,60,80,100,120,140,150,170,188
PER  CP : 50,101,152
ABS  | F1=1.0000000000  Haus=10.0000000000  Rand=0.9592000000  Ann=8  Time=1.7800000000
PER  | F1=0.5384615385  Haus=40.0000000000  Rand=0.7973500000  Ann=16  Time=66.6100000000

--- Trial 3 (seed=481231186) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 20,40,50,60,80,100,110,130,150,170,180
PER  CP : 49,100,151
ABS  | F1=1.0000000000  Haus=10.0000000000  Rand=0.9600000000  Ann=8  Time=2.0100000000
PER  | F1=0.5384615385  Haus=39.0000000000  Rand=0.7981000000  Ann=16  Time=68.5700000000

--- Trial 4 (seed=126214081) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 3,7,10,14,17,20,24,27,30,33,37,40,44,47,50,53,57,60,65,70,73,77,80,84,87,90,93,97,100,104,107,110,114,117,120,123,126,130,135,140,143,147,150,153,157,160,164,167,170,174,177,180,184,187,190,194,197
PER  CP : 51,101,150,174
ABS  | F1=1.0000000000  Haus=7.0000000000  Rand=0.9678000000  Ann=38  Time=1.9100000000
PER  | F1=0.6428571429  Haus=41.0000000000  Rand=0.8269500000  Ann=15  Time=65.5400000000

--- Trial 5 (seed=572187700) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 10,30,50,70,80,100,110,130,150,170,190
PER  CP : 48,99,150
ABS  | F1=1.0000000000  Haus=10.0000000000  Rand=0.9600000000  Ann=8  Time=2.2900000000
PER  | F1=0.5384615385  Haus=40.0000000000  Rand=0.7973500000  Ann=16  Time=67.9800000000

--- Trial 6 (seed=183354659) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 20,40,50,70,90,100,110,130,150,170,180
PER  CP : 49,100,152
ABS  | F1=1.0000000000  Haus=10.0000000000  Rand=0.9600000000  Ann=8  Time=1.8600000000
PER  | F1=0.5384615385  Haus=39.0000000000  Rand=0.7972500000  Ann=16  Time=67.8600000000

--- Trial 7 (seed=100809883) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 4,7,10,15,20,23,26,30,35,40,43,46,50,53,57,60,63,66,70,73,76,80,83,87,90,93,96,100,103,107,110,115,120,123,126,130,134,137,140,143,147,150,153,156,160,163,167,170,175,180,183,186,190,194,197
PER  CP : 50,100,151
ABS  | F1=1.0000000000  Haus=7.0000000000  Rand=0.9686000000  Ann=36  Time=1.9400000000
PER  | F1=0.5925925926  Haus=40.0000000000  Rand=0.7990500000  Ann=16  Time=61.3700000000

--- Trial 8 (seed=325988686) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 3,7,10,13,16,20,23,26,30,35,40,44,47,50,53,56,60,64,67,70,74,77,80,83,86,90,93,96,100,104,107,110,114,117,120,124,129,133,137,140,144,147,150,154,157,160,163,167,170,175,180,184,187,190,194,197
PER  CP : 49,99,150
ABS  | F1=1.0000000000  Haus=7.0000000000  Rand=0.9678500000  Ann=37  Time=1.6200000000
PER  | F1=0.5384615385  Haus=40.0000000000  Rand=0.7981500000  Ann=16  Time=60.6200000000

--- Trial 9 (seed=630624868) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 5,10,14,17,20,24,27,30,33,36,40,43,46,50,53,57,60,63,66,70,74,77,80,83,87,90,93,96,100,104,107,110,113,116,120,123,126,130,133,137,140,144,147,150,155,160,163,166,170,173,176,180,183,187,190,193,197
PER  CP : 49,101,153
ABS  | F1=1.0000000000  Haus=7.0000000000  Rand=0.9678000000  Ann=38  Time=1.9900000000
PER  | F1=0.4800000000  Haus=39.0000000000  Rand=0.7956500000  Ann=16  Time=62.0500000000

--- Trial 10 (seed=970172043) ---
True CP : 10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190
ABS  CP : 3,7,10,13,17,20,23,27,30,33,36,40,45,50,55,60,63,67,70,73,77,80,83,86,90,93,96,100,104,107,110,114,119,122,125,130,133,137,140,143,146,150,154,157,160,163,166,170,175,180,183,187,190,193,197
PER  CP : 49,102,153
ABS  | F1=1.0000000000  Haus=7.0000000000  Rand=0.9684000000  Ann=36  Time=1.9200000000
PER  | F1=0.4800000000  Haus=39.0000000000  Rand=0.7949000000  Ann=16  Time=63.7500000000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-396836ee4c1825c483a7" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-396836ee4c1825c483a7">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10],[264783846,742253299,481231186,126214081,572187700,183354659,100809883,325988686,630624868,970172043],["10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190","10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190"],["10,30,50,70,84,100,110,130,150,170,180","20,30,50,60,80,100,120,140,150,170,188","20,40,50,60,80,100,110,130,150,170,180","3,7,10,14,17,20,24,27,30,33,37,40,44,47,50,53,57,60,65,70,73,77,80,84,87,90,93,97,100,104,107,110,114,117,120,123,126,130,135,140,143,147,150,153,157,160,164,167,170,174,177,180,184,187,190,194,197","10,30,50,70,80,100,110,130,150,170,190","20,40,50,70,90,100,110,130,150,170,180","4,7,10,15,20,23,26,30,35,40,43,46,50,53,57,60,63,66,70,73,76,80,83,87,90,93,96,100,103,107,110,115,120,123,126,130,134,137,140,143,147,150,153,156,160,163,167,170,175,180,183,186,190,194,197","3,7,10,13,16,20,23,26,30,35,40,44,47,50,53,56,60,64,67,70,74,77,80,83,86,90,93,96,100,104,107,110,114,117,120,124,129,133,137,140,144,147,150,154,157,160,163,167,170,175,180,184,187,190,194,197","5,10,14,17,20,24,27,30,33,36,40,43,46,50,53,57,60,63,66,70,74,77,80,83,87,90,93,96,100,104,107,110,113,116,120,123,126,130,133,137,140,144,147,150,155,160,163,166,170,173,176,180,183,187,190,193,197","3,7,10,13,17,20,23,27,30,33,36,40,45,50,55,60,63,67,70,73,77,80,83,86,90,93,96,100,104,107,110,114,119,122,125,130,133,137,140,143,146,150,154,157,160,163,166,170,175,180,183,187,190,193,197"],["50,99,149","50,101,152","49,100,151","51,101,150,174","48,99,150","49,100,152","50,100,151","49,99,150","49,101,153","49,102,153"],[1,1,1,1,1,1,1,1,1,1],[0.5384615384615384,0.5384615384615384,0.5384615384615384,0.6428571428571429,0.5384615384615384,0.5384615384615384,0.5925925925925926,0.5384615384615384,0.4799999999999999,0.4799999999999999],[10,10,10,7,10,10,7,7,7,7],[41,40,39,41,40,39,40,40,39,39],[0.9588,0.9592000000000001,0.96,0.9678,0.96,0.96,0.9686,0.96785,0.9678,0.9684],[0.79815,0.79735,0.7981,0.82695,0.79735,0.79725,0.79905,0.79815,0.79565,0.7949000000000001],[8,8,8,38,8,8,36,37,38,36],[16,16,16,15,16,16,16,16,16,16],[1.740000000000009,1.779999999999973,2.009999999999991,1.909999999999854,2.289999999999964,1.860000000000127,1.939999999999827,1.620000000000118,1.990000000000009,1.919999999999845],[65.31999999999994,66.6099999999999,68.56999999999994,65.53999999999996,67.98000000000002,67.86000000000013,61.36999999999989,60.62000000000012,62.04999999999995,63.75000000000023]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>trial<\/th>\n      <th>seed<\/th>\n      <th>true_cp<\/th>\n      <th>abs_cp<\/th>\n      <th>per_cp<\/th>\n      <th>abs_f1<\/th>\n      <th>per_f1<\/th>\n      <th>abs_haus<\/th>\n      <th>per_haus<\/th>\n      <th>abs_rand<\/th>\n      <th>per_rand<\/th>\n      <th>abs_ann<\/th>\n      <th>per_ann<\/th>\n      <th>abs_time<\/th>\n      <th>per_time<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[0,1,5,6,7,8,9,10,11,12,13,14]},{"name":"trial","targets":0},{"name":"seed","targets":1},{"name":"true_cp","targets":2},{"name":"abs_cp","targets":3},{"name":"per_cp","targets":4},{"name":"abs_f1","targets":5},{"name":"per_f1","targets":6},{"name":"abs_haus","targets":7},{"name":"per_haus","targets":8},{"name":"abs_rand","targets":9},{"name":"per_rand","targets":10},{"name":"abs_ann","targets":11},{"name":"per_ann","targets":12},{"name":"abs_time","targets":13},{"name":"per_time","targets":14}],"order":[],"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>判断beta</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span> (<span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">500</span>,</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>,<span class="dv">60</span>,<span class="dv">70</span>,<span class="dv">80</span>,<span class="dv">90</span>,<span class="dv">100</span>,<span class="dv">110</span>,<span class="dv">120</span>,<span class="dv">130</span>,<span class="dv">140</span>,<span class="dv">150</span>,<span class="dv">160</span>,<span class="dv">170</span>,<span class="dv">180</span>,<span class="dv">190</span>),</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rho =</span> <span class="fl">0.6</span>,              <span class="co"># 每次跳变的受影响比例</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">delta =</span> <span class="fl">1.0</span>,            <span class="co"># 单次跳变幅度（同号）</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma =</span> <span class="fl">1.0</span>,            <span class="co"># 噪声标准差</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ar_phi =</span> <span class="fl">0.0</span>,           <span class="co"># AR(1) 噪声相关，0 表示独立</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">same_sign =</span> <span class="cn">TRUE</span>,       <span class="co"># TRUE：所有受影响维同号上升</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seed =</span> <span class="cn">NULL</span>)</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(sim<span class="sc">$</span>Y,<span class="at">beta_min =</span> <span class="dv">10</span>, </span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_max =</span> <span class="dv">50</span>, </span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size=</span><span class="dv">2</span>, </span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">p=</span><span class="dv">2</span>, </span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">elbow_window=</span><span class="dv">10</span>,</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><br>
</p>
</section>
</section>
<section id="func-逐维cpt-vs-高维" class="level2">
<h2 class="anchored" data-anchor-id="func-逐维cpt-vs-高维">func: 逐维（Cpt） vs 高维</h2>
<section id="跑可视化-1" class="level3">
<h3 class="anchored" data-anchor-id="跑可视化-1">(跑可视化)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="do">## A) 逐维法（使用现成包 changepoint 的 cpt.mean）</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="do">##    - method: "PELT"（默认，推荐）或 "BinSeg" / "SegNeigh"</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="do">##    - penalty: "MBIC"（默认）/ "BIC" / "AIC" / "Manual" 等</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="do">##    - min_size: 映射到 cpt.mean 的 minseglen</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="do">##    - Q: 仅对 BinSeg/SegNeigh 有意义（最大变点数）</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>per_dim_pkg_detect <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tol =</span> <span class="dv">3</span>L,</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>                               <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>,<span class="st">"median"</span>),</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">"PELT"</span>,</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">penalty =</span> <span class="st">"MBIC"</span>,</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">pen_value =</span> <span class="cn">NULL</span>,   <span class="co"># penalty="Manual" 时可用</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">min_size =</span> <span class="dv">2</span>,</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Q =</span> <span class="cn">NULL</span>,           <span class="co"># BinSeg/SegNeigh 的最大变点数</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"changepoint"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"需要安装 R 包 'changepoint'：install.packages('changepoint')"</span>)</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>  dim_cps <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, d)</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Y[, j])</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>    res_j <span class="ot">&lt;-</span> <span class="fu">try</span>({</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (method <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"BinSeg"</span>, <span class="st">"SegNeigh"</span>)) {</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 这两种方法需要 Q；若为空给个保守上限</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>        Q_eff <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(Q)) <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">floor</span>(<span class="fu">nrow</span>(Y) <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> min_size))) <span class="cf">else</span> <span class="fu">as.integer</span>(Q)</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>        changepoint<span class="sc">::</span><span class="fu">cpt.mean</span>(y, <span class="at">method =</span> method, <span class="at">penalty =</span> penalty, <span class="at">pen.value =</span> pen_value,</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Q =</span> Q_eff, <span class="at">minseglen =</span> min_size, <span class="at">class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PELT（推荐，自动选点数）</span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>        changepoint<span class="sc">::</span><span class="fu">cpt.mean</span>(y, <span class="at">method =</span> method, <span class="at">penalty =</span> penalty, <span class="at">pen.value =</span> pen_value,</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>                              <span class="at">minseglen =</span> min_size, <span class="at">class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(res_j, <span class="st">"try-error"</span>)) {</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[pkg] 维度 %d 出错，跳过该维。"</span>, j))</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>      dim_cps[[j]] <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="dv">0</span>)</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>    cp <span class="ot">&lt;-</span> <span class="fu">try</span>(changepoint<span class="sc">::</span><span class="fu">cpts</span>(res_j), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(cp, <span class="st">"try-error"</span>)) {</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>      dim_cps[[j]] <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="dv">0</span>)</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>      <span class="co"># cpts() 通常包含 n，去掉 n 这个终点</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>      cp <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cp)</span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>      cp <span class="ot">&lt;-</span> cp[cp <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> cp <span class="sc">&lt;</span> <span class="fu">length</span>(y)]</span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>      dim_cps[[j]] <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(cp))</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose) <span class="sc">&amp;&amp;</span> (j <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[pkg] finished %d/%d"</span>, j, d))</span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>  merged <span class="ot">&lt;-</span> <span class="fu">merge_cps</span>(dim_cps, <span class="at">tol =</span> tol, <span class="at">representative =</span> representative)</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">merged_cp =</span> <span class="fu">sort</span>(merged), <span class="at">per_dim_cp =</span> dim_cps)</span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a><span class="do">## B) 单次实验（ABS vs 包法逐维）</span></span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a><span class="do">##    复用你已定义的：</span></span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a><span class="do">##    - adaptive_binary_segmentation()</span></span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a><span class="do">##    - f1_score / hausdorff / rand_index / annotation_error</span></span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a><span class="do">##    - simulate_dense()</span></span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a>run_one_trial_pkg <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>,</span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>                              <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a>                              <span class="at">min_size =</span> <span class="dv">5</span>,                <span class="co"># ABS 与包法都用这个 minseglen</span></span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a>                              <span class="at">tol_match =</span> <span class="dv">3</span>L,              <span class="co"># 合并与评测容忍（可拆分为 merge_tol/eval_tol）</span></span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># ABS 参数</span></span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>                              <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a>                              <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># 包法参数</span></span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a>                              <span class="at">method =</span> <span class="st">"PELT"</span>,</span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a>                              <span class="at">penalty =</span> <span class="st">"MBIC"</span>,</span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a>                              <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a>                              <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a>                              <span class="at">seed =</span> <span class="cn">NULL</span>,</span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a>                              <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span>(n, d, cps, rho, delta, sigma, ar_phi, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS（你的方法）</span></span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a>  t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true" tabindex="-1"></a>    abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true" tabindex="-1"></a>      Y,</span>
<span id="cb75-93"><a href="#cb75-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb75-94"><a href="#cb75-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> verbose</span>
<span id="cb75-95"><a href="#cb75-95" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-96"><a href="#cb75-96" aria-hidden="true" tabindex="-1"></a>    idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb75-97"><a href="#cb75-97" aria-hidden="true" tabindex="-1"></a>    cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb75-98"><a href="#cb75-98" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb75-99"><a href="#cb75-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-100"><a href="#cb75-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 逐维（包）：changepoint::cpt.mean</span></span>
<span id="cb75-101"><a href="#cb75-101" aria-hidden="true" tabindex="-1"></a>  t_pkg <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb75-102"><a href="#cb75-102" aria-hidden="true" tabindex="-1"></a>    pkg_res <span class="ot">&lt;-</span> <span class="fu">per_dim_pkg_detect</span>(</span>
<span id="cb75-103"><a href="#cb75-103" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">tol =</span> tol_match, <span class="at">representative =</span> representative,</span>
<span id="cb75-104"><a href="#cb75-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> method, <span class="at">penalty =</span> penalty, <span class="at">pen_value =</span> pen_value,</span>
<span id="cb75-105"><a href="#cb75-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">Q =</span> Q, <span class="at">verbose =</span> verbose</span>
<span id="cb75-106"><a href="#cb75-106" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-107"><a href="#cb75-107" aria-hidden="true" tabindex="-1"></a>    cp_pkg <span class="ot">&lt;-</span> pkg_res<span class="sc">$</span>merged_cp</span>
<span id="cb75-108"><a href="#cb75-108" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb75-109"><a href="#cb75-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-110"><a href="#cb75-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 指标</span></span>
<span id="cb75-111"><a href="#cb75-111" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> tol_match)</span>
<span id="cb75-112"><a href="#cb75-112" aria-hidden="true" tabindex="-1"></a>  pkg_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_pkg, <span class="at">tol =</span> tol_match)</span>
<span id="cb75-113"><a href="#cb75-113" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb75-114"><a href="#cb75-114" aria-hidden="true" tabindex="-1"></a>  pkg_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_pkg)</span>
<span id="cb75-115"><a href="#cb75-115" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> n)</span>
<span id="cb75-116"><a href="#cb75-116" aria-hidden="true" tabindex="-1"></a>  pkg_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_pkg, <span class="at">n =</span> n)</span>
<span id="cb75-117"><a href="#cb75-117" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb75-118"><a href="#cb75-118" aria-hidden="true" tabindex="-1"></a>  pkg_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_pkg)</span>
<span id="cb75-119"><a href="#cb75-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-120"><a href="#cb75-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb75-121"><a href="#cb75-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp =</span> true_cp,</span>
<span id="cb75-122"><a href="#cb75-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_abs,</span>
<span id="cb75-123"><a href="#cb75-123" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> abs_f1, <span class="at">haus =</span> abs_haus, <span class="at">rand =</span> abs_rand, <span class="at">ann =</span> abs_ann,</span>
<span id="cb75-124"><a href="#cb75-124" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])),</span>
<span id="cb75-125"><a href="#cb75-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_pkg,</span>
<span id="cb75-126"><a href="#cb75-126" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> pkg_f1, <span class="at">haus =</span> pkg_haus, <span class="at">rand =</span> pkg_rand, <span class="at">ann =</span> pkg_ann,</span>
<span id="cb75-127"><a href="#cb75-127" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_pkg[<span class="st">"elapsed"</span>]))</span>
<span id="cb75-128"><a href="#cb75-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-129"><a href="#cb75-129" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-130"><a href="#cb75-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-131"><a href="#cb75-131" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb75-132"><a href="#cb75-132" aria-hidden="true" tabindex="-1"></a><span class="do">## C) 逐次观察（1–10 次）：ABS vs 包法逐维</span></span>
<span id="cb75-133"><a href="#cb75-133" aria-hidden="true" tabindex="-1"></a><span class="do">##    打印每次真/检变点与指标；导出 CSV（可选）</span></span>
<span id="cb75-134"><a href="#cb75-134" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb75-135"><a href="#cb75-135" aria-hidden="true" tabindex="-1"></a>observe_trials_pkg <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">5</span>,</span>
<span id="cb75-136"><a href="#cb75-136" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seeds =</span> <span class="cn">NULL</span>,</span>
<span id="cb75-137"><a href="#cb75-137" aria-hidden="true" tabindex="-1"></a>                               <span class="at">export_csv =</span> <span class="cn">NULL</span>,</span>
<span id="cb75-138"><a href="#cb75-138" aria-hidden="true" tabindex="-1"></a>                               <span class="at">print_each =</span> <span class="cn">TRUE</span>,</span>
<span id="cb75-139"><a href="#cb75-139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb75-140"><a href="#cb75-140" aria-hidden="true" tabindex="-1"></a>                               ...) {</span>
<span id="cb75-141"><a href="#cb75-141" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(R)</span>
<span id="cb75-142"><a href="#cb75-142" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (R <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">||</span> R <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="fu">stop</span>(<span class="st">"R 必须在 1~10 之间。"</span>)</span>
<span id="cb75-143"><a href="#cb75-143" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(seeds)) {</span>
<span id="cb75-144"><a href="#cb75-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">20250911</span>)</span>
<span id="cb75-145"><a href="#cb75-145" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, R)</span>
<span id="cb75-146"><a href="#cb75-146" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb75-147"><a href="#cb75-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(seeds) <span class="sc">&lt;</span> R) <span class="fu">stop</span>(<span class="st">"提供的 seeds 数量不足 R。"</span>)</span>
<span id="cb75-148"><a href="#cb75-148" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(seeds[<span class="fu">seq_len</span>(R)])</span>
<span id="cb75-149"><a href="#cb75-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-150"><a href="#cb75-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-151"><a href="#cb75-151" aria-hidden="true" tabindex="-1"></a>  base_args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb75-152"><a href="#cb75-152" aria-hidden="true" tabindex="-1"></a>  vec_to_str <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { x <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(x); <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">0</span>) <span class="st">"∅"</span> <span class="cf">else</span> <span class="fu">paste</span>(x, <span class="at">collapse =</span> <span class="st">","</span>) }</span>
<span id="cb75-153"><a href="#cb75-153" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb75-154"><a href="#cb75-154" aria-hidden="true" tabindex="-1"></a>  digits  <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(digits)</span>
<span id="cb75-155"><a href="#cb75-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-156"><a href="#cb75-156" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb75-157"><a href="#cb75-157" aria-hidden="true" tabindex="-1"></a>    args_i <span class="ot">&lt;-</span> base_args; args_i<span class="sc">$</span>seed <span class="ot">&lt;-</span> seeds[i]</span>
<span id="cb75-158"><a href="#cb75-158" aria-hidden="true" tabindex="-1"></a>    res_i <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">do.call</span>(run_one_trial_pkg, args_i), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-159"><a href="#cb75-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-160"><a href="#cb75-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(res_i, <span class="st">"try-error"</span>)) {</span>
<span id="cb75-161"><a href="#cb75-161" aria-hidden="true" tabindex="-1"></a>      results[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb75-162"><a href="#cb75-162" aria-hidden="true" tabindex="-1"></a>        <span class="at">true_cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb75-163"><a href="#cb75-163" aria-hidden="true" tabindex="-1"></a>        <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb75-164"><a href="#cb75-164" aria-hidden="true" tabindex="-1"></a>        <span class="at">pkg =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb75-165"><a href="#cb75-165" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="fu">as.character</span>(res_i)</span>
<span id="cb75-166"><a href="#cb75-166" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb75-167"><a href="#cb75-167" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb75-168"><a href="#cb75-168" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb75-169"><a href="#cb75-169" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"发生错误："</span>, results[[i]]<span class="sc">$</span>error, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb75-170"><a href="#cb75-170" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb75-171"><a href="#cb75-171" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb75-172"><a href="#cb75-172" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-173"><a href="#cb75-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-174"><a href="#cb75-174" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> res_i</span>
<span id="cb75-175"><a href="#cb75-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-176"><a href="#cb75-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb75-177"><a href="#cb75-177" aria-hidden="true" tabindex="-1"></a>      haus_abs <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb75-178"><a href="#cb75-178" aria-hidden="true" tabindex="-1"></a>      haus_pkg <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>pkg<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb75-179"><a href="#cb75-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-180"><a href="#cb75-180" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb75-181"><a href="#cb75-181" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"True CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>true_cp), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb75-182"><a href="#cb75-182" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"ABS  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb75-183"><a href="#cb75-183" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"PKG  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>pkg<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb75-184"><a href="#cb75-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-185"><a href="#cb75-185" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ABS  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb75-186"><a href="#cb75-186" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>f1, haus_abs, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>rand, res_i<span class="sc">$</span>abs<span class="sc">$</span>ann, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>time))</span>
<span id="cb75-187"><a href="#cb75-187" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"PKG  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb75-188"><a href="#cb75-188" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>f1, haus_pkg, digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>rand, res_i<span class="sc">$</span>pkg<span class="sc">$</span>ann, digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>time))</span>
<span id="cb75-189"><a href="#cb75-189" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-190"><a href="#cb75-190" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-191"><a href="#cb75-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-192"><a href="#cb75-192" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb75-193"><a href="#cb75-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial    =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb75-194"><a href="#cb75-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed     =</span> seeds,</span>
<span id="cb75-195"><a href="#cb75-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>true_cp), <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb75-196"><a href="#cb75-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>abs<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb75-197"><a href="#cb75-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>pkg<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb75-198"><a href="#cb75-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-199"><a href="#cb75-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-200"><a href="#cb75-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-201"><a href="#cb75-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-202"><a href="#cb75-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-203"><a href="#cb75-203" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-204"><a href="#cb75-204" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb75-205"><a href="#cb75-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb75-206"><a href="#cb75-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-207"><a href="#cb75-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb75-208"><a href="#cb75-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb75-209"><a href="#cb75-209" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-210"><a href="#cb75-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-211"><a href="#cb75-211" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(export_csv)) {</span>
<span id="cb75-212"><a href="#cb75-212" aria-hidden="true" tabindex="-1"></a>    utils<span class="sc">::</span><span class="fu">write.csv</span>(df, <span class="at">file =</span> export_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb75-213"><a href="#cb75-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"已导出 CSV: %s"</span>, <span class="fu">normalizePath</span>(export_csv, <span class="at">winslash =</span> <span class="st">"/"</span>)))</span>
<span id="cb75-214"><a href="#cb75-214" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-215"><a href="#cb75-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-216"><a href="#cb75-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(<span class="at">table =</span> df, <span class="at">trials =</span> results))</span>
<span id="cb75-217"><a href="#cb75-217" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>应用</p>
<ul>
<li>逐维法使用现成包 changepoint 的 cpt.mean</li>
</ul>
<p>n = 200, d = 5, cps = c(60,120,160), rho = 0.7</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>obs_pkg <span class="ot">&lt;-</span> <span class="fu">observe_trials_pkg</span>(</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a> <span class="co"># seeds = NULL, #  控制每次试验用的随机数种子</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">5</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 包法（changepoint）</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"PELT"</span>,          <span class="co"># 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="st">"MBIC"</span>,         <span class="co"># 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">representative =</span> <span class="st">"median"</span>, <span class="co"># 建议中位数更鲁棒</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Trial 1 (seed=264783846) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 8,61,133
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=2.82000
PKG  | F1=0.33333  Haus=52.00000  Rand=0.86375  Ann=0  Time=0.68000

--- Trial 2 (seed=742253299) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 16,120
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=2.26000
PKG  | F1=0.40000  Haus=44.00000  Rand=0.75280  Ann=1  Time=0.52000

--- Trial 3 (seed=481231186) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 120
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.99000
PKG  | F1=0.50000  Haus=60.00000  Rand=0.74000  Ann=2  Time=0.34000

--- Trial 4 (seed=126214081) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 9,35,60,136
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.59000
PKG  | F1=0.28571  Haus=51.00000  Rand=0.82935  Ann=1  Time=0.26000

--- Trial 5 (seed=572187700) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 40,120
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.51000
PKG  | F1=0.40000  Haus=40.00000  Rand=0.82000  Ann=1  Time=0.35000

--- Trial 6 (seed=183354659) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 120
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.78000
PKG  | F1=0.50000  Haus=60.00000  Rand=0.74000  Ann=2  Time=0.36000

--- Trial 7 (seed=100809883) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 16,120
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.56000
PKG  | F1=0.40000  Haus=44.00000  Rand=0.75280  Ann=1  Time=0.26000

--- Trial 8 (seed=325988686) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 11,119,186
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.50000
PKG  | F1=0.33333  Haus=49.00000  Rand=0.75205  Ann=0  Time=0.21000

--- Trial 9 (seed=630624868) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 22,119
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.67000
PKG  | F1=0.40000  Haus=41.00000  Rand=0.75915  Ann=1  Time=0.31000

--- Trial 10 (seed=970172043) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 23,60,136
ABS  | F1=1.00000  Haus=0.00000  Rand=1.00000  Ann=0  Time=1.71000
PKG  | F1=0.33333  Haus=37.00000  Rand=0.84225  Ann=0  Time=0.31000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$table</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">datatable</span>(</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    obs_pkg<span class="sc">$</span>table,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-0355ca808d8e28a7ed3f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-0355ca808d8e28a7ed3f">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10],[264783846,742253299,481231186,126214081,572187700,183354659,100809883,325988686,630624868,970172043],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160"],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160"],["8,61,133","16,120","120","9,35,60,136","40,120","120","16,120","11,119,186","22,119","23,60,136"],[1,1,1,1,1,1,1,1,1,1],[0.3333333333333333,0.4,0.5,0.2857142857142858,0.4,0.5,0.4,0.3333333333333333,0.4,0.3333333333333333],[0,0,0,0,0,0,0,0,0,0],[52,44,60,51,40,60,44,49,41,37],[1,1,1,1,1,1,1,1,1,1],[0.86375,0.7528,0.74,0.82935,0.82,0.74,0.7528,0.75205,0.75915,0.8422500000000001],[0,0,0,0,0,0,0,0,0,0],[0,1,2,1,1,2,1,0,1,0],[2.820000000000164,2.259999999999764,1.989999999999782,1.590000000000146,1.509999999999764,1.7800000000002,1.559999999999945,1.5,1.670000000000073,1.710000000000036],[0.680000000000291,0.5199999999999818,0.3400000000001455,0.2600000000002183,0.3499999999999091,0.3600000000001273,0.2600000000002183,0.2100000000000364,0.3099999999999454,0.3099999999999454]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>trial<\/th>\n      <th>seed<\/th>\n      <th>true_cp<\/th>\n      <th>abs_cp<\/th>\n      <th>pkg_cp<\/th>\n      <th>abs_f1<\/th>\n      <th>pkg_f1<\/th>\n      <th>abs_haus<\/th>\n      <th>pkg_haus<\/th>\n      <th>abs_rand<\/th>\n      <th>pkg_rand<\/th>\n      <th>abs_ann<\/th>\n      <th>pkg_ann<\/th>\n      <th>abs_time<\/th>\n      <th>pkg_time<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[0,1,5,6,7,8,9,10,11,12,13,14]},{"name":"trial","targets":0},{"name":"seed","targets":1},{"name":"true_cp","targets":2},{"name":"abs_cp","targets":3},{"name":"pkg_cp","targets":4},{"name":"abs_f1","targets":5},{"name":"pkg_f1","targets":6},{"name":"abs_haus","targets":7},{"name":"pkg_haus","targets":8},{"name":"abs_rand","targets":9},{"name":"pkg_rand","targets":10},{"name":"abs_ann","targets":11},{"name":"pkg_ann","targets":12},{"name":"abs_time","targets":13},{"name":"pkg_time","targets":14}],"order":[],"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 第 i 次的原始向量：</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$trials[[i]]$true_cp</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$trials[[i]]$abs$cp</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$trials[[i]]$pkg$cp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>n = 200, d = 200, cps = c(60,120,160), rho = 0.7</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>obs_pkg <span class="ot">&lt;-</span> <span class="fu">observe_trials_pkg</span>(</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">54</span>,<span class="dv">2575</span>,<span class="dv">367</span>,<span class="dv">3859</span>,<span class="dv">28585</span>,<span class="dv">2895</span>,<span class="dv">278485</span>,<span class="dv">278</span>,<span class="dv">3748</span>), <span class="co">#  控制每次试验用的随机数种子</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">200</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 包法（changepoint）</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"PELT"</span>,          <span class="co"># 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="st">"MBIC"</span>,         <span class="co"># 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">representative =</span> <span class="st">"median"</span>, <span class="co"># 建议中位数更鲁棒</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Trial 1 (seed=3) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 60,130,185
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.72000000000025465851649641990661621093750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.66666666666666662965923251249478198587894439697265625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=25.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.89875000000000004884981308350688777863979339599609375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=0.33999999999969077180139720439910888671875000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 2 (seed=54) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 10,60,94,130
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.94000000000005456968210637569427490234375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.57142857142857150787307318751118145883083343505859375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=50.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.84279999999999999360511537815909832715988159179687500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=1  Time=0.36000000000012732925824820995330810546875000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 3 (seed=2575) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 60,148
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.75000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.40000000000000002220446049250313080847263336181640625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=28.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.87519999999999997797317519143689423799514770507812500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=1  Time=0.46999999999979991116560995578765869140625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 4 (seed=367) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 27,120
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.76999999999998181010596454143524169921875000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.40000000000000002220446049250313080847263336181640625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=40.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.77644999999999997353228309293626807630062103271484375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=1  Time=0.50999999999976353137753903865814208984375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 5 (seed=3859) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 60,146
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.84000000000014551915228366851806640625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.40000000000000002220446049250313080847263336181640625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=26.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.87580000000000002291500322826323099434375762939453125000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=1  Time=0.32999999999992724042385816574096679687500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 6 (seed=28585) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 10,60,96,141,187
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.71999999999979991116560995578765869140625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.25000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=50.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.84345000000000003304023721284465864300727844238281250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=2  Time=0.34999999999990905052982270717620849609375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 7 (seed=2895) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 10,60,133,194
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.89000000000032741809263825416564941406250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.28571428571428575393653659375559072941541671752929687500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=50.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.86234999999999994990673712891293689608573913574218750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=1  Time=0.41999999999961801222525537014007568359375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 8 (seed=278485) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 5,60,136,189
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.59000000000014551915228366851806640625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.28571428571428575393653659375559072941541671752929687500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=55.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.86829999999999996074251384925446473062038421630859375000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=1  Time=0.43000000000029103830456733703613281250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 9 (seed=278) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 60,99,138
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.80999999999994543031789362430572509765625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.33333333333333331482961625624739099293947219848632812500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=22.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.87634999999999996234123500471469014883041381835937500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=0.63999999999987267074175179004669189453125000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--- Trial 10 (seed=3748) ---
True CP : 60,120,160
ABS  CP : 60,120,160
PKG  CP : 23,120,180
ABS  | F1=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=1.77999999999974534148350358009338378906250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
PKG  | F1=0.33333333333333331482961625624739099293947219848632812500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Haus=37.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Rand=0.78644999999999998241406728993752039968967437744140625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000  Ann=0  Time=0.42000000000007275957614183425903320312500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$table</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">datatable</span>(</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    obs_pkg<span class="sc">$</span>table,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-a16edff94e1131e2861f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a16edff94e1131e2861f">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10],[3,54,2575,367,3859,28585,2895,278485,278,3748],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160"],["60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160","60,120,160"],["60,130,185","10,60,94,130","60,148","27,120","60,146","10,60,96,141,187","10,60,133,194","5,60,136,189","60,99,138","23,120,180"],[1,1,1,1,1,1,1,1,1,1],[0.6666666666666666,0.5714285714285715,0.4,0.4,0.4,0.25,0.2857142857142858,0.2857142857142858,0.3333333333333333,0.3333333333333333],[0,0,0,0,0,0,0,0,0,0],[25,50,28,40,26,50,50,55,22,37],[1,1,1,1,1,1,1,1,1,1],[0.89875,0.8428,0.8752,0.77645,0.8758,0.84345,0.8623499999999999,0.8683,0.87635,0.78645],[0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,2,1,1,0,0],[1.720000000000255,1.940000000000055,1.75,1.769999999999982,1.840000000000146,1.7199999999998,1.890000000000327,1.590000000000146,1.809999999999945,1.779999999999745],[0.3399999999996908,0.3600000000001273,0.4699999999997999,0.5099999999997635,0.3299999999999272,0.3499999999999091,0.419999999999618,0.430000000000291,0.6399999999998727,0.4200000000000728]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>trial<\/th>\n      <th>seed<\/th>\n      <th>true_cp<\/th>\n      <th>abs_cp<\/th>\n      <th>pkg_cp<\/th>\n      <th>abs_f1<\/th>\n      <th>pkg_f1<\/th>\n      <th>abs_haus<\/th>\n      <th>pkg_haus<\/th>\n      <th>abs_rand<\/th>\n      <th>pkg_rand<\/th>\n      <th>abs_ann<\/th>\n      <th>pkg_ann<\/th>\n      <th>abs_time<\/th>\n      <th>pkg_time<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[0,1,5,6,7,8,9,10,11,12,13,14]},{"name":"trial","targets":0},{"name":"seed","targets":1},{"name":"true_cp","targets":2},{"name":"abs_cp","targets":3},{"name":"pkg_cp","targets":4},{"name":"abs_f1","targets":5},{"name":"pkg_f1","targets":6},{"name":"abs_haus","targets":7},{"name":"pkg_haus","targets":8},{"name":"abs_rand","targets":9},{"name":"pkg_rand","targets":10},{"name":"abs_ann","targets":11},{"name":"pkg_ann","targets":12},{"name":"abs_time","targets":13},{"name":"pkg_time","targets":14}],"order":[],"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
</section>
<section id="稀疏模式" class="level1">
<h1>稀疏模式</h1>
<p>n = 200, d = 10, cps = c(60,120,160), rho = 0.1(稀疏)</p>
<p>p=2</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>obs_pkg <span class="ot">&lt;-</span> <span class="fu">observe_trials_pkg</span>(</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">54</span>,<span class="dv">2575</span>,<span class="dv">367</span>,<span class="dv">3859</span>,<span class="dv">28585</span>,<span class="dv">2895</span>,<span class="dv">278485</span>,<span class="dv">278</span>,<span class="dv">3748</span>), <span class="co">#  控制每次试验用的随机数种子</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.1</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 包法（changepoint）</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"PELT"</span>,          <span class="co"># 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="st">"MBIC"</span>,         <span class="co"># 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">representative =</span> <span class="st">"median"</span>, <span class="co"># 建议中位数更鲁棒</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>obs_pkg<span class="sc">$</span>table</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>n = 200, d = 10, cps = c(60,120,160), rho = 0.1(稀疏)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>obs_pkg <span class="ot">&lt;-</span> <span class="fu">observe_trials_pkg</span>(</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">54</span>,<span class="dv">2575</span>,<span class="dv">367</span>,<span class="dv">3859</span>,<span class="dv">28585</span>,<span class="dv">2895</span>,<span class="dv">278485</span>,<span class="dv">278</span>,<span class="dv">3748</span>), <span class="co">#  控制每次试验用的随机数种子</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.1</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">20</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="st">"inf"</span>,</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 包法（changepoint）</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"PELT"</span>,          <span class="co"># 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="st">"MBIC"</span>,         <span class="co"># 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">representative =</span> <span class="st">"median"</span>, <span class="co"># 建议中位数更鲁棒</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>obs_pkg<span class="sc">$</span>table</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="table" class="level1">
<h1>Table</h1>
<p>所有前置函数：abs，per_abs，仿真数据，评价函数</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 0) 工具与可重复性</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 内部加速工具（不改变对外 API）</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 说明：</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="do">## - 通过一次性构建按行的列累积和 (cumsums) 来将任意区间均值计算从 O(k) 降到 O(1)</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="do">## - 所有优化均以隐式属性附着在 Y 上（attr(Y, "._csum")），</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   若缺失则在首次调用时自动构建；对外函数名、参数与用法保持不变</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>.ensure_cumsum <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cs)) {</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>    cs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(Y)), <span class="fu">apply</span>(Y, <span class="dv">2</span>, cumsum))</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>) <span class="ot">&lt;-</span> cs</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>  Y</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>.segment_means_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(cs, t_left, t_mid, t_right) {</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cs 的行索引与时间点对齐：第 0 个时间点位于行 1</span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 区间 (t_left+1):t_mid 与 (t_mid+1):t_right</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>  sum1 <span class="ot">&lt;-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_left <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>  sum2 <span class="ot">&lt;-</span> cs[t_right <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> sum1 <span class="sc">/</span> n1</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> sum2 <span class="sc">/</span> n2</span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">mean1 =</span> mean1, <span class="at">mean2 =</span> mean2, <span class="at">n1 =</span> n1, <span class="at">n2 =</span> n2)</span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 代价函数 &amp; 二元分割（保持 API，不改变名称/参数）</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 尝试使用累计和加速；若不可用则回退到原始实现</span></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cs)) {</span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>    seg <span class="ot">&lt;-</span> <span class="fu">.segment_means_fast</span>(cs, t_left, t_mid, t_right)</span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>    n1 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n1; n2 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n2; n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(seg<span class="sc">$</span>mean2 <span class="sc">-</span> seg<span class="sc">$</span>mean1)</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-50"><a href="#cb85-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weight <span class="sc">*</span> norm_p)</span>
<span id="cb85-51"><a href="#cb85-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-52"><a href="#cb85-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 回退路径（仅在未预先构建 cumsum 时触发）</span></span>
<span id="cb85-53"><a href="#cb85-53" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb85-54"><a href="#cb85-54" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb85-55"><a href="#cb85-55" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb85-56"><a href="#cb85-56" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb85-57"><a href="#cb85-57" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb85-58"><a href="#cb85-58" aria-hidden="true" tabindex="-1"></a>  diff  <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb85-59"><a href="#cb85-59" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb85-60"><a href="#cb85-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb85-61"><a href="#cb85-61" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb85-62"><a href="#cb85-62" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb85-63"><a href="#cb85-63" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb85-64"><a href="#cb85-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-65"><a href="#cb85-65" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">*</span> norm_p</span>
<span id="cb85-66"><a href="#cb85-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-67"><a href="#cb85-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-68"><a href="#cb85-68" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb85-69"><a href="#cb85-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 确保累计和已存在（若无则自动构建）</span></span>
<span id="cb85-70"><a href="#cb85-70" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb85-71"><a href="#cb85-71" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb85-72"><a href="#cb85-72" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb85-73"><a href="#cb85-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">*</span> min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb85-74"><a href="#cb85-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb85-75"><a href="#cb85-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-76"><a href="#cb85-76" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb85-77"><a href="#cb85-77" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb85-78"><a href="#cb85-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用累计和的 compute_cost，按扫描区间求最大增益</span></span>
<span id="cb85-79"><a href="#cb85-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb85-80"><a href="#cb85-80" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb85-81"><a href="#cb85-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb85-82"><a href="#cb85-82" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain; best_t <span class="ot">&lt;-</span> t</span>
<span id="cb85-83"><a href="#cb85-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-84"><a href="#cb85-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-85"><a href="#cb85-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb85-86"><a href="#cb85-86" aria-hidden="true" tabindex="-1"></a>    left  <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb85-87"><a href="#cb85-87" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb85-88"><a href="#cb85-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb85-89"><a href="#cb85-89" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb85-90"><a href="#cb85-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb85-91"><a href="#cb85-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-92"><a href="#cb85-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-93"><a href="#cb85-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-94"><a href="#cb85-94" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-95"><a href="#cb85-95" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 稳定路径：手肘 + 平台 (Kneedle + plateau)</span></span>
<span id="cb85-96"><a href="#cb85-96" aria-hidden="true" tabindex="-1"></a><span class="do">##    （内部同样利用累计和以复用加速）</span></span>
<span id="cb85-97"><a href="#cb85-97" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-98"><a href="#cb85-98" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb85-99"><a href="#cb85-99" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>]); p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb85-100"><a href="#cb85-100" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb85-101"><a href="#cb85-101" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]); dy <span class="ot">&lt;-</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])</span>
<span id="cb85-102"><a href="#cb85-102" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb85-103"><a href="#cb85-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb85-104"><a href="#cb85-104" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb85-105"><a href="#cb85-105" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>(dy <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> dx <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span> denom</span>
<span id="cb85-106"><a href="#cb85-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-107"><a href="#cb85-107" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb85-108"><a href="#cb85-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx)</span>
<span id="cb85-109"><a href="#cb85-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-110"><a href="#cb85-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-111"><a href="#cb85-111" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb85-112"><a href="#cb85-112" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb85-113"><a href="#cb85-113" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb85-114"><a href="#cb85-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb85-115"><a href="#cb85-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i <span class="sc">-</span> <span class="dv">1</span>]) {</span>
<span id="cb85-116"><a href="#cb85-116" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb85-117"><a href="#cb85-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start, <span class="at">end =</span> i <span class="sc">-</span> <span class="dv">1</span>, <span class="at">value =</span> y[i <span class="sc">-</span> <span class="dv">1</span>], <span class="at">length =</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb85-118"><a href="#cb85-118" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb85-119"><a href="#cb85-119" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb85-120"><a href="#cb85-120" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-121"><a href="#cb85-121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-122"><a href="#cb85-122" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb85-123"><a href="#cb85-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start, <span class="at">end =</span> <span class="fu">length</span>(y), <span class="at">value =</span> y[<span class="fu">length</span>(y)], <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb85-124"><a href="#cb85-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb85-125"><a href="#cb85-125" aria-hidden="true" tabindex="-1"></a>  plateaus</span>
<span id="cb85-126"><a href="#cb85-126" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-127"><a href="#cb85-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-128"><a href="#cb85-128" aria-hidden="true" tabindex="-1"></a>adaptive_binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb85-129"><a href="#cb85-129" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb85-130"><a href="#cb85-130" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb85-131"><a href="#cb85-131" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb85-132"><a href="#cb85-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 预先构建累计和，加速所有后续成本评估</span></span>
<span id="cb85-133"><a href="#cb85-133" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb85-134"><a href="#cb85-134" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb85-135"><a href="#cb85-135" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb85-136"><a href="#cb85-136" aria-hidden="true" tabindex="-1"></a>  bp_counts <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb85-137"><a href="#cb85-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-138"><a href="#cb85-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb85-139"><a href="#cb85-139" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb85-140"><a href="#cb85-140" aria-hidden="true" tabindex="-1"></a>    t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, b, <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb85-141"><a href="#cb85-141" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb85-142"><a href="#cb85-142" aria-hidden="true" tabindex="-1"></a>    bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb85-143"><a href="#cb85-143" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-144"><a href="#cb85-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-145"><a href="#cb85-145" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb85-146"><a href="#cb85-146" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb85-147"><a href="#cb85-147" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb85-148"><a href="#cb85-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-149"><a href="#cb85-149" aria-hidden="true" tabindex="-1"></a>  left_bound <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb85-150"><a href="#cb85-150" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb85-151"><a href="#cb85-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-152"><a href="#cb85-152" aria-hidden="true" tabindex="-1"></a>  best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb85-153"><a href="#cb85-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb85-154"><a href="#cb85-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound) <span class="sc">&amp;&amp;</span> (pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound)) {</span>
<span id="cb85-155"><a href="#cb85-155" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) best_plateau <span class="ot">&lt;-</span> pp</span>
<span id="cb85-156"><a href="#cb85-156" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-157"><a href="#cb85-157" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-158"><a href="#cb85-158" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb85-159"><a href="#cb85-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-160"><a href="#cb85-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) {</span>
<span id="cb85-161"><a href="#cb85-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span></span>
<span id="cb85-162"><a href="#cb85-162" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb85-163"><a href="#cb85-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb85-164"><a href="#cb85-164" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span></span>
<span id="cb85-165"><a href="#cb85-165" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>,</span>
<span id="cb85-166"><a href="#cb85-166" aria-hidden="true" tabindex="-1"></a>                  beta_list[pp<span class="sc">$</span>start], beta_list[pp<span class="sc">$</span>end], pp<span class="sc">$</span>length, pp<span class="sc">$</span>value))</span>
<span id="cb85-167"><a href="#cb85-167" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-168"><a href="#cb85-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span></span>
<span id="cb85-169"><a href="#cb85-169" aria-hidden="true" tabindex="-1"></a><span class="st">Elbow 候选 β = %.2f</span></span>
<span id="cb85-170"><a href="#cb85-170" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, el<span class="sc">$</span>beta))</span>
<span id="cb85-171"><a href="#cb85-171" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span></span>
<span id="cb85-172"><a href="#cb85-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-173"><a href="#cb85-173" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, best_beta))</span>
<span id="cb85-174"><a href="#cb85-174" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-175"><a href="#cb85-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-176"><a href="#cb85-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb85-177"><a href="#cb85-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_list =</span> beta_list,</span>
<span id="cb85-178"><a href="#cb85-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">bp_counts =</span> bp_counts,</span>
<span id="cb85-179"><a href="#cb85-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> results,</span>
<span id="cb85-180"><a href="#cb85-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">plateaus =</span> plateaus,</span>
<span id="cb85-181"><a href="#cb85-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb85-182"><a href="#cb85-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">best_beta =</span> best_beta</span>
<span id="cb85-183"><a href="#cb85-183" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb85-184"><a href="#cb85-184" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-185"><a href="#cb85-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-186"><a href="#cb85-186" aria-hidden="true" tabindex="-1"></a>plot_segmentation_path <span class="ot">&lt;-</span> <span class="cf">function</span>(res) {</span>
<span id="cb85-187"><a href="#cb85-187" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> res<span class="sc">$</span>beta_list; bp_counts <span class="ot">&lt;-</span> res<span class="sc">$</span>bp_counts</span>
<span id="cb85-188"><a href="#cb85-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb85-189"><a href="#cb85-189" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb85-190"><a href="#cb85-190" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb85-191"><a href="#cb85-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb85-192"><a href="#cb85-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>best_beta,  <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb85-193"><a href="#cb85-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb85-194"><a href="#cb85-194" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb85-195"><a href="#cb85-195" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-196"><a href="#cb85-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-197"><a href="#cb85-197" aria-hidden="true" tabindex="-1"></a><span class="co"># 记忆：我的abs算法</span></span>
<span id="cb85-198"><a href="#cb85-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-199"><a href="#cb85-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-200"><a href="#cb85-200" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb85-201"><a href="#cb85-201" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 逐维法：单维 BS + 合并</span></span>
<span id="cb85-202"><a href="#cb85-202" aria-hidden="true" tabindex="-1"></a><span class="do">##    ——并配套“稳定路径 Elbow+Plateau”自适应选 β（与 ABS 公平）</span></span>
<span id="cb85-203"><a href="#cb85-203" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb85-204"><a href="#cb85-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-205"><a href="#cb85-205" aria-hidden="true" tabindex="-1"></a><span class="co"># 把若干维度检出的变点合并：按 tol 聚簇，簇内取均值(四舍五入)为代表</span></span>
<span id="cb85-206"><a href="#cb85-206" aria-hidden="true" tabindex="-1"></a>merge_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(cplist, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>)) {</span>
<span id="cb85-207"><a href="#cb85-207" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb85-208"><a href="#cb85-208" aria-hidden="true" tabindex="-1"></a>  all <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.integer</span>(<span class="fu">unlist</span>(cplist)))</span>
<span id="cb85-209"><a href="#cb85-209" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(all) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb85-210"><a href="#cb85-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-211"><a href="#cb85-211" aria-hidden="true" tabindex="-1"></a>  clusters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb85-212"><a href="#cb85-212" aria-hidden="true" tabindex="-1"></a>  curr <span class="ot">&lt;-</span> <span class="fu">c</span>(all[<span class="dv">1</span>])</span>
<span id="cb85-213"><a href="#cb85-213" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x <span class="cf">in</span> all[<span class="sc">-</span><span class="dv">1</span>]) {</span>
<span id="cb85-214"><a href="#cb85-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">-</span> curr[<span class="fu">length</span>(curr)] <span class="sc">&lt;=</span> tol) {</span>
<span id="cb85-215"><a href="#cb85-215" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(curr, x)</span>
<span id="cb85-216"><a href="#cb85-216" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb85-217"><a href="#cb85-217" aria-hidden="true" tabindex="-1"></a>      clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb85-218"><a href="#cb85-218" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(x)</span>
<span id="cb85-219"><a href="#cb85-219" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-220"><a href="#cb85-220" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-221"><a href="#cb85-221" aria-hidden="true" tabindex="-1"></a>  clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb85-222"><a href="#cb85-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-223"><a href="#cb85-223" aria-hidden="true" tabindex="-1"></a>  rep_fun <span class="ot">&lt;-</span> <span class="cf">if</span> (representative <span class="sc">==</span> <span class="st">"mean"</span>) mean <span class="cf">else</span> median</span>
<span id="cb85-224"><a href="#cb85-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">vapply</span>(clusters, rep_fun, <span class="fu">numeric</span>(<span class="dv">1</span>))))</span>
<span id="cb85-225"><a href="#cb85-225" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-226"><a href="#cb85-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-227"><a href="#cb85-227" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-228"><a href="#cb85-228" aria-hidden="true" tabindex="-1"></a>per_dim_single_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(y_vec,</span>
<span id="cb85-229"><a href="#cb85-229" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb85-230"><a href="#cb85-230" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>) {</span>
<span id="cb85-231"><a href="#cb85-231" aria-hidden="true" tabindex="-1"></a>  Yj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(y_vec, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb85-232"><a href="#cb85-232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 关键优化：为该维度一次性构建累计和，供后续多次 binary_segmentation 复用</span></span>
<span id="cb85-233"><a href="#cb85-233" aria-hidden="true" tabindex="-1"></a>  Yj <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Yj)</span>
<span id="cb85-234"><a href="#cb85-234" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb85-235"><a href="#cb85-235" aria-hidden="true" tabindex="-1"></a>  results   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb85-236"><a href="#cb85-236" aria-hidden="true" tabindex="-1"></a>  counts    <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb85-237"><a href="#cb85-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-238"><a href="#cb85-238" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb85-239"><a href="#cb85-239" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb85-240"><a href="#cb85-240" aria-hidden="true" tabindex="-1"></a>    th <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Yj, b, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Yj), <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb85-241"><a href="#cb85-241" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> th</span>
<span id="cb85-242"><a href="#cb85-242" aria-hidden="true" tabindex="-1"></a>    counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(th)</span>
<span id="cb85-243"><a href="#cb85-243" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-244"><a href="#cb85-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-245"><a href="#cb85-245" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(counts <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb85-246"><a href="#cb85-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">best_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb85-247"><a href="#cb85-247" aria-hidden="true" tabindex="-1"></a>                <span class="at">elbow_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb85-248"><a href="#cb85-248" aria-hidden="true" tabindex="-1"></a>                <span class="at">plateaus =</span> <span class="fu">list</span>(), <span class="at">t_hat =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb85-249"><a href="#cb85-249" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts))</span>
<span id="cb85-250"><a href="#cb85-250" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-251"><a href="#cb85-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-252"><a href="#cb85-252" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, counts)</span>
<span id="cb85-253"><a href="#cb85-253" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb85-254"><a href="#cb85-254" aria-hidden="true" tabindex="-1"></a>  pls <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, counts)</span>
<span id="cb85-255"><a href="#cb85-255" aria-hidden="true" tabindex="-1"></a>  left_bound  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb85-256"><a href="#cb85-256" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb85-257"><a href="#cb85-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-258"><a href="#cb85-258" aria-hidden="true" tabindex="-1"></a>  best_pl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb85-259"><a href="#cb85-259" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> pls) {</span>
<span id="cb85-260"><a href="#cb85-260" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound <span class="sc">&amp;&amp;</span> pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound) {</span>
<span id="cb85-261"><a href="#cb85-261" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_pl) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_pl<span class="sc">$</span>length) best_pl <span class="ot">&lt;-</span> pp</span>
<span id="cb85-262"><a href="#cb85-262" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-263"><a href="#cb85-263" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-264"><a href="#cb85-264" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_pl<span class="sc">$</span>start <span class="sc">+</span> best_pl<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb85-265"><a href="#cb85-265" aria-hidden="true" tabindex="-1"></a>  best_idx  <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(beta_list <span class="sc">-</span> best_beta))</span>
<span id="cb85-266"><a href="#cb85-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-267"><a href="#cb85-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">best_beta =</span> best_beta,</span>
<span id="cb85-268"><a href="#cb85-268" aria-hidden="true" tabindex="-1"></a>       <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb85-269"><a href="#cb85-269" aria-hidden="true" tabindex="-1"></a>       <span class="at">plateaus =</span> pls,</span>
<span id="cb85-270"><a href="#cb85-270" aria-hidden="true" tabindex="-1"></a>       <span class="at">t_hat =</span> <span class="fu">sort</span>(results[[best_idx]]),</span>
<span id="cb85-271"><a href="#cb85-271" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts)</span>
<span id="cb85-272"><a href="#cb85-272" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-273"><a href="#cb85-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-274"><a href="#cb85-274" aria-hidden="true" tabindex="-1"></a>per_dim_individual_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb85-275"><a href="#cb85-275" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb85-276"><a href="#cb85-276" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb85-277"><a href="#cb85-277" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>),</span>
<span id="cb85-278"><a href="#cb85-278" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb85-279"><a href="#cb85-279" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb85-280"><a href="#cb85-280" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb85-281"><a href="#cb85-281" aria-hidden="true" tabindex="-1"></a>  dim_betas <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d)</span>
<span id="cb85-282"><a href="#cb85-282" aria-hidden="true" tabindex="-1"></a>  dim_cps   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, d)</span>
<span id="cb85-283"><a href="#cb85-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-284"><a href="#cb85-284" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb85-285"><a href="#cb85-285" aria-hidden="true" tabindex="-1"></a>    rj <span class="ot">&lt;-</span> <span class="fu">per_dim_single_adaptive</span>(Y[, j],</span>
<span id="cb85-286"><a href="#cb85-286" aria-hidden="true" tabindex="-1"></a>                                  beta_min, beta_max, beta_points,</span>
<span id="cb85-287"><a href="#cb85-287" aria-hidden="true" tabindex="-1"></a>                                  min_size, p, elbow_window)</span>
<span id="cb85-288"><a href="#cb85-288" aria-hidden="true" tabindex="-1"></a>    dim_betas[j] <span class="ot">&lt;-</span> rj<span class="sc">$</span>best_beta</span>
<span id="cb85-289"><a href="#cb85-289" aria-hidden="true" tabindex="-1"></a>    dim_cps[[j]] <span class="ot">&lt;-</span> rj<span class="sc">$</span>t_hat</span>
<span id="cb85-290"><a href="#cb85-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose) <span class="sc">&amp;&amp;</span> (j <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[per-dim] finished %d/%d"</span>, j, d))</span>
<span id="cb85-291"><a href="#cb85-291" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-292"><a href="#cb85-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-293"><a href="#cb85-293" aria-hidden="true" tabindex="-1"></a>  merged <span class="ot">&lt;-</span> <span class="fu">merge_cps</span>(dim_cps, <span class="at">tol =</span> tol, <span class="at">representative =</span> representative)</span>
<span id="cb85-294"><a href="#cb85-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">merged_cp =</span> <span class="fu">sort</span>(merged), <span class="at">per_dim_beta =</span> dim_betas, <span class="at">per_dim_cp =</span> dim_cps)</span>
<span id="cb85-295"><a href="#cb85-295" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-296"><a href="#cb85-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-297"><a href="#cb85-297" aria-hidden="true" tabindex="-1"></a><span class="co"># 记忆：我的对比function 逐维法和abs</span></span>
<span id="cb85-298"><a href="#cb85-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-299"><a href="#cb85-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-300"><a href="#cb85-300" aria-hidden="true" tabindex="-1"></a><span class="do">## 3) 密集模式数据生成 &amp; 评价指标</span></span>
<span id="cb85-301"><a href="#cb85-301" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb85-302"><a href="#cb85-302" aria-hidden="true" tabindex="-1"></a>simulate_dense <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">100</span>,</span>
<span id="cb85-303"><a href="#cb85-303" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>),</span>
<span id="cb85-304"><a href="#cb85-304" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rho =</span> <span class="fl">0.6</span>,              <span class="co"># 每次跳变的受影响比例</span></span>
<span id="cb85-305"><a href="#cb85-305" aria-hidden="true" tabindex="-1"></a>                           <span class="at">delta =</span> <span class="fl">1.0</span>,            <span class="co"># 单次跳变幅度（同号）</span></span>
<span id="cb85-306"><a href="#cb85-306" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma =</span> <span class="fl">1.0</span>,            <span class="co"># 噪声标准差</span></span>
<span id="cb85-307"><a href="#cb85-307" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ar_phi =</span> <span class="fl">0.0</span>,           <span class="co"># AR(1) 噪声相关，0 表示独立</span></span>
<span id="cb85-308"><a href="#cb85-308" aria-hidden="true" tabindex="-1"></a>                           <span class="at">same_sign =</span> <span class="cn">TRUE</span>,       <span class="co"># TRUE：所有受影响维同号上升</span></span>
<span id="cb85-309"><a href="#cb85-309" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb85-310"><a href="#cb85-310" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb85-311"><a href="#cb85-311" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb85-312"><a href="#cb85-312" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb85-313"><a href="#cb85-313" aria-hidden="true" tabindex="-1"></a>  Y  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb85-314"><a href="#cb85-314" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb85-315"><a href="#cb85-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-316"><a href="#cb85-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 固定一个受影响子集（密集：每个变点都影响同一批维度）</span></span>
<span id="cb85-317"><a href="#cb85-317" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb85-318"><a href="#cb85-318" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-319"><a href="#cb85-319" aria-hidden="true" tabindex="-1"></a>  jump_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d); jump_vec[S] <span class="ot">&lt;-</span> signs[S] <span class="sc">*</span> delta</span>
<span id="cb85-320"><a href="#cb85-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-321"><a href="#cb85-321" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 累积式均值：每遇到一个变点，对 [cp+1, n] 段叠加 jump_vec</span></span>
<span id="cb85-322"><a href="#cb85-322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (cp <span class="cf">in</span> cps) {</span>
<span id="cb85-323"><a href="#cb85-323" aria-hidden="true" tabindex="-1"></a>    mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, ] <span class="ot">&lt;-</span> <span class="fu">sweep</span>(mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, , <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="dv">2</span>, jump_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb85-324"><a href="#cb85-324" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-325"><a href="#cb85-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-326"><a href="#cb85-326" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 嵌入噪声：独立或 AR(1)</span></span>
<span id="cb85-327"><a href="#cb85-327" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb85-328"><a href="#cb85-328" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb85-329"><a href="#cb85-329" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb85-330"><a href="#cb85-330" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb85-331"><a href="#cb85-331" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb85-332"><a href="#cb85-332" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb85-333"><a href="#cb85-333" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb85-334"><a href="#cb85-334" aria-hidden="true" tabindex="-1"></a>      eps[t, ] <span class="ot">&lt;-</span> ar_phi <span class="sc">*</span> eps[t <span class="sc">-</span> <span class="dv">1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb85-335"><a href="#cb85-335" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-336"><a href="#cb85-336" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-337"><a href="#cb85-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-338"><a href="#cb85-338" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> mu <span class="sc">+</span> eps</span>
<span id="cb85-339"><a href="#cb85-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> Y, <span class="at">true_cp =</span> cps, <span class="at">mu =</span> mu, <span class="at">S =</span> S)</span>
<span id="cb85-340"><a href="#cb85-340" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-341"><a href="#cb85-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-342"><a href="#cb85-342" aria-hidden="true" tabindex="-1"></a><span class="co"># 评价函数（增强鲁棒性）</span></span>
<span id="cb85-343"><a href="#cb85-343" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb85-344"><a href="#cb85-344" aria-hidden="true" tabindex="-1"></a>hausdorff <span class="ot">&lt;-</span> <span class="cf">function</span>(A, B) {</span>
<span id="cb85-345"><a href="#cb85-345" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(A) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(B) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">Inf</span>)</span>
<span id="cb85-346"><a href="#cb85-346" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(A)</span>
<span id="cb85-347"><a href="#cb85-347" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(B)</span>
<span id="cb85-348"><a href="#cb85-348" aria-hidden="true" tabindex="-1"></a>  max_A <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(A, <span class="cf">function</span>(a) <span class="fu">min</span>(<span class="fu">abs</span>(a <span class="sc">-</span> B))))</span>
<span id="cb85-349"><a href="#cb85-349" aria-hidden="true" tabindex="-1"></a>  max_B <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(B, <span class="cf">function</span>(b) <span class="fu">min</span>(<span class="fu">abs</span>(b <span class="sc">-</span> A))))</span>
<span id="cb85-350"><a href="#cb85-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">max</span>(max_A, max_B))</span>
<span id="cb85-351"><a href="#cb85-351" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-352"><a href="#cb85-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-353"><a href="#cb85-353" aria-hidden="true" tabindex="-1"></a>f1_score <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, <span class="at">tol =</span> <span class="dv">1</span>) {</span>
<span id="cb85-354"><a href="#cb85-354" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb85-355"><a href="#cb85-355" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb85-356"><a href="#cb85-356" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-357"><a href="#cb85-357" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 处理空输入</span></span>
<span id="cb85-358"><a href="#cb85-358" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(detected_cp) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb85-359"><a href="#cb85-359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb85-360"><a href="#cb85-360" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-361"><a href="#cb85-361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-362"><a href="#cb85-362" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">any</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&lt;=</span> tol)))</span>
<span id="cb85-363"><a href="#cb85-363" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(detected_cp, <span class="cf">function</span>(dc) <span class="fu">all</span>(<span class="fu">abs</span>(true_cp <span class="sc">-</span> dc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb85-364"><a href="#cb85-364" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">all</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb85-365"><a href="#cb85-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-366"><a href="#cb85-366" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FP) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FP)</span>
<span id="cb85-367"><a href="#cb85-367" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FN) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb85-368"><a href="#cb85-368" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-369"><a href="#cb85-369" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((precision <span class="sc">+</span> recall) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb85-370"><a href="#cb85-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="dv">2</span> <span class="sc">*</span> precision <span class="sc">*</span> recall <span class="sc">/</span> (precision <span class="sc">+</span> recall))</span>
<span id="cb85-371"><a href="#cb85-371" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-372"><a href="#cb85-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-373"><a href="#cb85-373" aria-hidden="true" tabindex="-1"></a>rand_index <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, n) {</span>
<span id="cb85-374"><a href="#cb85-374" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(true_cp))</span>
<span id="cb85-375"><a href="#cb85-375" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(detected_cp))</span>
<span id="cb85-376"><a href="#cb85-376" aria-hidden="true" tabindex="-1"></a>  true_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, true_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb85-377"><a href="#cb85-377" aria-hidden="true" tabindex="-1"></a>  detected_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, detected_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb85-378"><a href="#cb85-378" aria-hidden="true" tabindex="-1"></a>  agree <span class="ot">&lt;-</span> <span class="fu">outer</span>(true_labels, true_labels, <span class="st">"=="</span>) <span class="sc">==</span> <span class="fu">outer</span>(detected_labels, detected_labels, <span class="st">"=="</span>)</span>
<span id="cb85-379"><a href="#cb85-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(agree))</span>
<span id="cb85-380"><a href="#cb85-380" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-381"><a href="#cb85-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-382"><a href="#cb85-382" aria-hidden="true" tabindex="-1"></a>annotation_error <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp) {</span>
<span id="cb85-383"><a href="#cb85-383" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb85-384"><a href="#cb85-384" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb85-385"><a href="#cb85-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>(<span class="fu">length</span>(true_cp) <span class="sc">-</span> <span class="fu">length</span>(detected_cp))</span>
<span id="cb85-386"><a href="#cb85-386" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-387"><a href="#cb85-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-388"><a href="#cb85-388" aria-hidden="true" tabindex="-1"></a><span class="co"># 记忆：数据生成和评价指标</span></span>
<span id="cb85-389"><a href="#cb85-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-390"><a href="#cb85-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-391"><a href="#cb85-391" aria-hidden="true" tabindex="-1"></a><span class="do">## 4) 实验驱动：单次与批量评估</span></span>
<span id="cb85-392"><a href="#cb85-392" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-393"><a href="#cb85-393" aria-hidden="true" tabindex="-1"></a>run_one_trial <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>,</span>
<span id="cb85-394"><a href="#cb85-394" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb85-395"><a href="#cb85-395" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb85-396"><a href="#cb85-396" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb85-397"><a href="#cb85-397" aria-hidden="true" tabindex="-1"></a>                          <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb85-398"><a href="#cb85-398" aria-hidden="true" tabindex="-1"></a>                          <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb85-399"><a href="#cb85-399" aria-hidden="true" tabindex="-1"></a>                          <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb85-400"><a href="#cb85-400" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="cn">NULL</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb85-401"><a href="#cb85-401" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span>(n, d, cps, rho, delta, sigma, ar_phi, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb85-402"><a href="#cb85-402" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb85-403"><a href="#cb85-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-404"><a href="#cb85-404" aria-hidden="true" tabindex="-1"></a>  t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb85-405"><a href="#cb85-405" aria-hidden="true" tabindex="-1"></a>    abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb85-406"><a href="#cb85-406" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb85-407"><a href="#cb85-407" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> verbose</span>
<span id="cb85-408"><a href="#cb85-408" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-409"><a href="#cb85-409" aria-hidden="true" tabindex="-1"></a>    idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb85-410"><a href="#cb85-410" aria-hidden="true" tabindex="-1"></a>    cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb85-411"><a href="#cb85-411" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb85-412"><a href="#cb85-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-413"><a href="#cb85-413" aria-hidden="true" tabindex="-1"></a>  t_per <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb85-414"><a href="#cb85-414" aria-hidden="true" tabindex="-1"></a>    per_res <span class="ot">&lt;-</span> <span class="fu">per_dim_individual_adaptive</span>(</span>
<span id="cb85-415"><a href="#cb85-415" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> per_beta_min, <span class="at">beta_max =</span> per_beta_max, <span class="at">beta_points =</span> per_beta_points,</span>
<span id="cb85-416"><a href="#cb85-416" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_per, <span class="at">tol =</span> tol_match, <span class="at">elbow_window =</span> elbow_window,</span>
<span id="cb85-417"><a href="#cb85-417" aria-hidden="true" tabindex="-1"></a>      <span class="at">representative =</span> representative, <span class="at">verbose =</span> verbose</span>
<span id="cb85-418"><a href="#cb85-418" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-419"><a href="#cb85-419" aria-hidden="true" tabindex="-1"></a>    cp_per <span class="ot">&lt;-</span> per_res<span class="sc">$</span>merged_cp</span>
<span id="cb85-420"><a href="#cb85-420" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb85-421"><a href="#cb85-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-422"><a href="#cb85-422" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 评估</span></span>
<span id="cb85-423"><a href="#cb85-423" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> tol_match)</span>
<span id="cb85-424"><a href="#cb85-424" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_per, <span class="at">tol =</span> tol_match)</span>
<span id="cb85-425"><a href="#cb85-425" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb85-426"><a href="#cb85-426" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_per)</span>
<span id="cb85-427"><a href="#cb85-427" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> n)</span>
<span id="cb85-428"><a href="#cb85-428" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_per, <span class="at">n =</span> n)</span>
<span id="cb85-429"><a href="#cb85-429" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb85-430"><a href="#cb85-430" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_per)</span>
<span id="cb85-431"><a href="#cb85-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-432"><a href="#cb85-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb85-433"><a href="#cb85-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp =</span> true_cp,</span>
<span id="cb85-434"><a href="#cb85-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_abs,</span>
<span id="cb85-435"><a href="#cb85-435" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> abs_f1, <span class="at">haus =</span> abs_haus, <span class="at">rand =</span> abs_rand, <span class="at">ann =</span> abs_ann,</span>
<span id="cb85-436"><a href="#cb85-436" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])),</span>
<span id="cb85-437"><a href="#cb85-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">per =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_per,</span>
<span id="cb85-438"><a href="#cb85-438" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> per_f1, <span class="at">haus =</span> per_haus, <span class="at">rand =</span> per_rand, <span class="at">ann =</span> per_ann,</span>
<span id="cb85-439"><a href="#cb85-439" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_per[<span class="st">"elapsed"</span>]))</span>
<span id="cb85-440"><a href="#cb85-440" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb85-441"><a href="#cb85-441" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-442"><a href="#cb85-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-443"><a href="#cb85-443" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-444"><a href="#cb85-444" aria-hidden="true" tabindex="-1"></a><span class="do">## 批量实验与汇总</span></span>
<span id="cb85-445"><a href="#cb85-445" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb85-446"><a href="#cb85-446" aria-hidden="true" tabindex="-1"></a>run_experiments <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">30</span>,</span>
<span id="cb85-447"><a href="#cb85-447" aria-hidden="true" tabindex="-1"></a>                            <span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb85-448"><a href="#cb85-448" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb85-449"><a href="#cb85-449" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb85-450"><a href="#cb85-450" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb85-451"><a href="#cb85-451" aria-hidden="true" tabindex="-1"></a>                            <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb85-452"><a href="#cb85-452" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb85-453"><a href="#cb85-453" aria-hidden="true" tabindex="-1"></a>                            <span class="at">seed0 =</span> <span class="dv">123</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb85-454"><a href="#cb85-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed0)</span>
<span id="cb85-455"><a href="#cb85-455" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb85-456"><a href="#cb85-456" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb85-457"><a href="#cb85-457" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, <span class="dv">1</span>)</span>
<span id="cb85-458"><a href="#cb85-458" aria-hidden="true" tabindex="-1"></a>    results[[r]] <span class="ot">&lt;-</span> <span class="fu">run_one_trial</span>(</span>
<span id="cb85-459"><a href="#cb85-459" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> n, <span class="at">d =</span> d, <span class="at">cps =</span> cps, <span class="at">rho =</span> rho, <span class="at">delta =</span> delta, <span class="at">sigma =</span> sigma, <span class="at">ar_phi =</span> ar_phi,</span>
<span id="cb85-460"><a href="#cb85-460" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">tol_match =</span> tol_match,</span>
<span id="cb85-461"><a href="#cb85-461" aria-hidden="true" tabindex="-1"></a>      <span class="at">abs_beta_min =</span> abs_beta_min, <span class="at">abs_beta_max =</span> abs_beta_max, <span class="at">abs_beta_points =</span> abs_beta_points, <span class="at">p_abs =</span> p_abs,</span>
<span id="cb85-462"><a href="#cb85-462" aria-hidden="true" tabindex="-1"></a>      <span class="at">per_beta_min =</span> per_beta_min, <span class="at">per_beta_max =</span> per_beta_max, <span class="at">per_beta_points =</span> per_beta_points, <span class="at">p_per =</span> p_per,</span>
<span id="cb85-463"><a href="#cb85-463" aria-hidden="true" tabindex="-1"></a>      <span class="at">elbow_window =</span> elbow_window, <span class="at">representative =</span> representative,</span>
<span id="cb85-464"><a href="#cb85-464" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> s, <span class="at">verbose =</span> verbose</span>
<span id="cb85-465"><a href="#cb85-465" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-466"><a href="#cb85-466" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[run] %d/%d done"</span>, r, R))</span>
<span id="cb85-467"><a href="#cb85-467" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-468"><a href="#cb85-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-469"><a href="#cb85-469" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 抽出指标</span></span>
<span id="cb85-470"><a href="#cb85-470" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1)</span>
<span id="cb85-471"><a href="#cb85-471" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>f1)</span>
<span id="cb85-472"><a href="#cb85-472" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus)</span>
<span id="cb85-473"><a href="#cb85-473" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>haus)</span>
<span id="cb85-474"><a href="#cb85-474" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand)</span>
<span id="cb85-475"><a href="#cb85-475" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>rand)</span>
<span id="cb85-476"><a href="#cb85-476" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann)</span>
<span id="cb85-477"><a href="#cb85-477" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>ann)</span>
<span id="cb85-478"><a href="#cb85-478" aria-hidden="true" tabindex="-1"></a>  abs_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time)</span>
<span id="cb85-479"><a href="#cb85-479" aria-hidden="true" tabindex="-1"></a>  per_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>time)</span>
<span id="cb85-480"><a href="#cb85-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-481"><a href="#cb85-481" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-482"><a href="#cb85-482" aria-hidden="true" tabindex="-1"></a>  sdv <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-483"><a href="#cb85-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-484"><a href="#cb85-484" aria-hidden="true" tabindex="-1"></a>  summary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb85-485"><a href="#cb85-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">ABS =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(abs_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(abs_f1),</span>
<span id="cb85-486"><a href="#cb85-486" aria-hidden="true" tabindex="-1"></a>            <span class="at">Haus_median =</span> <span class="fu">median</span>(abs_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb85-487"><a href="#cb85-487" aria-hidden="true" tabindex="-1"></a>            <span class="at">Rand_mean =</span> <span class="fu">m</span>(abs_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(abs_rand),</span>
<span id="cb85-488"><a href="#cb85-488" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ann_mean =</span> <span class="fu">m</span>(abs_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(abs_ann),</span>
<span id="cb85-489"><a href="#cb85-489" aria-hidden="true" tabindex="-1"></a>            <span class="at">Time_mean =</span> <span class="fu">m</span>(abs_t)),</span>
<span id="cb85-490"><a href="#cb85-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">PER_indivBeta =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(per_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(per_f1),</span>
<span id="cb85-491"><a href="#cb85-491" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Haus_median =</span> <span class="fu">median</span>(per_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb85-492"><a href="#cb85-492" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Rand_mean =</span> <span class="fu">m</span>(per_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(per_rand),</span>
<span id="cb85-493"><a href="#cb85-493" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Ann_mean =</span> <span class="fu">m</span>(per_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(per_ann),</span>
<span id="cb85-494"><a href="#cb85-494" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Time_mean =</span> <span class="fu">m</span>(per_t))</span>
<span id="cb85-495"><a href="#cb85-495" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb85-496"><a href="#cb85-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-497"><a href="#cb85-497" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 逐次结果的 data.frame，便于出图</span></span>
<span id="cb85-498"><a href="#cb85-498" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb85-499"><a href="#cb85-499" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb85-500"><a href="#cb85-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1 =</span> abs_f1, <span class="at">per_f1 =</span> per_f1,</span>
<span id="cb85-501"><a href="#cb85-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> abs_haus, <span class="at">per_haus =</span> per_haus,</span>
<span id="cb85-502"><a href="#cb85-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> abs_rand, <span class="at">per_rand =</span> per_rand,</span>
<span id="cb85-503"><a href="#cb85-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann =</span> abs_ann, <span class="at">per_ann =</span> per_ann,</span>
<span id="cb85-504"><a href="#cb85-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> abs_t, <span class="at">per_time =</span> per_t</span>
<span id="cb85-505"><a href="#cb85-505" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb85-506"><a href="#cb85-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-507"><a href="#cb85-507" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">all =</span> results, <span class="at">summary =</span> summary, <span class="at">metrics =</span> df)</span>
<span id="cb85-508"><a href="#cb85-508" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-509"><a href="#cb85-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-510"><a href="#cb85-510" aria-hidden="true" tabindex="-1"></a><span class="do">## 示例</span></span>
<span id="cb85-511"><a href="#cb85-511" aria-hidden="true" tabindex="-1"></a><span class="co"># res &lt;- run_experiments(</span></span>
<span id="cb85-512"><a href="#cb85-512" aria-hidden="true" tabindex="-1"></a><span class="co">#   R = 1,</span></span>
<span id="cb85-513"><a href="#cb85-513" aria-hidden="true" tabindex="-1"></a><span class="co">#   n = 200, d = 10, cps = c(60, 120, 160),</span></span>
<span id="cb85-514"><a href="#cb85-514" aria-hidden="true" tabindex="-1"></a><span class="co">#   rho = 0.7, delta = 1.0, sigma = 1.0, ar_phi = 0.2,</span></span>
<span id="cb85-515"><a href="#cb85-515" aria-hidden="true" tabindex="-1"></a><span class="co">#   min_size = 5, tol_match = 3L,</span></span>
<span id="cb85-516"><a href="#cb85-516" aria-hidden="true" tabindex="-1"></a><span class="co">#   abs_beta_min = 3, abs_beta_max = 30, abs_beta_points = 70, p_abs = 2,</span></span>
<span id="cb85-517"><a href="#cb85-517" aria-hidden="true" tabindex="-1"></a><span class="co">#   per_beta_min = 3, per_beta_max = 30, per_beta_points = 70, p_per = 2,</span></span>
<span id="cb85-518"><a href="#cb85-518" aria-hidden="true" tabindex="-1"></a><span class="co">#   elbow_window = 10, representative = "mean",</span></span>
<span id="cb85-519"><a href="#cb85-519" aria-hidden="true" tabindex="-1"></a><span class="co">#   seed0 = 123, verbose = TRUE</span></span>
<span id="cb85-520"><a href="#cb85-520" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>运行服务器simulation.R</p>
<p>注意per_abs检测用的是前百分之20各维度取beta后的中位数作为per全局beta( 否则效率太低，速度太慢)</p>
<p>code：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================================================</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 大板表导出脚本（与已定义的 run_experiments() 配套）</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 放在你已有算法与函数定义之后再运行</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================================================</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>n_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">200</span>)       <span class="co"># T</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>d_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>)        <span class="co"># 列大分组</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>rho_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>)      <span class="co"># 列中分组</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>snr_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>)       <span class="co"># 行内第二列（Δ/σ；这里 σ=1 ⇒ Δ=SNR）</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>phi_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>)         <span class="co"># 行大分组</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>K_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">20</span>) </span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co">#metrics_to_show    &lt;- c("F1","Haus","Rand","Ann","Time","DetProb")</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>metrics_to_show    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"F1"</span>,<span class="st">"Haus"</span>)</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>R_trials    <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>seed0       <span class="ot">&lt;-</span> <span class="dv">264783846</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== 与 run_experiments() 对齐的口径 =====</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>min_size     <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>tol_match    <span class="ot">&lt;-</span> <span class="dv">3</span>L</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>abs_beta_min <span class="ot">&lt;-</span> <span class="dv">10</span>;  abs_beta_max <span class="ot">&lt;-</span> <span class="dv">50</span>; abs_beta_points <span class="ot">&lt;-</span> <span class="dv">70</span>; p_abs <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>per_beta_min <span class="ot">&lt;-</span> <span class="dv">10</span>;  per_beta_max <span class="ot">&lt;-</span> <span class="dv">50</span>; per_beta_points <span class="ot">&lt;-</span> <span class="dv">70</span>; p_per <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>elbow_window <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>representative <span class="ot">&lt;-</span> <span class="st">"mean"</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== 工具函数 =====</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 等距断点（与论文常见设定一致）</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>make_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(T, K) {</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (K <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">seq</span>(<span class="at">from =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">by =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">length.out =</span> K)))</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 在一个条件 (T, d, rho, snr, phi, K) 下跑 R_trials 次并汇总</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 变更点：PER 的 β 选取 = 仅用前 10% 维度各自自适应求 β，取中位数 β；</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a><span class="co">#         随后用该“中位数 β”对所有维度做 BS（固定 β），再合并变点。</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>run_condition <span class="ot">&lt;-</span> <span class="cf">function</span>(T, d, rho, snr, phi, K) {</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>  cps_vec <span class="ot">&lt;-</span> <span class="fu">make_cps</span>(T, K)</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 累计容器</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>  abs_f1 <span class="ot">&lt;-</span> per_f1 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> per_haus <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> per_rand <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>  abs_ann <span class="ot">&lt;-</span> per_ann <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>  abs_time <span class="ot">&lt;-</span> per_time <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>  det_abs <span class="ot">&lt;-</span> det_per <span class="ot">&lt;-</span> <span class="fu">logical</span>(R_trials)</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed0)</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_len</span>(R_trials)) {</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 与 run_experiments() 的抽样口径一致：每次试验一个随机种子</span></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, <span class="dv">1</span>)</span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span>(<span class="at">n =</span> T, <span class="at">d =</span> d, <span class="at">cps =</span> cps_vec,</span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rho =</span> rho, <span class="at">delta =</span> snr, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> phi,</span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>                          <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> s)</span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>    Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>    <span class="do">## 1) ABS：自适应选 β，并得到 cp_abs</span></span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>    t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>      abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>        Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>      idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a>      cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>    abs_time[r] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])</span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>    det_abs[r]  <span class="ot">&lt;-</span> <span class="fu">length</span>(cp_abs) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>    <span class="do">## 2) PER：仅用前 10% 维度各自自适应求 β，取中位数 β；再用该 β 在所有维度上做 BS</span></span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>    t_per <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">floor</span>(<span class="fl">0.2</span> <span class="sc">*</span> d))          <span class="co"># 前 10% 维度数（至少 1）</span></span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a>      idx_probe <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(m)                <span class="co"># 取前 m 个维度</span></span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 在探测维度上自适应求 β</span></span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>      probe_betas <span class="ot">&lt;-</span> <span class="fu">numeric</span>(m)</span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (jj <span class="cf">in</span> <span class="fu">seq_along</span>(idx_probe)) {</span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>        j <span class="ot">&lt;-</span> idx_probe[jj]</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>        rj <span class="ot">&lt;-</span> <span class="fu">per_dim_single_adaptive</span>(</span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a>          Y[, j],</span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>          <span class="at">beta_min =</span> per_beta_min, <span class="at">beta_max =</span> per_beta_max, <span class="at">beta_points =</span> per_beta_points,</span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a>          <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_per, <span class="at">elbow_window =</span> elbow_window</span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>        probe_betas[jj] <span class="ot">&lt;-</span> rj<span class="sc">$</span>best_beta</span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>      median_beta <span class="ot">&lt;-</span> <span class="fu">median</span>(probe_betas, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 用中位数 β 在所有维度上做固定 β 的 BS，然后合并变点</span></span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>      dim_cps <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, d)</span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>        Yj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Y[, j], <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>        Yj <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Yj)</span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>        th <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(</span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a>          Yj, <span class="at">beta =</span> median_beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Yj), <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_per</span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>        dim_cps[[j]] <span class="ot">&lt;-</span> th</span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>      cp_per <span class="ot">&lt;-</span> <span class="fu">merge_cps</span>(dim_cps, <span class="at">tol =</span> tol_match, <span class="at">representative =</span> representative)</span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a>    per_time[r] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(t_per[<span class="st">"elapsed"</span>])</span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>    det_per[r]  <span class="ot">&lt;-</span> <span class="fu">length</span>(cp_per) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a>    <span class="do">## 3) 评价指标</span></span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a>    abs_f1[r]   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> tol_match)</span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>    per_f1[r]   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_per, <span class="at">tol =</span> tol_match)</span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a>    abs_haus[r] <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a>    per_haus[r] <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_per)</span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a>    abs_rand[r] <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> T)</span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a>    per_rand[r] <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_per, <span class="at">n =</span> T)</span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a>    abs_ann[r]  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a>    per_ann[r]  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_per)</span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">F1      =</span> <span class="fu">c</span>(<span class="at">ABS =</span> <span class="fu">m</span>(abs_f1),         <span class="at">PER =</span> <span class="fu">m</span>(per_f1)),</span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">Haus    =</span> <span class="fu">c</span>(<span class="at">ABS =</span> <span class="fu">median</span>(abs_haus),  <span class="at">PER =</span> <span class="fu">median</span>(per_haus)),</span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">Rand    =</span> <span class="fu">c</span>(<span class="at">ABS =</span> <span class="fu">m</span>(abs_rand),       <span class="at">PER =</span> <span class="fu">m</span>(per_rand)),</span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ann     =</span> <span class="fu">c</span>(<span class="at">ABS =</span> <span class="fu">m</span>(abs_ann),        <span class="at">PER =</span> <span class="fu">m</span>(per_ann)),</span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time    =</span> <span class="fu">c</span>(<span class="at">ABS =</span> <span class="fu">m</span>(abs_time),       <span class="at">PER =</span> <span class="fu">m</span>(per_time)),</span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">DetProb =</span> <span class="fu">c</span>(<span class="at">ABS =</span> <span class="fu">mean</span>(det_abs),     <span class="at">PER =</span> <span class="fu">mean</span>(det_per))</span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成一个 (T,K,metric) 的“宽表”数据 + 3 行表头（模拟 LaTeX multicolumn/multirow）</span></span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a>build_plate_table <span class="ot">&lt;-</span> <span class="cf">function</span>(metric_name, T, K) {</span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 列顺序：每个 d 大组内按 rho；每个 rho 下 ABS / PER 两列</span></span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a>  col_blocks <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho)</span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | ABS"</span>, d, rho),</span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | PER"</span>, d, rho))</span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 初始化为 0 行数据框，避免“替换数据里有1行，但数据有0”的报错</span></span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">phi =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">snr =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> col_blocks) dat[[nm]] <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 行块：phi × snr；为模拟 multirow，每个 phi 块首行填 phi，其余行留 NA</span></span>
<span id="cb86-140"><a href="#cb86-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (phi <span class="cf">in</span> phi_levels) {</span>
<span id="cb86-141"><a href="#cb86-141" aria-hidden="true" tabindex="-1"></a>    first_row_in_phi <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (snr <span class="cf">in</span> snr_levels) {</span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a>      row_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">phi =</span> <span class="cf">if</span> (first_row_in_phi) phi <span class="cf">else</span> <span class="cn">NA</span>, <span class="at">snr =</span> snr)</span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (d <span class="cf">in</span> d_levels) {</span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (rho <span class="cf">in</span> rho_levels) {</span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  · 运行: T=%d, K=%d, metric=%s | d=%d, rho=%.2f, snr=%.2f, phi=%.2f, R=%d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a>                      T, K, metric_name, d, rho, snr, phi, R_trials))</span>
<span id="cb86-148"><a href="#cb86-148" aria-hidden="true" tabindex="-1"></a>          cond_res <span class="ot">&lt;-</span> <span class="fu">run_condition</span>(<span class="at">T=</span>T, <span class="at">d=</span>d, <span class="at">rho=</span>rho, <span class="at">snr=</span>snr, <span class="at">phi=</span>phi, <span class="at">K=</span>K)</span>
<span id="cb86-149"><a href="#cb86-149" aria-hidden="true" tabindex="-1"></a>          vals <span class="ot">&lt;-</span> cond_res[[metric_name]]</span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a>          row_list[[<span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | ABS"</span>, d, rho)]] <span class="ot">&lt;-</span> vals[<span class="st">"ABS"</span>]</span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a>          row_list[[<span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | PER"</span>, d, rho)]] <span class="ot">&lt;-</span> vals[<span class="st">"PER"</span>]</span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb86-153"><a href="#cb86-153" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb86-154"><a href="#cb86-154" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat, <span class="fu">as.data.frame</span>(row_list, <span class="at">check.names =</span> <span class="cn">FALSE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>))</span>
<span id="cb86-155"><a href="#cb86-155" aria-hidden="true" tabindex="-1"></a>      first_row_in_phi <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb86-156"><a href="#cb86-156" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-157"><a href="#cb86-157" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-158"><a href="#cb86-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-159"><a href="#cb86-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 三行“分组表头”（用于 CSV 视觉上接近 LaTeX 的 multicolumn）</span></span>
<span id="cb86-160"><a href="#cb86-160" aria-hidden="true" tabindex="-1"></a>  head1 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb86-161"><a href="#cb86-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"T=%d, K=%d"</span>, T, K), <span class="st">""</span>,  <span class="co"># 对齐“phi, snr”两列</span></span>
<span id="cb86-162"><a href="#cb86-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb86-163"><a href="#cb86-163" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"d=%d"</span>, d), <span class="fu">rep</span>(<span class="st">""</span>, <span class="fu">length</span>(rho_levels)<span class="sc">*</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb86-164"><a href="#cb86-164" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb86-165"><a href="#cb86-165" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-166"><a href="#cb86-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-167"><a href="#cb86-167" aria-hidden="true" tabindex="-1"></a>  head2 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb86-168"><a href="#cb86-168" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>, <span class="st">""</span>,</span>
<span id="cb86-169"><a href="#cb86-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb86-170"><a href="#cb86-170" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho) <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"ρ=%.2f"</span>, rho), <span class="st">""</span>)))</span>
<span id="cb86-171"><a href="#cb86-171" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb86-172"><a href="#cb86-172" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-173"><a href="#cb86-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-174"><a href="#cb86-174" aria-hidden="true" tabindex="-1"></a>  head3 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"φ"</span>, <span class="st">"snr"</span>,</span>
<span id="cb86-175"><a href="#cb86-175" aria-hidden="true" tabindex="-1"></a>             <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb86-176"><a href="#cb86-176" aria-hidden="true" tabindex="-1"></a>               <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho) <span class="fu">c</span>(<span class="st">"ABS"</span>, <span class="st">"PER"</span>)))</span>
<span id="cb86-177"><a href="#cb86-177" aria-hidden="true" tabindex="-1"></a>             )))</span>
<span id="cb86-178"><a href="#cb86-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-179"><a href="#cb86-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">data =</span> dat, <span class="at">header1 =</span> head1, <span class="at">header2 =</span> head2, <span class="at">header3 =</span> head3)</span>
<span id="cb86-180"><a href="#cb86-180" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-181"><a href="#cb86-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-182"><a href="#cb86-182" aria-hidden="true" tabindex="-1"></a><span class="co"># 以 UTF-8 + BOM 写 CSV，确保 Excel 正确识别</span></span>
<span id="cb86-183"><a href="#cb86-183" aria-hidden="true" tabindex="-1"></a>write_plate_csv <span class="ot">&lt;-</span> <span class="cf">function</span>(table_obj, metric_name, T, K, <span class="at">dir_out =</span> <span class="st">"tables"</span>) {</span>
<span id="cb86-184"><a href="#cb86-184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir_out)) <span class="fu">dir.create</span>(dir_out, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-185"><a href="#cb86-185" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s/plate_%s_T%d_K%d.csv"</span>, dir_out, metric_name, T, K)</span>
<span id="cb86-186"><a href="#cb86-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"&gt;&gt; 写出表格：%s</span><span class="sc">\n</span><span class="st">"</span>, fn))</span>
<span id="cb86-187"><a href="#cb86-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-188"><a href="#cb86-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1) 写到 UTF-8（无 BOM）的临时文件</span></span>
<span id="cb86-189"><a href="#cb86-189" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".csv"</span>)</span>
<span id="cb86-190"><a href="#cb86-190" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(tmp, <span class="at">open =</span> <span class="st">"wt"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb86-191"><a href="#cb86-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-192"><a href="#cb86-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header1), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>,</span>
<span id="cb86-193"><a href="#cb86-193" aria-hidden="true" tabindex="-1"></a>              <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>)</span>
<span id="cb86-194"><a href="#cb86-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header2), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>,</span>
<span id="cb86-195"><a href="#cb86-195" aria-hidden="true" tabindex="-1"></a>              <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-196"><a href="#cb86-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header3), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>,</span>
<span id="cb86-197"><a href="#cb86-197" aria-hidden="true" tabindex="-1"></a>              <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-198"><a href="#cb86-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(table_obj<span class="sc">$</span>data,      <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>,</span>
<span id="cb86-199"><a href="#cb86-199" aria-hidden="true" tabindex="-1"></a>              <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-200"><a href="#cb86-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-201"><a href="#cb86-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flush</span>(con)</span>
<span id="cb86-202"><a href="#cb86-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(con)   <span class="co"># 只关闭一次</span></span>
<span id="cb86-203"><a href="#cb86-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-204"><a href="#cb86-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2) 目标文件先写入 BOM，再把临时文件二进制内容追加进去</span></span>
<span id="cb86-205"><a href="#cb86-205" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">file</span>(fn, <span class="at">open =</span> <span class="st">"wb"</span>)</span>
<span id="cb86-206"><a href="#cb86-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeBin</span>(<span class="fu">as.raw</span>(<span class="fu">c</span>(<span class="dv">0xEF</span>, <span class="dv">0xBB</span>, <span class="dv">0xBF</span>)), out)   <span class="co"># UTF-8 BOM</span></span>
<span id="cb86-207"><a href="#cb86-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(out)</span>
<span id="cb86-208"><a href="#cb86-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-209"><a href="#cb86-209" aria-hidden="true" tabindex="-1"></a>  rawtxt <span class="ot">&lt;-</span> <span class="fu">readBin</span>(tmp, <span class="at">what =</span> <span class="st">"raw"</span>, <span class="at">n =</span> <span class="fu">file.info</span>(tmp)<span class="sc">$</span>size)</span>
<span id="cb86-210"><a href="#cb86-210" aria-hidden="true" tabindex="-1"></a>  out2 <span class="ot">&lt;-</span> <span class="fu">file</span>(fn, <span class="at">open =</span> <span class="st">"ab"</span>)</span>
<span id="cb86-211"><a href="#cb86-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeBin</span>(rawtxt, out2)</span>
<span id="cb86-212"><a href="#cb86-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(out2)</span>
<span id="cb86-213"><a href="#cb86-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-214"><a href="#cb86-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(tmp)</span>
<span id="cb86-215"><a href="#cb86-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(fn)</span>
<span id="cb86-216"><a href="#cb86-216" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-217"><a href="#cb86-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-218"><a href="#cb86-218" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== 主控：遍历 (K, T, metric) 导出 =====</span></span>
<span id="cb86-219"><a href="#cb86-219" aria-hidden="true" tabindex="-1"></a>run_all_plate <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb86-220"><a href="#cb86-220" aria-hidden="true" tabindex="-1"></a>  t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb86-221"><a href="#cb86-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=========== 表格导出开始 ===========</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-222"><a href="#cb86-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Grid: T=%s | K=%s | d=%s | rho=%s | snr=%s | phi=%s | R=%d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb86-223"><a href="#cb86-223" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste</span>(n_levels, <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">paste</span>(K_levels, <span class="at">collapse=</span><span class="st">","</span>),</span>
<span id="cb86-224"><a href="#cb86-224" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste</span>(d_levels, <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">paste</span>(rho_levels, <span class="at">collapse=</span><span class="st">","</span>),</span>
<span id="cb86-225"><a href="#cb86-225" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste</span>(snr_levels, <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">paste</span>(phi_levels, <span class="at">collapse=</span><span class="st">","</span>),</span>
<span id="cb86-226"><a href="#cb86-226" aria-hidden="true" tabindex="-1"></a>              R_trials))</span>
<span id="cb86-227"><a href="#cb86-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--------------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-228"><a href="#cb86-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (K <span class="cf">in</span> K_levels) {</span>
<span id="cb86-229"><a href="#cb86-229" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (T <span class="cf">in</span> n_levels) {</span>
<span id="cb86-230"><a href="#cb86-230" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (metric <span class="cf">in</span> metrics_to_show) {</span>
<span id="cb86-231"><a href="#cb86-231" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"[生成] T=%d, K=%d, metric=%s</span><span class="sc">\n</span><span class="st">"</span>, T, K, metric))</span>
<span id="cb86-232"><a href="#cb86-232" aria-hidden="true" tabindex="-1"></a>        t1 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb86-233"><a href="#cb86-233" aria-hidden="true" tabindex="-1"></a>        tab <span class="ot">&lt;-</span> <span class="fu">build_plate_table</span>(metric, T, K)</span>
<span id="cb86-234"><a href="#cb86-234" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_plate_csv</span>(tab, metric, T, K, <span class="at">dir_out =</span> <span class="st">"tables"</span>)</span>
<span id="cb86-235"><a href="#cb86-235" aria-hidden="true" tabindex="-1"></a>        t2 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb86-236"><a href="#cb86-236" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"-&gt; 完成：%s，用时 %.2fs</span><span class="sc">\n</span><span class="st">"</span>, metric, <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(t2, t1, <span class="at">units=</span><span class="st">"secs"</span>))))</span>
<span id="cb86-237"><a href="#cb86-237" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb86-238"><a href="#cb86-238" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-239"><a href="#cb86-239" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-240"><a href="#cb86-240" aria-hidden="true" tabindex="-1"></a>  t3 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb86-241"><a href="#cb86-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--------------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-242"><a href="#cb86-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"=========== 全部完成，用时 %.2fs ==========</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(t3, t0, <span class="at">units=</span><span class="st">"secs"</span>))))</span>
<span id="cb86-243"><a href="#cb86-243" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>调参注意：</p>
<p>K越多，min_size设置越小</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>n_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">200</span>)       <span class="co"># T</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>d_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>)        <span class="co"># 列大分组</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>rho_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>)      <span class="co"># 列中分组</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>snr_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>)       <span class="co"># 行内第二列（Δ/σ；这里 σ=1 ⇒ Δ=SNR）</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>phi_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>)         <span class="co"># 行大分组</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>K_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>) </span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="co">#metrics_to_show    &lt;- c("F1","Haus","Rand","Ann","Time","DetProb")</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>metrics_to_show    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"F1"</span>,<span class="st">"Haus"</span>)</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>R_trials    <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>seed0       <span class="ot">&lt;-</span> <span class="dv">264783846</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== 与 run_experiments() 对齐的口径 =====</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>min_size     <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>tol_match    <span class="ot">&lt;-</span> <span class="dv">3</span>L</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>abs_beta_min <span class="ot">&lt;-</span> <span class="dv">3</span>;  abs_beta_max <span class="ot">&lt;-</span> <span class="dv">30</span>; abs_beta_points <span class="ot">&lt;-</span> <span class="dv">70</span>; p_abs <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>per_beta_min <span class="ot">&lt;-</span> <span class="dv">3</span>;  per_beta_max <span class="ot">&lt;-</span> <span class="dv">30</span>; per_beta_points <span class="ot">&lt;-</span> <span class="dv">70</span>; p_per <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>elbow_window <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>representative <span class="ot">&lt;-</span> <span class="st">"mean"</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a><span class="do">## ===== 执行 =====</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a><span class="fu">run_all_plate</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ul>
<li><p>当d和b都很小时（d=10，b=0.5信噪比），结果和逐维法都不是很好，但是随着d或b的增加，结果明显优于逐维法(密集模式导致)</p></li>
<li><p>d和b相同时，rho越大越好（明显好于逐维法）</p></li>
<li><p>d和b，rho对结果影响大</p></li>
</ul>
<p>F1:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载 DT 包</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">3</span>)  <span class="co"># 全局设置，小数点保留 3 位</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/F1"</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/F1/plate_F1_T200_K1.csv 
正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/F1/plate_F1_T200_K10.csv 
正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/F1/plate_F1_T200_K20.csv </code></pre>
</div>
</div>
<p>Ann:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Ann"</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Ann/plate_Ann_T200_K1.csv 
正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Ann/plate_Ann_T200_K10.csv </code></pre>
</div>
</div>
<p>Haus:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Haus"</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 遍历读取并展示</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Haus/plate_Haus_T200_K1.csv 
正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Haus/plate_Haus_T200_K10.csv </code></pre>
</div>
</div>
<p>Rand:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Rand"</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Rand/plate_Rand_T200_K1.csv 
正在读取文件: C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Rand/plate_Rand_T200_K10.csv </code></pre>
</div>
</div>
</section>
<section id="各维度时间抖动" class="level1">
<h1>各维度时间抖动</h1>
<p>多维/高维时间序列：</p>
<p><span class="math display">\[
Y_t \in \mathbb{R}^d, \quad t = 1, \ldots, T.
\]</span></p>
<p>令</p>
<p><span class="math display">\[
Y_t = \mu_t + \varepsilon_t,
\]</span></p>
<p>其中 <span class="math inline">\(\mu_t\)</span> 为分段常数，<span class="math inline">\(\varepsilon_t\)</span> 为噪声（可带 AR(1) 相关）</p>
<p><strong>基线变点（用于标注/评估）</strong></p>
<p>给定基线真变点个数 <span class="math inline">\(K\)</span> 与其位置</p>
<p><span class="math display">\[
C = \{c_1, \ldots, c_K\} \subset \{1, \ldots, T-1\},
\quad 1 &lt; c_1 &lt; \cdots &lt; c_K &lt; T.
\]</span></p>
<p><strong>受影响维度</strong></p>
<p>每个变点 <span class="math inline">\(c_k\)</span> 影响一部分维度 <span class="math inline">\(S_k \subset \{1, \ldots, d\}\)</span>，满足</p>
<p><span class="math display">\[
\mathbb{E}[|S_k|] = \rho d, \qquad 0 &lt; \rho \leq 1.
\]</span></p>
<ul>
<li><strong>“共享子集”设定</strong>：<span class="math inline">\(S_k \equiv S\)</span> 对所有 <span class="math inline">\(k\)</span> 相同；<br>
</li>
<li><strong>“独立子集”设定</strong>：各 <span class="math inline">\(k\)</span> 独立抽样</li>
</ul>
<p>令每维的跃迁符号 <span class="math inline">\(s_j \in \{+1, -1\}\)</span>；同号场景取 <span class="math inline">\(s_j \equiv +1\)</span>。</p>
<p><strong>先后错位（时间抖动）</strong></p>
<p>受影响的维度 <span class="math inline">\(j \in S_k\)</span> 在第 <span class="math inline">\(k\)</span> 个基线变点附近各自发生实际变点：</p>
<p><span class="math display">\[
c_k^{(j)} = c_k + \delta_k^{(j)}, \qquad
\delta_k^{(j)} \sim \text{对称零均值分布 } (\text{如 } \mathcal{N}(0, \sigma_{\text{jit}}^2)),
\]</span></p>
<p>并裁剪到区间 <span class="math inline">\(1, \ldots, T-1\)</span> 内。</p>
<p>其中 <span class="math inline">\(\sigma_{\text{jit}}\)</span> 是<strong>抖动强度</strong></p>
<p><strong>噪声模型</strong></p>
<p>设各维度噪声满足</p>
<p><span class="math display">\[
\varepsilon_t^{(j)} = \phi \, \varepsilon_{t-1}^{(j)} + \eta_t^{(j)},
\qquad
\eta_t^{(j)} \overset{i.i.d.}{\sim} \mathcal{N}(0,\sigma_\eta^2),
\]</span></p>
<p>其中</p>
<p><span class="math display">\[
\sigma_\eta^2 = \sigma^2(1-\phi^2).
\]</span></p>
<p>当 <span class="math inline">\(\phi = 0\)</span> 时，退化为独立同分布噪声：</p>
<p><span class="math display">\[
\varepsilon_t^{(j)} \sim \mathcal{N}(0,\sigma^2).
\]</span></p>
<section id="跑评价-1" class="level2">
<h2 class="anchored" data-anchor-id="跑评价-1">跑评价</h2>
<p><strong>记号（单个基线变点</strong> <span class="math inline">\(k\)</span><strong>）</strong></p>
<ul>
<li><p><strong>基线真变点</strong>：<span class="math inline">\(c_k\)</span></p></li>
<li><p><strong>受影响的维度集合</strong>：<span class="math inline">\(S_k \subset \{1,\dots,d\}\)</span></p></li>
<li><p><strong>每个受影响维度的实际发生时刻（有先有后）</strong>：</p>
<p><span class="math display">\[
v_{j,k} \equiv c_k^{(j)},\quad j\in S_k
\]</span></p></li>
<li><p><strong>ABS 对该组错位变点的估计切点</strong>：<span class="math inline">\(\hat c_k\)</span><br>
（若检测出的断点数与 <span class="math inline">\(K\)</span> 不一致，先做次序保持的最近匹配，把第 <span class="math inline">\(k\)</span> 个检测点对齐到这组）</p></li>
</ul>
<hr>
<p>ABS 在多维“先后错位”场景下，能否把一团分散的单维变点拉到同一中心？</p>
<p><strong>1. 拉拢率 Pull-in rate（“小半径内收拢了多少”）</strong></p>
<p><strong>定义（给定容差</strong> <span class="math inline">\(\tau\)</span>）：</p>
<p><span class="math display">\[
P_k(\tau)=\frac{1}{|S_k|}\sum_{j\in S_k}\mathbf{1}\left\{|v_{j,k}-\hat c_k|\le \tau\right\}.
\]</span></p>
<ul>
<li>看 <strong>ABS 的红线</strong> 能在 <strong>±</strong><span class="math inline">\(\tau\)</span> 的小窗口里覆盖到多少比例的<strong>单维实际时刻</strong><br>
</li>
<li><strong>取值范围</strong>：<span class="math inline">\([0,1]\)</span>，越大越好<br>
</li>
<li><strong>聚合</strong>：<span class="math inline">\(\overline{P(\tau)}=\frac{1}{K}\sum_k P_k(\tau)\)</span>；或对多次取平均</li>
</ul>
<p><strong>2.中心误差 Center error（“红线离‘云’中心多远”）</strong></p>
<p>用<strong>稳健的中心</strong>：</p>
<p><span class="math display">\[
m_k=\operatorname{median}\{v_{j,k}:j\in S_k\},\qquad
E_k=|\hat c_k-m_k|.
\]</span></p>
<ul>
<li><strong>直觉</strong>：红线是否贴近“错位云”的中位中心<br>
</li>
<li><strong>聚合</strong>：<span class="math inline">\(\operatorname{median}_k E_k\)</span> 或平均<br>
</li>
<li><strong>取值</strong>：越小越好（常见目标：<span class="math inline">\(E_k\in[0,2]\)</span>）</li>
</ul>
<p><strong>3. 云的宽度 Cloud width（“错位有多分散”）</strong></p>
<p>度量“错位云”的散度：</p>
<p><span class="math display">\[W_k=\operatorname{IQR}\big(\{v_{j,k}\}\big).
\]</span></p>
<ul>
<li><strong>直觉</strong>：先后错位的强度<br>
</li>
<li><strong>难度指标</strong>，本身不是好坏</li>
</ul>
<p><strong>4.归一化中心误差（规模无关）</strong></p>
<p>用 <span class="math inline">\(W_k\)</span> 把 <span class="math inline">\(E_k\)</span> 规模化：</p>
<p><span class="math display">\[
R_k=\frac{E_k}{W_k+\varepsilon},\qquad (\varepsilon\ \text{很小，防 0 除}).
\]</span></p>
<ul>
<li><p><strong>直觉</strong>：在“云很宽”的情况下，ABS 仍应贴近中心 ,即 <span class="math inline">\(R_k\)</span> 仍然小<br>
</p></li>
<li><p><strong>聚合</strong>：<span class="math inline">\(\operatorname{median}_k R_k\)</span>；<br>
</p></li>
<li><p><strong>取值</strong>：越小越好</p></li>
</ul>
<p>code:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 生成“各维错位”的密集阶跃数据</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>simulate_staggered <span class="ot">&lt;-</span> <span class="cf">function</span>(n, d,</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>                               cps,               <span class="co"># 基线真断点（评估用它）</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">rho =</span> <span class="fl">0.6</span>,         <span class="co"># 受影响比例</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">delta =</span> <span class="fl">1.0</span>,       <span class="co"># SNR (σ=1)</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sigma =</span> <span class="fl">1.0</span>,</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ar_phi =</span> <span class="fl">0.0</span>,</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>                               <span class="at">jitter_sd =</span> <span class="dv">0</span>L,    <span class="co"># ★ 抖动强度（索引单位，整数）</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">same_sign =</span> <span class="cn">TRUE</span>,</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">shared_subset =</span> <span class="cn">TRUE</span>,  <span class="co"># TRUE: 每个变点影响同一批维度</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>  Y   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>  mu  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (shared_subset) {</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>    S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(K)) {</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    base_c <span class="ot">&lt;-</span> cps[k]</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>    Sk <span class="ot">&lt;-</span> <span class="cf">if</span> (shared_subset) S <span class="cf">else</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> Sk) {</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="cf">if</span> (jitter_sd <span class="sc">&gt;</span> <span class="dv">0</span>L) <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, jitter_sd)) <span class="cf">else</span> <span class="dv">0</span>L</span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>      cj  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">min</span>(n<span class="dv">-1</span>L, <span class="fu">as.integer</span>(base_c <span class="sc">+</span> eps)))</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>      step <span class="ot">&lt;-</span> signs[j] <span class="sc">*</span> delta</span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>      Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="ot">&lt;-</span> Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="sc">+</span> step</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>      mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="ot">&lt;-</span> mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="sc">+</span> step</span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 噪声</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) eps[t, ] <span class="ot">&lt;-</span> ar_phi<span class="sc">*</span>eps[t<span class="dv">-1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> mu <span class="sc">+</span> eps, <span class="at">true_cp =</span> cps, <span class="at">mu =</span> mu)</span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 只评估 ABS（每次 MC 的耗时=算法时间）</span></span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a>run_condition_abs <span class="ot">&lt;-</span> <span class="cf">function</span>(T, d, rho, snr, phi, K, <span class="at">jitter_sd =</span> <span class="dv">0</span>L,</span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>                              <span class="at">min_size =</span> <span class="dv">5</span>,</span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>                              <span class="at">abs_beta_min =</span> <span class="dv">10</span>, <span class="at">abs_beta_max =</span> <span class="dv">50</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>                              <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>                              <span class="at">R_trials =</span> <span class="dv">10</span>, <span class="at">seed0 =</span> <span class="dv">12345</span>) {</span>
<span id="cb96-58"><a href="#cb96-58" aria-hidden="true" tabindex="-1"></a>  cps_vec <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">seq</span>(<span class="at">from =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">by =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">length.out =</span> K)))</span>
<span id="cb96-59"><a href="#cb96-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-60"><a href="#cb96-60" aria-hidden="true" tabindex="-1"></a>  f1   <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb96-61"><a href="#cb96-61" aria-hidden="true" tabindex="-1"></a>  haus <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb96-62"><a href="#cb96-62" aria-hidden="true" tabindex="-1"></a>  rand <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb96-63"><a href="#cb96-63" aria-hidden="true" tabindex="-1"></a>  ann  <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb96-64"><a href="#cb96-64" aria-hidden="true" tabindex="-1"></a>  tm   <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb96-65"><a href="#cb96-65" aria-hidden="true" tabindex="-1"></a>  det  <span class="ot">&lt;-</span> <span class="fu">logical</span>(R_trials)</span>
<span id="cb96-66"><a href="#cb96-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-67"><a href="#cb96-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed0)</span>
<span id="cb96-68"><a href="#cb96-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_len</span>(R_trials)) {</span>
<span id="cb96-69"><a href="#cb96-69" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, <span class="dv">1</span>)</span>
<span id="cb96-70"><a href="#cb96-70" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">simulate_staggered</span>(<span class="at">n =</span> T, <span class="at">d =</span> d, <span class="at">cps =</span> cps_vec,</span>
<span id="cb96-71"><a href="#cb96-71" aria-hidden="true" tabindex="-1"></a>                              <span class="at">rho =</span> rho, <span class="at">delta =</span> snr, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> phi,</span>
<span id="cb96-72"><a href="#cb96-72" aria-hidden="true" tabindex="-1"></a>                              <span class="at">jitter_sd =</span> jitter_sd, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">shared_subset =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> s)</span>
<span id="cb96-73"><a href="#cb96-73" aria-hidden="true" tabindex="-1"></a>    Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb96-74"><a href="#cb96-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-75"><a href="#cb96-75" aria-hidden="true" tabindex="-1"></a>    t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb96-76"><a href="#cb96-76" aria-hidden="true" tabindex="-1"></a>      abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb96-77"><a href="#cb96-77" aria-hidden="true" tabindex="-1"></a>        Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb96-78"><a href="#cb96-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb96-79"><a href="#cb96-79" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb96-80"><a href="#cb96-80" aria-hidden="true" tabindex="-1"></a>      idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb96-81"><a href="#cb96-81" aria-hidden="true" tabindex="-1"></a>      cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb96-82"><a href="#cb96-82" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb96-83"><a href="#cb96-83" aria-hidden="true" tabindex="-1"></a>    tm[r]  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])</span>
<span id="cb96-84"><a href="#cb96-84" aria-hidden="true" tabindex="-1"></a>    det[r] <span class="ot">&lt;-</span> <span class="fu">length</span>(cp_abs) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb96-85"><a href="#cb96-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-86"><a href="#cb96-86" aria-hidden="true" tabindex="-1"></a>    f1[r]   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> <span class="dv">3</span>L)</span>
<span id="cb96-87"><a href="#cb96-87" aria-hidden="true" tabindex="-1"></a>    haus[r] <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb96-88"><a href="#cb96-88" aria-hidden="true" tabindex="-1"></a>    rand[r] <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> T)</span>
<span id="cb96-89"><a href="#cb96-89" aria-hidden="true" tabindex="-1"></a>    ann[r]  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb96-90"><a href="#cb96-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-91"><a href="#cb96-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-92"><a href="#cb96-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb96-93"><a href="#cb96-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">F1_mean =</span> <span class="fu">mean</span>(f1),    <span class="at">F1_sd =</span> <span class="fu">sd</span>(f1),</span>
<span id="cb96-94"><a href="#cb96-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">Haus_median =</span> <span class="fu">median</span>(haus),</span>
<span id="cb96-95"><a href="#cb96-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">Rand_mean =</span> <span class="fu">mean</span>(rand), <span class="at">Rand_sd =</span> <span class="fu">sd</span>(rand),</span>
<span id="cb96-96"><a href="#cb96-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ann_mean =</span> <span class="fu">mean</span>(ann),  <span class="at">Ann_sd =</span> <span class="fu">sd</span>(ann),</span>
<span id="cb96-97"><a href="#cb96-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time_mean =</span> <span class="fu">mean</span>(tm),</span>
<span id="cb96-98"><a href="#cb96-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">DetProb =</span> <span class="fu">mean</span>(det)     <span class="co"># 检出≥1个断点的比例</span></span>
<span id="cb96-99"><a href="#cb96-99" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb96-100"><a href="#cb96-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-101"><a href="#cb96-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-102"><a href="#cb96-102" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-103"><a href="#cb96-103" aria-hidden="true" tabindex="-1"></a><span class="do">## 3) 生成“ABS 专用大板表”（列=每个 d×ρ；行=φ×snr；另加 J=抖动强度）</span></span>
<span id="cb96-104"><a href="#cb96-104" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-105"><a href="#cb96-105" aria-hidden="true" tabindex="-1"></a>build_abs_plate_table <span class="ot">&lt;-</span> <span class="cf">function</span>(metric_name, T, K, J,</span>
<span id="cb96-106"><a href="#cb96-106" aria-hidden="true" tabindex="-1"></a>                                  d_levels, rho_levels, snr_levels, phi_levels,</span>
<span id="cb96-107"><a href="#cb96-107" aria-hidden="true" tabindex="-1"></a>                                  R_trials, seed0,</span>
<span id="cb96-108"><a href="#cb96-108" aria-hidden="true" tabindex="-1"></a>                                  min_size,</span>
<span id="cb96-109"><a href="#cb96-109" aria-hidden="true" tabindex="-1"></a>                                  abs_beta_min, abs_beta_max, abs_beta_points, p_abs, elbow_window) {</span>
<span id="cb96-110"><a href="#cb96-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 每个 (d, rho) 只有一列（ABS）</span></span>
<span id="cb96-111"><a href="#cb96-111" aria-hidden="true" tabindex="-1"></a>  col_blocks <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb96-112"><a href="#cb96-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho)</span>
<span id="cb96-113"><a href="#cb96-113" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | ABS"</span>, d, rho)</span>
<span id="cb96-114"><a href="#cb96-114" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb96-115"><a href="#cb96-115" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb96-116"><a href="#cb96-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-117"><a href="#cb96-117" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">phi =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">snr =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb96-118"><a href="#cb96-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> col_blocks) dat[[nm]] <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb96-119"><a href="#cb96-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-120"><a href="#cb96-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (phi <span class="cf">in</span> phi_levels) {</span>
<span id="cb96-121"><a href="#cb96-121" aria-hidden="true" tabindex="-1"></a>    first_row_in_phi <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb96-122"><a href="#cb96-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (snr <span class="cf">in</span> snr_levels) {</span>
<span id="cb96-123"><a href="#cb96-123" aria-hidden="true" tabindex="-1"></a>      row_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">phi =</span> <span class="cf">if</span> (first_row_in_phi) phi <span class="cf">else</span> <span class="cn">NA</span>, <span class="at">snr =</span> snr)</span>
<span id="cb96-124"><a href="#cb96-124" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (d <span class="cf">in</span> d_levels) {</span>
<span id="cb96-125"><a href="#cb96-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (rho <span class="cf">in</span> rho_levels) {</span>
<span id="cb96-126"><a href="#cb96-126" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  · ABS: T=%d, K=%d, J=%d | d=%d, rho=%.2f, snr=%.2f, phi=%.2f, R=%d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb96-127"><a href="#cb96-127" aria-hidden="true" tabindex="-1"></a>                      T, K, J, d, rho, snr, phi, R_trials))</span>
<span id="cb96-128"><a href="#cb96-128" aria-hidden="true" tabindex="-1"></a>          res <span class="ot">&lt;-</span> <span class="fu">run_condition_abs</span>(<span class="at">T=</span>T, <span class="at">d=</span>d, <span class="at">rho=</span>rho, <span class="at">snr=</span>snr, <span class="at">phi=</span>phi, <span class="at">K=</span>K, <span class="at">jitter_sd=</span>J,</span>
<span id="cb96-129"><a href="#cb96-129" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">min_size=</span>min_size,</span>
<span id="cb96-130"><a href="#cb96-130" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">abs_beta_min=</span>abs_beta_min, <span class="at">abs_beta_max=</span>abs_beta_max,</span>
<span id="cb96-131"><a href="#cb96-131" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">abs_beta_points=</span>abs_beta_points, <span class="at">p_abs=</span>p_abs,</span>
<span id="cb96-132"><a href="#cb96-132" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">elbow_window=</span>elbow_window,</span>
<span id="cb96-133"><a href="#cb96-133" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">R_trials=</span>R_trials, <span class="at">seed0=</span>seed0)</span>
<span id="cb96-134"><a href="#cb96-134" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 取某个指标的单值</span></span>
<span id="cb96-135"><a href="#cb96-135" aria-hidden="true" tabindex="-1"></a>          val <span class="ot">&lt;-</span> <span class="cf">switch</span>(metric_name,</span>
<span id="cb96-136"><a href="#cb96-136" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"F1"</span>   <span class="ot">=</span> res<span class="sc">$</span>F1_mean,</span>
<span id="cb96-137"><a href="#cb96-137" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Haus"</span> <span class="ot">=</span> res<span class="sc">$</span>Haus_median,</span>
<span id="cb96-138"><a href="#cb96-138" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Rand"</span> <span class="ot">=</span> res<span class="sc">$</span>Rand_mean,</span>
<span id="cb96-139"><a href="#cb96-139" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Ann"</span>  <span class="ot">=</span> res<span class="sc">$</span>Ann_mean,</span>
<span id="cb96-140"><a href="#cb96-140" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Time"</span> <span class="ot">=</span> res<span class="sc">$</span>Time_mean,</span>
<span id="cb96-141"><a href="#cb96-141" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"DetProb"</span> <span class="ot">=</span> res<span class="sc">$</span>DetProb,</span>
<span id="cb96-142"><a href="#cb96-142" aria-hidden="true" tabindex="-1"></a>                        <span class="cn">NA_real_</span>)</span>
<span id="cb96-143"><a href="#cb96-143" aria-hidden="true" tabindex="-1"></a>          row_list[[<span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | ABS"</span>, d, rho)]] <span class="ot">&lt;-</span> val</span>
<span id="cb96-144"><a href="#cb96-144" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb96-145"><a href="#cb96-145" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb96-146"><a href="#cb96-146" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat, <span class="fu">as.data.frame</span>(row_list, <span class="at">check.names =</span> <span class="cn">FALSE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>))</span>
<span id="cb96-147"><a href="#cb96-147" aria-hidden="true" tabindex="-1"></a>      first_row_in_phi <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb96-148"><a href="#cb96-148" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-149"><a href="#cb96-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-150"><a href="#cb96-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-151"><a href="#cb96-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 三行表头（含 J）</span></span>
<span id="cb96-152"><a href="#cb96-152" aria-hidden="true" tabindex="-1"></a>  head1 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb96-153"><a href="#cb96-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"T=%d, K=%d, J=%d"</span>, T, K, J), <span class="st">""</span>,</span>
<span id="cb96-154"><a href="#cb96-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb96-155"><a href="#cb96-155" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"d=%d"</span>, d), <span class="fu">rep</span>(<span class="st">""</span>, <span class="fu">length</span>(rho_levels)<span class="sc">*</span><span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span>))  <span class="co"># 每个 rho 只有 ABS 一列</span></span>
<span id="cb96-156"><a href="#cb96-156" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb96-157"><a href="#cb96-157" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb96-158"><a href="#cb96-158" aria-hidden="true" tabindex="-1"></a>  head2 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb96-159"><a href="#cb96-159" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>, <span class="st">""</span>,</span>
<span id="cb96-160"><a href="#cb96-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb96-161"><a href="#cb96-161" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho) <span class="fu">sprintf</span>(<span class="st">"ρ=%.2f"</span>, rho)))</span>
<span id="cb96-162"><a href="#cb96-162" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb96-163"><a href="#cb96-163" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb96-164"><a href="#cb96-164" aria-hidden="true" tabindex="-1"></a>  head3 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"φ"</span>, <span class="st">"snr"</span>,</span>
<span id="cb96-165"><a href="#cb96-165" aria-hidden="true" tabindex="-1"></a>             <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb96-166"><a href="#cb96-166" aria-hidden="true" tabindex="-1"></a>               <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho) <span class="st">"ABS"</span>))</span>
<span id="cb96-167"><a href="#cb96-167" aria-hidden="true" tabindex="-1"></a>             )))</span>
<span id="cb96-168"><a href="#cb96-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">data =</span> dat, <span class="at">header1 =</span> head1, <span class="at">header2 =</span> head2, <span class="at">header3 =</span> head3)</span>
<span id="cb96-169"><a href="#cb96-169" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-170"><a href="#cb96-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-171"><a href="#cb96-171" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-172"><a href="#cb96-172" aria-hidden="true" tabindex="-1"></a><span class="do">## 4) UTF-8 + BOM 写 CSV（Excel 不乱码）</span></span>
<span id="cb96-173"><a href="#cb96-173" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb96-174"><a href="#cb96-174" aria-hidden="true" tabindex="-1"></a>write_plate_csv_abs <span class="ot">&lt;-</span> <span class="cf">function</span>(table_obj, metric_name, T, K, J, <span class="at">dir_out =</span> <span class="st">"tables_abs"</span>) {</span>
<span id="cb96-175"><a href="#cb96-175" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir_out)) <span class="fu">dir.create</span>(dir_out, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-176"><a href="#cb96-176" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s/ABS_%s_T%d_K%d_J%d.csv"</span>, dir_out, metric_name, T, K, J)</span>
<span id="cb96-177"><a href="#cb96-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"&gt;&gt; 写出表格：%s</span><span class="sc">\n</span><span class="st">"</span>, fn))</span>
<span id="cb96-178"><a href="#cb96-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-179"><a href="#cb96-179" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".csv"</span>)</span>
<span id="cb96-180"><a href="#cb96-180" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(tmp, <span class="at">open =</span> <span class="st">"wt"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb96-181"><a href="#cb96-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header1), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>)</span>
<span id="cb96-182"><a href="#cb96-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header2), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-183"><a href="#cb96-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header3), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-184"><a href="#cb96-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(table_obj<span class="sc">$</span>data,      <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-185"><a href="#cb96-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flush</span>(con); <span class="fu">close</span>(con)</span>
<span id="cb96-186"><a href="#cb96-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-187"><a href="#cb96-187" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">file</span>(fn, <span class="at">open =</span> <span class="st">"wb"</span>); <span class="fu">writeBin</span>(<span class="fu">as.raw</span>(<span class="fu">c</span>(<span class="dv">0xEF</span>,<span class="dv">0xBB</span>,<span class="dv">0xBF</span>)), out); <span class="fu">close</span>(out)</span>
<span id="cb96-188"><a href="#cb96-188" aria-hidden="true" tabindex="-1"></a>  rawtxt <span class="ot">&lt;-</span> <span class="fu">readBin</span>(tmp, <span class="at">what =</span> <span class="st">"raw"</span>, <span class="at">n =</span> <span class="fu">file.info</span>(tmp)<span class="sc">$</span>size)</span>
<span id="cb96-189"><a href="#cb96-189" aria-hidden="true" tabindex="-1"></a>  out2 <span class="ot">&lt;-</span> <span class="fu">file</span>(fn, <span class="at">open =</span> <span class="st">"ab"</span>); <span class="fu">writeBin</span>(rawtxt, out2); <span class="fu">close</span>(out2)</span>
<span id="cb96-190"><a href="#cb96-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(tmp)</span>
<span id="cb96-191"><a href="#cb96-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(fn)</span>
<span id="cb96-192"><a href="#cb96-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-193"><a href="#cb96-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-194"><a href="#cb96-194" aria-hidden="true" tabindex="-1"></a>run_all_abs_plates <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">out_dir =</span> <span class="st">"tables_abs"</span>) {</span>
<span id="cb96-195"><a href="#cb96-195" aria-hidden="true" tabindex="-1"></a>  t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb96-196"><a href="#cb96-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=========== 仅 ABS 的大板表导出（含错位 J） ===========</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb96-197"><a href="#cb96-197" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (K <span class="cf">in</span> K_levels) {</span>
<span id="cb96-198"><a href="#cb96-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (T <span class="cf">in</span> n_levels) {</span>
<span id="cb96-199"><a href="#cb96-199" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (J <span class="cf">in</span> jitter_levels) {</span>
<span id="cb96-200"><a href="#cb96-200" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (metric <span class="cf">in</span> metrics_to_show) {</span>
<span id="cb96-201"><a href="#cb96-201" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"[生成] T=%d, K=%d, J=%d, metric=%s</span><span class="sc">\n</span><span class="st">"</span>, T, K, J, metric))</span>
<span id="cb96-202"><a href="#cb96-202" aria-hidden="true" tabindex="-1"></a>          tab <span class="ot">&lt;-</span> <span class="fu">build_abs_plate_table</span>(metric, T, K, J,</span>
<span id="cb96-203"><a href="#cb96-203" aria-hidden="true" tabindex="-1"></a>                                       d_levels, rho_levels, snr_levels, phi_levels,</span>
<span id="cb96-204"><a href="#cb96-204" aria-hidden="true" tabindex="-1"></a>                                       R_trials, seed0,</span>
<span id="cb96-205"><a href="#cb96-205" aria-hidden="true" tabindex="-1"></a>                                       min_size,</span>
<span id="cb96-206"><a href="#cb96-206" aria-hidden="true" tabindex="-1"></a>                                       abs_beta_min, abs_beta_max, abs_beta_points, p_abs, elbow_window)</span>
<span id="cb96-207"><a href="#cb96-207" aria-hidden="true" tabindex="-1"></a>          <span class="fu">write_plate_csv_abs</span>(tab, metric, T, K, J, <span class="at">dir_out =</span> out_dir)</span>
<span id="cb96-208"><a href="#cb96-208" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb96-209"><a href="#cb96-209" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb96-210"><a href="#cb96-210" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-211"><a href="#cb96-211" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-212"><a href="#cb96-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=========== 完成 ===========</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb96-213"><a href="#cb96-213" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 5) 主控：只跑 ABS，多 J（抖动）层级</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co"># —— 参数网格（按需改）——</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>n_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">200</span>)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>K_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>d_levels    <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">200</span>)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>rho_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.8</span>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>snr_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">1.0</span>)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>phi_levels  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.25</span>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>jitter_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>L, <span class="dv">3</span>L, <span class="dv">6</span>L, <span class="dv">10</span>L)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>R_trials    <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>seed0       <span class="ot">&lt;-</span> <span class="dv">12345</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>min_size     <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>abs_beta_min <span class="ot">&lt;-</span> <span class="dv">10</span>; abs_beta_max <span class="ot">&lt;-</span> <span class="dv">50</span>; abs_beta_points <span class="ot">&lt;-</span> <span class="dv">70</span>; p_abs <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>elbow_window <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>metrics_to_show <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"F1"</span>,<span class="st">"Haus"</span>,<span class="st">"Rand"</span>,<span class="st">"Ann"</span>,<span class="st">"Time"</span>)  <span class="co"># 想精简可删</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 运行</span></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a><span class="co"># run_all_abs_plates("D:/your/path/abs_only")  # 指定保存目录；不指定则写到 ./tables_abs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="跑可视化-2" class="level2">
<h2 class="anchored" data-anchor-id="跑可视化-2">跑可视化</h2>
<ul>
<li><strong>“共享子集”设定</strong>：<span class="math inline">\(S_k \equiv S\)</span> 对所有 <span class="math inline">\(k\)</span> 相同</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="do">## (1) 生成“各维错位”的密集阶跃数据</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>simulate_staggered <span class="ot">&lt;-</span> <span class="cf">function</span>(n, d,</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>                               cps,</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">rho =</span> <span class="fl">0.6</span>,</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">delta =</span> <span class="fl">1.0</span>,</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sigma =</span> <span class="fl">1.0</span>,</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ar_phi =</span> <span class="fl">0.0</span>,</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>                               <span class="at">jitter_sd =</span> <span class="dv">0</span>L,</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">same_sign =</span> <span class="cn">TRUE</span>,</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">shared_subset =</span> <span class="cn">TRUE</span>,</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  Y   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>  mu  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>  affected <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)  <span class="co"># ★ 记录哪些维度发生过变点</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (shared_subset) {</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>    S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(K)) {</span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>    base_c <span class="ot">&lt;-</span> cps[k]</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>    Sk <span class="ot">&lt;-</span> <span class="cf">if</span> (shared_subset) S <span class="cf">else</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>    affected[Sk] <span class="ot">&lt;-</span> <span class="cn">TRUE</span>  <span class="co"># ★ 并集</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> Sk) {</span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="cf">if</span> (jitter_sd <span class="sc">&gt;</span> <span class="dv">0</span>L) <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, jitter_sd)) <span class="cf">else</span> <span class="dv">0</span>L</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>      cj  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">min</span>(n<span class="dv">-1</span>L, <span class="fu">as.integer</span>(base_c <span class="sc">+</span> eps)))</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>      step <span class="ot">&lt;-</span> signs[j] <span class="sc">*</span> delta</span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>      Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="ot">&lt;-</span> Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="sc">+</span> step</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>      mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="ot">&lt;-</span> mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="sc">+</span> step</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 噪声</span></span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) eps[t, ] <span class="ot">&lt;-</span> ar_phi<span class="sc">*</span>eps[t<span class="dv">-1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> mu <span class="sc">+</span> eps, <span class="at">true_cp =</span> cps, <span class="at">affected =</span> affected)</span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a><span class="do">## (2) 单次 ABS 检测（返回 Y、true_cp、cp_abs）</span></span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>detect_abs_once <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">T =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">50</span>, <span class="at">K =</span> <span class="dv">1</span>,</span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">snr =</span> <span class="fl">0.8</span>, <span class="at">phi =</span> <span class="dv">0</span>,</span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>                            <span class="at">jitter_sd =</span> <span class="dv">6</span>L,</span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_size =</span> <span class="dv">5</span>,</span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min =</span> <span class="dv">10</span>, <span class="at">abs_beta_max =</span> <span class="dv">50</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>                            <span class="at">seed =</span> <span class="dv">123</span>) {</span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">seq</span>(<span class="at">from =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">by =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">length.out =</span> K)))</span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_staggered</span>(<span class="at">n =</span> T, <span class="at">d =</span> d, <span class="at">cps =</span> cps,</span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> rho, <span class="at">delta =</span> snr, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> phi,</span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>                            <span class="at">jitter_sd =</span> jitter_sd, <span class="at">same_sign =</span> <span class="cn">TRUE</span>,</span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a>                            <span class="at">shared_subset =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp; affected <span class="ot">&lt;-</span> dat<span class="sc">$</span>affected</span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>  abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>    Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a>  idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a>  cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> Y, <span class="at">true_cp =</span> true_cp, <span class="at">cp_abs =</span> cp_abs, <span class="at">affected =</span> affected,</span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a>       <span class="at">params =</span> <span class="fu">list</span>(<span class="at">T=</span>T, <span class="at">d=</span>d, <span class="at">K=</span>K, <span class="at">rho=</span>rho, <span class="at">snr=</span>snr, <span class="at">phi=</span>phi, <span class="at">jitter_sd=</span>jitter_sd))</span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a><span class="do">## (3) 画图：各维并列（不重叠），蓝虚线=真实变点，红虚线=检测变点</span></span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a>plot_multidim_with_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, true_cp, detected_cp,</span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">affected_dims =</span> <span class="cn">NULL</span>,          <span class="co"># ★ 逻辑/索引：哪些维度发生过变点</span></span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">main =</span> <span class="st">"ABS detection (stacked per-dimension)"</span>,</span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">xlab =</span> <span class="st">"time"</span>, <span class="at">ylab =</span> <span class="st">"dimension (stacked)"</span>,</span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">col_normal =</span> <span class="st">"grey30"</span>,</span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">col_affected =</span> <span class="st">"lightblue"</span>) {  <span class="co"># ★ 淡蓝色</span></span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Y); d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(affected_dims)) affected_dims <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)</span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.numeric</span>(affected_dims)) {</span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d); tmp[affected_dims] <span class="ot">&lt;-</span> <span class="cn">TRUE</span>; affected_dims <span class="ot">&lt;-</span> tmp</span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 去中心 + 计算层间距</span></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a>  Yc <span class="ot">&lt;-</span> <span class="fu">scale</span>(Y, <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a>  amp <span class="ot">&lt;-</span> <span class="fu">apply</span>(Yc, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">diff</span>(<span class="fu">range</span>(x)))</span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a>  gap <span class="ot">&lt;-</span> <span class="fu">max</span>(amp); <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(gap) <span class="sc">||</span> gap <span class="sc">&lt;=</span> <span class="dv">0</span>) gap <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a>  gap <span class="ot">&lt;-</span> gap <span class="sc">*</span> <span class="fl">1.3</span></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a>  ylim_top <span class="ot">&lt;-</span> (d <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> gap</span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a>  op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">no.readonly =</span> <span class="cn">TRUE</span>); <span class="fu">on.exit</span>(<span class="fu">par</span>(op), <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="fl">2.5</span>, <span class="dv">1</span>))</span>
<span id="cb98-104"><a href="#cb98-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="cn">NA</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">1</span>, T), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span>gap<span class="sc">*</span><span class="fl">0.5</span>, ylim_top <span class="sc">+</span> gap<span class="sc">*</span><span class="fl">0.5</span>),</span>
<span id="cb98-105"><a href="#cb98-105" aria-hidden="true" tabindex="-1"></a>       <span class="at">xaxs =</span> <span class="st">"i"</span>, <span class="at">yaxs =</span> <span class="st">"i"</span>, <span class="at">xlab =</span> xlab, <span class="at">ylab =</span> ylab, <span class="at">main =</span> main,</span>
<span id="cb98-106"><a href="#cb98-106" aria-hidden="true" tabindex="-1"></a>       <span class="at">yaxt =</span> <span class="st">"n"</span>)  <span class="co"># 关闭默认 y 轴刻度</span></span>
<span id="cb98-107"><a href="#cb98-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-108"><a href="#cb98-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 逐维绘制（发生变点=淡蓝；否则灰）</span></span>
<span id="cb98-109"><a href="#cb98-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb98-110"><a href="#cb98-110" aria-hidden="true" tabindex="-1"></a>    yoff <span class="ot">&lt;-</span> (j <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> gap</span>
<span id="cb98-111"><a href="#cb98-111" aria-hidden="true" tabindex="-1"></a>    cc <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">isTRUE</span>(affected_dims[j])) col_affected <span class="cf">else</span> col_normal</span>
<span id="cb98-112"><a href="#cb98-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(<span class="fu">seq_len</span>(T), Yc[, j] <span class="sc">+</span> yoff, <span class="at">col =</span> cc, <span class="at">lwd =</span> <span class="fl">1.2</span>)</span>
<span id="cb98-113"><a href="#cb98-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-114"><a href="#cb98-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-115"><a href="#cb98-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 左侧自定义维度刻度</span></span>
<span id="cb98-116"><a href="#cb98-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at =</span> (<span class="dv">0</span><span class="sc">:</span>(d<span class="dv">-1</span>)) <span class="sc">*</span> gap, <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="st">"dim "</span>, <span class="dv">1</span><span class="sc">:</span>d), <span class="at">las =</span> <span class="dv">2</span>, <span class="at">cex.axis =</span> <span class="fl">0.7</span>)</span>
<span id="cb98-117"><a href="#cb98-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-118"><a href="#cb98-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 蓝色虚线：真实断点；红色虚线：检出断点</span></span>
<span id="cb98-119"><a href="#cb98-119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp))  <span class="cf">for</span> (v <span class="cf">in</span> true_cp)   <span class="fu">abline</span>(<span class="at">v =</span> v, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb98-120"><a href="#cb98-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(detected_cp)) <span class="cf">for</span> (v <span class="cf">in</span> detected_cp) <span class="fu">abline</span>(<span class="at">v =</span> v, <span class="at">col =</span> <span class="st">"red"</span>,  <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb98-121"><a href="#cb98-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-122"><a href="#cb98-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>,</span>
<span id="cb98-123"><a href="#cb98-123" aria-hidden="true" tabindex="-1"></a>         <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"affected dim"</span>, <span class="st">"true cp"</span>, <span class="st">"detected cp"</span>),</span>
<span id="cb98-124"><a href="#cb98-124" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(col_affected, <span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">lwd =</span> <span class="fu">c</span>(<span class="fl">1.2</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb98-125"><a href="#cb98-125" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">detect_abs_once</span>(</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">T =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">K =</span> <span class="dv">3</span>,</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">snr =</span> <span class="dv">2</span>, <span class="at">phi =</span> <span class="fl">0.0</span>,</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">jitter_sd =</span> <span class="dv">6</span>L,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>,</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">397492</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_multidim_with_cps</span>(</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> res<span class="sc">$</span>Y,</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">true_cp =</span> res<span class="sc">$</span>true_cp,</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">detected_cp =</span> res<span class="sc">$</span>cp_abs,</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">affected_dims =</span> res<span class="sc">$</span>affected,   </span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="fu">sprintf</span>(<span class="st">"ABS (T=%d, d=%d, K=%d, jitter=%d)"</span>,</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>                 res<span class="sc">$</span>params<span class="sc">$</span>T, res<span class="sc">$</span>params<span class="sc">$</span>d, res<span class="sc">$</span>params<span class="sc">$</span>K, res<span class="sc">$</span>params<span class="sc">$</span>jitter_sd)</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成 100 个 N(0, 12) 的随机数</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">12</span>))</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(x)  <span class="co"># 查看前6个</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(x)  <span class="co"># 查看基本统计量</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>ABS 在多维“先后错位”场景下，能否把一团分散的单维变点拉到同一中心？</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>simulate_staggered <span class="ot">&lt;-</span> <span class="cf">function</span>(n, d, cps, <span class="at">rho=</span><span class="fl">0.6</span>, <span class="at">delta=</span><span class="dv">1</span>, <span class="at">sigma=</span><span class="dv">1</span>, <span class="at">ar_phi=</span><span class="dv">0</span>,</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">jitter_sd=</span><span class="dv">0</span>L, <span class="at">same_sign=</span><span class="cn">TRUE</span>, <span class="at">shared_subset=</span><span class="cn">TRUE</span>, <span class="at">seed=</span><span class="cn">NULL</span>) {</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps))); K <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d); mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  affected <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  cp_per_dim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_integer_</span>, <span class="at">nrow=</span>d, <span class="at">ncol=</span>K)   <span class="co"># 每维在第 k 个基线变点的实际时刻</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (shared_subset) S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size=</span><span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho<span class="sc">*</span>d)), <span class="at">replace=</span><span class="cn">FALSE</span>))</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), d, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(K)) {</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    base_c <span class="ot">&lt;-</span> cps[k]</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    Sk <span class="ot">&lt;-</span> <span class="cf">if</span> (shared_subset) S <span class="cf">else</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size=</span><span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho<span class="sc">*</span>d)), <span class="at">replace=</span><span class="cn">FALSE</span>))</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>    affected[Sk] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> Sk) {</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="cf">if</span> (jitter_sd <span class="sc">&gt;</span> <span class="dv">0</span>L) <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, jitter_sd)) <span class="cf">else</span> <span class="dv">0</span>L</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>      cj  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">min</span>(n<span class="dv">-1</span>L, <span class="fu">as.integer</span>(base_c <span class="sc">+</span> eps)))</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>      cp_per_dim[j, k] <span class="ot">&lt;-</span> cj       <span class="co"># 记录该维的实际变点时刻</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>      step <span class="ot">&lt;-</span> signs[j] <span class="sc">*</span> delta</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>      Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="ot">&lt;-</span> Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="sc">+</span> step</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>      mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="ot">&lt;-</span> mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="sc">+</span> step</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 噪声</span></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) eps[t, ] <span class="ot">&lt;-</span> ar_phi<span class="sc">*</span>eps[t<span class="dv">-1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> mu <span class="sc">+</span> eps, <span class="at">true_cp =</span> cps, <span class="at">affected =</span> affected, <span class="at">cp_per_dim =</span> cp_per_dim)</span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>detect_abs_once <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">T=</span><span class="dv">200</span>, <span class="at">d=</span><span class="dv">50</span>, <span class="at">K=</span><span class="dv">1</span>, <span class="at">rho=</span><span class="fl">0.7</span>, <span class="at">snr=</span><span class="fl">0.8</span>, <span class="at">phi=</span><span class="dv">0</span>,</span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>                            <span class="at">jitter_sd=</span><span class="dv">6</span>L, <span class="at">min_size=</span><span class="dv">5</span>,</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min=</span><span class="dv">10</span>, <span class="at">abs_beta_max=</span><span class="dv">50</span>, <span class="at">abs_beta_points=</span><span class="dv">70</span>, <span class="at">p_abs=</span><span class="dv">2</span>,</span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window=</span><span class="dv">10</span>, <span class="at">seed=</span><span class="dv">123</span>) {</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">seq</span>(<span class="at">from=</span>T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">by=</span>T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">length.out=</span>K)))</span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_staggered</span>(T, d, cps, rho, snr, <span class="fl">1.0</span>, phi, jitter_sd, <span class="cn">TRUE</span>, <span class="cn">TRUE</span>, seed)</span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp; affected <span class="ot">&lt;-</span> dat<span class="sc">$</span>affected; cp_per_dim <span class="ot">&lt;-</span> dat<span class="sc">$</span>cp_per_dim</span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a>  abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>    Y, <span class="at">beta_min=</span>abs_beta_min, <span class="at">beta_max=</span>abs_beta_max, <span class="at">beta_points=</span>abs_beta_points,</span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_size=</span>min_size, <span class="at">p=</span>p_abs, <span class="at">elbow_window=</span>elbow_window, <span class="at">verbose=</span><span class="cn">FALSE</span></span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a>  idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a>  cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb101-53"><a href="#cb101-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-54"><a href="#cb101-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y=</span>Y, <span class="at">true_cp=</span>true_cp, <span class="at">cp_abs=</span>cp_abs, <span class="at">affected=</span>affected, <span class="at">cp_per_dim=</span>cp_per_dim,</span>
<span id="cb101-55"><a href="#cb101-55" aria-hidden="true" tabindex="-1"></a>       <span class="at">params=</span><span class="fu">list</span>(<span class="at">T=</span>T,<span class="at">d=</span>d,<span class="at">K=</span>K,<span class="at">rho=</span>rho,<span class="at">snr=</span>snr,<span class="at">phi=</span>phi,<span class="at">jitter_sd=</span>jitter_sd))</span>
<span id="cb101-56"><a href="#cb101-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-57"><a href="#cb101-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-58"><a href="#cb101-58" aria-hidden="true" tabindex="-1"></a>plot_multidim_with_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, true_cp, detected_cp,</span>
<span id="cb101-59"><a href="#cb101-59" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">affected_dims=</span><span class="cn">NULL</span>, <span class="at">cp_per_dim=</span><span class="cn">NULL</span>,   <span class="co"># ★ 新增</span></span>
<span id="cb101-60"><a href="#cb101-60" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">main=</span><span class="st">"ABS detection (stacked per-dimension)"</span>,</span>
<span id="cb101-61"><a href="#cb101-61" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">xlab=</span><span class="st">"time"</span>, <span class="at">ylab=</span><span class="st">"dimension (stacked)"</span>,</span>
<span id="cb101-62"><a href="#cb101-62" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">col_normal=</span><span class="st">"grey70"</span>, <span class="at">col_affected=</span><span class="st">"lightblue"</span>) {</span>
<span id="cb101-63"><a href="#cb101-63" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Y); d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb101-64"><a href="#cb101-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(affected_dims)) affected_dims <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)</span>
<span id="cb101-65"><a href="#cb101-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.numeric</span>(affected_dims)) { tmp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d); tmp[affected_dims] <span class="ot">&lt;-</span> <span class="cn">TRUE</span>; affected_dims <span class="ot">&lt;-</span> tmp }</span>
<span id="cb101-66"><a href="#cb101-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-67"><a href="#cb101-67" aria-hidden="true" tabindex="-1"></a>  Yc <span class="ot">&lt;-</span> <span class="fu">scale</span>(Y, <span class="at">center=</span><span class="cn">TRUE</span>, <span class="at">scale=</span><span class="cn">FALSE</span>)</span>
<span id="cb101-68"><a href="#cb101-68" aria-hidden="true" tabindex="-1"></a>  amp <span class="ot">&lt;-</span> <span class="fu">apply</span>(Yc, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">diff</span>(<span class="fu">range</span>(x))); gap <span class="ot">&lt;-</span> <span class="fu">max</span>(amp); <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(gap)<span class="sc">||</span>gap<span class="sc">&lt;=</span><span class="dv">0</span>) gap <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb101-69"><a href="#cb101-69" aria-hidden="true" tabindex="-1"></a>  gap <span class="ot">&lt;-</span> gap <span class="sc">*</span> <span class="fl">1.3</span>; ylim_top <span class="ot">&lt;-</span> (d<span class="dv">-1</span>)<span class="sc">*</span>gap</span>
<span id="cb101-70"><a href="#cb101-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-71"><a href="#cb101-71" aria-hidden="true" tabindex="-1"></a>  op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">no.readonly=</span><span class="cn">TRUE</span>); <span class="fu">on.exit</span>(<span class="fu">par</span>(op), <span class="at">add=</span><span class="cn">TRUE</span>); <span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="fl">2.5</span>,<span class="dv">1</span>))</span>
<span id="cb101-72"><a href="#cb101-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="cn">NA</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>,T), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span>gap<span class="sc">*</span><span class="fl">0.5</span>, ylim_top<span class="sc">+</span>gap<span class="sc">*</span><span class="fl">0.5</span>),</span>
<span id="cb101-73"><a href="#cb101-73" aria-hidden="true" tabindex="-1"></a>       <span class="at">xaxs=</span><span class="st">"i"</span>, <span class="at">yaxs=</span><span class="st">"i"</span>, <span class="at">xlab=</span>xlab, <span class="at">ylab=</span>ylab, <span class="at">main=</span>main, <span class="at">yaxt=</span><span class="st">"n"</span>)</span>
<span id="cb101-74"><a href="#cb101-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-75"><a href="#cb101-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb101-76"><a href="#cb101-76" aria-hidden="true" tabindex="-1"></a>    yoff <span class="ot">&lt;-</span> (j<span class="dv">-1</span>)<span class="sc">*</span>gap</span>
<span id="cb101-77"><a href="#cb101-77" aria-hidden="true" tabindex="-1"></a>    cc <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">isTRUE</span>(affected_dims[j])) col_affected <span class="cf">else</span> col_normal</span>
<span id="cb101-78"><a href="#cb101-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(<span class="fu">seq_len</span>(T), Yc[,j] <span class="sc">+</span> yoff, <span class="at">col=</span>cc, <span class="at">lwd=</span><span class="fl">1.2</span>)</span>
<span id="cb101-79"><a href="#cb101-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 画该维的错位刻度（若提供）</span></span>
<span id="cb101-80"><a href="#cb101-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cp_per_dim)) {</span>
<span id="cb101-81"><a href="#cb101-81" aria-hidden="true" tabindex="-1"></a>      v <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cp_per_dim[j, ])</span>
<span id="cb101-82"><a href="#cb101-82" aria-hidden="true" tabindex="-1"></a>      v <span class="ot">&lt;-</span> v[<span class="fu">is.finite</span>(v)]</span>
<span id="cb101-83"><a href="#cb101-83" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(v)) {</span>
<span id="cb101-84"><a href="#cb101-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 画短横：在 yoff 附近一小段（± 0.15*gap）</span></span>
<span id="cb101-85"><a href="#cb101-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (x0 <span class="cf">in</span> v) <span class="fu">segments</span>(x0, yoff<span class="fl">-0.15</span><span class="sc">*</span>gap, x0, yoff<span class="fl">+0.15</span><span class="sc">*</span>gap, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="cb101-86"><a href="#cb101-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-87"><a href="#cb101-87" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb101-88"><a href="#cb101-88" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb101-89"><a href="#cb101-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-90"><a href="#cb101-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-91"><a href="#cb101-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at=</span>(<span class="dv">0</span><span class="sc">:</span>(d<span class="dv">-1</span>))<span class="sc">*</span>gap, <span class="at">labels=</span><span class="fu">paste0</span>(<span class="st">"dim "</span>,<span class="dv">1</span><span class="sc">:</span>d), <span class="at">las=</span><span class="dv">2</span>, <span class="at">cex.axis=</span><span class="fl">0.7</span>)</span>
<span id="cb101-92"><a href="#cb101-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-93"><a href="#cb101-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp))     <span class="cf">for</span> (v <span class="cf">in</span> true_cp)   <span class="fu">abline</span>(<span class="at">v=</span>v, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb101-94"><a href="#cb101-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(detected_cp)) <span class="cf">for</span> (v <span class="cf">in</span> detected_cp) <span class="fu">abline</span>(<span class="at">v=</span>v, <span class="at">col=</span><span class="st">"red"</span>,  <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb101-95"><a href="#cb101-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-96"><a href="#cb101-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>,</span>
<span id="cb101-97"><a href="#cb101-97" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"ABS cp"</span>, <span class="st">"true cp"</span>, <span class="st">"per-dim jitter cp"</span>, <span class="st">"affected dim"</span>),</span>
<span id="cb101-98"><a href="#cb101-98" aria-hidden="true" tabindex="-1"></a>       <span class="at">col    =</span> <span class="fu">c</span>(<span class="st">"red"</span>,    <span class="st">"blue"</span>,    <span class="st">"blue"</span>,             col_affected),</span>
<span id="cb101-99"><a href="#cb101-99" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty    =</span> <span class="fu">c</span>(<span class="dv">2</span>,        <span class="dv">2</span>,         <span class="cn">NA</span>,                 <span class="dv">1</span>),</span>
<span id="cb101-100"><a href="#cb101-100" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch    =</span> <span class="fu">c</span>(<span class="cn">NA</span>,       <span class="cn">NA</span>,        <span class="dv">124</span>,                <span class="cn">NA</span>),</span>
<span id="cb101-101"><a href="#cb101-101" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd    =</span> <span class="fu">c</span>(<span class="dv">2</span>,        <span class="dv">2</span>,         <span class="cn">NA</span>,                 <span class="fl">1.2</span>),</span>
<span id="cb101-102"><a href="#cb101-102" aria-hidden="true" tabindex="-1"></a>       <span class="at">pt.cex =</span> <span class="fu">c</span>(<span class="cn">NA</span>,       <span class="cn">NA</span>,        <span class="fl">1.5</span>,                <span class="cn">NA</span>),</span>
<span id="cb101-103"><a href="#cb101-103" aria-hidden="true" tabindex="-1"></a>       <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb101-104"><a href="#cb101-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-105"><a href="#cb101-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-106"><a href="#cb101-106" aria-hidden="true" tabindex="-1"></a><span class="do">########“聚拢度”指标（单次）</span></span>
<span id="cb101-107"><a href="#cb101-107" aria-hidden="true" tabindex="-1"></a>cohesion_metrics_abs <span class="ot">&lt;-</span> <span class="cf">function</span>(cp_abs, cp_per_dim, <span class="at">tol=</span><span class="dv">3</span>L) {</span>
<span id="cb101-108"><a href="#cb101-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cp_per_dim: d × K, NA 表示该维未受影响</span></span>
<span id="cb101-109"><a href="#cb101-109" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(cp_per_dim); d <span class="ot">&lt;-</span> <span class="fu">nrow</span>(cp_per_dim)</span>
<span id="cb101-110"><a href="#cb101-110" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(cp_abs) <span class="sc">!=</span> K) <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pull_in=</span><span class="cn">NA</span>, <span class="at">center_err=</span><span class="cn">NA</span>, <span class="at">cloud_iqr=</span><span class="cn">NA</span>))</span>
<span id="cb101-111"><a href="#cb101-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-112"><a href="#cb101-112" aria-hidden="true" tabindex="-1"></a>  pull_in <span class="ot">&lt;-</span> <span class="fu">numeric</span>(K); center_err <span class="ot">&lt;-</span> <span class="fu">numeric</span>(K); cloud_iqr <span class="ot">&lt;-</span> <span class="fu">numeric</span>(K)</span>
<span id="cb101-113"><a href="#cb101-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb101-114"><a href="#cb101-114" aria-hidden="true" tabindex="-1"></a>    vk <span class="ot">&lt;-</span> cp_per_dim[,k]; vk <span class="ot">&lt;-</span> vk[<span class="sc">!</span><span class="fu">is.na</span>(vk)]   <span class="co"># 受影响的维度</span></span>
<span id="cb101-115"><a href="#cb101-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(vk)) { pull_in[k] <span class="ot">&lt;-</span> <span class="cn">NA</span>; center_err[k] <span class="ot">&lt;-</span> <span class="cn">NA</span>; cloud_iqr[k] <span class="ot">&lt;-</span> <span class="cn">NA</span>; <span class="cf">next</span> }</span>
<span id="cb101-116"><a href="#cb101-116" aria-hidden="true" tabindex="-1"></a>    pull_in[k]   <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(vk <span class="sc">-</span> cp_abs[k]) <span class="sc">&lt;=</span> tol)            <span class="co"># 拉拢率</span></span>
<span id="cb101-117"><a href="#cb101-117" aria-hidden="true" tabindex="-1"></a>    center_err[k] <span class="ot">&lt;-</span> <span class="fu">abs</span>(cp_abs[k] <span class="sc">-</span> <span class="fu">median</span>(vk))                <span class="co"># 与“云中位数”的偏差</span></span>
<span id="cb101-118"><a href="#cb101-118" aria-hidden="true" tabindex="-1"></a>    cloud_iqr[k]  <span class="ot">&lt;-</span> <span class="fu">IQR</span>(vk)                                    <span class="co"># “云的宽度”</span></span>
<span id="cb101-119"><a href="#cb101-119" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-120"><a href="#cb101-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">pull_in =</span> <span class="fu">mean</span>(pull_in, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb101-121"><a href="#cb101-121" aria-hidden="true" tabindex="-1"></a>       <span class="at">center_err =</span> <span class="fu">median</span>(center_err, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb101-122"><a href="#cb101-122" aria-hidden="true" tabindex="-1"></a>       <span class="at">cloud_iqr =</span> <span class="fu">median</span>(cloud_iqr, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb101-123"><a href="#cb101-123" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">detect_abs_once</span>(</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">T =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">K =</span> <span class="dv">3</span>,</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">snr =</span> <span class="dv">2</span>, <span class="at">phi =</span> <span class="fl">0.0</span>,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">jitter_sd =</span> <span class="dv">6</span>L,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">397492</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_multidim_with_cps</span>(res<span class="sc">$</span>Y, res<span class="sc">$</span>true_cp, res<span class="sc">$</span>cp_abs, <span class="at">affected_dims=</span>res<span class="sc">$</span>affected, <span class="at">cp_per_dim=</span>res<span class="sc">$</span>cp_per_dim,</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">main=</span><span class="fu">sprintf</span>(<span class="st">"ABS (T=%d, d=%d, K=%d, jitter=%d)"</span>, </span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>                                    res<span class="sc">$</span>params<span class="sc">$</span>T, res<span class="sc">$</span>params<span class="sc">$</span>d, res<span class="sc">$</span>params<span class="sc">$</span>K, res<span class="sc">$</span>params<span class="sc">$</span>jitter_sd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Simulation_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>coh <span class="ot">&lt;-</span> <span class="fu">cohesion_metrics_abs</span>(res<span class="sc">$</span>cp_abs, res<span class="sc">$</span>cp_per_dim, <span class="at">tol=</span><span class="dv">3</span>L)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>coh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$pull_in
[1] 0.524

$center_err
[1] 2

$cloud_iqr
[1] 4.5</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># $pull_in   ~ 0.8~0.95   （越高越好）</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># $center_err~ 0~1        （越小越好）</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="co"># $cloud_iqr ~ 4~12       （云很宽，但 ABS 仍抓住中心）</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb106" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Simulation"</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> left</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> true</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="an">warning:</span><span class="co"> false</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: true #全局缓存</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a><span class="an">knitr:</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="co">  opts_chunk:</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="co">    digits: 3  </span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true        # 允许折叠代码</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-fold: true  # 默认折叠（关闭）所有代码块</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE,message=FALSE}</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(changepoint)) install.packages("changepoint")</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(patchwork)) install.packages("patchwork")</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(readxl)) install.packages("readxl")</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(ggplot2)) install.packages("ggplot2")</span></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(reshape2)) install.packages("reshape2")</span></span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(dplyr)) install.packages("dplyr")</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(plotly)) install.packages("plotly")</span></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(shiny)) install.packages("shiny")</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(highcharter)) install.packages("highcharter")</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(gridExtra)) install.packages("gridExtra")</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(DT)) install.packages("DT")</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(purrr)) install.packages("purrr")</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(tidyr)) install.packages("tidyr")</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(rTensor)) install.packages("rTensor")</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(changepoint)) install.packages("changepoint")</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a><span class="in">#multiway 专为多向数组（张量）分析设计的包，提供CP分解（PARAFAC）的实现</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(multiway)) install.packages("multiway")</span></span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a><span class="in">library(multiway)</span></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a><span class="in">#ThreeWay </span></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(ThreeWay)) install.packages("ThreeWay")</span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a><span class="in">library(ThreeWay)</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a><span class="in">#nntensor 专注于非负张量分解的包，但也可用于普通CP分解</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require(nnTensor)) install.packages("nnTensor")</span></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a><span class="in">library(nnTensor)</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a><span class="in">library(changepoint) # 变点检测</span></span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)   # 拼接多个 ggplot 图</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a><span class="in">library(readxl)</span></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a><span class="in"># 导入ggplot2包</span></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a><span class="in">library(reshape2)</span></span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a><span class="in">library(plotly)</span></span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a><span class="in">library(shiny)</span></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a><span class="in">library(highcharter)</span></span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a><span class="in">library(ecp)</span></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyr)</span></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3) </span></span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a>abs算法code</span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a><span class="do">## 0) 工具与可重复性</span></span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a><span class="do">## 内部加速工具（不改变对外 API）</span></span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a><span class="do">## 说明：</span></span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a><span class="do">## - 通过一次性构建按行的列累积和 (cumsums) 来将任意区间均值计算从 O(k) 降到 O(1)</span></span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a><span class="do">## - 所有优化均以隐式属性附着在 Y 上（attr(Y, "._csum")），</span></span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a><span class="do">##   若缺失则在首次调用时自动构建；对外函数名、参数与用法保持不变</span></span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a>.ensure_cumsum <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cs)) {</span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 构建 n+1 x p 的累计和矩阵：第 1 行是 0，便于用差分快速得到任意区间和</span></span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a>    cs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(Y)),</span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(Y, <span class="dv">2</span>, cumsum))</span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>) <span class="ot">&lt;-</span> cs</span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a>.segment_means_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(cs, t_left, t_mid, t_right) {</span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cs 的行索引与时间点对齐：第 0 个时间点位于行 1</span></span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 区间 (t_left+1):t_mid 与 (t_mid+1):t_right</span></span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a>  sum1 <span class="ot">&lt;-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_left <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a>  sum2 <span class="ot">&lt;-</span> cs[t_right <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> sum1 <span class="sc">/</span> n1</span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> sum2 <span class="sc">/</span> n2</span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">mean1 =</span> mean1, <span class="at">mean2 =</span> mean2, <span class="at">n1 =</span> n1, <span class="at">n2 =</span> n2)</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 代价函数 &amp; 二元分割（保持 API，不改变名称/参数）</span></span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 尝试使用累计和加速；若不可用则回退到原始实现</span></span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cs)) {</span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a>    seg <span class="ot">&lt;-</span> <span class="fu">.segment_means_fast</span>(cs, t_left, t_mid, t_right)</span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a>    n1 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n1; n2 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n2; n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb106-117"><a href="#cb106-117" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(seg<span class="sc">$</span>mean2 <span class="sc">-</span> seg<span class="sc">$</span>mean1)</span>
<span id="cb106-118"><a href="#cb106-118" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weight <span class="sc">*</span> norm_p)</span>
<span id="cb106-125"><a href="#cb106-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-126"><a href="#cb106-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 回退路径（仅在未预先构建 cumsum 时触发）</span></span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a>  diff  <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb106-133"><a href="#cb106-133" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb106-134"><a href="#cb106-134" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb106-135"><a href="#cb106-135" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb106-136"><a href="#cb106-136" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-137"><a href="#cb106-137" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb106-138"><a href="#cb106-138" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-139"><a href="#cb106-139" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">*</span> norm_p</span>
<span id="cb106-140"><a href="#cb106-140" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-141"><a href="#cb106-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-142"><a href="#cb106-142" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb106-143"><a href="#cb106-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 确保累计和已存在（若无则自动构建）</span></span>
<span id="cb106-144"><a href="#cb106-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb106-145"><a href="#cb106-145" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb106-146"><a href="#cb106-146" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb106-147"><a href="#cb106-147" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">*</span> min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb106-148"><a href="#cb106-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-149"><a href="#cb106-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-150"><a href="#cb106-150" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb106-151"><a href="#cb106-151" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-152"><a href="#cb106-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用累计和的 compute_cost，按扫描区间求最大增益</span></span>
<span id="cb106-153"><a href="#cb106-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb106-154"><a href="#cb106-154" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb106-155"><a href="#cb106-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb106-156"><a href="#cb106-156" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain; best_t <span class="ot">&lt;-</span> t</span>
<span id="cb106-157"><a href="#cb106-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-158"><a href="#cb106-158" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-159"><a href="#cb106-159" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb106-160"><a href="#cb106-160" aria-hidden="true" tabindex="-1"></a>    left  <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb106-161"><a href="#cb106-161" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb106-162"><a href="#cb106-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb106-163"><a href="#cb106-163" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-164"><a href="#cb106-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-165"><a href="#cb106-165" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-166"><a href="#cb106-166" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-167"><a href="#cb106-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-168"><a href="#cb106-168" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-169"><a href="#cb106-169" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 稳定路径：手肘 + 平台 (Kneedle + plateau)</span></span>
<span id="cb106-170"><a href="#cb106-170" aria-hidden="true" tabindex="-1"></a><span class="do">##    （内部同样利用累计和以复用加速）</span></span>
<span id="cb106-171"><a href="#cb106-171" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-172"><a href="#cb106-172" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-173"><a href="#cb106-173" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>]); p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb106-174"><a href="#cb106-174" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb106-175"><a href="#cb106-175" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]); dy <span class="ot">&lt;-</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])</span>
<span id="cb106-176"><a href="#cb106-176" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb106-177"><a href="#cb106-177" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb106-178"><a href="#cb106-178" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb106-179"><a href="#cb106-179" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>(dy <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> dx <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span> denom</span>
<span id="cb106-180"><a href="#cb106-180" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-181"><a href="#cb106-181" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb106-182"><a href="#cb106-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx)</span>
<span id="cb106-183"><a href="#cb106-183" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-184"><a href="#cb106-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-185"><a href="#cb106-185" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-186"><a href="#cb106-186" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-187"><a href="#cb106-187" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb106-188"><a href="#cb106-188" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb106-189"><a href="#cb106-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i <span class="sc">-</span> <span class="dv">1</span>]) {</span>
<span id="cb106-190"><a href="#cb106-190" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-191"><a href="#cb106-191" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start, <span class="at">end =</span> i <span class="sc">-</span> <span class="dv">1</span>, <span class="at">value =</span> y[i <span class="sc">-</span> <span class="dv">1</span>], <span class="at">length =</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-192"><a href="#cb106-192" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-193"><a href="#cb106-193" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb106-194"><a href="#cb106-194" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-195"><a href="#cb106-195" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-196"><a href="#cb106-196" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-197"><a href="#cb106-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start, <span class="at">end =</span> <span class="fu">length</span>(y), <span class="at">value =</span> y[<span class="fu">length</span>(y)], <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-198"><a href="#cb106-198" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-199"><a href="#cb106-199" aria-hidden="true" tabindex="-1"></a>  plateaus</span>
<span id="cb106-200"><a href="#cb106-200" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-201"><a href="#cb106-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-202"><a href="#cb106-202" aria-hidden="true" tabindex="-1"></a>adaptive_binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb106-203"><a href="#cb106-203" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-204"><a href="#cb106-204" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-205"><a href="#cb106-205" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-206"><a href="#cb106-206" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 预先构建累计和，加速所有后续成本评估</span></span>
<span id="cb106-207"><a href="#cb106-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb106-208"><a href="#cb106-208" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb106-209"><a href="#cb106-209" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb106-210"><a href="#cb106-210" aria-hidden="true" tabindex="-1"></a>  bp_counts <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb106-211"><a href="#cb106-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-212"><a href="#cb106-212" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb106-213"><a href="#cb106-213" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb106-214"><a href="#cb106-214" aria-hidden="true" tabindex="-1"></a>    t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, b, <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb106-215"><a href="#cb106-215" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb106-216"><a href="#cb106-216" aria-hidden="true" tabindex="-1"></a>    bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb106-217"><a href="#cb106-217" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-218"><a href="#cb106-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-219"><a href="#cb106-219" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb106-220"><a href="#cb106-220" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb106-221"><a href="#cb106-221" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb106-222"><a href="#cb106-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-223"><a href="#cb106-223" aria-hidden="true" tabindex="-1"></a>  left_bound <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb106-224"><a href="#cb106-224" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb106-225"><a href="#cb106-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-226"><a href="#cb106-226" aria-hidden="true" tabindex="-1"></a>  best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-227"><a href="#cb106-227" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb106-228"><a href="#cb106-228" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound) <span class="sc">&amp;&amp;</span> (pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound)) {</span>
<span id="cb106-229"><a href="#cb106-229" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) best_plateau <span class="ot">&lt;-</span> pp</span>
<span id="cb106-230"><a href="#cb106-230" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-231"><a href="#cb106-231" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-232"><a href="#cb106-232" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb106-233"><a href="#cb106-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-234"><a href="#cb106-234" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) {</span>
<span id="cb106-235"><a href="#cb106-235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-236"><a href="#cb106-236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb106-237"><a href="#cb106-237" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb106-238"><a href="#cb106-238" aria-hidden="true" tabindex="-1"></a>                  beta_list[pp<span class="sc">$</span>start], beta_list[pp<span class="sc">$</span>end], pp<span class="sc">$</span>length, pp<span class="sc">$</span>value))</span>
<span id="cb106-239"><a href="#cb106-239" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-240"><a href="#cb106-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Elbow 候选 β = %.2f</span><span class="sc">\n</span><span class="st">"</span>, el<span class="sc">$</span>beta))</span>
<span id="cb106-241"><a href="#cb106-241" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span><span class="sc">\n\n</span><span class="st">"</span>, best_beta))</span>
<span id="cb106-242"><a href="#cb106-242" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-243"><a href="#cb106-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-244"><a href="#cb106-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb106-245"><a href="#cb106-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_list =</span> beta_list,</span>
<span id="cb106-246"><a href="#cb106-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">bp_counts =</span> bp_counts,</span>
<span id="cb106-247"><a href="#cb106-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> results,</span>
<span id="cb106-248"><a href="#cb106-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">plateaus =</span> plateaus,</span>
<span id="cb106-249"><a href="#cb106-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb106-250"><a href="#cb106-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">best_beta =</span> best_beta</span>
<span id="cb106-251"><a href="#cb106-251" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-252"><a href="#cb106-252" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-253"><a href="#cb106-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-254"><a href="#cb106-254" aria-hidden="true" tabindex="-1"></a>plot_segmentation_path <span class="ot">&lt;-</span> <span class="cf">function</span>(res) {</span>
<span id="cb106-255"><a href="#cb106-255" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> res<span class="sc">$</span>beta_list; bp_counts <span class="ot">&lt;-</span> res<span class="sc">$</span>bp_counts</span>
<span id="cb106-256"><a href="#cb106-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb106-257"><a href="#cb106-257" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb106-258"><a href="#cb106-258" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb106-259"><a href="#cb106-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-260"><a href="#cb106-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>best_beta,  <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-261"><a href="#cb106-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb106-262"><a href="#cb106-262" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb106-263"><a href="#cb106-263" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-264"><a href="#cb106-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-265"><a href="#cb106-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-266"><a href="#cb106-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-267"><a href="#cb106-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-268"><a href="#cb106-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-269"><a href="#cb106-269" aria-hidden="true" tabindex="-1"></a>数据导入</span>
<span id="cb106-270"><a href="#cb106-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-271"><a href="#cb106-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning=FALSE,message=FALSE}</span></span>
<span id="cb106-272"><a href="#cb106-272" aria-hidden="true" tabindex="-1"></a><span class="in"># 定义一个函数，读取指定文件夹中的所有 Excel 文件</span></span>
<span id="cb106-273"><a href="#cb106-273" aria-hidden="true" tabindex="-1"></a><span class="in">read_excel_files_in_directory &lt;- function(directory_path) {</span></span>
<span id="cb106-274"><a href="#cb106-274" aria-hidden="true" tabindex="-1"></a><span class="in">  # 获取指定目录下的所有 Excel 文件（以 .xlsx 或 .xls 结尾）</span></span>
<span id="cb106-275"><a href="#cb106-275" aria-hidden="true" tabindex="-1"></a><span class="in">  excel_files &lt;- list.files(directory_path, pattern = "\\.xlsx$|\\.xls$", full.names = TRUE)</span></span>
<span id="cb106-276"><a href="#cb106-276" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-277"><a href="#cb106-277" aria-hidden="true" tabindex="-1"></a><span class="in">  # 创建一个空的列表来存储读取的数据</span></span>
<span id="cb106-278"><a href="#cb106-278" aria-hidden="true" tabindex="-1"></a><span class="in">  data_list &lt;- list()</span></span>
<span id="cb106-279"><a href="#cb106-279" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-280"><a href="#cb106-280" aria-hidden="true" tabindex="-1"></a><span class="in">  # 遍历每个 Excel 文件</span></span>
<span id="cb106-281"><a href="#cb106-281" aria-hidden="true" tabindex="-1"></a><span class="in">  for (file in excel_files) {</span></span>
<span id="cb106-282"><a href="#cb106-282" aria-hidden="true" tabindex="-1"></a><span class="in">    # 读取 Excel 文件的数据</span></span>
<span id="cb106-283"><a href="#cb106-283" aria-hidden="true" tabindex="-1"></a><span class="in">    try({</span></span>
<span id="cb106-284"><a href="#cb106-284" aria-hidden="true" tabindex="-1"></a><span class="in">      df &lt;- read_excel(file)</span></span>
<span id="cb106-285"><a href="#cb106-285" aria-hidden="true" tabindex="-1"></a><span class="in">      data_list[[file]] &lt;- df</span></span>
<span id="cb106-286"><a href="#cb106-286" aria-hidden="true" tabindex="-1"></a><span class="in">      print(paste("成功读取文件:", file))</span></span>
<span id="cb106-287"><a href="#cb106-287" aria-hidden="true" tabindex="-1"></a><span class="in">    }, silent = TRUE)</span></span>
<span id="cb106-288"><a href="#cb106-288" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb106-289"><a href="#cb106-289" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-290"><a href="#cb106-290" aria-hidden="true" tabindex="-1"></a><span class="in">  # 返回一个包含所有文件数据的列表</span></span>
<span id="cb106-291"><a href="#cb106-291" aria-hidden="true" tabindex="-1"></a><span class="in">  return(data_list)</span></span>
<span id="cb106-292"><a href="#cb106-292" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-293"><a href="#cb106-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-294"><a href="#cb106-294" aria-hidden="true" tabindex="-1"></a><span class="in"># 指定文件夹路径</span></span>
<span id="cb106-295"><a href="#cb106-295" aria-hidden="true" tabindex="-1"></a><span class="in">directory_path &lt;- "C:/Users/86133/Desktop/software/changepoint/rawdata/per_game"</span></span>
<span id="cb106-296"><a href="#cb106-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-297"><a href="#cb106-297" aria-hidden="true" tabindex="-1"></a><span class="in"># 调用函数读取并存储所有 Excel 文件</span></span>
<span id="cb106-298"><a href="#cb106-298" aria-hidden="true" tabindex="-1"></a><span class="in">pergame_list &lt;- read_excel_files_in_directory(directory_path)</span></span>
<span id="cb106-299"><a href="#cb106-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-300"><a href="#cb106-300" aria-hidden="true" tabindex="-1"></a><span class="in"># 如果需要将所有文件的数据合并为一个大的数据框</span></span>
<span id="cb106-301"><a href="#cb106-301" aria-hidden="true" tabindex="-1"></a><span class="in">combinedpergame_data &lt;- do.call(rbind, pergame_list)</span></span>
<span id="cb106-302"><a href="#cb106-302" aria-hidden="true" tabindex="-1"></a><span class="in"># 输出合并后的数据框</span></span>
<span id="cb106-303"><a href="#cb106-303" aria-hidden="true" tabindex="-1"></a><span class="in">print(combinedpergame_data)</span></span>
<span id="cb106-304"><a href="#cb106-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-305"><a href="#cb106-305" aria-hidden="true" tabindex="-1"></a><span class="in">combinedpergame_data &lt;- do.call(rbind, pergame_list)</span></span>
<span id="cb106-306"><a href="#cb106-306" aria-hidden="true" tabindex="-1"></a><span class="in">subpergame &lt;- pergame_list[[1]][,2:ncol(pergame_list[[1]])]</span></span>
<span id="cb106-307"><a href="#cb106-307" aria-hidden="true" tabindex="-1"></a><span class="in">pergame_mean &lt;- data.frame(matrix(NA, nrow = 0, ncol = ncol(subpergame)))</span></span>
<span id="cb106-308"><a href="#cb106-308" aria-hidden="true" tabindex="-1"></a><span class="in">colnames(pergame_mean) &lt;- colnames(subpergame)</span></span>
<span id="cb106-309"><a href="#cb106-309" aria-hidden="true" tabindex="-1"></a><span class="in">colnames(pergame_mean)[1] &lt;- "year"</span></span>
<span id="cb106-310"><a href="#cb106-310" aria-hidden="true" tabindex="-1"></a><span class="in">pergame_var &lt;- pergame_mean</span></span>
<span id="cb106-311"><a href="#cb106-311" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:length(pergame_list)) {</span></span>
<span id="cb106-312"><a href="#cb106-312" aria-hidden="true" tabindex="-1"></a><span class="in">  subpergame &lt;- pergame_list[[i]][,2:ncol(pergame_list[[i]])]</span></span>
<span id="cb106-313"><a href="#cb106-313" aria-hidden="true" tabindex="-1"></a><span class="in">  pergame_mean[i,] &lt;- sapply(subpergame, function(x) if (is.numeric(x)) mean(x, na.rm = TRUE) else NA)</span></span>
<span id="cb106-314"><a href="#cb106-314" aria-hidden="true" tabindex="-1"></a><span class="in">  pergame_var[i,] &lt;- sapply(subpergame, function(x) if (is.numeric(x)) var(x, na.rm = TRUE) else NA)</span></span>
<span id="cb106-315"><a href="#cb106-315" aria-hidden="true" tabindex="-1"></a><span class="in">  pergame_mean[i,1] &lt;- i+1999</span></span>
<span id="cb106-316"><a href="#cb106-316" aria-hidden="true" tabindex="-1"></a><span class="in">  pergame_var[i,1] &lt;- i+1999</span></span>
<span id="cb106-317"><a href="#cb106-317" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-318"><a href="#cb106-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-319"><a href="#cb106-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-320"><a href="#cb106-320" aria-hidden="true" tabindex="-1"></a>原始数据转化为张量tensor_nba:</span>
<span id="cb106-321"><a href="#cb106-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-322"><a href="#cb106-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning=FALSE,message=FALSE}</span></span>
<span id="cb106-323"><a href="#cb106-323" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-324"><a href="#cb106-324" aria-hidden="true" tabindex="-1"></a><span class="in"># 定义一个函数，读取指定文件夹中的所有 Excel 文件</span></span>
<span id="cb106-325"><a href="#cb106-325" aria-hidden="true" tabindex="-1"></a><span class="in">read_excel_files_in_directory &lt;- function(directory_path) {</span></span>
<span id="cb106-326"><a href="#cb106-326" aria-hidden="true" tabindex="-1"></a><span class="in">  # 获取指定目录下的所有 Excel 文件（以 .xlsx 或 .xls 结尾）</span></span>
<span id="cb106-327"><a href="#cb106-327" aria-hidden="true" tabindex="-1"></a><span class="in">  excel_files &lt;- list.files(directory_path, pattern = "\\.xlsx$|\\.xls$", full.names = TRUE)</span></span>
<span id="cb106-328"><a href="#cb106-328" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-329"><a href="#cb106-329" aria-hidden="true" tabindex="-1"></a><span class="in">  # 创建一个空的列表来存储读取的数据</span></span>
<span id="cb106-330"><a href="#cb106-330" aria-hidden="true" tabindex="-1"></a><span class="in">  data_list &lt;- list()</span></span>
<span id="cb106-331"><a href="#cb106-331" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-332"><a href="#cb106-332" aria-hidden="true" tabindex="-1"></a><span class="in">  # 遍历每个 Excel 文件</span></span>
<span id="cb106-333"><a href="#cb106-333" aria-hidden="true" tabindex="-1"></a><span class="in">  for (file in excel_files) {</span></span>
<span id="cb106-334"><a href="#cb106-334" aria-hidden="true" tabindex="-1"></a><span class="in">    # 读取 Excel 文件的数据</span></span>
<span id="cb106-335"><a href="#cb106-335" aria-hidden="true" tabindex="-1"></a><span class="in">    try({</span></span>
<span id="cb106-336"><a href="#cb106-336" aria-hidden="true" tabindex="-1"></a><span class="in">      df &lt;- read_excel(file)</span></span>
<span id="cb106-337"><a href="#cb106-337" aria-hidden="true" tabindex="-1"></a><span class="in">      data_list[[file]] &lt;- df</span></span>
<span id="cb106-338"><a href="#cb106-338" aria-hidden="true" tabindex="-1"></a><span class="in">      print(paste("成功读取文件:", file))</span></span>
<span id="cb106-339"><a href="#cb106-339" aria-hidden="true" tabindex="-1"></a><span class="in">    }, silent = TRUE)</span></span>
<span id="cb106-340"><a href="#cb106-340" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb106-341"><a href="#cb106-341" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-342"><a href="#cb106-342" aria-hidden="true" tabindex="-1"></a><span class="in">  # 返回一个包含所有文件数据的列表</span></span>
<span id="cb106-343"><a href="#cb106-343" aria-hidden="true" tabindex="-1"></a><span class="in">  return(data_list)</span></span>
<span id="cb106-344"><a href="#cb106-344" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-345"><a href="#cb106-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-346"><a href="#cb106-346" aria-hidden="true" tabindex="-1"></a><span class="in"># 指定文件夹路径</span></span>
<span id="cb106-347"><a href="#cb106-347" aria-hidden="true" tabindex="-1"></a><span class="in">directory_path &lt;- "C:/Users/86133/Desktop/software/changepoint/rawdata/per_game_rename_complete"</span></span>
<span id="cb106-348"><a href="#cb106-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-349"><a href="#cb106-349" aria-hidden="true" tabindex="-1"></a><span class="in"># 调用函数读取并存储所有 Excel 文件</span></span>
<span id="cb106-350"><a href="#cb106-350" aria-hidden="true" tabindex="-1"></a><span class="in">pergame_list_re &lt;- read_excel_files_in_directory(directory_path)</span></span>
<span id="cb106-351"><a href="#cb106-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-352"><a href="#cb106-352" aria-hidden="true" tabindex="-1"></a><span class="in"># 如果需要将所有文件的数据合并为一个大的数据框</span></span>
<span id="cb106-353"><a href="#cb106-353" aria-hidden="true" tabindex="-1"></a><span class="in">combinedpergame_data_re &lt;- do.call(rbind, pergame_list_re)</span></span>
<span id="cb106-354"><a href="#cb106-354" aria-hidden="true" tabindex="-1"></a><span class="in"># 输出合并后的数据框</span></span>
<span id="cb106-355"><a href="#cb106-355" aria-hidden="true" tabindex="-1"></a><span class="in">print(combinedpergame_data_re)</span></span>
<span id="cb106-356"><a href="#cb106-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-357"><a href="#cb106-357" aria-hidden="true" tabindex="-1"></a><span class="in">#转为tensor</span></span>
<span id="cb106-358"><a href="#cb106-358" aria-hidden="true" tabindex="-1"></a><span class="in"># 假设 pergame_list 是按年份顺序排列的列表（2000-2023），每个元素为 p×q 矩阵</span></span>
<span id="cb106-359"><a href="#cb106-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-360"><a href="#cb106-360" aria-hidden="true" tabindex="-1"></a><span class="in"># 1. 检查所有矩阵维度是否一致</span></span>
<span id="cb106-361"><a href="#cb106-361" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- nrow(pergame_list_re[[1]]) </span></span>
<span id="cb106-362"><a href="#cb106-362" aria-hidden="true" tabindex="-1"></a><span class="in">q &lt;- ncol(pergame_list_re[[1]])</span></span>
<span id="cb106-363"><a href="#cb106-363" aria-hidden="true" tabindex="-1"></a><span class="in">n_years &lt;- length(pergame_list_re)</span></span>
<span id="cb106-364"><a href="#cb106-364" aria-hidden="true" tabindex="-1"></a><span class="in">#检查每层的行列数是否一致</span></span>
<span id="cb106-365"><a href="#cb106-365" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in seq_along(pergame_list_re)) {</span></span>
<span id="cb106-366"><a href="#cb106-366" aria-hidden="true" tabindex="-1"></a><span class="in">  if (nrow(pergame_list_re[[i]]) != p || ncol(pergame_list_re[[i]]) != q) {</span></span>
<span id="cb106-367"><a href="#cb106-367" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("矩阵维度不一致，无法构建张量")</span></span>
<span id="cb106-368"><a href="#cb106-368" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb106-369"><a href="#cb106-369" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-370"><a href="#cb106-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-371"><a href="#cb106-371" aria-hidden="true" tabindex="-1"></a><span class="in"># 2. 直接合并为行×列×层的三维数组（维度顺序: p×q×n_years）</span></span>
<span id="cb106-372"><a href="#cb106-372" aria-hidden="true" tabindex="-1"></a><span class="in">tensor &lt;- array(</span></span>
<span id="cb106-373"><a href="#cb106-373" aria-hidden="true" tabindex="-1"></a><span class="in">  data = unlist(pergame_list_re),</span></span>
<span id="cb106-374"><a href="#cb106-374" aria-hidden="true" tabindex="-1"></a><span class="in">  dim = c(p, q, n_years)  # 行 × 列 × 层（年份）</span></span>
<span id="cb106-375"><a href="#cb106-375" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-376"><a href="#cb106-376" aria-hidden="true" tabindex="-1"></a><span class="in">tensor &lt;- tensor[, -1, ] </span></span>
<span id="cb106-377"><a href="#cb106-377" aria-hidden="true" tabindex="-1"></a><span class="in">column_names &lt;- as.character(tensor[, 1, 1]) </span></span>
<span id="cb106-378"><a href="#cb106-378" aria-hidden="true" tabindex="-1"></a><span class="in">tensor &lt;- tensor[, -2:-1, ] #删掉第一列(球队和G)</span></span>
<span id="cb106-379"><a href="#cb106-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-380"><a href="#cb106-380" aria-hidden="true" tabindex="-1"></a><span class="in">tensor_numeric &lt;- array(as.numeric(tensor), dim = dim(tensor)) #转为数值型</span></span>
<span id="cb106-381"><a href="#cb106-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-382"><a href="#cb106-382" aria-hidden="true" tabindex="-1"></a><span class="in"># 验证维度</span></span>
<span id="cb106-383"><a href="#cb106-383" aria-hidden="true" tabindex="-1"></a><span class="in">cat("张量维度 (行 × 列 × 层):", dim(tensor))</span></span>
<span id="cb106-384"><a href="#cb106-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-385"><a href="#cb106-385" aria-hidden="true" tabindex="-1"></a><span class="in">library(rTensor)</span></span>
<span id="cb106-386"><a href="#cb106-386" aria-hidden="true" tabindex="-1"></a><span class="in">tensor_nba &lt;- as.tensor(tensor_numeric)</span></span>
<span id="cb106-387"><a href="#cb106-387" aria-hidden="true" tabindex="-1"></a><span class="in">attr(tensor, "column_names") &lt;- column_names  #取第一层第一列作为列名</span></span>
<span id="cb106-388"><a href="#cb106-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-389"><a href="#cb106-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-390"><a href="#cb106-390" aria-hidden="true" tabindex="-1"></a><span class="fu">## proposed method</span></span>
<span id="cb106-391"><a href="#cb106-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-392"><a href="#cb106-392" aria-hidden="true" tabindex="-1"></a><span class="fu">### Binary Segmentation</span></span>
<span id="cb106-393"><a href="#cb106-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-394"><a href="#cb106-394" aria-hidden="true" tabindex="-1"></a>Given a multivariate time series $Y_1, Y_2, \dots, Y_n \in \mathbb{R}^d$. For any candidate change point $t \in (t_{k-1}, t_{k+1})$, we define the cost function as:</span>
<span id="cb106-395"><a href="#cb106-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-396"><a href="#cb106-396" aria-hidden="true" tabindex="-1"></a>$$ c(y_{t_{k-1}..t_{k+1}}) = \sqrt{\frac{(t_k - t_{k-1})(t_{k+1} - t_k)}{t_{k+1} - t_{k-1}}} \cdot \left\| \bar{Y}_{(t_k, t_{k+1}]} - \bar{Y}_{(t_{k-1}, t_k]} \right\|_p $$</span>
<span id="cb106-397"><a href="#cb106-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-398"><a href="#cb106-398" aria-hidden="true" tabindex="-1"></a>where $\bar{Y}_{(a, b]}$ is the mean of the data in the interval $(a, b]$, and $\|\cdot\|_p$ is the $\ell_p$-norm.</span>
<span id="cb106-399"><a href="#cb106-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-400"><a href="#cb106-400" aria-hidden="true" tabindex="-1"></a>Binary Segmentation: In the current interval $<span class="co">[</span><span class="ot">t_0, t_1</span><span class="co">]</span>$, enumerate all possible split points $t \in (t_0 + \text{min_size}, t_1 - \text{min_size})$, compute the cost $c(t)$ for each split, and select the maximum cost $c^*$ with optimal point $t^*$. If $c^* &gt; \beta$, accept $t^*$ as a change point, and recursively apply the same procedure to $[t_0, t^*]$ and $[t^*, t_1]$; If $c^* \leq \beta$, do not split further.</span>
<span id="cb106-401"><a href="#cb106-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-402"><a href="#cb106-402" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1.1 β网格搜索</span></span>
<span id="cb106-403"><a href="#cb106-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-404"><a href="#cb106-404" aria-hidden="true" tabindex="-1"></a>**伪代码：**</span>
<span id="cb106-405"><a href="#cb106-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-406"><a href="#cb106-406" aria-hidden="true" tabindex="-1"></a>输入：</span>
<span id="cb106-407"><a href="#cb106-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-408"><a href="#cb106-408" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>数据矩阵 $Y_{1:n}$</span>
<span id="cb106-409"><a href="#cb106-409" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>子区间 $[t_0, t_1)$</span>
<span id="cb106-410"><a href="#cb106-410" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>区间最小段长 <span class="in">`min_size`</span></span>
<span id="cb106-411"><a href="#cb106-411" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>惩罚项强度 $β$</span>
<span id="cb106-412"><a href="#cb106-412" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>范数类型 $\ell_p$</span>
<span id="cb106-413"><a href="#cb106-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-414"><a href="#cb106-414" aria-hidden="true" tabindex="-1"></a><span class="in">```         </span></span>
<span id="cb106-415"><a href="#cb106-415" aria-hidden="true" tabindex="-1"></a><span class="in">Input</span></span>
<span id="cb106-416"><a href="#cb106-416" aria-hidden="true" tabindex="-1"></a><span class="in">  Data matrix $Y_{1:n}$, </span></span>
<span id="cb106-417"><a href="#cb106-417" aria-hidden="true" tabindex="-1"></a><span class="in">  Interval $[t_0, t_1)$, </span></span>
<span id="cb106-418"><a href="#cb106-418" aria-hidden="true" tabindex="-1"></a><span class="in">  Minimum segment length $\mathtt{min\_size}$, </span></span>
<span id="cb106-419"><a href="#cb106-419" aria-hidden="true" tabindex="-1"></a><span class="in">  Penalty parameter $\beta$, </span></span>
<span id="cb106-420"><a href="#cb106-420" aria-hidden="true" tabindex="-1"></a><span class="in">  Norm type $\ell_p$</span></span>
<span id="cb106-421"><a href="#cb106-421" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-422"><a href="#cb106-422" aria-hidden="true" tabindex="-1"></a><span class="in">Function BinarySegmentation(Y, t0 = 0, t1 = n, β, min_size, p):</span></span>
<span id="cb106-423"><a href="#cb106-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-424"><a href="#cb106-424" aria-hidden="true" tabindex="-1"></a><span class="in">Initialize:</span></span>
<span id="cb106-425"><a href="#cb106-425" aria-hidden="true" tabindex="-1"></a><span class="in">    best_gain ← -∞</span></span>
<span id="cb106-426"><a href="#cb106-426" aria-hidden="true" tabindex="-1"></a><span class="in">    best_t ← NULL</span></span>
<span id="cb106-427"><a href="#cb106-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-428"><a href="#cb106-428" aria-hidden="true" tabindex="-1"></a><span class="in">For t in (t0 + min_size) to (t1 - min_size):</span></span>
<span id="cb106-429"><a href="#cb106-429" aria-hidden="true" tabindex="-1"></a><span class="in">    Compute gain = c(Y[t0+1 : t1], split at t)</span></span>
<span id="cb106-430"><a href="#cb106-430" aria-hidden="true" tabindex="-1"></a><span class="in">    If gain &gt; best_gain:</span></span>
<span id="cb106-431"><a href="#cb106-431" aria-hidden="true" tabindex="-1"></a><span class="in">        best_gain ← gain</span></span>
<span id="cb106-432"><a href="#cb106-432" aria-hidden="true" tabindex="-1"></a><span class="in">        best_t ← t</span></span>
<span id="cb106-433"><a href="#cb106-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-434"><a href="#cb106-434" aria-hidden="true" tabindex="-1"></a><span class="in">If best_gain &gt; β:</span></span>
<span id="cb106-435"><a href="#cb106-435" aria-hidden="true" tabindex="-1"></a><span class="in">    # Accept split</span></span>
<span id="cb106-436"><a href="#cb106-436" aria-hidden="true" tabindex="-1"></a><span class="in">    left_changes ← BinarySegmentation(Y, t0, best_t, β, min_size, p)</span></span>
<span id="cb106-437"><a href="#cb106-437" aria-hidden="true" tabindex="-1"></a><span class="in">    right_changes ← BinarySegmentation(Y, best_t, t1, β, min_size, p)</span></span>
<span id="cb106-438"><a href="#cb106-438" aria-hidden="true" tabindex="-1"></a><span class="in">    return left_changes ∪ {best_t} ∪ right_changes</span></span>
<span id="cb106-439"><a href="#cb106-439" aria-hidden="true" tabindex="-1"></a><span class="in">Else:</span></span>
<span id="cb106-440"><a href="#cb106-440" aria-hidden="true" tabindex="-1"></a><span class="in">    return ∅</span></span>
<span id="cb106-441"><a href="#cb106-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-442"><a href="#cb106-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-443"><a href="#cb106-443" aria-hidden="true" tabindex="-1"></a>Binary Segmentation code:</span>
<span id="cb106-444"><a href="#cb106-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-447"><a href="#cb106-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-448"><a href="#cb106-448" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb106-449"><a href="#cb106-449" aria-hidden="true" tabindex="-1"></a>cp_decomp <span class="ot">&lt;-</span> <span class="fu">parafac</span>(tensor_numeric, <span class="at">nfac =</span> <span class="dv">2</span>, <span class="at">const=</span><span class="fu">c</span>(<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>), <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-450"><a href="#cb106-450" aria-hidden="true" tabindex="-1"></a>cp_decomp</span>
<span id="cb106-451"><a href="#cb106-451" aria-hidden="true" tabindex="-1"></a><span class="fu">const</span>()</span>
<span id="cb106-452"><a href="#cb106-452" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取结果</span></span>
<span id="cb106-453"><a href="#cb106-453" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>A  <span class="co"># 第一模态因子矩阵</span></span>
<span id="cb106-454"><a href="#cb106-454" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>B  <span class="co"># 第二模态因子矩阵</span></span>
<span id="cb106-455"><a href="#cb106-455" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>C  <span class="co"># 时间模态因子矩阵</span></span>
<span id="cb106-456"><a href="#cb106-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-457"><a href="#cb106-457" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> C</span>
<span id="cb106-458"><a href="#cb106-458" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb106-459"><a href="#cb106-459" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-460"><a href="#cb106-460" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义 cost 函数</span></span>
<span id="cb106-461"><a href="#cb106-461" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-462"><a href="#cb106-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-463"><a href="#cb106-463" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p=</span><span class="dv">2</span> ) {</span>
<span id="cb106-464"><a href="#cb106-464" aria-hidden="true" tabindex="-1"></a>   <span class="co">#p = 2范数类型</span></span>
<span id="cb106-465"><a href="#cb106-465" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-466"><a href="#cb106-466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-467"><a href="#cb106-467" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb106-468"><a href="#cb106-468" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb106-469"><a href="#cb106-469" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb106-470"><a href="#cb106-470" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-471"><a href="#cb106-471" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-472"><a href="#cb106-472" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-473"><a href="#cb106-473" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-474"><a href="#cb106-474" aria-hidden="true" tabindex="-1"></a>  diff <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb106-475"><a href="#cb106-475" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb106-476"><a href="#cb106-476" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-477"><a href="#cb106-477" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 用 sum(abs(diff)^p)^(1/p) 计算 p 范数</span></span>
<span id="cb106-478"><a href="#cb106-478" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p <span class="sc">==</span> <span class="st">"inf"</span>) {</span>
<span id="cb106-479"><a href="#cb106-479" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb106-480"><a href="#cb106-480" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-481"><a href="#cb106-481" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb106-482"><a href="#cb106-482" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-483"><a href="#cb106-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-484"><a href="#cb106-484" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-485"><a href="#cb106-485" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> weight <span class="sc">*</span> norm_p</span>
<span id="cb106-486"><a href="#cb106-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cost)</span>
<span id="cb106-487"><a href="#cb106-487" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-488"><a href="#cb106-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-489"><a href="#cb106-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-490"><a href="#cb106-490" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-491"><a href="#cb106-491" aria-hidden="true" tabindex="-1"></a><span class="co"># 二元分割函数（递归）</span></span>
<span id="cb106-492"><a href="#cb106-492" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-493"><a href="#cb106-493" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size=</span><span class="dv">2</span>, <span class="at">p=</span><span class="dv">2</span>) {</span>
<span id="cb106-494"><a href="#cb106-494" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 先算扫描边界</span></span>
<span id="cb106-495"><a href="#cb106-495" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb106-496"><a href="#cb106-496" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb106-497"><a href="#cb106-497" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-498"><a href="#cb106-498" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ★关键：如果无可扫范围，直接返回</span></span>
<span id="cb106-499"><a href="#cb106-499" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span><span class="sc">*</span>min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb106-500"><a href="#cb106-500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-501"><a href="#cb106-501" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-502"><a href="#cb106-502" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-503"><a href="#cb106-503" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb106-504"><a href="#cb106-504" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-505"><a href="#cb106-505" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-506"><a href="#cb106-506" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb106-507"><a href="#cb106-507" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb106-508"><a href="#cb106-508" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb106-509"><a href="#cb106-509" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain</span>
<span id="cb106-510"><a href="#cb106-510" aria-hidden="true" tabindex="-1"></a>      best_t <span class="ot">&lt;-</span> t</span>
<span id="cb106-511"><a href="#cb106-511" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-512"><a href="#cb106-512" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-513"><a href="#cb106-513" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-514"><a href="#cb106-514" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb106-515"><a href="#cb106-515" aria-hidden="true" tabindex="-1"></a>    left <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb106-516"><a href="#cb106-516" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb106-517"><a href="#cb106-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb106-518"><a href="#cb106-518" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-519"><a href="#cb106-519" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-520"><a href="#cb106-520" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-521"><a href="#cb106-521" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-522"><a href="#cb106-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-523"><a href="#cb106-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-524"><a href="#cb106-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-525"><a href="#cb106-525" aria-hidden="true" tabindex="-1"></a>Run the algorithm with a sequence of β values and observe how the number of change points changes.</span>
<span id="cb106-526"><a href="#cb106-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-527"><a href="#cb106-527" aria-hidden="true" tabindex="-1"></a>p=2, min_size=2, β=seq(3, 30, length.out = 50), when β<span class="sc">\&gt;</span>95, no changepoint</span>
<span id="cb106-528"><a href="#cb106-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-531"><a href="#cb106-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-532"><a href="#cb106-532" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-533"><a href="#cb106-533" aria-hidden="true" tabindex="-1"></a><span class="co"># 遍历多个 β 值</span></span>
<span id="cb106-534"><a href="#cb106-534" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-535"><a href="#cb106-535" aria-hidden="true" tabindex="-1"></a>beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">3</span>, <span class="dv">70</span>, <span class="at">length.out =</span> <span class="dv">90</span>)</span>
<span id="cb106-536"><a href="#cb106-536" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-537"><a href="#cb106-537" aria-hidden="true" tabindex="-1"></a>bp_counts <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb106-538"><a href="#cb106-538" aria-hidden="true" tabindex="-1"></a><span class="co">#beta_list: 遍历的 β 值序列，例如 seq(3, 30, length.out = 70), bp_counts: 对应每个 β 下检测到的变点数量（整型向量）</span></span>
<span id="cb106-539"><a href="#cb106-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-540"><a href="#cb106-540" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb106-541"><a href="#cb106-541" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb106-542"><a href="#cb106-542" aria-hidden="true" tabindex="-1"></a>  t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, beta))</span>
<span id="cb106-543"><a href="#cb106-543" aria-hidden="true" tabindex="-1"></a>  results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb106-544"><a href="#cb106-544" aria-hidden="true" tabindex="-1"></a>  bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb106-545"><a href="#cb106-545" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-546"><a href="#cb106-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-547"><a href="#cb106-547" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-548"><a href="#cb106-548" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘图：β vs 变点数</span></span>
<span id="cb106-549"><a href="#cb106-549" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-550"><a href="#cb106-550" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb106-551"><a href="#cb106-551" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb106-552"><a href="#cb106-552" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Number of Change Points"</span>)</span>
<span id="cb106-553"><a href="#cb106-553" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb106-554"><a href="#cb106-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-555"><a href="#cb106-555" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出变点结构供进一步分析</span></span>
<span id="cb106-556"><a href="#cb106-556" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb106-557"><a href="#cb106-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f: changepoints = %s</span><span class="sc">\n</span><span class="st">"</span>, beta_list[i], <span class="fu">paste</span>(results[[i]], <span class="at">collapse =</span> <span class="st">", "</span>)))</span>
<span id="cb106-558"><a href="#cb106-558" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-559"><a href="#cb106-559" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb106-560"><a href="#cb106-560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-561"><a href="#cb106-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-562"><a href="#cb106-562" aria-hidden="true" tabindex="-1"></a>上述结果是遍历beta的nba数据变点结果：变点稳定在2016年</span>
<span id="cb106-563"><a href="#cb106-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-564"><a href="#cb106-564" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>β 怎么确定？</span>
<span id="cb106-565"><a href="#cb106-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-566"><a href="#cb106-566" aria-hidden="true" tabindex="-1"></a><span class="ss">    1.  </span>**先用手肘法** 找到拐点 β（候选）：取第一点和最后一点把它们连成一条直线，对曲线上每个点计算它到直线的**垂直距离**，距离最大的那一点，就是和端点连线“偏得最远”的点，当作“肘部”</span>
<span id="cb106-567"><a href="#cb106-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-568"><a href="#cb106-568" aria-hidden="true" tabindex="-1"></a><span class="ss">    2.  </span>**在 elbow 附近（窗口内）搜索**：找到一个区间里变点数稳定的“最长 plateau”（变点数相同的连续 β 区间），取该 plateau 的中点 β 作为最终beta</span>
<span id="cb106-569"><a href="#cb106-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-570"><a href="#cb106-570" aria-hidden="true" tabindex="-1"></a><span class="ss">    3.  </span>先在**手肘附近窗口**里找**最长 plateau**；</span>
<span id="cb106-571"><a href="#cb106-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-572"><a href="#cb106-572" aria-hidden="true" tabindex="-1"></a>        若窗口里**找不到**（极端/锯齿曲线）：则取**全局最长 plateau**；</span>
<span id="cb106-573"><a href="#cb106-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-574"><a href="#cb106-574" aria-hidden="true" tabindex="-1"></a>        若**根本没有 plateau**：直接用 **`elbow_beta`**</span>
<span id="cb106-575"><a href="#cb106-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-576"><a href="#cb106-576" aria-hidden="true" tabindex="-1"></a>code:</span>
<span id="cb106-577"><a href="#cb106-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-580"><a href="#cb106-580" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-581"><a href="#cb106-581" aria-hidden="true" tabindex="-1"></a><span class="co">#先运行遍历beta,得到beta_list: 遍历的 β 值序列，例如 seq(3, 30, length.out = 70)和bp_counts: 对应每个 β 下检测到的变点数量（整型向量）</span></span>
<span id="cb106-582"><a href="#cb106-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-583"><a href="#cb106-583" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-584"><a href="#cb106-584" aria-hidden="true" tabindex="-1"></a><span class="co"># 手肘法 (Kneedle)</span></span>
<span id="cb106-585"><a href="#cb106-585" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-586"><a href="#cb106-586" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-587"><a href="#cb106-587" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>])</span>
<span id="cb106-588"><a href="#cb106-588" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb106-589"><a href="#cb106-589" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-590"><a href="#cb106-590" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb106-591"><a href="#cb106-591" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb106-592"><a href="#cb106-592" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb106-593"><a href="#cb106-593" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>((p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>]) <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb106-594"><a href="#cb106-594" aria-hidden="true" tabindex="-1"></a>                        (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]) <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> </span>
<span id="cb106-595"><a href="#cb106-595" aria-hidden="true" tabindex="-1"></a>                        p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span></span>
<span id="cb106-596"><a href="#cb106-596" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sqrt</span>((p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb106-597"><a href="#cb106-597" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-598"><a href="#cb106-598" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb106-599"><a href="#cb106-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx))</span>
<span id="cb106-600"><a href="#cb106-600" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-601"><a href="#cb106-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-602"><a href="#cb106-602" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-603"><a href="#cb106-603" aria-hidden="true" tabindex="-1"></a><span class="co"># 找 plateau 区间</span></span>
<span id="cb106-604"><a href="#cb106-604" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-605"><a href="#cb106-605" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-606"><a href="#cb106-606" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-607"><a href="#cb106-607" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb106-608"><a href="#cb106-608" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb106-609"><a href="#cb106-609" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i<span class="dv">-1</span>]) {</span>
<span id="cb106-610"><a href="#cb106-610" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-611"><a href="#cb106-611" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start,</span>
<span id="cb106-612"><a href="#cb106-612" aria-hidden="true" tabindex="-1"></a>        <span class="at">end =</span> i<span class="dv">-1</span>,</span>
<span id="cb106-613"><a href="#cb106-613" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> y[i<span class="dv">-1</span>],</span>
<span id="cb106-614"><a href="#cb106-614" aria-hidden="true" tabindex="-1"></a>        <span class="at">length =</span> (i<span class="dv">-1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-615"><a href="#cb106-615" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-616"><a href="#cb106-616" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb106-617"><a href="#cb106-617" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-618"><a href="#cb106-618" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-619"><a href="#cb106-619" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 最后一个 plateau</span></span>
<span id="cb106-620"><a href="#cb106-620" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-621"><a href="#cb106-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start,</span>
<span id="cb106-622"><a href="#cb106-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">end =</span> <span class="fu">length</span>(y),</span>
<span id="cb106-623"><a href="#cb106-623" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> y[<span class="fu">length</span>(y)],</span>
<span id="cb106-624"><a href="#cb106-624" aria-hidden="true" tabindex="-1"></a>    <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-625"><a href="#cb106-625" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-626"><a href="#cb106-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(plateaus)</span>
<span id="cb106-627"><a href="#cb106-627" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-628"><a href="#cb106-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-629"><a href="#cb106-629" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-630"><a href="#cb106-630" aria-hidden="true" tabindex="-1"></a><span class="co"># 主逻辑</span></span>
<span id="cb106-631"><a href="#cb106-631" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-632"><a href="#cb106-632" aria-hidden="true" tabindex="-1"></a>plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb106-633"><a href="#cb106-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-634"><a href="#cb106-634" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 手肘法</span></span>
<span id="cb106-635"><a href="#cb106-635" aria-hidden="true" tabindex="-1"></a>elbow <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb106-636"><a href="#cb106-636" aria-hidden="true" tabindex="-1"></a>elbow_beta <span class="ot">&lt;-</span> elbow<span class="sc">$</span>beta</span>
<span id="cb106-637"><a href="#cb106-637" aria-hidden="true" tabindex="-1"></a>elbow_idx <span class="ot">&lt;-</span> elbow<span class="sc">$</span>index</span>
<span id="cb106-638"><a href="#cb106-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-639"><a href="#cb106-639" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 在 elbow 附近找最长 plateau</span></span>
<span id="cb106-640"><a href="#cb106-640" aria-hidden="true" tabindex="-1"></a>window <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb106-641"><a href="#cb106-641" aria-hidden="true" tabindex="-1"></a>best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-642"><a href="#cb106-642" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p <span class="cf">in</span> plateaus) {</span>
<span id="cb106-643"><a href="#cb106-643" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((p<span class="sc">$</span>start <span class="sc">&lt;=</span> elbow_idx <span class="sc">+</span> window) <span class="sc">&amp;&amp;</span> (p<span class="sc">$</span>end <span class="sc">&gt;=</span> elbow_idx <span class="sc">-</span> window)) {</span>
<span id="cb106-644"><a href="#cb106-644" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> p<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) {</span>
<span id="cb106-645"><a href="#cb106-645" aria-hidden="true" tabindex="-1"></a>      best_plateau <span class="ot">&lt;-</span> p</span>
<span id="cb106-646"><a href="#cb106-646" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-647"><a href="#cb106-647" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-648"><a href="#cb106-648" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-649"><a href="#cb106-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-650"><a href="#cb106-650" aria-hidden="true" tabindex="-1"></a>best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end)<span class="sc">/</span><span class="dv">2</span>)]</span>
<span id="cb106-651"><a href="#cb106-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-652"><a href="#cb106-652" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-653"><a href="#cb106-653" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化</span></span>
<span id="cb106-654"><a href="#cb106-654" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-655"><a href="#cb106-655" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb106-656"><a href="#cb106-656" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb106-657"><a href="#cb106-657" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb106-658"><a href="#cb106-658" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb106-659"><a href="#cb106-659" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> best_beta, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb106-660"><a href="#cb106-660" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb106-661"><a href="#cb106-661" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="dv">2</span>, <span class="at">bty=</span><span class="st">"n"</span>)</span>
<span id="cb106-662"><a href="#cb106-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-663"><a href="#cb106-663" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-664"><a href="#cb106-664" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印结果</span></span>
<span id="cb106-665"><a href="#cb106-665" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-666"><a href="#cb106-666" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-667"><a href="#cb106-667" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p <span class="cf">in</span> plateaus) {</span>
<span id="cb106-668"><a href="#cb106-668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb106-669"><a href="#cb106-669" aria-hidden="true" tabindex="-1"></a>              beta_list[p<span class="sc">$</span>start], beta_list[p<span class="sc">$</span>end],</span>
<span id="cb106-670"><a href="#cb106-670" aria-hidden="true" tabindex="-1"></a>              p<span class="sc">$</span>length, p<span class="sc">$</span>value))</span>
<span id="cb106-671"><a href="#cb106-671" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-672"><a href="#cb106-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-673"><a href="#cb106-673" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Elbow 候选 β = %.2f</span><span class="sc">\n</span><span class="st">"</span>, elbow_beta))</span>
<span id="cb106-674"><a href="#cb106-674" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span><span class="sc">\n</span><span class="st">"</span>, best_beta))</span>
<span id="cb106-675"><a href="#cb106-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-676"><a href="#cb106-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-677"><a href="#cb106-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-678"><a href="#cb106-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-679"><a href="#cb106-679" aria-hidden="true" tabindex="-1"></a>**输出效果**</span>
<span id="cb106-680"><a href="#cb106-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-681"><a href="#cb106-681" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>红线：手肘法选出的候选</span>
<span id="cb106-682"><a href="#cb106-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-683"><a href="#cb106-683" aria-hidden="true" tabindex="-1"></a>    蓝线：在 elbow 附近 plateau 区间里挑出的推荐\</span>
<span id="cb106-684"><a href="#cb106-684" aria-hidden="true" tabindex="-1"></a>    会列出所有 plateau，例如：</span>
<span id="cb106-685"><a href="#cb106-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-686"><a href="#cb106-686" aria-hidden="true" tabindex="-1"></a><span class="in">```         </span></span>
<span id="cb106-687"><a href="#cb106-687" aria-hidden="true" tabindex="-1"></a><span class="in">所有 plateau 区间: </span></span>
<span id="cb106-688"><a href="#cb106-688" aria-hidden="true" tabindex="-1"></a><span class="in">β = 3.00–4.20, 长度 = 5, 变点数 = 10 </span></span>
<span id="cb106-689"><a href="#cb106-689" aria-hidden="true" tabindex="-1"></a><span class="in">β = 4.60–6.00, 长度 = 4, 变点数 = 6 </span></span>
<span id="cb106-690"><a href="#cb106-690" aria-hidden="true" tabindex="-1"></a><span class="in">β = 6.40–14.20, 长度 = 20, 变点数 = 4 </span></span>
<span id="cb106-691"><a href="#cb106-691" aria-hidden="true" tabindex="-1"></a><span class="in">β = 14.60–21.40, 长度 = 15, 变点数 = 3 </span></span>
<span id="cb106-692"><a href="#cb106-692" aria-hidden="true" tabindex="-1"></a><span class="in">β = 21.80–26.00, 长度 = 12, 变点数 = 2 </span></span>
<span id="cb106-693"><a href="#cb106-693" aria-hidden="true" tabindex="-1"></a><span class="in">β = 26.40–30.00, 长度 = 10, 变点数 = 1  </span></span>
<span id="cb106-694"><a href="#cb106-694" aria-hidden="true" tabindex="-1"></a><span class="in">Elbow 候选 β = 6.40 </span></span>
<span id="cb106-695"><a href="#cb106-695" aria-hidden="true" tabindex="-1"></a><span class="in">最终推荐 β = 10.20 (在 elbow 附近 plateau 最长)</span></span>
<span id="cb106-696"><a href="#cb106-696" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-697"><a href="#cb106-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-698"><a href="#cb106-698" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>二元分割+上述beta选择方法结合：</span>
<span id="cb106-699"><a href="#cb106-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-700"><a href="#cb106-700" aria-hidden="true" tabindex="-1"></a><span class="fu">## （ABS）adaptive_binary_segmentation</span></span>
<span id="cb106-701"><a href="#cb106-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-702"><a href="#cb106-702" aria-hidden="true" tabindex="-1"></a>**主函数：**</span>
<span id="cb106-703"><a href="#cb106-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-704"><a href="#cb106-704" aria-hidden="true" tabindex="-1"></a>**二元分割函数**（自使用确定beta）**adaptive_binary_segmentation** <span class="sc">\&lt;</span>- function(Y, beta_min = 3, beta_max = 30, beta_points = 70, min_size=2, p=2, elbow_window=10)</span>
<span id="cb106-705"><a href="#cb106-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-706"><a href="#cb106-706" aria-hidden="true" tabindex="-1"></a>beta_min beta_max beta_points 遍历beta的区间和数量，min_size:变点最小间隔，p:范数，elbow_window:手肘法附近窗口大小</span>
<span id="cb106-707"><a href="#cb106-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-708"><a href="#cb106-708" aria-hidden="true" tabindex="-1"></a>**可视化**：plot_segmentation_path</span>
<span id="cb106-709"><a href="#cb106-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-710"><a href="#cb106-710" aria-hidden="true" tabindex="-1"></a>**应用：**</span>
<span id="cb106-711"><a href="#cb106-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-712"><a href="#cb106-712" aria-hidden="true" tabindex="-1"></a>假设数据矩阵 Y 已经准备好</span>
<span id="cb106-713"><a href="#cb106-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-714"><a href="#cb106-714" aria-hidden="true" tabindex="-1"></a>res <span class="sc">\&lt;</span>- adaptive_binary_segmentation(Y)</span>
<span id="cb106-715"><a href="#cb106-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-716"><a href="#cb106-716" aria-hidden="true" tabindex="-1"></a>画图</span>
<span id="cb106-717"><a href="#cb106-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-718"><a href="#cb106-718" aria-hidden="true" tabindex="-1"></a>plot_segmentation_path(res)</span>
<span id="cb106-719"><a href="#cb106-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-720"><a href="#cb106-720" aria-hidden="true" tabindex="-1"></a>code：</span>
<span id="cb106-721"><a href="#cb106-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-724"><a href="#cb106-724" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-725"><a href="#cb106-725" aria-hidden="true" tabindex="-1"></a><span class="do">## 0) 工具与可重复性</span></span>
<span id="cb106-726"><a href="#cb106-726" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-727"><a href="#cb106-727" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-728"><a href="#cb106-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-729"><a href="#cb106-729" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-730"><a href="#cb106-730" aria-hidden="true" tabindex="-1"></a><span class="do">## 内部加速工具（不改变对外 API）</span></span>
<span id="cb106-731"><a href="#cb106-731" aria-hidden="true" tabindex="-1"></a><span class="do">## 说明：</span></span>
<span id="cb106-732"><a href="#cb106-732" aria-hidden="true" tabindex="-1"></a><span class="do">## - 通过一次性构建按行的列累积和 (cumsums) 来将任意区间均值计算从 O(k) 降到 O(1)</span></span>
<span id="cb106-733"><a href="#cb106-733" aria-hidden="true" tabindex="-1"></a><span class="do">## - 所有优化均以隐式属性附着在 Y 上（attr(Y, "._csum")），</span></span>
<span id="cb106-734"><a href="#cb106-734" aria-hidden="true" tabindex="-1"></a><span class="do">##   若缺失则在首次调用时自动构建；对外函数名、参数与用法保持不变</span></span>
<span id="cb106-735"><a href="#cb106-735" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-736"><a href="#cb106-736" aria-hidden="true" tabindex="-1"></a>.ensure_cumsum <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb106-737"><a href="#cb106-737" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb106-738"><a href="#cb106-738" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cs)) {</span>
<span id="cb106-739"><a href="#cb106-739" aria-hidden="true" tabindex="-1"></a>    cs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(Y)), <span class="fu">apply</span>(Y, <span class="dv">2</span>, cumsum))</span>
<span id="cb106-740"><a href="#cb106-740" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>) <span class="ot">&lt;-</span> cs</span>
<span id="cb106-741"><a href="#cb106-741" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-742"><a href="#cb106-742" aria-hidden="true" tabindex="-1"></a>  Y</span>
<span id="cb106-743"><a href="#cb106-743" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-744"><a href="#cb106-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-745"><a href="#cb106-745" aria-hidden="true" tabindex="-1"></a>.segment_means_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(cs, t_left, t_mid, t_right) {</span>
<span id="cb106-746"><a href="#cb106-746" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cs 的行索引与时间点对齐：第 0 个时间点位于行 1</span></span>
<span id="cb106-747"><a href="#cb106-747" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 区间 (t_left+1):t_mid 与 (t_mid+1):t_right</span></span>
<span id="cb106-748"><a href="#cb106-748" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb106-749"><a href="#cb106-749" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb106-750"><a href="#cb106-750" aria-hidden="true" tabindex="-1"></a>  sum1 <span class="ot">&lt;-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_left <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb106-751"><a href="#cb106-751" aria-hidden="true" tabindex="-1"></a>  sum2 <span class="ot">&lt;-</span> cs[t_right <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb106-752"><a href="#cb106-752" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> sum1 <span class="sc">/</span> n1</span>
<span id="cb106-753"><a href="#cb106-753" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> sum2 <span class="sc">/</span> n2</span>
<span id="cb106-754"><a href="#cb106-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">mean1 =</span> mean1, <span class="at">mean2 =</span> mean2, <span class="at">n1 =</span> n1, <span class="at">n2 =</span> n2)</span>
<span id="cb106-755"><a href="#cb106-755" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-756"><a href="#cb106-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-757"><a href="#cb106-757" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-758"><a href="#cb106-758" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 代价函数 &amp; 二元分割（保持 API，不改变名称/参数）</span></span>
<span id="cb106-759"><a href="#cb106-759" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-760"><a href="#cb106-760" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb106-761"><a href="#cb106-761" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-762"><a href="#cb106-762" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 尝试使用累计和加速；若不可用则回退到原始实现</span></span>
<span id="cb106-763"><a href="#cb106-763" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb106-764"><a href="#cb106-764" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cs)) {</span>
<span id="cb106-765"><a href="#cb106-765" aria-hidden="true" tabindex="-1"></a>    seg <span class="ot">&lt;-</span> <span class="fu">.segment_means_fast</span>(cs, t_left, t_mid, t_right)</span>
<span id="cb106-766"><a href="#cb106-766" aria-hidden="true" tabindex="-1"></a>    n1 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n1; n2 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n2; n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb106-767"><a href="#cb106-767" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(seg<span class="sc">$</span>mean2 <span class="sc">-</span> seg<span class="sc">$</span>mean1)</span>
<span id="cb106-768"><a href="#cb106-768" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb106-769"><a href="#cb106-769" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb106-770"><a href="#cb106-770" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb106-771"><a href="#cb106-771" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb106-772"><a href="#cb106-772" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb106-773"><a href="#cb106-773" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-774"><a href="#cb106-774" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weight <span class="sc">*</span> norm_p)</span>
<span id="cb106-775"><a href="#cb106-775" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-776"><a href="#cb106-776" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 回退路径（仅在未预先构建 cumsum 时触发）</span></span>
<span id="cb106-777"><a href="#cb106-777" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb106-778"><a href="#cb106-778" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb106-779"><a href="#cb106-779" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb106-780"><a href="#cb106-780" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-781"><a href="#cb106-781" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-782"><a href="#cb106-782" aria-hidden="true" tabindex="-1"></a>  diff  <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb106-783"><a href="#cb106-783" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb106-784"><a href="#cb106-784" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb106-785"><a href="#cb106-785" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb106-786"><a href="#cb106-786" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-787"><a href="#cb106-787" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb106-788"><a href="#cb106-788" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-789"><a href="#cb106-789" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">*</span> norm_p</span>
<span id="cb106-790"><a href="#cb106-790" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-791"><a href="#cb106-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-792"><a href="#cb106-792" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb106-793"><a href="#cb106-793" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 确保累计和已存在（若无则自动构建）</span></span>
<span id="cb106-794"><a href="#cb106-794" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb106-795"><a href="#cb106-795" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb106-796"><a href="#cb106-796" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb106-797"><a href="#cb106-797" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">*</span> min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb106-798"><a href="#cb106-798" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-799"><a href="#cb106-799" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-800"><a href="#cb106-800" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb106-801"><a href="#cb106-801" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-802"><a href="#cb106-802" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用累计和的 compute_cost，按扫描区间求最大增益</span></span>
<span id="cb106-803"><a href="#cb106-803" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb106-804"><a href="#cb106-804" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb106-805"><a href="#cb106-805" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb106-806"><a href="#cb106-806" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain; best_t <span class="ot">&lt;-</span> t</span>
<span id="cb106-807"><a href="#cb106-807" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-808"><a href="#cb106-808" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-809"><a href="#cb106-809" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb106-810"><a href="#cb106-810" aria-hidden="true" tabindex="-1"></a>    left  <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb106-811"><a href="#cb106-811" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb106-812"><a href="#cb106-812" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb106-813"><a href="#cb106-813" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-814"><a href="#cb106-814" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-815"><a href="#cb106-815" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-816"><a href="#cb106-816" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-817"><a href="#cb106-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-818"><a href="#cb106-818" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-819"><a href="#cb106-819" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 稳定路径：手肘 + 平台 (Kneedle + plateau)</span></span>
<span id="cb106-820"><a href="#cb106-820" aria-hidden="true" tabindex="-1"></a><span class="do">##    （内部同样利用累计和以复用加速）</span></span>
<span id="cb106-821"><a href="#cb106-821" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-822"><a href="#cb106-822" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-823"><a href="#cb106-823" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>]); p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb106-824"><a href="#cb106-824" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb106-825"><a href="#cb106-825" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]); dy <span class="ot">&lt;-</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])</span>
<span id="cb106-826"><a href="#cb106-826" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb106-827"><a href="#cb106-827" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb106-828"><a href="#cb106-828" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb106-829"><a href="#cb106-829" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>(dy <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> dx <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span> denom</span>
<span id="cb106-830"><a href="#cb106-830" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-831"><a href="#cb106-831" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb106-832"><a href="#cb106-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx)</span>
<span id="cb106-833"><a href="#cb106-833" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-834"><a href="#cb106-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-835"><a href="#cb106-835" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-836"><a href="#cb106-836" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-837"><a href="#cb106-837" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb106-838"><a href="#cb106-838" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb106-839"><a href="#cb106-839" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i <span class="sc">-</span> <span class="dv">1</span>]) {</span>
<span id="cb106-840"><a href="#cb106-840" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-841"><a href="#cb106-841" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start, <span class="at">end =</span> i <span class="sc">-</span> <span class="dv">1</span>, <span class="at">value =</span> y[i <span class="sc">-</span> <span class="dv">1</span>], <span class="at">length =</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-842"><a href="#cb106-842" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-843"><a href="#cb106-843" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb106-844"><a href="#cb106-844" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-845"><a href="#cb106-845" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-846"><a href="#cb106-846" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-847"><a href="#cb106-847" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start, <span class="at">end =</span> <span class="fu">length</span>(y), <span class="at">value =</span> y[<span class="fu">length</span>(y)], <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-848"><a href="#cb106-848" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-849"><a href="#cb106-849" aria-hidden="true" tabindex="-1"></a>  plateaus</span>
<span id="cb106-850"><a href="#cb106-850" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-851"><a href="#cb106-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-852"><a href="#cb106-852" aria-hidden="true" tabindex="-1"></a>adaptive_binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb106-853"><a href="#cb106-853" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-854"><a href="#cb106-854" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-855"><a href="#cb106-855" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-856"><a href="#cb106-856" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 预先构建累计和，加速所有后续成本评估</span></span>
<span id="cb106-857"><a href="#cb106-857" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb106-858"><a href="#cb106-858" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb106-859"><a href="#cb106-859" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb106-860"><a href="#cb106-860" aria-hidden="true" tabindex="-1"></a>  bp_counts <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb106-861"><a href="#cb106-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-862"><a href="#cb106-862" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb106-863"><a href="#cb106-863" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb106-864"><a href="#cb106-864" aria-hidden="true" tabindex="-1"></a>    t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, b, <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb106-865"><a href="#cb106-865" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb106-866"><a href="#cb106-866" aria-hidden="true" tabindex="-1"></a>    bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb106-867"><a href="#cb106-867" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-868"><a href="#cb106-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-869"><a href="#cb106-869" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb106-870"><a href="#cb106-870" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb106-871"><a href="#cb106-871" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb106-872"><a href="#cb106-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-873"><a href="#cb106-873" aria-hidden="true" tabindex="-1"></a>  left_bound <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb106-874"><a href="#cb106-874" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb106-875"><a href="#cb106-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-876"><a href="#cb106-876" aria-hidden="true" tabindex="-1"></a>  best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-877"><a href="#cb106-877" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb106-878"><a href="#cb106-878" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound) <span class="sc">&amp;&amp;</span> (pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound)) {</span>
<span id="cb106-879"><a href="#cb106-879" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) best_plateau <span class="ot">&lt;-</span> pp</span>
<span id="cb106-880"><a href="#cb106-880" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-881"><a href="#cb106-881" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-882"><a href="#cb106-882" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb106-883"><a href="#cb106-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-884"><a href="#cb106-884" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) {</span>
<span id="cb106-885"><a href="#cb106-885" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span></span>
<span id="cb106-886"><a href="#cb106-886" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb106-887"><a href="#cb106-887" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb106-888"><a href="#cb106-888" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span></span>
<span id="cb106-889"><a href="#cb106-889" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>,</span>
<span id="cb106-890"><a href="#cb106-890" aria-hidden="true" tabindex="-1"></a>                  beta_list[pp<span class="sc">$</span>start], beta_list[pp<span class="sc">$</span>end], pp<span class="sc">$</span>length, pp<span class="sc">$</span>value))</span>
<span id="cb106-891"><a href="#cb106-891" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-892"><a href="#cb106-892" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span></span>
<span id="cb106-893"><a href="#cb106-893" aria-hidden="true" tabindex="-1"></a><span class="st">Elbow 候选 β = %.2f</span></span>
<span id="cb106-894"><a href="#cb106-894" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, el<span class="sc">$</span>beta))</span>
<span id="cb106-895"><a href="#cb106-895" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span></span>
<span id="cb106-896"><a href="#cb106-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-897"><a href="#cb106-897" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, best_beta))</span>
<span id="cb106-898"><a href="#cb106-898" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-899"><a href="#cb106-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-900"><a href="#cb106-900" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb106-901"><a href="#cb106-901" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_list =</span> beta_list,</span>
<span id="cb106-902"><a href="#cb106-902" aria-hidden="true" tabindex="-1"></a>    <span class="at">bp_counts =</span> bp_counts,</span>
<span id="cb106-903"><a href="#cb106-903" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> results,</span>
<span id="cb106-904"><a href="#cb106-904" aria-hidden="true" tabindex="-1"></a>    <span class="at">plateaus =</span> plateaus,</span>
<span id="cb106-905"><a href="#cb106-905" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb106-906"><a href="#cb106-906" aria-hidden="true" tabindex="-1"></a>    <span class="at">best_beta =</span> best_beta</span>
<span id="cb106-907"><a href="#cb106-907" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-908"><a href="#cb106-908" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-909"><a href="#cb106-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-910"><a href="#cb106-910" aria-hidden="true" tabindex="-1"></a>plot_segmentation_path <span class="ot">&lt;-</span> <span class="cf">function</span>(res) {</span>
<span id="cb106-911"><a href="#cb106-911" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> res<span class="sc">$</span>beta_list; bp_counts <span class="ot">&lt;-</span> res<span class="sc">$</span>bp_counts</span>
<span id="cb106-912"><a href="#cb106-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb106-913"><a href="#cb106-913" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb106-914"><a href="#cb106-914" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb106-915"><a href="#cb106-915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-916"><a href="#cb106-916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>best_beta,  <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-917"><a href="#cb106-917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb106-918"><a href="#cb106-918" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb106-919"><a href="#cb106-919" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-920"><a href="#cb106-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-921"><a href="#cb106-921" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-922"><a href="#cb106-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-923"><a href="#cb106-923" aria-hidden="true" tabindex="-1"></a>应用(NBA数据)：</span>
<span id="cb106-924"><a href="#cb106-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-927"><a href="#cb106-927" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-928"><a href="#cb106-928" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb106-929"><a href="#cb106-929" aria-hidden="true" tabindex="-1"></a>cp_decomp <span class="ot">&lt;-</span> <span class="fu">parafac</span>(tensor_numeric, <span class="at">nfac =</span> <span class="dv">2</span>, <span class="at">const=</span><span class="fu">c</span>(<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>,<span class="st">"nonneg"</span>), <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-930"><a href="#cb106-930" aria-hidden="true" tabindex="-1"></a><span class="co"># cp_decomp</span></span>
<span id="cb106-931"><a href="#cb106-931" aria-hidden="true" tabindex="-1"></a><span class="co"># const()</span></span>
<span id="cb106-932"><a href="#cb106-932" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取结果</span></span>
<span id="cb106-933"><a href="#cb106-933" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>A  <span class="co"># 第一模态因子矩阵</span></span>
<span id="cb106-934"><a href="#cb106-934" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>B  <span class="co"># 第二模态因子矩阵</span></span>
<span id="cb106-935"><a href="#cb106-935" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> cp_decomp<span class="sc">$</span>C  <span class="co"># 时间模态因子矩阵</span></span>
<span id="cb106-936"><a href="#cb106-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-937"><a href="#cb106-937" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> C</span>
<span id="cb106-938"><a href="#cb106-938" aria-hidden="true" tabindex="-1"></a><span class="co"># 假设数据矩阵 Y 已经准备好</span></span>
<span id="cb106-939"><a href="#cb106-939" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(Y,<span class="at">beta_min =</span> <span class="dv">3</span>, </span>
<span id="cb106-940"><a href="#cb106-940" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_max =</span> <span class="dv">50</span>, </span>
<span id="cb106-941"><a href="#cb106-941" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-942"><a href="#cb106-942" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size=</span><span class="dv">2</span>, </span>
<span id="cb106-943"><a href="#cb106-943" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">p=</span><span class="dv">2</span>, </span>
<span id="cb106-944"><a href="#cb106-944" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">elbow_window=</span><span class="dv">10</span>,</span>
<span id="cb106-945"><a href="#cb106-945" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-946"><a href="#cb106-946" aria-hidden="true" tabindex="-1"></a><span class="co">#res #查看细节</span></span>
<span id="cb106-947"><a href="#cb106-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-948"><a href="#cb106-948" aria-hidden="true" tabindex="-1"></a><span class="co"># 画图</span></span>
<span id="cb106-949"><a href="#cb106-949" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_segmentation_path</span>(res)</span>
<span id="cb106-950"><a href="#cb106-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-951"><a href="#cb106-951" aria-hidden="true" tabindex="-1"></a><span class="co"># 用推荐 beta 获取最终变点</span></span>
<span id="cb106-952"><a href="#cb106-952" aria-hidden="true" tabindex="-1"></a>best_beta <span class="ot">&lt;-</span> res<span class="sc">$</span>best_beta</span>
<span id="cb106-953"><a href="#cb106-953" aria-hidden="true" tabindex="-1"></a>change_points <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, <span class="at">beta =</span>best_beta, <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>))</span>
<span id="cb106-954"><a href="#cb106-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-955"><a href="#cb106-955" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"最终变点："</span>, <span class="fu">paste</span>(change_points, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-956"><a href="#cb106-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-957"><a href="#cb106-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-958"><a href="#cb106-958" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-959"><a href="#cb106-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-960"><a href="#cb106-960" aria-hidden="true" tabindex="-1"></a>结果稳定在2016年（变点）</span>
<span id="cb106-961"><a href="#cb106-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-962"><a href="#cb106-962" aria-hidden="true" tabindex="-1"></a><span class="fu"># Proposed VS 逐维法</span></span>
<span id="cb106-963"><a href="#cb106-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-964"><a href="#cb106-964" aria-hidden="true" tabindex="-1"></a><span class="fu"># 评测指标</span></span>
<span id="cb106-965"><a href="#cb106-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-966"><a href="#cb106-966" aria-hidden="true" tabindex="-1"></a>1.AnnotationError AnnotationError 是预测变点数量与真实变点数量之间的差异：</span>
<span id="cb106-967"><a href="#cb106-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-968"><a href="#cb106-968" aria-hidden="true" tabindex="-1"></a>$$\text{ANNOtationError}:=\left\|\widehat{K}-K^{*}\right\|.$$ 指标用于区分在未知变点数量情况下的检测方法。</span>
<span id="cb106-969"><a href="#cb106-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-970"><a href="#cb106-970" aria-hidden="true" tabindex="-1"></a>2.Hausdorff HAUSDORFF 距离衡量的是检测方法在不同变点位置上的最大误差：</span>
<span id="cb106-971"><a href="#cb106-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-972"><a href="#cb106-972" aria-hidden="true" tabindex="-1"></a>$$ \operatorname{HAUSDORFF}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right):=\max\left\{\max_{\hat{t}\in\widehat{\mathcal{T}}}\min_{t^{*}\in\mathcal{T}^{*}}\left|\hat{t}-t^{*}\right|,\max_{t^{*}\in\mathcal{T}^{*}}\min_{\hat{t}\in\widehat{\mathcal{T}}}\left|\hat{t}-t^{*}\right|\right<span class="sc">\}</span>. $$</span>
<span id="cb106-973"><a href="#cb106-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-974"><a href="#cb106-974" aria-hidden="true" tabindex="-1"></a>如果这个指标为零，说明两个变点集合完全相同；否则，说明存在较大的误差。</span>
<span id="cb106-975"><a href="#cb106-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-976"><a href="#cb106-976" aria-hidden="true" tabindex="-1"></a>3.RandIndex RANDINDEX 用于衡量预测变点集合与真实变点集合之间的相似性：</span>
<span id="cb106-977"><a href="#cb106-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-978"><a href="#cb106-978" aria-hidden="true" tabindex="-1"></a>$$ \operatorname{RANDINDEX}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right):=\frac{\left|\operatorname{gr}\left(\widehat{\mathcal{T}}\right)\cap\operatorname{gr}\left(\mathcal{T}^{*}\right)\right| + \left|\operatorname{ngr}\left(\widehat{\mathcal{T}}\right)\cap\operatorname{ngr}\left(\mathcal{T}^{*}\right)\right|}{T(T-1)} $$</span>
<span id="cb106-979"><a href="#cb106-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-980"><a href="#cb106-980" aria-hidden="true" tabindex="-1"></a>其中</span>
<span id="cb106-981"><a href="#cb106-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-982"><a href="#cb106-982" aria-hidden="true" tabindex="-1"></a>$$ \operatorname{gr}(\mathcal{T}) := \left<span class="sc">\{</span> (s, t) \mid 1 \leq s &lt; t \leq T \text{ s.t. } s \text{ and } t \text{ belong to the same segment according to } \mathcal{T} \right<span class="sc">\}</span>, $$</span>
<span id="cb106-983"><a href="#cb106-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-984"><a href="#cb106-984" aria-hidden="true" tabindex="-1"></a>$$ \operatorname{ngr}(\mathcal{T}) := \left<span class="sc">\{</span> (s, t) \mid 1 \leq s &lt; t \leq T \text{ s.t. } s \text{ and } t \text{ belong to different segments according to } \mathcal{T} \right<span class="sc">\}</span>. $$</span>
<span id="cb106-985"><a href="#cb106-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-986"><a href="#cb106-986" aria-hidden="true" tabindex="-1"></a>RANDINDEX 的取值范围在0到1之间，1表示完全一致，0表示完全不一致.</span>
<span id="cb106-987"><a href="#cb106-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-988"><a href="#cb106-988" aria-hidden="true" tabindex="-1"></a>4.F1-score: F1-score 是精确率和召回率的调和平均值： $$ F1\operatorname{ScoRE}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right):=2\times\frac{\operatorname{PREc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)\times\operatorname{REc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)}{\operatorname{PREc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)+\operatorname{REc}\left(\mathcal{T}^{*},\widehat{\mathcal{T}}\right)}.  $$</span>
<span id="cb106-989"><a href="#cb106-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-990"><a href="#cb106-990" aria-hidden="true" tabindex="-1"></a>F1-score 的取值范围也在0到1之间，1表示最佳性能，0表示最差性能。</span>
<span id="cb106-991"><a href="#cb106-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-992"><a href="#cb106-992" aria-hidden="true" tabindex="-1"></a>评价函数code：</span>
<span id="cb106-993"><a href="#cb106-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-996"><a href="#cb106-996" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-997"><a href="#cb106-997" aria-hidden="true" tabindex="-1"></a><span class="co"># 评价函数（增强鲁棒性）</span></span>
<span id="cb106-998"><a href="#cb106-998" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-999"><a href="#cb106-999" aria-hidden="true" tabindex="-1"></a>hausdorff <span class="ot">&lt;-</span> <span class="cf">function</span>(A, B) {</span>
<span id="cb106-1000"><a href="#cb106-1000" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(A) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(B) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">Inf</span>)</span>
<span id="cb106-1001"><a href="#cb106-1001" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(A)</span>
<span id="cb106-1002"><a href="#cb106-1002" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(B)</span>
<span id="cb106-1003"><a href="#cb106-1003" aria-hidden="true" tabindex="-1"></a>  max_A <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(A, <span class="cf">function</span>(a) <span class="fu">min</span>(<span class="fu">abs</span>(a <span class="sc">-</span> B))))</span>
<span id="cb106-1004"><a href="#cb106-1004" aria-hidden="true" tabindex="-1"></a>  max_B <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(B, <span class="cf">function</span>(b) <span class="fu">min</span>(<span class="fu">abs</span>(b <span class="sc">-</span> A))))</span>
<span id="cb106-1005"><a href="#cb106-1005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">max</span>(max_A, max_B))</span>
<span id="cb106-1006"><a href="#cb106-1006" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1007"><a href="#cb106-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1008"><a href="#cb106-1008" aria-hidden="true" tabindex="-1"></a>f1_score <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, <span class="at">tol =</span> <span class="dv">1</span>) {</span>
<span id="cb106-1009"><a href="#cb106-1009" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb106-1010"><a href="#cb106-1010" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb106-1011"><a href="#cb106-1011" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1012"><a href="#cb106-1012" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 处理空输入</span></span>
<span id="cb106-1013"><a href="#cb106-1013" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(detected_cp) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb106-1014"><a href="#cb106-1014" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-1015"><a href="#cb106-1015" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1016"><a href="#cb106-1016" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1017"><a href="#cb106-1017" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">any</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&lt;=</span> tol)))</span>
<span id="cb106-1018"><a href="#cb106-1018" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(detected_cp, <span class="cf">function</span>(dc) <span class="fu">all</span>(<span class="fu">abs</span>(true_cp <span class="sc">-</span> dc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb106-1019"><a href="#cb106-1019" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">all</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb106-1020"><a href="#cb106-1020" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1021"><a href="#cb106-1021" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FP) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FP)</span>
<span id="cb106-1022"><a href="#cb106-1022" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FN) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb106-1023"><a href="#cb106-1023" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1024"><a href="#cb106-1024" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((precision <span class="sc">+</span> recall) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-1025"><a href="#cb106-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="dv">2</span> <span class="sc">*</span> precision <span class="sc">*</span> recall <span class="sc">/</span> (precision <span class="sc">+</span> recall))</span>
<span id="cb106-1026"><a href="#cb106-1026" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1027"><a href="#cb106-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1028"><a href="#cb106-1028" aria-hidden="true" tabindex="-1"></a>rand_index <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, n) {</span>
<span id="cb106-1029"><a href="#cb106-1029" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(true_cp))</span>
<span id="cb106-1030"><a href="#cb106-1030" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(detected_cp))</span>
<span id="cb106-1031"><a href="#cb106-1031" aria-hidden="true" tabindex="-1"></a>  true_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, true_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-1032"><a href="#cb106-1032" aria-hidden="true" tabindex="-1"></a>  detected_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, detected_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-1033"><a href="#cb106-1033" aria-hidden="true" tabindex="-1"></a>  agree <span class="ot">&lt;-</span> <span class="fu">outer</span>(true_labels, true_labels, <span class="st">"=="</span>) <span class="sc">==</span> <span class="fu">outer</span>(detected_labels, detected_labels, <span class="st">"=="</span>)</span>
<span id="cb106-1034"><a href="#cb106-1034" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(agree))</span>
<span id="cb106-1035"><a href="#cb106-1035" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1036"><a href="#cb106-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1037"><a href="#cb106-1037" aria-hidden="true" tabindex="-1"></a>annotation_error <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp) {</span>
<span id="cb106-1038"><a href="#cb106-1038" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb106-1039"><a href="#cb106-1039" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb106-1040"><a href="#cb106-1040" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>(<span class="fu">length</span>(true_cp) <span class="sc">-</span> <span class="fu">length</span>(detected_cp))</span>
<span id="cb106-1041"><a href="#cb106-1041" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1042"><a href="#cb106-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1043"><a href="#cb106-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1044"><a href="#cb106-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1045"><a href="#cb106-1045" aria-hidden="true" tabindex="-1"></a><span class="fu"># 稠密模式</span></span>
<span id="cb106-1046"><a href="#cb106-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1047"><a href="#cb106-1047" aria-hidden="true" tabindex="-1"></a>设观测为 $d$ 维时间序列 $<span class="sc">\{</span>Y_t<span class="sc">\}</span>_{t=1}^n$，其中 $Y_t\in\mathbb{R}^d$，是分段常数，给定分段端点 $$</span>
<span id="cb106-1048"><a href="#cb106-1048" aria-hidden="true" tabindex="-1"></a>0=\tau_0&lt;\tau_1&lt;\cdots&lt;\tau_K=n,</span>
<span id="cb106-1049"><a href="#cb106-1049" aria-hidden="true" tabindex="-1"></a>$$ 在每个区间 $(\tau_{k-1},\tau_k]$ 上有 $$</span>
<span id="cb106-1050"><a href="#cb106-1050" aria-hidden="true" tabindex="-1"></a>Y_t=\mu_k+\varepsilon_t,\quad t\in(\tau_{k-1},\tau_k],\ k=1,\ldots,K.</span>
<span id="cb106-1051"><a href="#cb106-1051" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1052"><a href="#cb106-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1053"><a href="#cb106-1053" aria-hidden="true" tabindex="-1"></a>真变点集合记为 $$</span>
<span id="cb106-1054"><a href="#cb106-1054" aria-hidden="true" tabindex="-1"></a>T^<span class="sc">\*</span>=<span class="sc">\{</span>\tau_1,\tau_2,\ldots,\tau_K<span class="sc">\}</span>.</span>
<span id="cb106-1055"><a href="#cb106-1055" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1056"><a href="#cb106-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1057"><a href="#cb106-1057" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb106-1058"><a href="#cb106-1058" aria-hidden="true" tabindex="-1"></a>**例**：$n=2000,\ d\in<span class="co">[</span><span class="ot">100,200</span><span class="co">]</span>,\ T^<span class="sc">\*</span>=<span class="sc">\{</span>600,1200,1600<span class="sc">\}</span>$</span>
<span id="cb106-1059"><a href="#cb106-1059" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-1060"><a href="#cb106-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1061"><a href="#cb106-1061" aria-hidden="true" tabindex="-1"></a>密集（dense）变点设定</span>
<span id="cb106-1062"><a href="#cb106-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1063"><a href="#cb106-1063" aria-hidden="true" tabindex="-1"></a>在每个变点 $\tau_k$ 处，有比例为 $\rho$ 的坐标同时发生均值跃迁，跃迁幅度为 $\Delta$。令 $S_k\subset<span class="sc">\{</span>1,\ldots,d<span class="sc">\}</span>$，$|S_k|=\lfloor \rho d\rfloor$，并令 $s_k\in<span class="sc">\{</span>+1,-1<span class="sc">\}</span>$ 表示跃迁方向（同一变点内方向一致）。则 $$</span>
<span id="cb106-1064"><a href="#cb106-1064" aria-hidden="true" tabindex="-1"></a>\mu_k=\mu_{k-1}+s_k\,\Delta\,\mathbf{1}_{S_k},</span>
<span id="cb106-1065"><a href="#cb106-1065" aria-hidden="true" tabindex="-1"></a>$$ 其中 $\mathbf{1}_{S_k}\in\mathbb{R}^d$ 为在 $S_k$ 上取 $1$、其余取 $0$ 的指示向量。</span>
<span id="cb106-1066"><a href="#cb106-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1067"><a href="#cb106-1067" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb106-1068"><a href="#cb106-1068" aria-hidden="true" tabindex="-1"></a>**例**：$\rho=0.7,\ \Delta=1.0$</span>
<span id="cb106-1069"><a href="#cb106-1069" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-1070"><a href="#cb106-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1071"><a href="#cb106-1071" aria-hidden="true" tabindex="-1"></a>噪声过程 $<span class="sc">\{</span>\varepsilon_t<span class="sc">\}</span>$ 可取其一：</span>
<span id="cb106-1072"><a href="#cb106-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1073"><a href="#cb106-1073" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**独立同分布高斯噪声**（各维独立同分布）： $$</span>
<span id="cb106-1074"><a href="#cb106-1074" aria-hidden="true" tabindex="-1"></a>    \varepsilon_t \overset{\text{i.i.d.}}{\sim}\mathcal{N}(0,\sigma^2 I_d).</span>
<span id="cb106-1075"><a href="#cb106-1075" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb106-1076"><a href="#cb106-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1077"><a href="#cb106-1077" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**各维独立的 AR(1) 噪声**（刻画时间相关性）：</span>
<span id="cb106-1078"><a href="#cb106-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1079"><a href="#cb106-1079" aria-hidden="true" tabindex="-1"></a>    $$ \varepsilon_t=\phi\,\varepsilon_{t-1}+\eta_t,\qquad</span>
<span id="cb106-1080"><a href="#cb106-1080" aria-hidden="true" tabindex="-1"></a>    \eta_t\overset{\text{i.i.d.}}{\sim}\mathcal{N}(0,\sigma_\eta^2 I_d).$$</span>
<span id="cb106-1081"><a href="#cb106-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1082"><a href="#cb106-1082" aria-hidden="true" tabindex="-1"></a>    其中</span>
<span id="cb106-1083"><a href="#cb106-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1084"><a href="#cb106-1084" aria-hidden="true" tabindex="-1"></a>    $$ \sigma_\eta^2 = \sigma^2(1-\phi^2). $$</span>
<span id="cb106-1085"><a href="#cb106-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1086"><a href="#cb106-1086" aria-hidden="true" tabindex="-1"></a>    例：$\phi=0.2$.</span>
<span id="cb106-1087"><a href="#cb106-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1088"><a href="#cb106-1088" aria-hidden="true" tabindex="-1"></a><span class="fu"># code:</span></span>
<span id="cb106-1089"><a href="#cb106-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1090"><a href="#cb106-1090" aria-hidden="true" tabindex="-1"></a><span class="fu">## 数据生成：</span></span>
<span id="cb106-1091"><a href="#cb106-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1092"><a href="#cb106-1092" aria-hidden="true" tabindex="-1"></a>$<span class="sc">\{</span>Y_t<span class="sc">\}</span>_{t=1}^n$是分段常数</span>
<span id="cb106-1093"><a href="#cb106-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1096"><a href="#cb106-1096" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1097"><a href="#cb106-1097" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 密集模式数据生成</span></span>
<span id="cb106-1098"><a href="#cb106-1098" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-1099"><a href="#cb106-1099" aria-hidden="true" tabindex="-1"></a>simulate_dense <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">100</span>,</span>
<span id="cb106-1100"><a href="#cb106-1100" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>),</span>
<span id="cb106-1101"><a href="#cb106-1101" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rho =</span> <span class="fl">0.6</span>,              <span class="co"># 每次跳变的受影响比例</span></span>
<span id="cb106-1102"><a href="#cb106-1102" aria-hidden="true" tabindex="-1"></a>                           <span class="at">delta =</span> <span class="fl">1.0</span>,            <span class="co"># 单次跳变幅度（同号）</span></span>
<span id="cb106-1103"><a href="#cb106-1103" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma =</span> <span class="fl">1.0</span>,            <span class="co"># 噪声标准差</span></span>
<span id="cb106-1104"><a href="#cb106-1104" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ar_phi =</span> <span class="fl">0.0</span>,           <span class="co"># AR(1) 噪声相关，0 表示独立</span></span>
<span id="cb106-1105"><a href="#cb106-1105" aria-hidden="true" tabindex="-1"></a>                           <span class="at">same_sign =</span> <span class="cn">TRUE</span>,       <span class="co"># TRUE：所有受影响维同号上升</span></span>
<span id="cb106-1106"><a href="#cb106-1106" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb106-1107"><a href="#cb106-1107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb106-1108"><a href="#cb106-1108" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb106-1109"><a href="#cb106-1109" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb106-1110"><a href="#cb106-1110" aria-hidden="true" tabindex="-1"></a>  Y  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-1111"><a href="#cb106-1111" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-1112"><a href="#cb106-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1113"><a href="#cb106-1113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 固定一个受影响子集（密集：每个变点都影响同一批维度）</span></span>
<span id="cb106-1114"><a href="#cb106-1114" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb106-1115"><a href="#cb106-1115" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1116"><a href="#cb106-1116" aria-hidden="true" tabindex="-1"></a>  jump_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d); jump_vec[S] <span class="ot">&lt;-</span> signs[S] <span class="sc">*</span> delta</span>
<span id="cb106-1117"><a href="#cb106-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1118"><a href="#cb106-1118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 累积式均值：每遇到一个变点，对 [cp+1, n] 段叠加 jump_vec</span></span>
<span id="cb106-1119"><a href="#cb106-1119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (cp <span class="cf">in</span> cps) {</span>
<span id="cb106-1120"><a href="#cb106-1120" aria-hidden="true" tabindex="-1"></a>    mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, ] <span class="ot">&lt;-</span> <span class="fu">sweep</span>(mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, , <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="dv">2</span>, jump_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb106-1121"><a href="#cb106-1121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1122"><a href="#cb106-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1123"><a href="#cb106-1123" aria-hidden="true" tabindex="-1"></a>  <span class="co">#嵌入噪声：独立或 AR(1)</span></span>
<span id="cb106-1124"><a href="#cb106-1124" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb106-1125"><a href="#cb106-1125" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb106-1126"><a href="#cb106-1126" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-1127"><a href="#cb106-1127" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-1128"><a href="#cb106-1128" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb106-1129"><a href="#cb106-1129" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb106-1130"><a href="#cb106-1130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb106-1131"><a href="#cb106-1131" aria-hidden="true" tabindex="-1"></a>      eps[t, ] <span class="ot">&lt;-</span> ar_phi <span class="sc">*</span> eps[t <span class="sc">-</span> <span class="dv">1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb106-1132"><a href="#cb106-1132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1133"><a href="#cb106-1133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1134"><a href="#cb106-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1135"><a href="#cb106-1135" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> mu <span class="sc">+</span> eps</span>
<span id="cb106-1136"><a href="#cb106-1136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> Y, <span class="at">true_cp =</span> cps, <span class="at">mu =</span> mu, <span class="at">S =</span> S)</span>
<span id="cb106-1137"><a href="#cb106-1137" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1138"><a href="#cb106-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1139"><a href="#cb106-1139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1140"><a href="#cb106-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1141"><a href="#cb106-1141" aria-hidden="true" tabindex="-1"></a><span class="fu">## func: 逐维（ABS） vs 高维</span></span>
<span id="cb106-1142"><a href="#cb106-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1143"><a href="#cb106-1143" aria-hidden="true" tabindex="-1"></a>即一维一维做abs的结果和直接做高维abs结果的对比</span>
<span id="cb106-1144"><a href="#cb106-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1145"><a href="#cb106-1145" aria-hidden="true" tabindex="-1"></a>code：</span>
<span id="cb106-1146"><a href="#cb106-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1149"><a href="#cb106-1149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1150"><a href="#cb106-1150" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-1151"><a href="#cb106-1151" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 逐维法：单维 BS + 合并</span></span>
<span id="cb106-1152"><a href="#cb106-1152" aria-hidden="true" tabindex="-1"></a><span class="do">##    ——并配套“稳定路径 Elbow+Plateau”自适应选 β（与 ABS 公平）</span></span>
<span id="cb106-1153"><a href="#cb106-1153" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-1154"><a href="#cb106-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1155"><a href="#cb106-1155" aria-hidden="true" tabindex="-1"></a><span class="co"># 把若干维度检出的变点合并：按 tol 聚簇，簇内取均值(四舍五入)为代表</span></span>
<span id="cb106-1156"><a href="#cb106-1156" aria-hidden="true" tabindex="-1"></a>merge_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(cplist, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>)) {</span>
<span id="cb106-1157"><a href="#cb106-1157" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb106-1158"><a href="#cb106-1158" aria-hidden="true" tabindex="-1"></a>  all <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.integer</span>(<span class="fu">unlist</span>(cplist)))</span>
<span id="cb106-1159"><a href="#cb106-1159" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(all) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-1160"><a href="#cb106-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1161"><a href="#cb106-1161" aria-hidden="true" tabindex="-1"></a>  clusters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-1162"><a href="#cb106-1162" aria-hidden="true" tabindex="-1"></a>  curr <span class="ot">&lt;-</span> <span class="fu">c</span>(all[<span class="dv">1</span>])</span>
<span id="cb106-1163"><a href="#cb106-1163" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x <span class="cf">in</span> all[<span class="sc">-</span><span class="dv">1</span>]) {</span>
<span id="cb106-1164"><a href="#cb106-1164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">-</span> curr[<span class="fu">length</span>(curr)] <span class="sc">&lt;=</span> tol) {</span>
<span id="cb106-1165"><a href="#cb106-1165" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(curr, x)</span>
<span id="cb106-1166"><a href="#cb106-1166" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb106-1167"><a href="#cb106-1167" aria-hidden="true" tabindex="-1"></a>      clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb106-1168"><a href="#cb106-1168" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(x)</span>
<span id="cb106-1169"><a href="#cb106-1169" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1170"><a href="#cb106-1170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1171"><a href="#cb106-1171" aria-hidden="true" tabindex="-1"></a>  clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb106-1172"><a href="#cb106-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1173"><a href="#cb106-1173" aria-hidden="true" tabindex="-1"></a>  rep_fun <span class="ot">&lt;-</span> <span class="cf">if</span> (representative <span class="sc">==</span> <span class="st">"mean"</span>) mean <span class="cf">else</span> median</span>
<span id="cb106-1174"><a href="#cb106-1174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">vapply</span>(clusters, rep_fun, <span class="fu">numeric</span>(<span class="dv">1</span>))))</span>
<span id="cb106-1175"><a href="#cb106-1175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1176"><a href="#cb106-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1177"><a href="#cb106-1177" aria-hidden="true" tabindex="-1"></a><span class="do">## 在单一维度上独立寻找合适的 β 和对应的变点=====================================================================</span></span>
<span id="cb106-1178"><a href="#cb106-1178" aria-hidden="true" tabindex="-1"></a>per_dim_single_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(y_vec,</span>
<span id="cb106-1179"><a href="#cb106-1179" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-1180"><a href="#cb106-1180" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>) {</span>
<span id="cb106-1181"><a href="#cb106-1181" aria-hidden="true" tabindex="-1"></a>  Yj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(y_vec, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb106-1182"><a href="#cb106-1182" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb106-1183"><a href="#cb106-1183" aria-hidden="true" tabindex="-1"></a>  results   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb106-1184"><a href="#cb106-1184" aria-hidden="true" tabindex="-1"></a>  counts    <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb106-1185"><a href="#cb106-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1186"><a href="#cb106-1186" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb106-1187"><a href="#cb106-1187" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb106-1188"><a href="#cb106-1188" aria-hidden="true" tabindex="-1"></a>    th <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Yj, b, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Yj), <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb106-1189"><a href="#cb106-1189" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> th</span>
<span id="cb106-1190"><a href="#cb106-1190" aria-hidden="true" tabindex="-1"></a>    counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(th)</span>
<span id="cb106-1191"><a href="#cb106-1191" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1192"><a href="#cb106-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1193"><a href="#cb106-1193" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(counts <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb106-1194"><a href="#cb106-1194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">best_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb106-1195"><a href="#cb106-1195" aria-hidden="true" tabindex="-1"></a>                <span class="at">elbow_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb106-1196"><a href="#cb106-1196" aria-hidden="true" tabindex="-1"></a>                <span class="at">plateaus =</span> <span class="fu">list</span>(), <span class="at">t_hat =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb106-1197"><a href="#cb106-1197" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts))</span>
<span id="cb106-1198"><a href="#cb106-1198" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1199"><a href="#cb106-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1200"><a href="#cb106-1200" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, counts)</span>
<span id="cb106-1201"><a href="#cb106-1201" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb106-1202"><a href="#cb106-1202" aria-hidden="true" tabindex="-1"></a>  pls <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, counts)</span>
<span id="cb106-1203"><a href="#cb106-1203" aria-hidden="true" tabindex="-1"></a>  left_bound  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb106-1204"><a href="#cb106-1204" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb106-1205"><a href="#cb106-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1206"><a href="#cb106-1206" aria-hidden="true" tabindex="-1"></a>  best_pl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-1207"><a href="#cb106-1207" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> pls) {</span>
<span id="cb106-1208"><a href="#cb106-1208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound <span class="sc">&amp;&amp;</span> pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound) {</span>
<span id="cb106-1209"><a href="#cb106-1209" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_pl) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_pl<span class="sc">$</span>length) best_pl <span class="ot">&lt;-</span> pp</span>
<span id="cb106-1210"><a href="#cb106-1210" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1211"><a href="#cb106-1211" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1212"><a href="#cb106-1212" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_pl<span class="sc">$</span>start <span class="sc">+</span> best_pl<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb106-1213"><a href="#cb106-1213" aria-hidden="true" tabindex="-1"></a>  best_idx  <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(beta_list <span class="sc">-</span> best_beta))</span>
<span id="cb106-1214"><a href="#cb106-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1215"><a href="#cb106-1215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">best_beta =</span> best_beta,</span>
<span id="cb106-1216"><a href="#cb106-1216" aria-hidden="true" tabindex="-1"></a>       <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb106-1217"><a href="#cb106-1217" aria-hidden="true" tabindex="-1"></a>       <span class="at">plateaus =</span> pls,</span>
<span id="cb106-1218"><a href="#cb106-1218" aria-hidden="true" tabindex="-1"></a>       <span class="at">t_hat =</span> <span class="fu">sort</span>(results[[best_idx]]),</span>
<span id="cb106-1219"><a href="#cb106-1219" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts)</span>
<span id="cb106-1220"><a href="#cb106-1220" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1221"><a href="#cb106-1221" aria-hidden="true" tabindex="-1"></a><span class="do">##在多维数据上做逐维检出，再合并成一个整体的变点集合########</span></span>
<span id="cb106-1222"><a href="#cb106-1222" aria-hidden="true" tabindex="-1"></a>per_dim_individual_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb106-1223"><a href="#cb106-1223" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-1224"><a href="#cb106-1224" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-1225"><a href="#cb106-1225" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>),</span>
<span id="cb106-1226"><a href="#cb106-1226" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-1227"><a href="#cb106-1227" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb106-1228"><a href="#cb106-1228" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb106-1229"><a href="#cb106-1229" aria-hidden="true" tabindex="-1"></a>  dim_betas <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d)</span>
<span id="cb106-1230"><a href="#cb106-1230" aria-hidden="true" tabindex="-1"></a>  dim_cps   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, d)</span>
<span id="cb106-1231"><a href="#cb106-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1232"><a href="#cb106-1232" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb106-1233"><a href="#cb106-1233" aria-hidden="true" tabindex="-1"></a>    rj <span class="ot">&lt;-</span> <span class="fu">per_dim_single_adaptive</span>(Y[, j],</span>
<span id="cb106-1234"><a href="#cb106-1234" aria-hidden="true" tabindex="-1"></a>                                  beta_min, beta_max, beta_points,</span>
<span id="cb106-1235"><a href="#cb106-1235" aria-hidden="true" tabindex="-1"></a>                                  min_size, p, elbow_window)</span>
<span id="cb106-1236"><a href="#cb106-1236" aria-hidden="true" tabindex="-1"></a>    dim_betas[j] <span class="ot">&lt;-</span> rj<span class="sc">$</span>best_beta</span>
<span id="cb106-1237"><a href="#cb106-1237" aria-hidden="true" tabindex="-1"></a>    dim_cps[[j]] <span class="ot">&lt;-</span> rj<span class="sc">$</span>t_hat</span>
<span id="cb106-1238"><a href="#cb106-1238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose) <span class="sc">&amp;&amp;</span> (j <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[per-dim] finished %d/%d"</span>, j, d))</span>
<span id="cb106-1239"><a href="#cb106-1239" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1240"><a href="#cb106-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1241"><a href="#cb106-1241" aria-hidden="true" tabindex="-1"></a>  merged <span class="ot">&lt;-</span> <span class="fu">merge_cps</span>(dim_cps, <span class="at">tol =</span> tol, <span class="at">representative =</span> representative)</span>
<span id="cb106-1242"><a href="#cb106-1242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">merged_cp =</span> <span class="fu">sort</span>(merged), <span class="at">per_dim_beta =</span> dim_betas, <span class="at">per_dim_cp =</span> dim_cps)</span>
<span id="cb106-1243"><a href="#cb106-1243" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1244"><a href="#cb106-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1245"><a href="#cb106-1245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1246"><a href="#cb106-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1247"><a href="#cb106-1247" aria-hidden="true" tabindex="-1"></a><span class="fu">### (跑评价)</span></span>
<span id="cb106-1248"><a href="#cb106-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1251"><a href="#cb106-1251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1252"><a href="#cb106-1252" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-1253"><a href="#cb106-1253" aria-hidden="true" tabindex="-1"></a>run_one_trial <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>,</span>
<span id="cb106-1254"><a href="#cb106-1254" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb106-1255"><a href="#cb106-1255" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1256"><a href="#cb106-1256" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb106-1257"><a href="#cb106-1257" aria-hidden="true" tabindex="-1"></a>                          <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1258"><a href="#cb106-1258" aria-hidden="true" tabindex="-1"></a>                          <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-1259"><a href="#cb106-1259" aria-hidden="true" tabindex="-1"></a>                          <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1260"><a href="#cb106-1260" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="cn">NULL</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-1261"><a href="#cb106-1261" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span>(n, d, cps, rho, delta, sigma, ar_phi, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb106-1262"><a href="#cb106-1262" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb106-1263"><a href="#cb106-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1264"><a href="#cb106-1264" aria-hidden="true" tabindex="-1"></a>  t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb106-1265"><a href="#cb106-1265" aria-hidden="true" tabindex="-1"></a>    abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb106-1266"><a href="#cb106-1266" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb106-1267"><a href="#cb106-1267" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> verbose</span>
<span id="cb106-1268"><a href="#cb106-1268" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1269"><a href="#cb106-1269" aria-hidden="true" tabindex="-1"></a>    idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb106-1270"><a href="#cb106-1270" aria-hidden="true" tabindex="-1"></a>    cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb106-1271"><a href="#cb106-1271" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb106-1272"><a href="#cb106-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1273"><a href="#cb106-1273" aria-hidden="true" tabindex="-1"></a>  t_per <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb106-1274"><a href="#cb106-1274" aria-hidden="true" tabindex="-1"></a>    per_res <span class="ot">&lt;-</span> <span class="fu">per_dim_individual_adaptive</span>(</span>
<span id="cb106-1275"><a href="#cb106-1275" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> per_beta_min, <span class="at">beta_max =</span> per_beta_max, <span class="at">beta_points =</span> per_beta_points,</span>
<span id="cb106-1276"><a href="#cb106-1276" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_per, <span class="at">tol =</span> tol_match, <span class="at">elbow_window =</span> elbow_window,</span>
<span id="cb106-1277"><a href="#cb106-1277" aria-hidden="true" tabindex="-1"></a>      <span class="at">representative =</span> representative, <span class="at">verbose =</span> verbose</span>
<span id="cb106-1278"><a href="#cb106-1278" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1279"><a href="#cb106-1279" aria-hidden="true" tabindex="-1"></a>    cp_per <span class="ot">&lt;-</span> per_res<span class="sc">$</span>merged_cp</span>
<span id="cb106-1280"><a href="#cb106-1280" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb106-1281"><a href="#cb106-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1282"><a href="#cb106-1282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 评估</span></span>
<span id="cb106-1283"><a href="#cb106-1283" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> tol_match)</span>
<span id="cb106-1284"><a href="#cb106-1284" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_per, <span class="at">tol =</span> tol_match)</span>
<span id="cb106-1285"><a href="#cb106-1285" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb106-1286"><a href="#cb106-1286" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_per)</span>
<span id="cb106-1287"><a href="#cb106-1287" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> n)</span>
<span id="cb106-1288"><a href="#cb106-1288" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_per, <span class="at">n =</span> n)</span>
<span id="cb106-1289"><a href="#cb106-1289" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb106-1290"><a href="#cb106-1290" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_per)</span>
<span id="cb106-1291"><a href="#cb106-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1292"><a href="#cb106-1292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb106-1293"><a href="#cb106-1293" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp =</span> true_cp,</span>
<span id="cb106-1294"><a href="#cb106-1294" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_abs,</span>
<span id="cb106-1295"><a href="#cb106-1295" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> abs_f1, <span class="at">haus =</span> abs_haus, <span class="at">rand =</span> abs_rand, <span class="at">ann =</span> abs_ann,</span>
<span id="cb106-1296"><a href="#cb106-1296" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])),</span>
<span id="cb106-1297"><a href="#cb106-1297" aria-hidden="true" tabindex="-1"></a>    <span class="at">per =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_per,</span>
<span id="cb106-1298"><a href="#cb106-1298" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> per_f1, <span class="at">haus =</span> per_haus, <span class="at">rand =</span> per_rand, <span class="at">ann =</span> per_ann,</span>
<span id="cb106-1299"><a href="#cb106-1299" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_per[<span class="st">"elapsed"</span>]))</span>
<span id="cb106-1300"><a href="#cb106-1300" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1301"><a href="#cb106-1301" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1302"><a href="#cb106-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1303"><a href="#cb106-1303" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-1304"><a href="#cb106-1304" aria-hidden="true" tabindex="-1"></a><span class="do">##) 批量实验与汇总</span></span>
<span id="cb106-1305"><a href="#cb106-1305" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-1306"><a href="#cb106-1306" aria-hidden="true" tabindex="-1"></a>run_experiments <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">30</span>,</span>
<span id="cb106-1307"><a href="#cb106-1307" aria-hidden="true" tabindex="-1"></a>                            <span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb106-1308"><a href="#cb106-1308" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1309"><a href="#cb106-1309" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb106-1310"><a href="#cb106-1310" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1311"><a href="#cb106-1311" aria-hidden="true" tabindex="-1"></a>                            <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-1312"><a href="#cb106-1312" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1313"><a href="#cb106-1313" aria-hidden="true" tabindex="-1"></a>                            <span class="at">seed0 =</span> <span class="dv">123</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-1314"><a href="#cb106-1314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed0)</span>
<span id="cb106-1315"><a href="#cb106-1315" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb106-1316"><a href="#cb106-1316" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb106-1317"><a href="#cb106-1317" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, <span class="dv">1</span>)</span>
<span id="cb106-1318"><a href="#cb106-1318" aria-hidden="true" tabindex="-1"></a>    results[[r]] <span class="ot">&lt;-</span> <span class="fu">run_one_trial</span>(</span>
<span id="cb106-1319"><a href="#cb106-1319" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> n, <span class="at">d =</span> d, <span class="at">cps =</span> cps, <span class="at">rho =</span> rho, <span class="at">delta =</span> delta, <span class="at">sigma =</span> sigma, <span class="at">ar_phi =</span> ar_phi,</span>
<span id="cb106-1320"><a href="#cb106-1320" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">tol_match =</span> tol_match,</span>
<span id="cb106-1321"><a href="#cb106-1321" aria-hidden="true" tabindex="-1"></a>      <span class="at">abs_beta_min =</span> abs_beta_min, <span class="at">abs_beta_max =</span> abs_beta_max, <span class="at">abs_beta_points =</span> abs_beta_points, <span class="at">p_abs =</span> p_abs,</span>
<span id="cb106-1322"><a href="#cb106-1322" aria-hidden="true" tabindex="-1"></a>      <span class="at">per_beta_min =</span> per_beta_min, <span class="at">per_beta_max =</span> per_beta_max, <span class="at">per_beta_points =</span> per_beta_points, <span class="at">p_per =</span> p_per,</span>
<span id="cb106-1323"><a href="#cb106-1323" aria-hidden="true" tabindex="-1"></a>      <span class="at">elbow_window =</span> elbow_window, <span class="at">representative =</span> representative,</span>
<span id="cb106-1324"><a href="#cb106-1324" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> s, <span class="at">verbose =</span> verbose</span>
<span id="cb106-1325"><a href="#cb106-1325" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1326"><a href="#cb106-1326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[run] %d/%d done"</span>, r, R))</span>
<span id="cb106-1327"><a href="#cb106-1327" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1328"><a href="#cb106-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1329"><a href="#cb106-1329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 抽出指标</span></span>
<span id="cb106-1330"><a href="#cb106-1330" aria-hidden="true" tabindex="-1"></a>  to_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(key) <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o[[key]])</span>
<span id="cb106-1331"><a href="#cb106-1331" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1)</span>
<span id="cb106-1332"><a href="#cb106-1332" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>f1)</span>
<span id="cb106-1333"><a href="#cb106-1333" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus)</span>
<span id="cb106-1334"><a href="#cb106-1334" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>haus)</span>
<span id="cb106-1335"><a href="#cb106-1335" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand)</span>
<span id="cb106-1336"><a href="#cb106-1336" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>rand)</span>
<span id="cb106-1337"><a href="#cb106-1337" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann)</span>
<span id="cb106-1338"><a href="#cb106-1338" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>ann)</span>
<span id="cb106-1339"><a href="#cb106-1339" aria-hidden="true" tabindex="-1"></a>  abs_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time)</span>
<span id="cb106-1340"><a href="#cb106-1340" aria-hidden="true" tabindex="-1"></a>  per_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>time)</span>
<span id="cb106-1341"><a href="#cb106-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1342"><a href="#cb106-1342" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1343"><a href="#cb106-1343" aria-hidden="true" tabindex="-1"></a>  sdv <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1344"><a href="#cb106-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1345"><a href="#cb106-1345" aria-hidden="true" tabindex="-1"></a>  summary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-1346"><a href="#cb106-1346" aria-hidden="true" tabindex="-1"></a>    <span class="at">ABS =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(abs_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(abs_f1),</span>
<span id="cb106-1347"><a href="#cb106-1347" aria-hidden="true" tabindex="-1"></a>            <span class="at">Haus_median =</span> <span class="fu">median</span>(abs_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1348"><a href="#cb106-1348" aria-hidden="true" tabindex="-1"></a>            <span class="at">Rand_mean =</span> <span class="fu">m</span>(abs_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(abs_rand),</span>
<span id="cb106-1349"><a href="#cb106-1349" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ann_mean =</span> <span class="fu">m</span>(abs_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(abs_ann),</span>
<span id="cb106-1350"><a href="#cb106-1350" aria-hidden="true" tabindex="-1"></a>            <span class="at">Time_mean =</span> <span class="fu">m</span>(abs_t)),</span>
<span id="cb106-1351"><a href="#cb106-1351" aria-hidden="true" tabindex="-1"></a>    <span class="at">PER_indivBeta =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(per_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(per_f1),</span>
<span id="cb106-1352"><a href="#cb106-1352" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Haus_median =</span> <span class="fu">median</span>(per_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1353"><a href="#cb106-1353" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Rand_mean =</span> <span class="fu">m</span>(per_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(per_rand),</span>
<span id="cb106-1354"><a href="#cb106-1354" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Ann_mean =</span> <span class="fu">m</span>(per_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(per_ann),</span>
<span id="cb106-1355"><a href="#cb106-1355" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Time_mean =</span> <span class="fu">m</span>(per_t))</span>
<span id="cb106-1356"><a href="#cb106-1356" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1357"><a href="#cb106-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1358"><a href="#cb106-1358" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 也给出逐次结果的 data.frame，便于出图</span></span>
<span id="cb106-1359"><a href="#cb106-1359" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb106-1360"><a href="#cb106-1360" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb106-1361"><a href="#cb106-1361" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1 =</span> abs_f1, <span class="at">per_f1 =</span> per_f1,</span>
<span id="cb106-1362"><a href="#cb106-1362" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> abs_haus, <span class="at">per_haus =</span> per_haus,</span>
<span id="cb106-1363"><a href="#cb106-1363" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> abs_rand, <span class="at">per_rand =</span> per_rand,</span>
<span id="cb106-1364"><a href="#cb106-1364" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann =</span> abs_ann, <span class="at">per_ann =</span> per_ann,</span>
<span id="cb106-1365"><a href="#cb106-1365" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> abs_t, <span class="at">per_time =</span> per_t</span>
<span id="cb106-1366"><a href="#cb106-1366" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1367"><a href="#cb106-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1368"><a href="#cb106-1368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">all =</span> results, <span class="at">summary =</span> summary, <span class="at">metrics =</span> df)</span>
<span id="cb106-1369"><a href="#cb106-1369" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1370"><a href="#cb106-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1371"><a href="#cb106-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1372"><a href="#cb106-1372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1373"><a href="#cb106-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1374"><a href="#cb106-1374" aria-hidden="true" tabindex="-1"></a>应用</span>
<span id="cb106-1375"><a href="#cb106-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1376"><a href="#cb106-1376" aria-hidden="true" tabindex="-1"></a>n = 200, d = 10, cps = c(60, 120, 160)，rho = 0.7，ar_phi = 0.2，R=10，信噪比 snr=1，R=10</span>
<span id="cb106-1377"><a href="#cb106-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1378"><a href="#cb106-1378" aria-hidden="true" tabindex="-1"></a>“abs<span class="sc">\_</span>”结果是abs的评价分数，“per<span class="sc">\_</span>”是逐维法的结果，可以看到结果明显是abs更好</span>
<span id="cb106-1379"><a href="#cb106-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1382"><a href="#cb106-1382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1383"><a href="#cb106-1383" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-1384"><a href="#cb106-1384" aria-hidden="true" tabindex="-1"></a><span class="do">## ) 示例运行</span></span>
<span id="cb106-1385"><a href="#cb106-1385" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">run_experiments</span>(</span>
<span id="cb106-1386"><a href="#cb106-1386" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb106-1387"><a href="#cb106-1387" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">120</span>, <span class="dv">160</span>),</span>
<span id="cb106-1388"><a href="#cb106-1388" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1389"><a href="#cb106-1389" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb106-1390"><a href="#cb106-1390" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1391"><a href="#cb106-1391" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-1392"><a href="#cb106-1392" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1393"><a href="#cb106-1393" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed0 =</span> <span class="dv">123</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb106-1394"><a href="#cb106-1394" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1395"><a href="#cb106-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1396"><a href="#cb106-1396" aria-hidden="true" tabindex="-1"></a><span class="co"># print(res$summary)</span></span>
<span id="cb106-1397"><a href="#cb106-1397" aria-hidden="true" tabindex="-1"></a><span class="co"># res$metrics</span></span>
<span id="cb106-1398"><a href="#cb106-1398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb106-1399"><a href="#cb106-1399" aria-hidden="true" tabindex="-1"></a>    res<span class="sc">$</span>metrics,</span>
<span id="cb106-1400"><a href="#cb106-1400" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb106-1401"><a href="#cb106-1401" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb106-1402"><a href="#cb106-1402" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb106-1403"><a href="#cb106-1403" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb106-1404"><a href="#cb106-1404" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1405"><a href="#cb106-1405" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1406"><a href="#cb106-1406" aria-hidden="true" tabindex="-1"></a><span class="co"># 若想查看某次 ABS 的稳定路径，可在 run_one_trial 中将 abs_res 暴露出来后调用：</span></span>
<span id="cb106-1407"><a href="#cb106-1407" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_segmentation_path(abs_res)</span></span>
<span id="cb106-1408"><a href="#cb106-1408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1409"><a href="#cb106-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1410"><a href="#cb106-1410" aria-hidden="true" tabindex="-1"></a><span class="fu">### (跑可视化)</span></span>
<span id="cb106-1411"><a href="#cb106-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1412"><a href="#cb106-1412" aria-hidden="true" tabindex="-1"></a>看到具体检测情况</span>
<span id="cb106-1413"><a href="#cb106-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1416"><a href="#cb106-1416" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1417"><a href="#cb106-1417" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================================</span></span>
<span id="cb106-1418"><a href="#cb106-1418" aria-hidden="true" tabindex="-1"></a><span class="co"># 逐次观察函数：1–10 次试验的真/检变点 + 指标（ABS vs 逐维-独立β）</span></span>
<span id="cb106-1419"><a href="#cb106-1419" aria-hidden="true" tabindex="-1"></a><span class="co"># - Hausdorff 为 Inf 时友好打印</span></span>
<span id="cb106-1420"><a href="#cb106-1420" aria-hidden="true" tabindex="-1"></a><span class="co"># - 可选导出 CSV</span></span>
<span id="cb106-1421"><a href="#cb106-1421" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================================</span></span>
<span id="cb106-1422"><a href="#cb106-1422" aria-hidden="true" tabindex="-1"></a>observe_trials <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">5</span>,</span>
<span id="cb106-1423"><a href="#cb106-1423" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seeds =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1424"><a href="#cb106-1424" aria-hidden="true" tabindex="-1"></a>                           <span class="at">export_csv =</span> <span class="cn">NULL</span>,   <span class="co"># 例如 "observe_trials.csv"</span></span>
<span id="cb106-1425"><a href="#cb106-1425" aria-hidden="true" tabindex="-1"></a>                           <span class="at">print_each =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-1426"><a href="#cb106-1426" aria-hidden="true" tabindex="-1"></a>                           <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb106-1427"><a href="#cb106-1427" aria-hidden="true" tabindex="-1"></a>                           ...) {</span>
<span id="cb106-1428"><a href="#cb106-1428" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(R)</span>
<span id="cb106-1429"><a href="#cb106-1429" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (R <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">||</span> R <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="fu">stop</span>(<span class="st">"R 必须在 1~10 之间。"</span>)</span>
<span id="cb106-1430"><a href="#cb106-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1431"><a href="#cb106-1431" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 生成/对齐随机种子</span></span>
<span id="cb106-1432"><a href="#cb106-1432" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(seeds)) {</span>
<span id="cb106-1433"><a href="#cb106-1433" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">20250911</span>)</span>
<span id="cb106-1434"><a href="#cb106-1434" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, R)</span>
<span id="cb106-1435"><a href="#cb106-1435" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-1436"><a href="#cb106-1436" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(seeds) <span class="sc">&lt;</span> R) <span class="fu">stop</span>(<span class="st">"提供的 seeds 数量不足 R。"</span>)</span>
<span id="cb106-1437"><a href="#cb106-1437" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(seeds[<span class="fu">seq_len</span>(R)])</span>
<span id="cb106-1438"><a href="#cb106-1438" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1439"><a href="#cb106-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1440"><a href="#cb106-1440" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ... 透传给 run_one_trial()</span></span>
<span id="cb106-1441"><a href="#cb106-1441" aria-hidden="true" tabindex="-1"></a>  base_args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb106-1442"><a href="#cb106-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1443"><a href="#cb106-1443" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 小工具：把整数向量转为简洁字符串</span></span>
<span id="cb106-1444"><a href="#cb106-1444" aria-hidden="true" tabindex="-1"></a>  vec_to_str <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb106-1445"><a href="#cb106-1445" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(x)</span>
<span id="cb106-1446"><a href="#cb106-1446" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="st">"∅"</span>)</span>
<span id="cb106-1447"><a href="#cb106-1447" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(x, <span class="at">collapse =</span> <span class="st">","</span>)</span>
<span id="cb106-1448"><a href="#cb106-1448" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1449"><a href="#cb106-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1450"><a href="#cb106-1450" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb106-1451"><a href="#cb106-1451" aria-hidden="true" tabindex="-1"></a>  digits  <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(digits)</span>
<span id="cb106-1452"><a href="#cb106-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1453"><a href="#cb106-1453" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb106-1454"><a href="#cb106-1454" aria-hidden="true" tabindex="-1"></a>    args_i <span class="ot">&lt;-</span> base_args</span>
<span id="cb106-1455"><a href="#cb106-1455" aria-hidden="true" tabindex="-1"></a>    args_i<span class="sc">$</span>seed <span class="ot">&lt;-</span> seeds[i]</span>
<span id="cb106-1456"><a href="#cb106-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1457"><a href="#cb106-1457" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 单次试验，容错不中断</span></span>
<span id="cb106-1458"><a href="#cb106-1458" aria-hidden="true" tabindex="-1"></a>    res_i <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">do.call</span>(run_one_trial, args_i), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1459"><a href="#cb106-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1460"><a href="#cb106-1460" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(res_i, <span class="st">"try-error"</span>)) {</span>
<span id="cb106-1461"><a href="#cb106-1461" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 记一条占位，后续表格里会是 NA/∅，并附上错误信息</span></span>
<span id="cb106-1462"><a href="#cb106-1462" aria-hidden="true" tabindex="-1"></a>      results[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-1463"><a href="#cb106-1463" aria-hidden="true" tabindex="-1"></a>        <span class="at">true_cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb106-1464"><a href="#cb106-1464" aria-hidden="true" tabindex="-1"></a>        <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb106-1465"><a href="#cb106-1465" aria-hidden="true" tabindex="-1"></a>        <span class="at">per =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb106-1466"><a href="#cb106-1466" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="fu">as.character</span>(res_i)</span>
<span id="cb106-1467"><a href="#cb106-1467" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-1468"><a href="#cb106-1468" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb106-1469"><a href="#cb106-1469" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb106-1470"><a href="#cb106-1470" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"发生错误："</span>, results[[i]]<span class="sc">$</span>error, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1471"><a href="#cb106-1471" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb106-1472"><a href="#cb106-1472" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb106-1473"><a href="#cb106-1473" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1474"><a href="#cb106-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1475"><a href="#cb106-1475" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> res_i</span>
<span id="cb106-1476"><a href="#cb106-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1477"><a href="#cb106-1477" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb106-1478"><a href="#cb106-1478" aria-hidden="true" tabindex="-1"></a>      haus_abs <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb106-1479"><a href="#cb106-1479" aria-hidden="true" tabindex="-1"></a>      haus_per <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>per<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>per<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb106-1480"><a href="#cb106-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1481"><a href="#cb106-1481" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb106-1482"><a href="#cb106-1482" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"True CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>true_cp), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1483"><a href="#cb106-1483" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"ABS  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1484"><a href="#cb106-1484" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"PER  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>per<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1485"><a href="#cb106-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1486"><a href="#cb106-1486" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ABS  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb106-1487"><a href="#cb106-1487" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>f1,</span>
<span id="cb106-1488"><a href="#cb106-1488" aria-hidden="true" tabindex="-1"></a>                  haus_abs,</span>
<span id="cb106-1489"><a href="#cb106-1489" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>rand,</span>
<span id="cb106-1490"><a href="#cb106-1490" aria-hidden="true" tabindex="-1"></a>                  res_i<span class="sc">$</span>abs<span class="sc">$</span>ann,</span>
<span id="cb106-1491"><a href="#cb106-1491" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>time))</span>
<span id="cb106-1492"><a href="#cb106-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1493"><a href="#cb106-1493" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"PER  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb106-1494"><a href="#cb106-1494" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>per<span class="sc">$</span>f1,</span>
<span id="cb106-1495"><a href="#cb106-1495" aria-hidden="true" tabindex="-1"></a>                  haus_per,</span>
<span id="cb106-1496"><a href="#cb106-1496" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>per<span class="sc">$</span>rand,</span>
<span id="cb106-1497"><a href="#cb106-1497" aria-hidden="true" tabindex="-1"></a>                  res_i<span class="sc">$</span>per<span class="sc">$</span>ann,</span>
<span id="cb106-1498"><a href="#cb106-1498" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>per<span class="sc">$</span>time))</span>
<span id="cb106-1499"><a href="#cb106-1499" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1500"><a href="#cb106-1500" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1501"><a href="#cb106-1501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1502"><a href="#cb106-1502" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 组织明细表</span></span>
<span id="cb106-1503"><a href="#cb106-1503" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb106-1504"><a href="#cb106-1504" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial    =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb106-1505"><a href="#cb106-1505" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed     =</span> seeds,</span>
<span id="cb106-1506"><a href="#cb106-1506" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>true_cp), <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1507"><a href="#cb106-1507" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>abs<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1508"><a href="#cb106-1508" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>per<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1509"><a href="#cb106-1509" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1510"><a href="#cb106-1510" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1511"><a href="#cb106-1511" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1512"><a href="#cb106-1512" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1513"><a href="#cb106-1513" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1514"><a href="#cb106-1514" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1515"><a href="#cb106-1515" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1516"><a href="#cb106-1516" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1517"><a href="#cb106-1517" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1518"><a href="#cb106-1518" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1519"><a href="#cb106-1519" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1520"><a href="#cb106-1520" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1521"><a href="#cb106-1521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1522"><a href="#cb106-1522" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(export_csv)) {</span>
<span id="cb106-1523"><a href="#cb106-1523" aria-hidden="true" tabindex="-1"></a>    utils<span class="sc">::</span><span class="fu">write.csv</span>(df, <span class="at">file =</span> export_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-1524"><a href="#cb106-1524" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"已导出 CSV: %s"</span>, <span class="fu">normalizePath</span>(export_csv, <span class="at">winslash =</span> <span class="st">"/"</span>)))</span>
<span id="cb106-1525"><a href="#cb106-1525" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1526"><a href="#cb106-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1527"><a href="#cb106-1527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(</span>
<span id="cb106-1528"><a href="#cb106-1528" aria-hidden="true" tabindex="-1"></a>    <span class="at">table  =</span> df,</span>
<span id="cb106-1529"><a href="#cb106-1529" aria-hidden="true" tabindex="-1"></a>    <span class="at">trials =</span> results</span>
<span id="cb106-1530"><a href="#cb106-1530" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb106-1531"><a href="#cb106-1531" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1532"><a href="#cb106-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1533"><a href="#cb106-1533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1534"><a href="#cb106-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1535"><a href="#cb106-1535" aria-hidden="true" tabindex="-1"></a>应用</span>
<span id="cb106-1536"><a href="#cb106-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1537"><a href="#cb106-1537" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>逐维法一旦信噪比比较低，那么一维一维的检查就容易误检，漏检，而高维检验更稳健</span>
<span id="cb106-1538"><a href="#cb106-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1539"><a href="#cb106-1539" aria-hidden="true" tabindex="-1"></a>n = 200, d = 12, cps = c(60), rho = 0.5，ar_phi = 0.2，信噪比=1</span>
<span id="cb106-1540"><a href="#cb106-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1543"><a href="#cb106-1543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1544"><a href="#cb106-1544" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb106-1545"><a href="#cb106-1545" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb106-1546"><a href="#cb106-1546" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb106-1547"><a href="#cb106-1547" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>),</span>
<span id="cb106-1548"><a href="#cb106-1548" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1549"><a href="#cb106-1549" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb106-1550"><a href="#cb106-1550" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1551"><a href="#cb106-1551" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-1552"><a href="#cb106-1552" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1553"><a href="#cb106-1553" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1554"><a href="#cb106-1554" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1555"><a href="#cb106-1555" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb106-1556"><a href="#cb106-1556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb106-1557"><a href="#cb106-1557" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb106-1558"><a href="#cb106-1558" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb106-1559"><a href="#cb106-1559" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb106-1560"><a href="#cb106-1560" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb106-1561"><a href="#cb106-1561" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb106-1562"><a href="#cb106-1562" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1563"><a href="#cb106-1563" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1564"><a href="#cb106-1564" aria-hidden="true" tabindex="-1"></a><span class="co"># 访问第 i 次：</span></span>
<span id="cb106-1565"><a href="#cb106-1565" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$true_cp</span></span>
<span id="cb106-1566"><a href="#cb106-1566" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$abs$cp</span></span>
<span id="cb106-1567"><a href="#cb106-1567" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$per$cp</span></span>
<span id="cb106-1568"><a href="#cb106-1568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1569"><a href="#cb106-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1570"><a href="#cb106-1570" aria-hidden="true" tabindex="-1"></a>n = 200, d = 12, cps = c(60,120,160), rho = 0.5，ar_phi = 0.2，信噪比=1</span>
<span id="cb106-1571"><a href="#cb106-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1574"><a href="#cb106-1574" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1575"><a href="#cb106-1575" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb106-1576"><a href="#cb106-1576" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb106-1577"><a href="#cb106-1577" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb106-1578"><a href="#cb106-1578" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">12</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb106-1579"><a href="#cb106-1579" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1580"><a href="#cb106-1580" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb106-1581"><a href="#cb106-1581" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1582"><a href="#cb106-1582" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-1583"><a href="#cb106-1583" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1584"><a href="#cb106-1584" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1585"><a href="#cb106-1585" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1586"><a href="#cb106-1586" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb106-1587"><a href="#cb106-1587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb106-1588"><a href="#cb106-1588" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb106-1589"><a href="#cb106-1589" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb106-1590"><a href="#cb106-1590" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb106-1591"><a href="#cb106-1591" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb106-1592"><a href="#cb106-1592" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb106-1593"><a href="#cb106-1593" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1594"><a href="#cb106-1594" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1595"><a href="#cb106-1595" aria-hidden="true" tabindex="-1"></a><span class="co"># 访问第 i 次：</span></span>
<span id="cb106-1596"><a href="#cb106-1596" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$true_cp</span></span>
<span id="cb106-1597"><a href="#cb106-1597" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$abs$cp</span></span>
<span id="cb106-1598"><a href="#cb106-1598" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$per$cp</span></span>
<span id="cb106-1599"><a href="#cb106-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1600"><a href="#cb106-1600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1601"><a href="#cb106-1601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1602"><a href="#cb106-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1603"><a href="#cb106-1603" aria-hidden="true" tabindex="-1"></a>n = 200, d = 12, cps = c(60,120,160), rho = 0.5，ar_phi = 0.2，信噪比=0.5</span>
<span id="cb106-1604"><a href="#cb106-1604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1607"><a href="#cb106-1607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1608"><a href="#cb106-1608" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb106-1609"><a href="#cb106-1609" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb106-1610"><a href="#cb106-1610" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb106-1611"><a href="#cb106-1611" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">12</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb106-1612"><a href="#cb106-1612" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1613"><a href="#cb106-1613" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb106-1614"><a href="#cb106-1614" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1615"><a href="#cb106-1615" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-1616"><a href="#cb106-1616" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1617"><a href="#cb106-1617" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1618"><a href="#cb106-1618" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1619"><a href="#cb106-1619" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb106-1620"><a href="#cb106-1620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb106-1621"><a href="#cb106-1621" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb106-1622"><a href="#cb106-1622" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb106-1623"><a href="#cb106-1623" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb106-1624"><a href="#cb106-1624" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb106-1625"><a href="#cb106-1625" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb106-1626"><a href="#cb106-1626" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1627"><a href="#cb106-1627" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1628"><a href="#cb106-1628" aria-hidden="true" tabindex="-1"></a><span class="co"># 访问第 i 次：</span></span>
<span id="cb106-1629"><a href="#cb106-1629" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$true_cp</span></span>
<span id="cb106-1630"><a href="#cb106-1630" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$abs$cp</span></span>
<span id="cb106-1631"><a href="#cb106-1631" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$trials[[i]]$per$cp</span></span>
<span id="cb106-1632"><a href="#cb106-1632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1633"><a href="#cb106-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1634"><a href="#cb106-1634" aria-hidden="true" tabindex="-1"></a>n = 200, d = 10,cps = c(10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190), rho = 0.5，ar_phi = 0.2，信噪比=1</span>
<span id="cb106-1635"><a href="#cb106-1635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1638"><a href="#cb106-1638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1639"><a href="#cb106-1639" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">observe_trials</span>(</span>
<span id="cb106-1640"><a href="#cb106-1640" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,  <span class="co">#重复次数</span></span>
<span id="cb106-1641"><a href="#cb106-1641" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials.csv",</span></span>
<span id="cb106-1642"><a href="#cb106-1642" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>,<span class="dv">60</span>,<span class="dv">70</span>,<span class="dv">80</span>,<span class="dv">90</span>,<span class="dv">100</span>,<span class="dv">110</span>,<span class="dv">120</span>,<span class="dv">130</span>,<span class="dv">140</span>,<span class="dv">150</span>,<span class="dv">160</span>,<span class="dv">170</span>,<span class="dv">180</span>,<span class="dv">190</span>),</span>
<span id="cb106-1643"><a href="#cb106-1643" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.5</span>, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1644"><a href="#cb106-1644" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb106-1645"><a href="#cb106-1645" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span><span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">50</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1646"><a href="#cb106-1646" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">50</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-1647"><a href="#cb106-1647" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1648"><a href="#cb106-1648" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1649"><a href="#cb106-1649" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1650"><a href="#cb106-1650" aria-hidden="true" tabindex="-1"></a><span class="co"># obs$table</span></span>
<span id="cb106-1651"><a href="#cb106-1651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb106-1652"><a href="#cb106-1652" aria-hidden="true" tabindex="-1"></a>    obs<span class="sc">$</span>table,</span>
<span id="cb106-1653"><a href="#cb106-1653" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb106-1654"><a href="#cb106-1654" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb106-1655"><a href="#cb106-1655" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb106-1656"><a href="#cb106-1656" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb106-1657"><a href="#cb106-1657" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1658"><a href="#cb106-1658" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1659"><a href="#cb106-1659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1660"><a href="#cb106-1660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1661"><a href="#cb106-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1662"><a href="#cb106-1662" aria-hidden="true" tabindex="-1"></a>判断beta</span>
<span id="cb106-1663"><a href="#cb106-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1664"><a href="#cb106-1664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-1665"><a href="#cb106-1665" aria-hidden="true" tabindex="-1"></a><span class="in">sim &lt;- simulate_dense (n = 200, d = 500,</span></span>
<span id="cb106-1666"><a href="#cb106-1666" aria-hidden="true" tabindex="-1"></a><span class="in">                           cps = c(10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190),</span></span>
<span id="cb106-1667"><a href="#cb106-1667" aria-hidden="true" tabindex="-1"></a><span class="in">                           rho = 0.6,              # 每次跳变的受影响比例</span></span>
<span id="cb106-1668"><a href="#cb106-1668" aria-hidden="true" tabindex="-1"></a><span class="in">                           delta = 1.0,            # 单次跳变幅度（同号）</span></span>
<span id="cb106-1669"><a href="#cb106-1669" aria-hidden="true" tabindex="-1"></a><span class="in">                           sigma = 1.0,            # 噪声标准差</span></span>
<span id="cb106-1670"><a href="#cb106-1670" aria-hidden="true" tabindex="-1"></a><span class="in">                           ar_phi = 0.0,           # AR(1) 噪声相关，0 表示独立</span></span>
<span id="cb106-1671"><a href="#cb106-1671" aria-hidden="true" tabindex="-1"></a><span class="in">                           same_sign = TRUE,       # TRUE：所有受影响维同号上升</span></span>
<span id="cb106-1672"><a href="#cb106-1672" aria-hidden="true" tabindex="-1"></a><span class="in">                           seed = NULL)</span></span>
<span id="cb106-1673"><a href="#cb106-1673" aria-hidden="true" tabindex="-1"></a><span class="in">res &lt;- adaptive_binary_segmentation(sim$Y,beta_min = 10, </span></span>
<span id="cb106-1674"><a href="#cb106-1674" aria-hidden="true" tabindex="-1"></a><span class="in">                                         beta_max = 50, </span></span>
<span id="cb106-1675"><a href="#cb106-1675" aria-hidden="true" tabindex="-1"></a><span class="in">                                         beta_points = 70,</span></span>
<span id="cb106-1676"><a href="#cb106-1676" aria-hidden="true" tabindex="-1"></a><span class="in">                                         min_size=2, </span></span>
<span id="cb106-1677"><a href="#cb106-1677" aria-hidden="true" tabindex="-1"></a><span class="in">                                         p=2, </span></span>
<span id="cb106-1678"><a href="#cb106-1678" aria-hidden="true" tabindex="-1"></a><span class="in">                                         elbow_window=10,</span></span>
<span id="cb106-1679"><a href="#cb106-1679" aria-hidden="true" tabindex="-1"></a><span class="in">                                    verbose = TRUE)</span></span>
<span id="cb106-1680"><a href="#cb106-1680" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1681"><a href="#cb106-1681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1682"><a href="#cb106-1682" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb106-1683"><a href="#cb106-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1684"><a href="#cb106-1684" aria-hidden="true" tabindex="-1"></a><span class="fu">## func: 逐维（Cpt） vs 高维</span></span>
<span id="cb106-1685"><a href="#cb106-1685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1686"><a href="#cb106-1686" aria-hidden="true" tabindex="-1"></a><span class="fu">### (跑可视化)</span></span>
<span id="cb106-1687"><a href="#cb106-1687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1690"><a href="#cb106-1690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1691"><a href="#cb106-1691" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb106-1692"><a href="#cb106-1692" aria-hidden="true" tabindex="-1"></a><span class="do">## A) 逐维法（使用现成包 changepoint 的 cpt.mean）</span></span>
<span id="cb106-1693"><a href="#cb106-1693" aria-hidden="true" tabindex="-1"></a><span class="do">##    - method: "PELT"（默认，推荐）或 "BinSeg" / "SegNeigh"</span></span>
<span id="cb106-1694"><a href="#cb106-1694" aria-hidden="true" tabindex="-1"></a><span class="do">##    - penalty: "MBIC"（默认）/ "BIC" / "AIC" / "Manual" 等</span></span>
<span id="cb106-1695"><a href="#cb106-1695" aria-hidden="true" tabindex="-1"></a><span class="do">##    - min_size: 映射到 cpt.mean 的 minseglen</span></span>
<span id="cb106-1696"><a href="#cb106-1696" aria-hidden="true" tabindex="-1"></a><span class="do">##    - Q: 仅对 BinSeg/SegNeigh 有意义（最大变点数）</span></span>
<span id="cb106-1697"><a href="#cb106-1697" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb106-1698"><a href="#cb106-1698" aria-hidden="true" tabindex="-1"></a>per_dim_pkg_detect <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb106-1699"><a href="#cb106-1699" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tol =</span> <span class="dv">3</span>L,</span>
<span id="cb106-1700"><a href="#cb106-1700" aria-hidden="true" tabindex="-1"></a>                               <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>,<span class="st">"median"</span>),</span>
<span id="cb106-1701"><a href="#cb106-1701" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">"PELT"</span>,</span>
<span id="cb106-1702"><a href="#cb106-1702" aria-hidden="true" tabindex="-1"></a>                               <span class="at">penalty =</span> <span class="st">"MBIC"</span>,</span>
<span id="cb106-1703"><a href="#cb106-1703" aria-hidden="true" tabindex="-1"></a>                               <span class="at">pen_value =</span> <span class="cn">NULL</span>,   <span class="co"># penalty="Manual" 时可用</span></span>
<span id="cb106-1704"><a href="#cb106-1704" aria-hidden="true" tabindex="-1"></a>                               <span class="at">min_size =</span> <span class="dv">2</span>,</span>
<span id="cb106-1705"><a href="#cb106-1705" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Q =</span> <span class="cn">NULL</span>,           <span class="co"># BinSeg/SegNeigh 的最大变点数</span></span>
<span id="cb106-1706"><a href="#cb106-1706" aria-hidden="true" tabindex="-1"></a>                               <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-1707"><a href="#cb106-1707" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb106-1708"><a href="#cb106-1708" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"changepoint"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb106-1709"><a href="#cb106-1709" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"需要安装 R 包 'changepoint'：install.packages('changepoint')"</span>)</span>
<span id="cb106-1710"><a href="#cb106-1710" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1711"><a href="#cb106-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1712"><a href="#cb106-1712" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb106-1713"><a href="#cb106-1713" aria-hidden="true" tabindex="-1"></a>  dim_cps <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, d)</span>
<span id="cb106-1714"><a href="#cb106-1714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1715"><a href="#cb106-1715" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb106-1716"><a href="#cb106-1716" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Y[, j])</span>
<span id="cb106-1717"><a href="#cb106-1717" aria-hidden="true" tabindex="-1"></a>    res_j <span class="ot">&lt;-</span> <span class="fu">try</span>({</span>
<span id="cb106-1718"><a href="#cb106-1718" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (method <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"BinSeg"</span>, <span class="st">"SegNeigh"</span>)) {</span>
<span id="cb106-1719"><a href="#cb106-1719" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 这两种方法需要 Q；若为空给个保守上限</span></span>
<span id="cb106-1720"><a href="#cb106-1720" aria-hidden="true" tabindex="-1"></a>        Q_eff <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(Q)) <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">floor</span>(<span class="fu">nrow</span>(Y) <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> min_size))) <span class="cf">else</span> <span class="fu">as.integer</span>(Q)</span>
<span id="cb106-1721"><a href="#cb106-1721" aria-hidden="true" tabindex="-1"></a>        changepoint<span class="sc">::</span><span class="fu">cpt.mean</span>(y, <span class="at">method =</span> method, <span class="at">penalty =</span> penalty, <span class="at">pen.value =</span> pen_value,</span>
<span id="cb106-1722"><a href="#cb106-1722" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Q =</span> Q_eff, <span class="at">minseglen =</span> min_size, <span class="at">class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1723"><a href="#cb106-1723" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb106-1724"><a href="#cb106-1724" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PELT（推荐，自动选点数）</span></span>
<span id="cb106-1725"><a href="#cb106-1725" aria-hidden="true" tabindex="-1"></a>        changepoint<span class="sc">::</span><span class="fu">cpt.mean</span>(y, <span class="at">method =</span> method, <span class="at">penalty =</span> penalty, <span class="at">pen.value =</span> pen_value,</span>
<span id="cb106-1726"><a href="#cb106-1726" aria-hidden="true" tabindex="-1"></a>                              <span class="at">minseglen =</span> min_size, <span class="at">class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1727"><a href="#cb106-1727" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb106-1728"><a href="#cb106-1728" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1729"><a href="#cb106-1729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1730"><a href="#cb106-1730" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(res_j, <span class="st">"try-error"</span>)) {</span>
<span id="cb106-1731"><a href="#cb106-1731" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[pkg] 维度 %d 出错，跳过该维。"</span>, j))</span>
<span id="cb106-1732"><a href="#cb106-1732" aria-hidden="true" tabindex="-1"></a>      dim_cps[[j]] <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="dv">0</span>)</span>
<span id="cb106-1733"><a href="#cb106-1733" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb106-1734"><a href="#cb106-1734" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1735"><a href="#cb106-1735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1736"><a href="#cb106-1736" aria-hidden="true" tabindex="-1"></a>    cp <span class="ot">&lt;-</span> <span class="fu">try</span>(changepoint<span class="sc">::</span><span class="fu">cpts</span>(res_j), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1737"><a href="#cb106-1737" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(cp, <span class="st">"try-error"</span>)) {</span>
<span id="cb106-1738"><a href="#cb106-1738" aria-hidden="true" tabindex="-1"></a>      dim_cps[[j]] <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="dv">0</span>)</span>
<span id="cb106-1739"><a href="#cb106-1739" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb106-1740"><a href="#cb106-1740" aria-hidden="true" tabindex="-1"></a>      <span class="co"># cpts() 通常包含 n，去掉 n 这个终点</span></span>
<span id="cb106-1741"><a href="#cb106-1741" aria-hidden="true" tabindex="-1"></a>      cp <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cp)</span>
<span id="cb106-1742"><a href="#cb106-1742" aria-hidden="true" tabindex="-1"></a>      cp <span class="ot">&lt;-</span> cp[cp <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> cp <span class="sc">&lt;</span> <span class="fu">length</span>(y)]</span>
<span id="cb106-1743"><a href="#cb106-1743" aria-hidden="true" tabindex="-1"></a>      dim_cps[[j]] <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(cp))</span>
<span id="cb106-1744"><a href="#cb106-1744" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1745"><a href="#cb106-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1746"><a href="#cb106-1746" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose) <span class="sc">&amp;&amp;</span> (j <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[pkg] finished %d/%d"</span>, j, d))</span>
<span id="cb106-1747"><a href="#cb106-1747" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1748"><a href="#cb106-1748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1749"><a href="#cb106-1749" aria-hidden="true" tabindex="-1"></a>  merged <span class="ot">&lt;-</span> <span class="fu">merge_cps</span>(dim_cps, <span class="at">tol =</span> tol, <span class="at">representative =</span> representative)</span>
<span id="cb106-1750"><a href="#cb106-1750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">merged_cp =</span> <span class="fu">sort</span>(merged), <span class="at">per_dim_cp =</span> dim_cps)</span>
<span id="cb106-1751"><a href="#cb106-1751" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1752"><a href="#cb106-1752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1753"><a href="#cb106-1753" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb106-1754"><a href="#cb106-1754" aria-hidden="true" tabindex="-1"></a><span class="do">## B) 单次实验（ABS vs 包法逐维）</span></span>
<span id="cb106-1755"><a href="#cb106-1755" aria-hidden="true" tabindex="-1"></a><span class="do">##    复用你已定义的：</span></span>
<span id="cb106-1756"><a href="#cb106-1756" aria-hidden="true" tabindex="-1"></a><span class="do">##    - adaptive_binary_segmentation()</span></span>
<span id="cb106-1757"><a href="#cb106-1757" aria-hidden="true" tabindex="-1"></a><span class="do">##    - f1_score / hausdorff / rand_index / annotation_error</span></span>
<span id="cb106-1758"><a href="#cb106-1758" aria-hidden="true" tabindex="-1"></a><span class="do">##    - simulate_dense()</span></span>
<span id="cb106-1759"><a href="#cb106-1759" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb106-1760"><a href="#cb106-1760" aria-hidden="true" tabindex="-1"></a>run_one_trial_pkg <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>,</span>
<span id="cb106-1761"><a href="#cb106-1761" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb106-1762"><a href="#cb106-1762" aria-hidden="true" tabindex="-1"></a>                              <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1763"><a href="#cb106-1763" aria-hidden="true" tabindex="-1"></a>                              <span class="at">min_size =</span> <span class="dv">5</span>,                <span class="co"># ABS 与包法都用这个 minseglen</span></span>
<span id="cb106-1764"><a href="#cb106-1764" aria-hidden="true" tabindex="-1"></a>                              <span class="at">tol_match =</span> <span class="dv">3</span>L,              <span class="co"># 合并与评测容忍（可拆分为 merge_tol/eval_tol）</span></span>
<span id="cb106-1765"><a href="#cb106-1765" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># ABS 参数</span></span>
<span id="cb106-1766"><a href="#cb106-1766" aria-hidden="true" tabindex="-1"></a>                              <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1767"><a href="#cb106-1767" aria-hidden="true" tabindex="-1"></a>                              <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-1768"><a href="#cb106-1768" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># 包法参数</span></span>
<span id="cb106-1769"><a href="#cb106-1769" aria-hidden="true" tabindex="-1"></a>                              <span class="at">method =</span> <span class="st">"PELT"</span>,</span>
<span id="cb106-1770"><a href="#cb106-1770" aria-hidden="true" tabindex="-1"></a>                              <span class="at">penalty =</span> <span class="st">"MBIC"</span>,</span>
<span id="cb106-1771"><a href="#cb106-1771" aria-hidden="true" tabindex="-1"></a>                              <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1772"><a href="#cb106-1772" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1773"><a href="#cb106-1773" aria-hidden="true" tabindex="-1"></a>                              <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-1774"><a href="#cb106-1774" aria-hidden="true" tabindex="-1"></a>                              <span class="at">seed =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1775"><a href="#cb106-1775" aria-hidden="true" tabindex="-1"></a>                              <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-1776"><a href="#cb106-1776" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span>(n, d, cps, rho, delta, sigma, ar_phi, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb106-1777"><a href="#cb106-1777" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb106-1778"><a href="#cb106-1778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1779"><a href="#cb106-1779" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS（你的方法）</span></span>
<span id="cb106-1780"><a href="#cb106-1780" aria-hidden="true" tabindex="-1"></a>  t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb106-1781"><a href="#cb106-1781" aria-hidden="true" tabindex="-1"></a>    abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb106-1782"><a href="#cb106-1782" aria-hidden="true" tabindex="-1"></a>      Y,</span>
<span id="cb106-1783"><a href="#cb106-1783" aria-hidden="true" tabindex="-1"></a>      <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb106-1784"><a href="#cb106-1784" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> verbose</span>
<span id="cb106-1785"><a href="#cb106-1785" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1786"><a href="#cb106-1786" aria-hidden="true" tabindex="-1"></a>    idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb106-1787"><a href="#cb106-1787" aria-hidden="true" tabindex="-1"></a>    cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb106-1788"><a href="#cb106-1788" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb106-1789"><a href="#cb106-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1790"><a href="#cb106-1790" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 逐维（包）：changepoint::cpt.mean</span></span>
<span id="cb106-1791"><a href="#cb106-1791" aria-hidden="true" tabindex="-1"></a>  t_pkg <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb106-1792"><a href="#cb106-1792" aria-hidden="true" tabindex="-1"></a>    pkg_res <span class="ot">&lt;-</span> <span class="fu">per_dim_pkg_detect</span>(</span>
<span id="cb106-1793"><a href="#cb106-1793" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">tol =</span> tol_match, <span class="at">representative =</span> representative,</span>
<span id="cb106-1794"><a href="#cb106-1794" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> method, <span class="at">penalty =</span> penalty, <span class="at">pen_value =</span> pen_value,</span>
<span id="cb106-1795"><a href="#cb106-1795" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">Q =</span> Q, <span class="at">verbose =</span> verbose</span>
<span id="cb106-1796"><a href="#cb106-1796" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1797"><a href="#cb106-1797" aria-hidden="true" tabindex="-1"></a>    cp_pkg <span class="ot">&lt;-</span> pkg_res<span class="sc">$</span>merged_cp</span>
<span id="cb106-1798"><a href="#cb106-1798" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb106-1799"><a href="#cb106-1799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1800"><a href="#cb106-1800" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 指标</span></span>
<span id="cb106-1801"><a href="#cb106-1801" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> tol_match)</span>
<span id="cb106-1802"><a href="#cb106-1802" aria-hidden="true" tabindex="-1"></a>  pkg_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_pkg, <span class="at">tol =</span> tol_match)</span>
<span id="cb106-1803"><a href="#cb106-1803" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb106-1804"><a href="#cb106-1804" aria-hidden="true" tabindex="-1"></a>  pkg_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_pkg)</span>
<span id="cb106-1805"><a href="#cb106-1805" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> n)</span>
<span id="cb106-1806"><a href="#cb106-1806" aria-hidden="true" tabindex="-1"></a>  pkg_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_pkg, <span class="at">n =</span> n)</span>
<span id="cb106-1807"><a href="#cb106-1807" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb106-1808"><a href="#cb106-1808" aria-hidden="true" tabindex="-1"></a>  pkg_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_pkg)</span>
<span id="cb106-1809"><a href="#cb106-1809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1810"><a href="#cb106-1810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb106-1811"><a href="#cb106-1811" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp =</span> true_cp,</span>
<span id="cb106-1812"><a href="#cb106-1812" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_abs,</span>
<span id="cb106-1813"><a href="#cb106-1813" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> abs_f1, <span class="at">haus =</span> abs_haus, <span class="at">rand =</span> abs_rand, <span class="at">ann =</span> abs_ann,</span>
<span id="cb106-1814"><a href="#cb106-1814" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])),</span>
<span id="cb106-1815"><a href="#cb106-1815" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_pkg,</span>
<span id="cb106-1816"><a href="#cb106-1816" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> pkg_f1, <span class="at">haus =</span> pkg_haus, <span class="at">rand =</span> pkg_rand, <span class="at">ann =</span> pkg_ann,</span>
<span id="cb106-1817"><a href="#cb106-1817" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_pkg[<span class="st">"elapsed"</span>]))</span>
<span id="cb106-1818"><a href="#cb106-1818" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1819"><a href="#cb106-1819" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1820"><a href="#cb106-1820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1821"><a href="#cb106-1821" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb106-1822"><a href="#cb106-1822" aria-hidden="true" tabindex="-1"></a><span class="do">## C) 逐次观察（1–10 次）：ABS vs 包法逐维</span></span>
<span id="cb106-1823"><a href="#cb106-1823" aria-hidden="true" tabindex="-1"></a><span class="do">##    打印每次真/检变点与指标；导出 CSV（可选）</span></span>
<span id="cb106-1824"><a href="#cb106-1824" aria-hidden="true" tabindex="-1"></a><span class="do">## ==========================================================</span></span>
<span id="cb106-1825"><a href="#cb106-1825" aria-hidden="true" tabindex="-1"></a>observe_trials_pkg <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">5</span>,</span>
<span id="cb106-1826"><a href="#cb106-1826" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seeds =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1827"><a href="#cb106-1827" aria-hidden="true" tabindex="-1"></a>                               <span class="at">export_csv =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1828"><a href="#cb106-1828" aria-hidden="true" tabindex="-1"></a>                               <span class="at">print_each =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-1829"><a href="#cb106-1829" aria-hidden="true" tabindex="-1"></a>                               <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb106-1830"><a href="#cb106-1830" aria-hidden="true" tabindex="-1"></a>                               ...) {</span>
<span id="cb106-1831"><a href="#cb106-1831" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(R)</span>
<span id="cb106-1832"><a href="#cb106-1832" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (R <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">||</span> R <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="fu">stop</span>(<span class="st">"R 必须在 1~10 之间。"</span>)</span>
<span id="cb106-1833"><a href="#cb106-1833" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(seeds)) {</span>
<span id="cb106-1834"><a href="#cb106-1834" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">20250911</span>)</span>
<span id="cb106-1835"><a href="#cb106-1835" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, R)</span>
<span id="cb106-1836"><a href="#cb106-1836" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-1837"><a href="#cb106-1837" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(seeds) <span class="sc">&lt;</span> R) <span class="fu">stop</span>(<span class="st">"提供的 seeds 数量不足 R。"</span>)</span>
<span id="cb106-1838"><a href="#cb106-1838" aria-hidden="true" tabindex="-1"></a>    seeds <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(seeds[<span class="fu">seq_len</span>(R)])</span>
<span id="cb106-1839"><a href="#cb106-1839" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1840"><a href="#cb106-1840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1841"><a href="#cb106-1841" aria-hidden="true" tabindex="-1"></a>  base_args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb106-1842"><a href="#cb106-1842" aria-hidden="true" tabindex="-1"></a>  vec_to_str <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { x <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(x); <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">0</span>) <span class="st">"∅"</span> <span class="cf">else</span> <span class="fu">paste</span>(x, <span class="at">collapse =</span> <span class="st">","</span>) }</span>
<span id="cb106-1843"><a href="#cb106-1843" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb106-1844"><a href="#cb106-1844" aria-hidden="true" tabindex="-1"></a>  digits  <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(digits)</span>
<span id="cb106-1845"><a href="#cb106-1845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1846"><a href="#cb106-1846" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb106-1847"><a href="#cb106-1847" aria-hidden="true" tabindex="-1"></a>    args_i <span class="ot">&lt;-</span> base_args; args_i<span class="sc">$</span>seed <span class="ot">&lt;-</span> seeds[i]</span>
<span id="cb106-1848"><a href="#cb106-1848" aria-hidden="true" tabindex="-1"></a>    res_i <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">do.call</span>(run_one_trial_pkg, args_i), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1849"><a href="#cb106-1849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1850"><a href="#cb106-1850" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(res_i, <span class="st">"try-error"</span>)) {</span>
<span id="cb106-1851"><a href="#cb106-1851" aria-hidden="true" tabindex="-1"></a>      results[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-1852"><a href="#cb106-1852" aria-hidden="true" tabindex="-1"></a>        <span class="at">true_cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb106-1853"><a href="#cb106-1853" aria-hidden="true" tabindex="-1"></a>        <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb106-1854"><a href="#cb106-1854" aria-hidden="true" tabindex="-1"></a>        <span class="at">pkg =</span> <span class="fu">list</span>(<span class="at">cp =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">f1 =</span> <span class="cn">NA_real_</span>, <span class="at">haus =</span> <span class="cn">Inf</span>, <span class="at">rand =</span> <span class="cn">NA_real_</span>, <span class="at">ann =</span> <span class="cn">NA_integer_</span>, <span class="at">time =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb106-1855"><a href="#cb106-1855" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="fu">as.character</span>(res_i)</span>
<span id="cb106-1856"><a href="#cb106-1856" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-1857"><a href="#cb106-1857" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb106-1858"><a href="#cb106-1858" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb106-1859"><a href="#cb106-1859" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"发生错误："</span>, results[[i]]<span class="sc">$</span>error, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1860"><a href="#cb106-1860" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb106-1861"><a href="#cb106-1861" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb106-1862"><a href="#cb106-1862" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1863"><a href="#cb106-1863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1864"><a href="#cb106-1864" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> res_i</span>
<span id="cb106-1865"><a href="#cb106-1865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1866"><a href="#cb106-1866" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(print_each)) {</span>
<span id="cb106-1867"><a href="#cb106-1867" aria-hidden="true" tabindex="-1"></a>      haus_abs <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb106-1868"><a href="#cb106-1868" aria-hidden="true" tabindex="-1"></a>      haus_pkg <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.finite</span>(res_i<span class="sc">$</span>pkg<span class="sc">$</span>haus)) <span class="fu">sprintf</span>(<span class="st">"%.*f"</span>, digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>haus) <span class="cf">else</span> <span class="st">"Inf"</span></span>
<span id="cb106-1869"><a href="#cb106-1869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1870"><a href="#cb106-1870" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Trial %d (seed=%d) ---</span><span class="sc">\n</span><span class="st">"</span>, i, seeds[i]))</span>
<span id="cb106-1871"><a href="#cb106-1871" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"True CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>true_cp), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1872"><a href="#cb106-1872" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"ABS  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>abs<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1873"><a href="#cb106-1873" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"PKG  CP : "</span>, <span class="fu">vec_to_str</span>(res_i<span class="sc">$</span>pkg<span class="sc">$</span>cp),   <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb106-1874"><a href="#cb106-1874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1875"><a href="#cb106-1875" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ABS  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb106-1876"><a href="#cb106-1876" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>f1, haus_abs, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>rand, res_i<span class="sc">$</span>abs<span class="sc">$</span>ann, digits, res_i<span class="sc">$</span>abs<span class="sc">$</span>time))</span>
<span id="cb106-1877"><a href="#cb106-1877" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"PKG  | F1=%.*f  Haus=%s  Rand=%.*f  Ann=%d  Time=%.*f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb106-1878"><a href="#cb106-1878" aria-hidden="true" tabindex="-1"></a>                  digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>f1, haus_pkg, digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>rand, res_i<span class="sc">$</span>pkg<span class="sc">$</span>ann, digits, res_i<span class="sc">$</span>pkg<span class="sc">$</span>time))</span>
<span id="cb106-1879"><a href="#cb106-1879" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-1880"><a href="#cb106-1880" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1881"><a href="#cb106-1881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1882"><a href="#cb106-1882" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb106-1883"><a href="#cb106-1883" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial    =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb106-1884"><a href="#cb106-1884" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed     =</span> seeds,</span>
<span id="cb106-1885"><a href="#cb106-1885" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>true_cp), <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1886"><a href="#cb106-1886" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>abs<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1887"><a href="#cb106-1887" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_cp   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) <span class="fu">paste</span>(<span class="fu">as.integer</span>(o<span class="sc">$</span>pkg<span class="sc">$</span>cp),  <span class="at">collapse=</span><span class="st">","</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1888"><a href="#cb106-1888" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1889"><a href="#cb106-1889" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_f1   =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>f1,  <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1890"><a href="#cb106-1890" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1891"><a href="#cb106-1891" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_haus =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>haus, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1892"><a href="#cb106-1892" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1893"><a href="#cb106-1893" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_rand =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>rand, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1894"><a href="#cb106-1894" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1895"><a href="#cb106-1895" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_ann  =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>ann, <span class="fu">integer</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1896"><a href="#cb106-1896" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1897"><a href="#cb106-1897" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkg_time =</span> <span class="fu">vapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>pkg<span class="sc">$</span>time, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb106-1898"><a href="#cb106-1898" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1899"><a href="#cb106-1899" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1900"><a href="#cb106-1900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1901"><a href="#cb106-1901" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(export_csv)) {</span>
<span id="cb106-1902"><a href="#cb106-1902" aria-hidden="true" tabindex="-1"></a>    utils<span class="sc">::</span><span class="fu">write.csv</span>(df, <span class="at">file =</span> export_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-1903"><a href="#cb106-1903" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"已导出 CSV: %s"</span>, <span class="fu">normalizePath</span>(export_csv, <span class="at">winslash =</span> <span class="st">"/"</span>)))</span>
<span id="cb106-1904"><a href="#cb106-1904" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-1905"><a href="#cb106-1905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1906"><a href="#cb106-1906" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(<span class="at">table =</span> df, <span class="at">trials =</span> results))</span>
<span id="cb106-1907"><a href="#cb106-1907" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1908"><a href="#cb106-1908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1909"><a href="#cb106-1909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1910"><a href="#cb106-1910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1911"><a href="#cb106-1911" aria-hidden="true" tabindex="-1"></a>应用</span>
<span id="cb106-1912"><a href="#cb106-1912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1913"><a href="#cb106-1913" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>逐维法使用现成包 changepoint 的 cpt.mean</span>
<span id="cb106-1914"><a href="#cb106-1914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1915"><a href="#cb106-1915" aria-hidden="true" tabindex="-1"></a>n = 200, d = 5, cps = c(60,120,160), rho = 0.7</span>
<span id="cb106-1916"><a href="#cb106-1916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1919"><a href="#cb106-1919" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1920"><a href="#cb106-1920" aria-hidden="true" tabindex="-1"></a><span class="co"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb106-1921"><a href="#cb106-1921" aria-hidden="true" tabindex="-1"></a>obs_pkg <span class="ot">&lt;-</span> <span class="fu">observe_trials_pkg</span>(</span>
<span id="cb106-1922"><a href="#cb106-1922" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb106-1923"><a href="#cb106-1923" aria-hidden="true" tabindex="-1"></a> <span class="co"># seeds = NULL, #  控制每次试验用的随机数种子</span></span>
<span id="cb106-1924"><a href="#cb106-1924" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb106-1925"><a href="#cb106-1925" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">5</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb106-1926"><a href="#cb106-1926" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1927"><a href="#cb106-1927" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb106-1928"><a href="#cb106-1928" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS</span></span>
<span id="cb106-1929"><a href="#cb106-1929" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1930"><a href="#cb106-1930" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-1931"><a href="#cb106-1931" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 包法（changepoint）</span></span>
<span id="cb106-1932"><a href="#cb106-1932" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"PELT"</span>,          <span class="co"># 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb106-1933"><a href="#cb106-1933" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="st">"MBIC"</span>,         <span class="co"># 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb106-1934"><a href="#cb106-1934" aria-hidden="true" tabindex="-1"></a>  <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1935"><a href="#cb106-1935" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1936"><a href="#cb106-1936" aria-hidden="true" tabindex="-1"></a>  <span class="at">representative =</span> <span class="st">"median"</span>, <span class="co"># 建议中位数更鲁棒</span></span>
<span id="cb106-1937"><a href="#cb106-1937" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1938"><a href="#cb106-1938" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1939"><a href="#cb106-1939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1940"><a href="#cb106-1940" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$table</span></span>
<span id="cb106-1941"><a href="#cb106-1941" aria-hidden="true" tabindex="-1"></a> <span class="fu">datatable</span>(</span>
<span id="cb106-1942"><a href="#cb106-1942" aria-hidden="true" tabindex="-1"></a>    obs_pkg<span class="sc">$</span>table,</span>
<span id="cb106-1943"><a href="#cb106-1943" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb106-1944"><a href="#cb106-1944" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb106-1945"><a href="#cb106-1945" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb106-1946"><a href="#cb106-1946" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb106-1947"><a href="#cb106-1947" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1948"><a href="#cb106-1948" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1949"><a href="#cb106-1949" aria-hidden="true" tabindex="-1"></a><span class="co"># 第 i 次的原始向量：</span></span>
<span id="cb106-1950"><a href="#cb106-1950" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$trials[[i]]$true_cp</span></span>
<span id="cb106-1951"><a href="#cb106-1951" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$trials[[i]]$abs$cp</span></span>
<span id="cb106-1952"><a href="#cb106-1952" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$trials[[i]]$pkg$cp</span></span>
<span id="cb106-1953"><a href="#cb106-1953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1954"><a href="#cb106-1954" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1955"><a href="#cb106-1955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1956"><a href="#cb106-1956" aria-hidden="true" tabindex="-1"></a>n = 200, d = 200, cps = c(60,120,160), rho = 0.7</span>
<span id="cb106-1957"><a href="#cb106-1957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1960"><a href="#cb106-1960" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1961"><a href="#cb106-1961" aria-hidden="true" tabindex="-1"></a><span class="co"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb106-1962"><a href="#cb106-1962" aria-hidden="true" tabindex="-1"></a>obs_pkg <span class="ot">&lt;-</span> <span class="fu">observe_trials_pkg</span>(</span>
<span id="cb106-1963"><a href="#cb106-1963" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">10</span>,</span>
<span id="cb106-1964"><a href="#cb106-1964" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">54</span>,<span class="dv">2575</span>,<span class="dv">367</span>,<span class="dv">3859</span>,<span class="dv">28585</span>,<span class="dv">2895</span>,<span class="dv">278485</span>,<span class="dv">278</span>,<span class="dv">3748</span>), <span class="co">#  控制每次试验用的随机数种子</span></span>
<span id="cb106-1965"><a href="#cb106-1965" aria-hidden="true" tabindex="-1"></a> <span class="co"># export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb106-1966"><a href="#cb106-1966" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">200</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">60</span>,<span class="dv">120</span>,<span class="dv">160</span>),</span>
<span id="cb106-1967"><a href="#cb106-1967" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-1968"><a href="#cb106-1968" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">10</span>L,</span>
<span id="cb106-1969"><a href="#cb106-1969" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ABS</span></span>
<span id="cb106-1970"><a href="#cb106-1970" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-1971"><a href="#cb106-1971" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-1972"><a href="#cb106-1972" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 包法（changepoint）</span></span>
<span id="cb106-1973"><a href="#cb106-1973" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"PELT"</span>,          <span class="co"># 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb106-1974"><a href="#cb106-1974" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="st">"MBIC"</span>,         <span class="co"># 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb106-1975"><a href="#cb106-1975" aria-hidden="true" tabindex="-1"></a>  <span class="at">pen_value =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1976"><a href="#cb106-1976" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-1977"><a href="#cb106-1977" aria-hidden="true" tabindex="-1"></a>  <span class="at">representative =</span> <span class="st">"median"</span>, <span class="co"># 建议中位数更鲁棒</span></span>
<span id="cb106-1978"><a href="#cb106-1978" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1979"><a href="#cb106-1979" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1980"><a href="#cb106-1980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1981"><a href="#cb106-1981" aria-hidden="true" tabindex="-1"></a><span class="co"># obs_pkg$table</span></span>
<span id="cb106-1982"><a href="#cb106-1982" aria-hidden="true" tabindex="-1"></a> <span class="fu">datatable</span>(</span>
<span id="cb106-1983"><a href="#cb106-1983" aria-hidden="true" tabindex="-1"></a>    obs_pkg<span class="sc">$</span>table,</span>
<span id="cb106-1984"><a href="#cb106-1984" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb106-1985"><a href="#cb106-1985" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">10</span>,     <span class="co"># 每页显示 10 行</span></span>
<span id="cb106-1986"><a href="#cb106-1986" aria-hidden="true" tabindex="-1"></a>      <span class="at">autoWidth =</span> <span class="cn">TRUE</span>     <span class="co"># 自动列宽</span></span>
<span id="cb106-1987"><a href="#cb106-1987" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb106-1988"><a href="#cb106-1988" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-1989"><a href="#cb106-1989" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1990"><a href="#cb106-1990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1991"><a href="#cb106-1991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1992"><a href="#cb106-1992" aria-hidden="true" tabindex="-1"></a><span class="fu"># 稀疏模式</span></span>
<span id="cb106-1993"><a href="#cb106-1993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1994"><a href="#cb106-1994" aria-hidden="true" tabindex="-1"></a>n = 200, d = 10, cps = c(60,120,160), rho = 0.1(稀疏)</span>
<span id="cb106-1995"><a href="#cb106-1995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1996"><a href="#cb106-1996" aria-hidden="true" tabindex="-1"></a>p=2</span>
<span id="cb106-1997"><a href="#cb106-1997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1998"><a href="#cb106-1998" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-1999"><a href="#cb106-1999" aria-hidden="true" tabindex="-1"></a><span class="in"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb106-2000"><a href="#cb106-2000" aria-hidden="true" tabindex="-1"></a><span class="in">obs_pkg &lt;- observe_trials_pkg(</span></span>
<span id="cb106-2001"><a href="#cb106-2001" aria-hidden="true" tabindex="-1"></a><span class="in">  R = 10,</span></span>
<span id="cb106-2002"><a href="#cb106-2002" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = c(3,54,2575,367,3859,28585,2895,278485,278,3748), #  控制每次试验用的随机数种子</span></span>
<span id="cb106-2003"><a href="#cb106-2003" aria-hidden="true" tabindex="-1"></a><span class="in"> # export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb106-2004"><a href="#cb106-2004" aria-hidden="true" tabindex="-1"></a><span class="in">  n = 200, d = 10, cps = c(60,120,160),</span></span>
<span id="cb106-2005"><a href="#cb106-2005" aria-hidden="true" tabindex="-1"></a><span class="in">  rho = 0.1, delta = 1.0, sigma = 1.0, ar_phi = 0.2,</span></span>
<span id="cb106-2006"><a href="#cb106-2006" aria-hidden="true" tabindex="-1"></a><span class="in">  min_size = 5, tol_match = 10L,</span></span>
<span id="cb106-2007"><a href="#cb106-2007" aria-hidden="true" tabindex="-1"></a><span class="in">  # ABS</span></span>
<span id="cb106-2008"><a href="#cb106-2008" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_beta_min = 3, abs_beta_max = 30, abs_beta_points = 70, p_abs = 2,</span></span>
<span id="cb106-2009"><a href="#cb106-2009" aria-hidden="true" tabindex="-1"></a><span class="in">  elbow_window = 10,</span></span>
<span id="cb106-2010"><a href="#cb106-2010" aria-hidden="true" tabindex="-1"></a><span class="in">  # 包法（changepoint）</span></span>
<span id="cb106-2011"><a href="#cb106-2011" aria-hidden="true" tabindex="-1"></a><span class="in">  method = "PELT",          # 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb106-2012"><a href="#cb106-2012" aria-hidden="true" tabindex="-1"></a><span class="in">  penalty = "MBIC",         # 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb106-2013"><a href="#cb106-2013" aria-hidden="true" tabindex="-1"></a><span class="in">  pen_value = NULL,</span></span>
<span id="cb106-2014"><a href="#cb106-2014" aria-hidden="true" tabindex="-1"></a><span class="in">  Q = NULL,</span></span>
<span id="cb106-2015"><a href="#cb106-2015" aria-hidden="true" tabindex="-1"></a><span class="in">  representative = "median", # 建议中位数更鲁棒</span></span>
<span id="cb106-2016"><a href="#cb106-2016" aria-hidden="true" tabindex="-1"></a><span class="in">  verbose = FALSE</span></span>
<span id="cb106-2017"><a href="#cb106-2017" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2018"><a href="#cb106-2018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2019"><a href="#cb106-2019" aria-hidden="true" tabindex="-1"></a><span class="in">obs_pkg$table</span></span>
<span id="cb106-2020"><a href="#cb106-2020" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2021"><a href="#cb106-2021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2022"><a href="#cb106-2022" aria-hidden="true" tabindex="-1"></a>n = 200, d = 10, cps = c(60,120,160), rho = 0.1(稀疏)</span>
<span id="cb106-2023"><a href="#cb106-2023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2024"><a href="#cb106-2024" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-2025"><a href="#cb106-2025" aria-hidden="true" tabindex="-1"></a><span class="in"># 观察 5 次（小 n,d 只为演示；实际建议更大）</span></span>
<span id="cb106-2026"><a href="#cb106-2026" aria-hidden="true" tabindex="-1"></a><span class="in">obs_pkg &lt;- observe_trials_pkg(</span></span>
<span id="cb106-2027"><a href="#cb106-2027" aria-hidden="true" tabindex="-1"></a><span class="in">  R = 10,</span></span>
<span id="cb106-2028"><a href="#cb106-2028" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = c(3,54,2575,367,3859,28585,2895,278485,278,3748), #  控制每次试验用的随机数种子</span></span>
<span id="cb106-2029"><a href="#cb106-2029" aria-hidden="true" tabindex="-1"></a><span class="in"> # export_csv = "observe_trials_pkg.csv",</span></span>
<span id="cb106-2030"><a href="#cb106-2030" aria-hidden="true" tabindex="-1"></a><span class="in">  n = 200, d = 10, cps = c(60,120,160),</span></span>
<span id="cb106-2031"><a href="#cb106-2031" aria-hidden="true" tabindex="-1"></a><span class="in">  rho = 0.1, delta = 1.0, sigma = 1.0, ar_phi = 0.2,</span></span>
<span id="cb106-2032"><a href="#cb106-2032" aria-hidden="true" tabindex="-1"></a><span class="in">  min_size = 5, tol_match = 10L,</span></span>
<span id="cb106-2033"><a href="#cb106-2033" aria-hidden="true" tabindex="-1"></a><span class="in">  # ABS</span></span>
<span id="cb106-2034"><a href="#cb106-2034" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_beta_min = 3, abs_beta_max = 20, abs_beta_points = 70, p_abs = "inf",</span></span>
<span id="cb106-2035"><a href="#cb106-2035" aria-hidden="true" tabindex="-1"></a><span class="in">  elbow_window = 10,</span></span>
<span id="cb106-2036"><a href="#cb106-2036" aria-hidden="true" tabindex="-1"></a><span class="in">  # 包法（changepoint）</span></span>
<span id="cb106-2037"><a href="#cb106-2037" aria-hidden="true" tabindex="-1"></a><span class="in">  method = "PELT",          # 或 "BinSeg"（配 Q），"SegNeigh"</span></span>
<span id="cb106-2038"><a href="#cb106-2038" aria-hidden="true" tabindex="-1"></a><span class="in">  penalty = "MBIC",         # 可换 "BIC"/"AIC"/"Manual"(配 pen_value)</span></span>
<span id="cb106-2039"><a href="#cb106-2039" aria-hidden="true" tabindex="-1"></a><span class="in">  pen_value = NULL,</span></span>
<span id="cb106-2040"><a href="#cb106-2040" aria-hidden="true" tabindex="-1"></a><span class="in">  Q = NULL,</span></span>
<span id="cb106-2041"><a href="#cb106-2041" aria-hidden="true" tabindex="-1"></a><span class="in">  representative = "median", # 建议中位数更鲁棒</span></span>
<span id="cb106-2042"><a href="#cb106-2042" aria-hidden="true" tabindex="-1"></a><span class="in">  verbose = FALSE</span></span>
<span id="cb106-2043"><a href="#cb106-2043" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2044"><a href="#cb106-2044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2045"><a href="#cb106-2045" aria-hidden="true" tabindex="-1"></a><span class="in">obs_pkg$table</span></span>
<span id="cb106-2046"><a href="#cb106-2046" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2047"><a href="#cb106-2047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2048"><a href="#cb106-2048" aria-hidden="true" tabindex="-1"></a><span class="fu"># Table</span></span>
<span id="cb106-2049"><a href="#cb106-2049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2050"><a href="#cb106-2050" aria-hidden="true" tabindex="-1"></a>所有前置函数：abs，per_abs，仿真数据，评价函数</span>
<span id="cb106-2051"><a href="#cb106-2051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2054"><a href="#cb106-2054" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-2055"><a href="#cb106-2055" aria-hidden="true" tabindex="-1"></a><span class="do">## 0) 工具与可重复性</span></span>
<span id="cb106-2056"><a href="#cb106-2056" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2057"><a href="#cb106-2057" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2058"><a href="#cb106-2058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2059"><a href="#cb106-2059" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2060"><a href="#cb106-2060" aria-hidden="true" tabindex="-1"></a><span class="do">## 内部加速工具（不改变对外 API）</span></span>
<span id="cb106-2061"><a href="#cb106-2061" aria-hidden="true" tabindex="-1"></a><span class="do">## 说明：</span></span>
<span id="cb106-2062"><a href="#cb106-2062" aria-hidden="true" tabindex="-1"></a><span class="do">## - 通过一次性构建按行的列累积和 (cumsums) 来将任意区间均值计算从 O(k) 降到 O(1)</span></span>
<span id="cb106-2063"><a href="#cb106-2063" aria-hidden="true" tabindex="-1"></a><span class="do">## - 所有优化均以隐式属性附着在 Y 上（attr(Y, "._csum")），</span></span>
<span id="cb106-2064"><a href="#cb106-2064" aria-hidden="true" tabindex="-1"></a><span class="do">##   若缺失则在首次调用时自动构建；对外函数名、参数与用法保持不变</span></span>
<span id="cb106-2065"><a href="#cb106-2065" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2066"><a href="#cb106-2066" aria-hidden="true" tabindex="-1"></a>.ensure_cumsum <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb106-2067"><a href="#cb106-2067" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb106-2068"><a href="#cb106-2068" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cs)) {</span>
<span id="cb106-2069"><a href="#cb106-2069" aria-hidden="true" tabindex="-1"></a>    cs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(Y)), <span class="fu">apply</span>(Y, <span class="dv">2</span>, cumsum))</span>
<span id="cb106-2070"><a href="#cb106-2070" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>) <span class="ot">&lt;-</span> cs</span>
<span id="cb106-2071"><a href="#cb106-2071" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2072"><a href="#cb106-2072" aria-hidden="true" tabindex="-1"></a>  Y</span>
<span id="cb106-2073"><a href="#cb106-2073" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2074"><a href="#cb106-2074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2075"><a href="#cb106-2075" aria-hidden="true" tabindex="-1"></a>.segment_means_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(cs, t_left, t_mid, t_right) {</span>
<span id="cb106-2076"><a href="#cb106-2076" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cs 的行索引与时间点对齐：第 0 个时间点位于行 1</span></span>
<span id="cb106-2077"><a href="#cb106-2077" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 区间 (t_left+1):t_mid 与 (t_mid+1):t_right</span></span>
<span id="cb106-2078"><a href="#cb106-2078" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb106-2079"><a href="#cb106-2079" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb106-2080"><a href="#cb106-2080" aria-hidden="true" tabindex="-1"></a>  sum1 <span class="ot">&lt;-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_left <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb106-2081"><a href="#cb106-2081" aria-hidden="true" tabindex="-1"></a>  sum2 <span class="ot">&lt;-</span> cs[t_right <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">-</span> cs[t_mid <span class="sc">+</span> <span class="dv">1</span>, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb106-2082"><a href="#cb106-2082" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> sum1 <span class="sc">/</span> n1</span>
<span id="cb106-2083"><a href="#cb106-2083" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> sum2 <span class="sc">/</span> n2</span>
<span id="cb106-2084"><a href="#cb106-2084" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">mean1 =</span> mean1, <span class="at">mean2 =</span> mean2, <span class="at">n1 =</span> n1, <span class="at">n2 =</span> n2)</span>
<span id="cb106-2085"><a href="#cb106-2085" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2086"><a href="#cb106-2086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2087"><a href="#cb106-2087" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2088"><a href="#cb106-2088" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 代价函数 &amp; 二元分割（保持 API，不改变名称/参数）</span></span>
<span id="cb106-2089"><a href="#cb106-2089" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2090"><a href="#cb106-2090" aria-hidden="true" tabindex="-1"></a>compute_cost <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, t_left, t_mid, t_right, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb106-2091"><a href="#cb106-2091" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t_left <span class="sc">&gt;=</span> t_mid) <span class="sc">||</span> (t_mid <span class="sc">&gt;=</span> t_right)) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-2092"><a href="#cb106-2092" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 尝试使用累计和加速；若不可用则回退到原始实现</span></span>
<span id="cb106-2093"><a href="#cb106-2093" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">attr</span>(Y, <span class="st">"._csum"</span>)</span>
<span id="cb106-2094"><a href="#cb106-2094" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cs)) {</span>
<span id="cb106-2095"><a href="#cb106-2095" aria-hidden="true" tabindex="-1"></a>    seg <span class="ot">&lt;-</span> <span class="fu">.segment_means_fast</span>(cs, t_left, t_mid, t_right)</span>
<span id="cb106-2096"><a href="#cb106-2096" aria-hidden="true" tabindex="-1"></a>    n1 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n1; n2 <span class="ot">&lt;-</span> seg<span class="sc">$</span>n2; n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb106-2097"><a href="#cb106-2097" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(seg<span class="sc">$</span>mean2 <span class="sc">-</span> seg<span class="sc">$</span>mean1)</span>
<span id="cb106-2098"><a href="#cb106-2098" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb106-2099"><a href="#cb106-2099" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb106-2100"><a href="#cb106-2100" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb106-2101"><a href="#cb106-2101" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb106-2102"><a href="#cb106-2102" aria-hidden="true" tabindex="-1"></a>      norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb106-2103"><a href="#cb106-2103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2104"><a href="#cb106-2104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weight <span class="sc">*</span> norm_p)</span>
<span id="cb106-2105"><a href="#cb106-2105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2106"><a href="#cb106-2106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 回退路径（仅在未预先构建 cumsum 时触发）</span></span>
<span id="cb106-2107"><a href="#cb106-2107" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> t_mid <span class="sc">-</span> t_left</span>
<span id="cb106-2108"><a href="#cb106-2108" aria-hidden="true" tabindex="-1"></a>  n2 <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_mid</span>
<span id="cb106-2109"><a href="#cb106-2109" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> t_right <span class="sc">-</span> t_left</span>
<span id="cb106-2110"><a href="#cb106-2110" aria-hidden="true" tabindex="-1"></a>  mean1 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_left <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_mid, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-2111"><a href="#cb106-2111" aria-hidden="true" tabindex="-1"></a>  mean2 <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y[(t_mid <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>t_right, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb106-2112"><a href="#cb106-2112" aria-hidden="true" tabindex="-1"></a>  diff  <span class="ot">&lt;-</span> mean2 <span class="sc">-</span> mean1</span>
<span id="cb106-2113"><a href="#cb106-2113" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((n1 <span class="sc">*</span> n2) <span class="sc">/</span> n_total)</span>
<span id="cb106-2114"><a href="#cb106-2114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(p, <span class="st">"inf"</span>)) {</span>
<span id="cb106-2115"><a href="#cb106-2115" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(diff))</span>
<span id="cb106-2116"><a href="#cb106-2116" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-2117"><a href="#cb106-2117" aria-hidden="true" tabindex="-1"></a>    norm_p <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff)<span class="sc">^</span>p)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>p)</span>
<span id="cb106-2118"><a href="#cb106-2118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2119"><a href="#cb106-2119" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">*</span> norm_p</span>
<span id="cb106-2120"><a href="#cb106-2120" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2121"><a href="#cb106-2121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2122"><a href="#cb106-2122" aria-hidden="true" tabindex="-1"></a>binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, beta, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Y), <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>) {</span>
<span id="cb106-2123"><a href="#cb106-2123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 确保累计和已存在（若无则自动构建）</span></span>
<span id="cb106-2124"><a href="#cb106-2124" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb106-2125"><a href="#cb106-2125" aria-hidden="true" tabindex="-1"></a>  left_scan  <span class="ot">&lt;-</span> t0 <span class="sc">+</span> min_size</span>
<span id="cb106-2126"><a href="#cb106-2126" aria-hidden="true" tabindex="-1"></a>  right_scan <span class="ot">&lt;-</span> t1 <span class="sc">-</span> min_size</span>
<span id="cb106-2127"><a href="#cb106-2127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((t1 <span class="sc">-</span> t0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">*</span> min_size <span class="sc">+</span> <span class="dv">1</span> <span class="sc">||</span> left_scan <span class="sc">&gt;</span> right_scan) {</span>
<span id="cb106-2128"><a href="#cb106-2128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-2129"><a href="#cb106-2129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2130"><a href="#cb106-2130" aria-hidden="true" tabindex="-1"></a>  best_gain <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb106-2131"><a href="#cb106-2131" aria-hidden="true" tabindex="-1"></a>  best_t <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-2132"><a href="#cb106-2132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用累计和的 compute_cost，按扫描区间求最大增益</span></span>
<span id="cb106-2133"><a href="#cb106-2133" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> left_scan<span class="sc">:</span>right_scan) {</span>
<span id="cb106-2134"><a href="#cb106-2134" aria-hidden="true" tabindex="-1"></a>    gain <span class="ot">&lt;-</span> <span class="fu">compute_cost</span>(Y, t0, t, t1, p)</span>
<span id="cb106-2135"><a href="#cb106-2135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gain <span class="sc">&gt;</span> best_gain) {</span>
<span id="cb106-2136"><a href="#cb106-2136" aria-hidden="true" tabindex="-1"></a>      best_gain <span class="ot">&lt;-</span> gain; best_t <span class="ot">&lt;-</span> t</span>
<span id="cb106-2137"><a href="#cb106-2137" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2138"><a href="#cb106-2138" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2139"><a href="#cb106-2139" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(best_t) <span class="sc">&amp;&amp;</span> (best_gain <span class="sc">&gt;</span> beta)) {</span>
<span id="cb106-2140"><a href="#cb106-2140" aria-hidden="true" tabindex="-1"></a>    left  <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, t0, best_t, min_size, p)</span>
<span id="cb106-2141"><a href="#cb106-2141" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">binary_segmentation</span>(Y, beta, best_t, t1, min_size, p)</span>
<span id="cb106-2142"><a href="#cb106-2142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(left, best_t, right))</span>
<span id="cb106-2143"><a href="#cb106-2143" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-2144"><a href="#cb106-2144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-2145"><a href="#cb106-2145" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2146"><a href="#cb106-2146" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2147"><a href="#cb106-2147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2148"><a href="#cb106-2148" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2149"><a href="#cb106-2149" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 稳定路径：手肘 + 平台 (Kneedle + plateau)</span></span>
<span id="cb106-2150"><a href="#cb106-2150" aria-hidden="true" tabindex="-1"></a><span class="do">##    （内部同样利用累计和以复用加速）</span></span>
<span id="cb106-2151"><a href="#cb106-2151" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2152"><a href="#cb106-2152" aria-hidden="true" tabindex="-1"></a>find_elbow <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-2153"><a href="#cb106-2153" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>]); p2 <span class="ot">&lt;-</span> <span class="fu">c</span>(x[<span class="fu">length</span>(x)], y[<span class="fu">length</span>(y)])</span>
<span id="cb106-2154"><a href="#cb106-2154" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb106-2155"><a href="#cb106-2155" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> (p2[<span class="dv">1</span>] <span class="sc">-</span> p1[<span class="dv">1</span>]); dy <span class="ot">&lt;-</span> (p2[<span class="dv">2</span>] <span class="sc">-</span> p1[<span class="dv">2</span>])</span>
<span id="cb106-2156"><a href="#cb106-2156" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb106-2157"><a href="#cb106-2157" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb106-2158"><a href="#cb106-2158" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">c</span>(x[i], y[i])</span>
<span id="cb106-2159"><a href="#cb106-2159" aria-hidden="true" tabindex="-1"></a>    distances[i] <span class="ot">&lt;-</span> <span class="fu">abs</span>(dy <span class="sc">*</span> p[<span class="dv">1</span>] <span class="sc">-</span> dx <span class="sc">*</span> p[<span class="dv">2</span>] <span class="sc">+</span> p2[<span class="dv">1</span>] <span class="sc">*</span> p1[<span class="dv">2</span>] <span class="sc">-</span> p2[<span class="dv">2</span>] <span class="sc">*</span> p1[<span class="dv">1</span>]) <span class="sc">/</span> denom</span>
<span id="cb106-2160"><a href="#cb106-2160" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2161"><a href="#cb106-2161" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(distances)</span>
<span id="cb106-2162"><a href="#cb106-2162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">beta =</span> x[idx], <span class="at">index =</span> idx)</span>
<span id="cb106-2163"><a href="#cb106-2163" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2164"><a href="#cb106-2164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2165"><a href="#cb106-2165" aria-hidden="true" tabindex="-1"></a>find_plateaus <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb106-2166"><a href="#cb106-2166" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-2167"><a href="#cb106-2167" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb106-2168"><a href="#cb106-2168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(y)) {</span>
<span id="cb106-2169"><a href="#cb106-2169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (y[i] <span class="sc">!=</span> y[i <span class="sc">-</span> <span class="dv">1</span>]) {</span>
<span id="cb106-2170"><a href="#cb106-2170" aria-hidden="true" tabindex="-1"></a>      plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-2171"><a href="#cb106-2171" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> start, <span class="at">end =</span> i <span class="sc">-</span> <span class="dv">1</span>, <span class="at">value =</span> y[i <span class="sc">-</span> <span class="dv">1</span>], <span class="at">length =</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-2172"><a href="#cb106-2172" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-2173"><a href="#cb106-2173" aria-hidden="true" tabindex="-1"></a>      start <span class="ot">&lt;-</span> i</span>
<span id="cb106-2174"><a href="#cb106-2174" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2175"><a href="#cb106-2175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2176"><a href="#cb106-2176" aria-hidden="true" tabindex="-1"></a>  plateaus[[<span class="fu">length</span>(plateaus) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-2177"><a href="#cb106-2177" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> start, <span class="at">end =</span> <span class="fu">length</span>(y), <span class="at">value =</span> y[<span class="fu">length</span>(y)], <span class="at">length =</span> <span class="fu">length</span>(y) <span class="sc">-</span> start <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb106-2178"><a href="#cb106-2178" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2179"><a href="#cb106-2179" aria-hidden="true" tabindex="-1"></a>  plateaus</span>
<span id="cb106-2180"><a href="#cb106-2180" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2181"><a href="#cb106-2181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2182"><a href="#cb106-2182" aria-hidden="true" tabindex="-1"></a>adaptive_binary_segmentation <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb106-2183"><a href="#cb106-2183" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-2184"><a href="#cb106-2184" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-2185"><a href="#cb106-2185" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-2186"><a href="#cb106-2186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 预先构建累计和，加速所有后续成本评估</span></span>
<span id="cb106-2187"><a href="#cb106-2187" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Y)</span>
<span id="cb106-2188"><a href="#cb106-2188" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb106-2189"><a href="#cb106-2189" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb106-2190"><a href="#cb106-2190" aria-hidden="true" tabindex="-1"></a>  bp_counts <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb106-2191"><a href="#cb106-2191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2192"><a href="#cb106-2192" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb106-2193"><a href="#cb106-2193" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb106-2194"><a href="#cb106-2194" aria-hidden="true" tabindex="-1"></a>    t_hat <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Y, b, <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb106-2195"><a href="#cb106-2195" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> t_hat</span>
<span id="cb106-2196"><a href="#cb106-2196" aria-hidden="true" tabindex="-1"></a>    bp_counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(t_hat)</span>
<span id="cb106-2197"><a href="#cb106-2197" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2198"><a href="#cb106-2198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2199"><a href="#cb106-2199" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, bp_counts)</span>
<span id="cb106-2200"><a href="#cb106-2200" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb106-2201"><a href="#cb106-2201" aria-hidden="true" tabindex="-1"></a>  plateaus <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, bp_counts)</span>
<span id="cb106-2202"><a href="#cb106-2202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2203"><a href="#cb106-2203" aria-hidden="true" tabindex="-1"></a>  left_bound <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb106-2204"><a href="#cb106-2204" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb106-2205"><a href="#cb106-2205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2206"><a href="#cb106-2206" aria-hidden="true" tabindex="-1"></a>  best_plateau <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-2207"><a href="#cb106-2207" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb106-2208"><a href="#cb106-2208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound) <span class="sc">&amp;&amp;</span> (pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound)) {</span>
<span id="cb106-2209"><a href="#cb106-2209" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_plateau) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_plateau<span class="sc">$</span>length) best_plateau <span class="ot">&lt;-</span> pp</span>
<span id="cb106-2210"><a href="#cb106-2210" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2211"><a href="#cb106-2211" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2212"><a href="#cb106-2212" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_plateau<span class="sc">$</span>start <span class="sc">+</span> best_plateau<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb106-2213"><a href="#cb106-2213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2214"><a href="#cb106-2214" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) {</span>
<span id="cb106-2215"><a href="#cb106-2215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"所有 plateau 区间:</span></span>
<span id="cb106-2216"><a href="#cb106-2216" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb106-2217"><a href="#cb106-2217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (pp <span class="cf">in</span> plateaus) {</span>
<span id="cb106-2218"><a href="#cb106-2218" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"β = %.2f–%.2f, 长度 = %d, 变点数 = %d</span></span>
<span id="cb106-2219"><a href="#cb106-2219" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>,</span>
<span id="cb106-2220"><a href="#cb106-2220" aria-hidden="true" tabindex="-1"></a>                  beta_list[pp<span class="sc">$</span>start], beta_list[pp<span class="sc">$</span>end], pp<span class="sc">$</span>length, pp<span class="sc">$</span>value))</span>
<span id="cb106-2221"><a href="#cb106-2221" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2222"><a href="#cb106-2222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span></span>
<span id="cb106-2223"><a href="#cb106-2223" aria-hidden="true" tabindex="-1"></a><span class="st">Elbow 候选 β = %.2f</span></span>
<span id="cb106-2224"><a href="#cb106-2224" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, el<span class="sc">$</span>beta))</span>
<span id="cb106-2225"><a href="#cb106-2225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"最终推荐 β = %.2f (在 elbow 附近 plateau 最长)</span></span>
<span id="cb106-2226"><a href="#cb106-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2227"><a href="#cb106-2227" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, best_beta))</span>
<span id="cb106-2228"><a href="#cb106-2228" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2229"><a href="#cb106-2229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2230"><a href="#cb106-2230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb106-2231"><a href="#cb106-2231" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_list =</span> beta_list,</span>
<span id="cb106-2232"><a href="#cb106-2232" aria-hidden="true" tabindex="-1"></a>    <span class="at">bp_counts =</span> bp_counts,</span>
<span id="cb106-2233"><a href="#cb106-2233" aria-hidden="true" tabindex="-1"></a>    <span class="at">results =</span> results,</span>
<span id="cb106-2234"><a href="#cb106-2234" aria-hidden="true" tabindex="-1"></a>    <span class="at">plateaus =</span> plateaus,</span>
<span id="cb106-2235"><a href="#cb106-2235" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb106-2236"><a href="#cb106-2236" aria-hidden="true" tabindex="-1"></a>    <span class="at">best_beta =</span> best_beta</span>
<span id="cb106-2237"><a href="#cb106-2237" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2238"><a href="#cb106-2238" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2239"><a href="#cb106-2239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2240"><a href="#cb106-2240" aria-hidden="true" tabindex="-1"></a>plot_segmentation_path <span class="ot">&lt;-</span> <span class="cf">function</span>(res) {</span>
<span id="cb106-2241"><a href="#cb106-2241" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> res<span class="sc">$</span>beta_list; bp_counts <span class="ot">&lt;-</span> res<span class="sc">$</span>bp_counts</span>
<span id="cb106-2242"><a href="#cb106-2242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(beta_list, bp_counts, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb106-2243"><a href="#cb106-2243" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"Beta"</span>, <span class="at">ylab =</span> <span class="st">"Number of Change Points"</span>,</span>
<span id="cb106-2244"><a href="#cb106-2244" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Stability Path: Beta vs. Change Points"</span>)</span>
<span id="cb106-2245"><a href="#cb106-2245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>elbow_beta, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-2246"><a href="#cb106-2246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>best_beta,  <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-2247"><a href="#cb106-2247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Elbow"</span>, <span class="st">"Final Beta (Plateau)"</span>),</span>
<span id="cb106-2248"><a href="#cb106-2248" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb106-2249"><a href="#cb106-2249" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2250"><a href="#cb106-2250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2251"><a href="#cb106-2251" aria-hidden="true" tabindex="-1"></a><span class="co"># 记忆：我的abs算法</span></span>
<span id="cb106-2252"><a href="#cb106-2252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2253"><a href="#cb106-2253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2254"><a href="#cb106-2254" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-2255"><a href="#cb106-2255" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 逐维法：单维 BS + 合并</span></span>
<span id="cb106-2256"><a href="#cb106-2256" aria-hidden="true" tabindex="-1"></a><span class="do">##    ——并配套“稳定路径 Elbow+Plateau”自适应选 β（与 ABS 公平）</span></span>
<span id="cb106-2257"><a href="#cb106-2257" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-2258"><a href="#cb106-2258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2259"><a href="#cb106-2259" aria-hidden="true" tabindex="-1"></a><span class="co"># 把若干维度检出的变点合并：按 tol 聚簇，簇内取均值(四舍五入)为代表</span></span>
<span id="cb106-2260"><a href="#cb106-2260" aria-hidden="true" tabindex="-1"></a>merge_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(cplist, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>)) {</span>
<span id="cb106-2261"><a href="#cb106-2261" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb106-2262"><a href="#cb106-2262" aria-hidden="true" tabindex="-1"></a>  all <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.integer</span>(<span class="fu">unlist</span>(cplist)))</span>
<span id="cb106-2263"><a href="#cb106-2263" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(all) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb106-2264"><a href="#cb106-2264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2265"><a href="#cb106-2265" aria-hidden="true" tabindex="-1"></a>  clusters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb106-2266"><a href="#cb106-2266" aria-hidden="true" tabindex="-1"></a>  curr <span class="ot">&lt;-</span> <span class="fu">c</span>(all[<span class="dv">1</span>])</span>
<span id="cb106-2267"><a href="#cb106-2267" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x <span class="cf">in</span> all[<span class="sc">-</span><span class="dv">1</span>]) {</span>
<span id="cb106-2268"><a href="#cb106-2268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">-</span> curr[<span class="fu">length</span>(curr)] <span class="sc">&lt;=</span> tol) {</span>
<span id="cb106-2269"><a href="#cb106-2269" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(curr, x)</span>
<span id="cb106-2270"><a href="#cb106-2270" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb106-2271"><a href="#cb106-2271" aria-hidden="true" tabindex="-1"></a>      clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb106-2272"><a href="#cb106-2272" aria-hidden="true" tabindex="-1"></a>      curr <span class="ot">&lt;-</span> <span class="fu">c</span>(x)</span>
<span id="cb106-2273"><a href="#cb106-2273" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2274"><a href="#cb106-2274" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2275"><a href="#cb106-2275" aria-hidden="true" tabindex="-1"></a>  clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> curr</span>
<span id="cb106-2276"><a href="#cb106-2276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2277"><a href="#cb106-2277" aria-hidden="true" tabindex="-1"></a>  rep_fun <span class="ot">&lt;-</span> <span class="cf">if</span> (representative <span class="sc">==</span> <span class="st">"mean"</span>) mean <span class="cf">else</span> median</span>
<span id="cb106-2278"><a href="#cb106-2278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">vapply</span>(clusters, rep_fun, <span class="fu">numeric</span>(<span class="dv">1</span>))))</span>
<span id="cb106-2279"><a href="#cb106-2279" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2280"><a href="#cb106-2280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2281"><a href="#cb106-2281" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2282"><a href="#cb106-2282" aria-hidden="true" tabindex="-1"></a>per_dim_single_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(y_vec,</span>
<span id="cb106-2283"><a href="#cb106-2283" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-2284"><a href="#cb106-2284" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">elbow_window =</span> <span class="dv">10</span>) {</span>
<span id="cb106-2285"><a href="#cb106-2285" aria-hidden="true" tabindex="-1"></a>  Yj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(y_vec, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb106-2286"><a href="#cb106-2286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 关键优化：为该维度一次性构建累计和，供后续多次 binary_segmentation 复用</span></span>
<span id="cb106-2287"><a href="#cb106-2287" aria-hidden="true" tabindex="-1"></a>  Yj <span class="ot">&lt;-</span> <span class="fu">.ensure_cumsum</span>(Yj)</span>
<span id="cb106-2288"><a href="#cb106-2288" aria-hidden="true" tabindex="-1"></a>  beta_list <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_min, beta_max, <span class="at">length.out =</span> beta_points)</span>
<span id="cb106-2289"><a href="#cb106-2289" aria-hidden="true" tabindex="-1"></a>  results   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(beta_list))</span>
<span id="cb106-2290"><a href="#cb106-2290" aria-hidden="true" tabindex="-1"></a>  counts    <span class="ot">&lt;-</span> <span class="fu">integer</span>(<span class="fu">length</span>(beta_list))</span>
<span id="cb106-2291"><a href="#cb106-2291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2292"><a href="#cb106-2292" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(beta_list)) {</span>
<span id="cb106-2293"><a href="#cb106-2293" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> beta_list[i]</span>
<span id="cb106-2294"><a href="#cb106-2294" aria-hidden="true" tabindex="-1"></a>    th <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">binary_segmentation</span>(Yj, b, <span class="at">t0 =</span> <span class="dv">0</span>, <span class="at">t1 =</span> <span class="fu">nrow</span>(Yj), <span class="at">min_size =</span> min_size, <span class="at">p =</span> p))</span>
<span id="cb106-2295"><a href="#cb106-2295" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> th</span>
<span id="cb106-2296"><a href="#cb106-2296" aria-hidden="true" tabindex="-1"></a>    counts[i] <span class="ot">&lt;-</span> <span class="fu">length</span>(th)</span>
<span id="cb106-2297"><a href="#cb106-2297" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2298"><a href="#cb106-2298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2299"><a href="#cb106-2299" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(counts <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb106-2300"><a href="#cb106-2300" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">best_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb106-2301"><a href="#cb106-2301" aria-hidden="true" tabindex="-1"></a>                <span class="at">elbow_beta =</span> <span class="fu">median</span>(beta_list),</span>
<span id="cb106-2302"><a href="#cb106-2302" aria-hidden="true" tabindex="-1"></a>                <span class="at">plateaus =</span> <span class="fu">list</span>(), <span class="at">t_hat =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb106-2303"><a href="#cb106-2303" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts))</span>
<span id="cb106-2304"><a href="#cb106-2304" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2305"><a href="#cb106-2305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2306"><a href="#cb106-2306" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">find_elbow</span>(beta_list, counts)</span>
<span id="cb106-2307"><a href="#cb106-2307" aria-hidden="true" tabindex="-1"></a>  elbow_idx <span class="ot">&lt;-</span> el<span class="sc">$</span>index</span>
<span id="cb106-2308"><a href="#cb106-2308" aria-hidden="true" tabindex="-1"></a>  pls <span class="ot">&lt;-</span> <span class="fu">find_plateaus</span>(beta_list, counts)</span>
<span id="cb106-2309"><a href="#cb106-2309" aria-hidden="true" tabindex="-1"></a>  left_bound  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, elbow_idx <span class="sc">-</span> elbow_window)</span>
<span id="cb106-2310"><a href="#cb106-2310" aria-hidden="true" tabindex="-1"></a>  right_bound <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(beta_list), elbow_idx <span class="sc">+</span> elbow_window)</span>
<span id="cb106-2311"><a href="#cb106-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2312"><a href="#cb106-2312" aria-hidden="true" tabindex="-1"></a>  best_pl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb106-2313"><a href="#cb106-2313" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pp <span class="cf">in</span> pls) {</span>
<span id="cb106-2314"><a href="#cb106-2314" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pp<span class="sc">$</span>start <span class="sc">&lt;=</span> right_bound <span class="sc">&amp;&amp;</span> pp<span class="sc">$</span>end <span class="sc">&gt;=</span> left_bound) {</span>
<span id="cb106-2315"><a href="#cb106-2315" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(best_pl) <span class="sc">||</span> pp<span class="sc">$</span>length <span class="sc">&gt;</span> best_pl<span class="sc">$</span>length) best_pl <span class="ot">&lt;-</span> pp</span>
<span id="cb106-2316"><a href="#cb106-2316" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2317"><a href="#cb106-2317" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2318"><a href="#cb106-2318" aria-hidden="true" tabindex="-1"></a>  best_beta <span class="ot">&lt;-</span> beta_list[<span class="fu">round</span>((best_pl<span class="sc">$</span>start <span class="sc">+</span> best_pl<span class="sc">$</span>end) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb106-2319"><a href="#cb106-2319" aria-hidden="true" tabindex="-1"></a>  best_idx  <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(beta_list <span class="sc">-</span> best_beta))</span>
<span id="cb106-2320"><a href="#cb106-2320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2321"><a href="#cb106-2321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">best_beta =</span> best_beta,</span>
<span id="cb106-2322"><a href="#cb106-2322" aria-hidden="true" tabindex="-1"></a>       <span class="at">elbow_beta =</span> el<span class="sc">$</span>beta,</span>
<span id="cb106-2323"><a href="#cb106-2323" aria-hidden="true" tabindex="-1"></a>       <span class="at">plateaus =</span> pls,</span>
<span id="cb106-2324"><a href="#cb106-2324" aria-hidden="true" tabindex="-1"></a>       <span class="at">t_hat =</span> <span class="fu">sort</span>(results[[best_idx]]),</span>
<span id="cb106-2325"><a href="#cb106-2325" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_list =</span> beta_list, <span class="at">counts =</span> counts)</span>
<span id="cb106-2326"><a href="#cb106-2326" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2327"><a href="#cb106-2327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2328"><a href="#cb106-2328" aria-hidden="true" tabindex="-1"></a>per_dim_individual_adaptive <span class="ot">&lt;-</span> <span class="cf">function</span>(Y,</span>
<span id="cb106-2329"><a href="#cb106-2329" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">beta_min =</span> <span class="dv">3</span>, <span class="at">beta_max =</span> <span class="dv">30</span>, <span class="at">beta_points =</span> <span class="dv">70</span>,</span>
<span id="cb106-2330"><a href="#cb106-2330" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">min_size =</span> <span class="dv">2</span>, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">tol =</span> <span class="dv">3</span>L, <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-2331"><a href="#cb106-2331" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">representative =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"median"</span>),</span>
<span id="cb106-2332"><a href="#cb106-2332" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-2333"><a href="#cb106-2333" aria-hidden="true" tabindex="-1"></a>  representative <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(representative)</span>
<span id="cb106-2334"><a href="#cb106-2334" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb106-2335"><a href="#cb106-2335" aria-hidden="true" tabindex="-1"></a>  dim_betas <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d)</span>
<span id="cb106-2336"><a href="#cb106-2336" aria-hidden="true" tabindex="-1"></a>  dim_cps   <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, d)</span>
<span id="cb106-2337"><a href="#cb106-2337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2338"><a href="#cb106-2338" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb106-2339"><a href="#cb106-2339" aria-hidden="true" tabindex="-1"></a>    rj <span class="ot">&lt;-</span> <span class="fu">per_dim_single_adaptive</span>(Y[, j],</span>
<span id="cb106-2340"><a href="#cb106-2340" aria-hidden="true" tabindex="-1"></a>                                  beta_min, beta_max, beta_points,</span>
<span id="cb106-2341"><a href="#cb106-2341" aria-hidden="true" tabindex="-1"></a>                                  min_size, p, elbow_window)</span>
<span id="cb106-2342"><a href="#cb106-2342" aria-hidden="true" tabindex="-1"></a>    dim_betas[j] <span class="ot">&lt;-</span> rj<span class="sc">$</span>best_beta</span>
<span id="cb106-2343"><a href="#cb106-2343" aria-hidden="true" tabindex="-1"></a>    dim_cps[[j]] <span class="ot">&lt;-</span> rj<span class="sc">$</span>t_hat</span>
<span id="cb106-2344"><a href="#cb106-2344" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose) <span class="sc">&amp;&amp;</span> (j <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[per-dim] finished %d/%d"</span>, j, d))</span>
<span id="cb106-2345"><a href="#cb106-2345" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2346"><a href="#cb106-2346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2347"><a href="#cb106-2347" aria-hidden="true" tabindex="-1"></a>  merged <span class="ot">&lt;-</span> <span class="fu">merge_cps</span>(dim_cps, <span class="at">tol =</span> tol, <span class="at">representative =</span> representative)</span>
<span id="cb106-2348"><a href="#cb106-2348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">merged_cp =</span> <span class="fu">sort</span>(merged), <span class="at">per_dim_beta =</span> dim_betas, <span class="at">per_dim_cp =</span> dim_cps)</span>
<span id="cb106-2349"><a href="#cb106-2349" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2350"><a href="#cb106-2350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2351"><a href="#cb106-2351" aria-hidden="true" tabindex="-1"></a><span class="co"># 记忆：我的对比function 逐维法和abs</span></span>
<span id="cb106-2352"><a href="#cb106-2352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2353"><a href="#cb106-2353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2354"><a href="#cb106-2354" aria-hidden="true" tabindex="-1"></a><span class="do">## 3) 密集模式数据生成 &amp; 评价指标</span></span>
<span id="cb106-2355"><a href="#cb106-2355" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-2356"><a href="#cb106-2356" aria-hidden="true" tabindex="-1"></a>simulate_dense <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">100</span>,</span>
<span id="cb106-2357"><a href="#cb106-2357" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>),</span>
<span id="cb106-2358"><a href="#cb106-2358" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rho =</span> <span class="fl">0.6</span>,              <span class="co"># 每次跳变的受影响比例</span></span>
<span id="cb106-2359"><a href="#cb106-2359" aria-hidden="true" tabindex="-1"></a>                           <span class="at">delta =</span> <span class="fl">1.0</span>,            <span class="co"># 单次跳变幅度（同号）</span></span>
<span id="cb106-2360"><a href="#cb106-2360" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma =</span> <span class="fl">1.0</span>,            <span class="co"># 噪声标准差</span></span>
<span id="cb106-2361"><a href="#cb106-2361" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ar_phi =</span> <span class="fl">0.0</span>,           <span class="co"># AR(1) 噪声相关，0 表示独立</span></span>
<span id="cb106-2362"><a href="#cb106-2362" aria-hidden="true" tabindex="-1"></a>                           <span class="at">same_sign =</span> <span class="cn">TRUE</span>,       <span class="co"># TRUE：所有受影响维同号上升</span></span>
<span id="cb106-2363"><a href="#cb106-2363" aria-hidden="true" tabindex="-1"></a>                           <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb106-2364"><a href="#cb106-2364" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb106-2365"><a href="#cb106-2365" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb106-2366"><a href="#cb106-2366" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb106-2367"><a href="#cb106-2367" aria-hidden="true" tabindex="-1"></a>  Y  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-2368"><a href="#cb106-2368" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-2369"><a href="#cb106-2369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2370"><a href="#cb106-2370" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 固定一个受影响子集（密集：每个变点都影响同一批维度）</span></span>
<span id="cb106-2371"><a href="#cb106-2371" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb106-2372"><a href="#cb106-2372" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-2373"><a href="#cb106-2373" aria-hidden="true" tabindex="-1"></a>  jump_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(d); jump_vec[S] <span class="ot">&lt;-</span> signs[S] <span class="sc">*</span> delta</span>
<span id="cb106-2374"><a href="#cb106-2374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2375"><a href="#cb106-2375" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 累积式均值：每遇到一个变点，对 [cp+1, n] 段叠加 jump_vec</span></span>
<span id="cb106-2376"><a href="#cb106-2376" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (cp <span class="cf">in</span> cps) {</span>
<span id="cb106-2377"><a href="#cb106-2377" aria-hidden="true" tabindex="-1"></a>    mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, ] <span class="ot">&lt;-</span> <span class="fu">sweep</span>(mu[(cp <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, , <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="dv">2</span>, jump_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb106-2378"><a href="#cb106-2378" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2379"><a href="#cb106-2379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2380"><a href="#cb106-2380" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 嵌入噪声：独立或 AR(1)</span></span>
<span id="cb106-2381"><a href="#cb106-2381" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb106-2382"><a href="#cb106-2382" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb106-2383"><a href="#cb106-2383" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-2384"><a href="#cb106-2384" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-2385"><a href="#cb106-2385" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb106-2386"><a href="#cb106-2386" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb106-2387"><a href="#cb106-2387" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb106-2388"><a href="#cb106-2388" aria-hidden="true" tabindex="-1"></a>      eps[t, ] <span class="ot">&lt;-</span> ar_phi <span class="sc">*</span> eps[t <span class="sc">-</span> <span class="dv">1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb106-2389"><a href="#cb106-2389" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-2390"><a href="#cb106-2390" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2391"><a href="#cb106-2391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2392"><a href="#cb106-2392" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> mu <span class="sc">+</span> eps</span>
<span id="cb106-2393"><a href="#cb106-2393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> Y, <span class="at">true_cp =</span> cps, <span class="at">mu =</span> mu, <span class="at">S =</span> S)</span>
<span id="cb106-2394"><a href="#cb106-2394" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2395"><a href="#cb106-2395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2396"><a href="#cb106-2396" aria-hidden="true" tabindex="-1"></a><span class="co"># 评价函数（增强鲁棒性）</span></span>
<span id="cb106-2397"><a href="#cb106-2397" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb106-2398"><a href="#cb106-2398" aria-hidden="true" tabindex="-1"></a>hausdorff <span class="ot">&lt;-</span> <span class="cf">function</span>(A, B) {</span>
<span id="cb106-2399"><a href="#cb106-2399" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(A) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(B) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">Inf</span>)</span>
<span id="cb106-2400"><a href="#cb106-2400" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(A)</span>
<span id="cb106-2401"><a href="#cb106-2401" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(B)</span>
<span id="cb106-2402"><a href="#cb106-2402" aria-hidden="true" tabindex="-1"></a>  max_A <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(A, <span class="cf">function</span>(a) <span class="fu">min</span>(<span class="fu">abs</span>(a <span class="sc">-</span> B))))</span>
<span id="cb106-2403"><a href="#cb106-2403" aria-hidden="true" tabindex="-1"></a>  max_B <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(B, <span class="cf">function</span>(b) <span class="fu">min</span>(<span class="fu">abs</span>(b <span class="sc">-</span> A))))</span>
<span id="cb106-2404"><a href="#cb106-2404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">max</span>(max_A, max_B))</span>
<span id="cb106-2405"><a href="#cb106-2405" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2406"><a href="#cb106-2406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2407"><a href="#cb106-2407" aria-hidden="true" tabindex="-1"></a>f1_score <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, <span class="at">tol =</span> <span class="dv">1</span>) {</span>
<span id="cb106-2408"><a href="#cb106-2408" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb106-2409"><a href="#cb106-2409" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb106-2410"><a href="#cb106-2410" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-2411"><a href="#cb106-2411" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 处理空输入</span></span>
<span id="cb106-2412"><a href="#cb106-2412" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(detected_cp) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb106-2413"><a href="#cb106-2413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-2414"><a href="#cb106-2414" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2415"><a href="#cb106-2415" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-2416"><a href="#cb106-2416" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">any</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&lt;=</span> tol)))</span>
<span id="cb106-2417"><a href="#cb106-2417" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(detected_cp, <span class="cf">function</span>(dc) <span class="fu">all</span>(<span class="fu">abs</span>(true_cp <span class="sc">-</span> dc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb106-2418"><a href="#cb106-2418" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(true_cp, <span class="cf">function</span>(tc) <span class="fu">all</span>(<span class="fu">abs</span>(detected_cp <span class="sc">-</span> tc) <span class="sc">&gt;</span> tol)))</span>
<span id="cb106-2419"><a href="#cb106-2419" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-2420"><a href="#cb106-2420" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FP) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FP)</span>
<span id="cb106-2421"><a href="#cb106-2421" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="cf">if</span> ((TP <span class="sc">+</span> FN) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb106-2422"><a href="#cb106-2422" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-2423"><a href="#cb106-2423" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((precision <span class="sc">+</span> recall) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-2424"><a href="#cb106-2424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="dv">2</span> <span class="sc">*</span> precision <span class="sc">*</span> recall <span class="sc">/</span> (precision <span class="sc">+</span> recall))</span>
<span id="cb106-2425"><a href="#cb106-2425" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2426"><a href="#cb106-2426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2427"><a href="#cb106-2427" aria-hidden="true" tabindex="-1"></a>rand_index <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp, n) {</span>
<span id="cb106-2428"><a href="#cb106-2428" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(true_cp))</span>
<span id="cb106-2429"><a href="#cb106-2429" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.numeric</span>(detected_cp))</span>
<span id="cb106-2430"><a href="#cb106-2430" aria-hidden="true" tabindex="-1"></a>  true_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, true_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2431"><a href="#cb106-2431" aria-hidden="true" tabindex="-1"></a>  detected_labels <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, detected_cp, n), <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2432"><a href="#cb106-2432" aria-hidden="true" tabindex="-1"></a>  agree <span class="ot">&lt;-</span> <span class="fu">outer</span>(true_labels, true_labels, <span class="st">"=="</span>) <span class="sc">==</span> <span class="fu">outer</span>(detected_labels, detected_labels, <span class="st">"=="</span>)</span>
<span id="cb106-2433"><a href="#cb106-2433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(agree))</span>
<span id="cb106-2434"><a href="#cb106-2434" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2435"><a href="#cb106-2435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2436"><a href="#cb106-2436" aria-hidden="true" tabindex="-1"></a>annotation_error <span class="ot">&lt;-</span> <span class="cf">function</span>(true_cp, detected_cp) {</span>
<span id="cb106-2437"><a href="#cb106-2437" aria-hidden="true" tabindex="-1"></a>  true_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(true_cp)</span>
<span id="cb106-2438"><a href="#cb106-2438" aria-hidden="true" tabindex="-1"></a>  detected_cp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(detected_cp)</span>
<span id="cb106-2439"><a href="#cb106-2439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>(<span class="fu">length</span>(true_cp) <span class="sc">-</span> <span class="fu">length</span>(detected_cp))</span>
<span id="cb106-2440"><a href="#cb106-2440" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2441"><a href="#cb106-2441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2442"><a href="#cb106-2442" aria-hidden="true" tabindex="-1"></a><span class="co"># 记忆：数据生成和评价指标</span></span>
<span id="cb106-2443"><a href="#cb106-2443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2444"><a href="#cb106-2444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2445"><a href="#cb106-2445" aria-hidden="true" tabindex="-1"></a><span class="do">## 4) 实验驱动：单次与批量评估</span></span>
<span id="cb106-2446"><a href="#cb106-2446" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2447"><a href="#cb106-2447" aria-hidden="true" tabindex="-1"></a>run_one_trial <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>,</span>
<span id="cb106-2448"><a href="#cb106-2448" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb106-2449"><a href="#cb106-2449" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-2450"><a href="#cb106-2450" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb106-2451"><a href="#cb106-2451" aria-hidden="true" tabindex="-1"></a>                          <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-2452"><a href="#cb106-2452" aria-hidden="true" tabindex="-1"></a>                          <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-2453"><a href="#cb106-2453" aria-hidden="true" tabindex="-1"></a>                          <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-2454"><a href="#cb106-2454" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="cn">NULL</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-2455"><a href="#cb106-2455" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_dense</span>(n, d, cps, rho, delta, sigma, ar_phi, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb106-2456"><a href="#cb106-2456" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb106-2457"><a href="#cb106-2457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2458"><a href="#cb106-2458" aria-hidden="true" tabindex="-1"></a>  t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb106-2459"><a href="#cb106-2459" aria-hidden="true" tabindex="-1"></a>    abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb106-2460"><a href="#cb106-2460" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb106-2461"><a href="#cb106-2461" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> verbose</span>
<span id="cb106-2462"><a href="#cb106-2462" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-2463"><a href="#cb106-2463" aria-hidden="true" tabindex="-1"></a>    idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb106-2464"><a href="#cb106-2464" aria-hidden="true" tabindex="-1"></a>    cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb106-2465"><a href="#cb106-2465" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb106-2466"><a href="#cb106-2466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2467"><a href="#cb106-2467" aria-hidden="true" tabindex="-1"></a>  t_per <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb106-2468"><a href="#cb106-2468" aria-hidden="true" tabindex="-1"></a>    per_res <span class="ot">&lt;-</span> <span class="fu">per_dim_individual_adaptive</span>(</span>
<span id="cb106-2469"><a href="#cb106-2469" aria-hidden="true" tabindex="-1"></a>      Y, <span class="at">beta_min =</span> per_beta_min, <span class="at">beta_max =</span> per_beta_max, <span class="at">beta_points =</span> per_beta_points,</span>
<span id="cb106-2470"><a href="#cb106-2470" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_per, <span class="at">tol =</span> tol_match, <span class="at">elbow_window =</span> elbow_window,</span>
<span id="cb106-2471"><a href="#cb106-2471" aria-hidden="true" tabindex="-1"></a>      <span class="at">representative =</span> representative, <span class="at">verbose =</span> verbose</span>
<span id="cb106-2472"><a href="#cb106-2472" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-2473"><a href="#cb106-2473" aria-hidden="true" tabindex="-1"></a>    cp_per <span class="ot">&lt;-</span> per_res<span class="sc">$</span>merged_cp</span>
<span id="cb106-2474"><a href="#cb106-2474" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb106-2475"><a href="#cb106-2475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2476"><a href="#cb106-2476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 评估</span></span>
<span id="cb106-2477"><a href="#cb106-2477" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> tol_match)</span>
<span id="cb106-2478"><a href="#cb106-2478" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_per, <span class="at">tol =</span> tol_match)</span>
<span id="cb106-2479"><a href="#cb106-2479" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb106-2480"><a href="#cb106-2480" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_per)</span>
<span id="cb106-2481"><a href="#cb106-2481" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> n)</span>
<span id="cb106-2482"><a href="#cb106-2482" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_per, <span class="at">n =</span> n)</span>
<span id="cb106-2483"><a href="#cb106-2483" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb106-2484"><a href="#cb106-2484" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_per)</span>
<span id="cb106-2485"><a href="#cb106-2485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2486"><a href="#cb106-2486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb106-2487"><a href="#cb106-2487" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_cp =</span> true_cp,</span>
<span id="cb106-2488"><a href="#cb106-2488" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_abs,</span>
<span id="cb106-2489"><a href="#cb106-2489" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> abs_f1, <span class="at">haus =</span> abs_haus, <span class="at">rand =</span> abs_rand, <span class="at">ann =</span> abs_ann,</span>
<span id="cb106-2490"><a href="#cb106-2490" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])),</span>
<span id="cb106-2491"><a href="#cb106-2491" aria-hidden="true" tabindex="-1"></a>    <span class="at">per =</span> <span class="fu">list</span>(<span class="at">cp =</span> cp_per,</span>
<span id="cb106-2492"><a href="#cb106-2492" aria-hidden="true" tabindex="-1"></a>               <span class="at">f1 =</span> per_f1, <span class="at">haus =</span> per_haus, <span class="at">rand =</span> per_rand, <span class="at">ann =</span> per_ann,</span>
<span id="cb106-2493"><a href="#cb106-2493" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">as.numeric</span>(t_per[<span class="st">"elapsed"</span>]))</span>
<span id="cb106-2494"><a href="#cb106-2494" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2495"><a href="#cb106-2495" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2496"><a href="#cb106-2496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2497"><a href="#cb106-2497" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2498"><a href="#cb106-2498" aria-hidden="true" tabindex="-1"></a><span class="do">## 批量实验与汇总</span></span>
<span id="cb106-2499"><a href="#cb106-2499" aria-hidden="true" tabindex="-1"></a><span class="do">## =====================================================================</span></span>
<span id="cb106-2500"><a href="#cb106-2500" aria-hidden="true" tabindex="-1"></a>run_experiments <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">R =</span> <span class="dv">30</span>,</span>
<span id="cb106-2501"><a href="#cb106-2501" aria-hidden="true" tabindex="-1"></a>                            <span class="at">n =</span> <span class="dv">2000</span>, <span class="at">d =</span> <span class="dv">120</span>, <span class="at">cps =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">1200</span>, <span class="dv">1600</span>),</span>
<span id="cb106-2502"><a href="#cb106-2502" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">delta =</span> <span class="fl">1.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> <span class="fl">0.2</span>,</span>
<span id="cb106-2503"><a href="#cb106-2503" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_size =</span> <span class="dv">5</span>, <span class="at">tol_match =</span> <span class="dv">3</span>L,</span>
<span id="cb106-2504"><a href="#cb106-2504" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-2505"><a href="#cb106-2505" aria-hidden="true" tabindex="-1"></a>                            <span class="at">per_beta_min =</span> <span class="dv">3</span>, <span class="at">per_beta_max =</span> <span class="dv">30</span>, <span class="at">per_beta_points =</span> <span class="dv">70</span>, <span class="at">p_per =</span> <span class="dv">2</span>,</span>
<span id="cb106-2506"><a href="#cb106-2506" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window =</span> <span class="dv">10</span>, <span class="at">representative =</span> <span class="st">"mean"</span>,</span>
<span id="cb106-2507"><a href="#cb106-2507" aria-hidden="true" tabindex="-1"></a>                            <span class="at">seed0 =</span> <span class="dv">123</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb106-2508"><a href="#cb106-2508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed0)</span>
<span id="cb106-2509"><a href="#cb106-2509" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, R)</span>
<span id="cb106-2510"><a href="#cb106-2510" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_len</span>(R)) {</span>
<span id="cb106-2511"><a href="#cb106-2511" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, <span class="dv">1</span>)</span>
<span id="cb106-2512"><a href="#cb106-2512" aria-hidden="true" tabindex="-1"></a>    results[[r]] <span class="ot">&lt;-</span> <span class="fu">run_one_trial</span>(</span>
<span id="cb106-2513"><a href="#cb106-2513" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> n, <span class="at">d =</span> d, <span class="at">cps =</span> cps, <span class="at">rho =</span> rho, <span class="at">delta =</span> delta, <span class="at">sigma =</span> sigma, <span class="at">ar_phi =</span> ar_phi,</span>
<span id="cb106-2514"><a href="#cb106-2514" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_size =</span> min_size, <span class="at">tol_match =</span> tol_match,</span>
<span id="cb106-2515"><a href="#cb106-2515" aria-hidden="true" tabindex="-1"></a>      <span class="at">abs_beta_min =</span> abs_beta_min, <span class="at">abs_beta_max =</span> abs_beta_max, <span class="at">abs_beta_points =</span> abs_beta_points, <span class="at">p_abs =</span> p_abs,</span>
<span id="cb106-2516"><a href="#cb106-2516" aria-hidden="true" tabindex="-1"></a>      <span class="at">per_beta_min =</span> per_beta_min, <span class="at">per_beta_max =</span> per_beta_max, <span class="at">per_beta_points =</span> per_beta_points, <span class="at">p_per =</span> p_per,</span>
<span id="cb106-2517"><a href="#cb106-2517" aria-hidden="true" tabindex="-1"></a>      <span class="at">elbow_window =</span> elbow_window, <span class="at">representative =</span> representative,</span>
<span id="cb106-2518"><a href="#cb106-2518" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> s, <span class="at">verbose =</span> verbose</span>
<span id="cb106-2519"><a href="#cb106-2519" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-2520"><a href="#cb106-2520" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(verbose)) <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[run] %d/%d done"</span>, r, R))</span>
<span id="cb106-2521"><a href="#cb106-2521" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-2522"><a href="#cb106-2522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2523"><a href="#cb106-2523" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 抽出指标</span></span>
<span id="cb106-2524"><a href="#cb106-2524" aria-hidden="true" tabindex="-1"></a>  abs_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>f1)</span>
<span id="cb106-2525"><a href="#cb106-2525" aria-hidden="true" tabindex="-1"></a>  per_f1   <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>f1)</span>
<span id="cb106-2526"><a href="#cb106-2526" aria-hidden="true" tabindex="-1"></a>  abs_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>haus)</span>
<span id="cb106-2527"><a href="#cb106-2527" aria-hidden="true" tabindex="-1"></a>  per_haus <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>haus)</span>
<span id="cb106-2528"><a href="#cb106-2528" aria-hidden="true" tabindex="-1"></a>  abs_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>rand)</span>
<span id="cb106-2529"><a href="#cb106-2529" aria-hidden="true" tabindex="-1"></a>  per_rand <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>rand)</span>
<span id="cb106-2530"><a href="#cb106-2530" aria-hidden="true" tabindex="-1"></a>  abs_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>ann)</span>
<span id="cb106-2531"><a href="#cb106-2531" aria-hidden="true" tabindex="-1"></a>  per_ann  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>ann)</span>
<span id="cb106-2532"><a href="#cb106-2532" aria-hidden="true" tabindex="-1"></a>  abs_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>abs<span class="sc">$</span>time)</span>
<span id="cb106-2533"><a href="#cb106-2533" aria-hidden="true" tabindex="-1"></a>  per_t    <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(o) o<span class="sc">$</span>per<span class="sc">$</span>time)</span>
<span id="cb106-2534"><a href="#cb106-2534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2535"><a href="#cb106-2535" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-2536"><a href="#cb106-2536" aria-hidden="true" tabindex="-1"></a>  sdv <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-2537"><a href="#cb106-2537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2538"><a href="#cb106-2538" aria-hidden="true" tabindex="-1"></a>  summary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb106-2539"><a href="#cb106-2539" aria-hidden="true" tabindex="-1"></a>    <span class="at">ABS =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(abs_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(abs_f1),</span>
<span id="cb106-2540"><a href="#cb106-2540" aria-hidden="true" tabindex="-1"></a>            <span class="at">Haus_median =</span> <span class="fu">median</span>(abs_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-2541"><a href="#cb106-2541" aria-hidden="true" tabindex="-1"></a>            <span class="at">Rand_mean =</span> <span class="fu">m</span>(abs_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(abs_rand),</span>
<span id="cb106-2542"><a href="#cb106-2542" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ann_mean =</span> <span class="fu">m</span>(abs_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(abs_ann),</span>
<span id="cb106-2543"><a href="#cb106-2543" aria-hidden="true" tabindex="-1"></a>            <span class="at">Time_mean =</span> <span class="fu">m</span>(abs_t)),</span>
<span id="cb106-2544"><a href="#cb106-2544" aria-hidden="true" tabindex="-1"></a>    <span class="at">PER_indivBeta =</span> <span class="fu">c</span>(<span class="at">F1_mean =</span> <span class="fu">m</span>(per_f1),  <span class="at">F1_sd =</span> <span class="fu">sdv</span>(per_f1),</span>
<span id="cb106-2545"><a href="#cb106-2545" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Haus_median =</span> <span class="fu">median</span>(per_haus, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-2546"><a href="#cb106-2546" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Rand_mean =</span> <span class="fu">m</span>(per_rand), <span class="at">Rand_sd =</span> <span class="fu">sdv</span>(per_rand),</span>
<span id="cb106-2547"><a href="#cb106-2547" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Ann_mean =</span> <span class="fu">m</span>(per_ann),   <span class="at">Ann_sd =</span> <span class="fu">sdv</span>(per_ann),</span>
<span id="cb106-2548"><a href="#cb106-2548" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Time_mean =</span> <span class="fu">m</span>(per_t))</span>
<span id="cb106-2549"><a href="#cb106-2549" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2550"><a href="#cb106-2550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2551"><a href="#cb106-2551" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 逐次结果的 data.frame，便于出图</span></span>
<span id="cb106-2552"><a href="#cb106-2552" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb106-2553"><a href="#cb106-2553" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial =</span> <span class="fu">seq_len</span>(R),</span>
<span id="cb106-2554"><a href="#cb106-2554" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_f1 =</span> abs_f1, <span class="at">per_f1 =</span> per_f1,</span>
<span id="cb106-2555"><a href="#cb106-2555" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_haus =</span> abs_haus, <span class="at">per_haus =</span> per_haus,</span>
<span id="cb106-2556"><a href="#cb106-2556" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_rand =</span> abs_rand, <span class="at">per_rand =</span> per_rand,</span>
<span id="cb106-2557"><a href="#cb106-2557" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_ann =</span> abs_ann, <span class="at">per_ann =</span> per_ann,</span>
<span id="cb106-2558"><a href="#cb106-2558" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_time =</span> abs_t, <span class="at">per_time =</span> per_t</span>
<span id="cb106-2559"><a href="#cb106-2559" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2560"><a href="#cb106-2560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2561"><a href="#cb106-2561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">all =</span> results, <span class="at">summary =</span> summary, <span class="at">metrics =</span> df)</span>
<span id="cb106-2562"><a href="#cb106-2562" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2563"><a href="#cb106-2563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2564"><a href="#cb106-2564" aria-hidden="true" tabindex="-1"></a><span class="do">## 示例</span></span>
<span id="cb106-2565"><a href="#cb106-2565" aria-hidden="true" tabindex="-1"></a><span class="co"># res &lt;- run_experiments(</span></span>
<span id="cb106-2566"><a href="#cb106-2566" aria-hidden="true" tabindex="-1"></a><span class="co">#   R = 1,</span></span>
<span id="cb106-2567"><a href="#cb106-2567" aria-hidden="true" tabindex="-1"></a><span class="co">#   n = 200, d = 10, cps = c(60, 120, 160),</span></span>
<span id="cb106-2568"><a href="#cb106-2568" aria-hidden="true" tabindex="-1"></a><span class="co">#   rho = 0.7, delta = 1.0, sigma = 1.0, ar_phi = 0.2,</span></span>
<span id="cb106-2569"><a href="#cb106-2569" aria-hidden="true" tabindex="-1"></a><span class="co">#   min_size = 5, tol_match = 3L,</span></span>
<span id="cb106-2570"><a href="#cb106-2570" aria-hidden="true" tabindex="-1"></a><span class="co">#   abs_beta_min = 3, abs_beta_max = 30, abs_beta_points = 70, p_abs = 2,</span></span>
<span id="cb106-2571"><a href="#cb106-2571" aria-hidden="true" tabindex="-1"></a><span class="co">#   per_beta_min = 3, per_beta_max = 30, per_beta_points = 70, p_per = 2,</span></span>
<span id="cb106-2572"><a href="#cb106-2572" aria-hidden="true" tabindex="-1"></a><span class="co">#   elbow_window = 10, representative = "mean",</span></span>
<span id="cb106-2573"><a href="#cb106-2573" aria-hidden="true" tabindex="-1"></a><span class="co">#   seed0 = 123, verbose = TRUE</span></span>
<span id="cb106-2574"><a href="#cb106-2574" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb106-2575"><a href="#cb106-2575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2576"><a href="#cb106-2576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2577"><a href="#cb106-2577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2578"><a href="#cb106-2578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2579"><a href="#cb106-2579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2580"><a href="#cb106-2580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2581"><a href="#cb106-2581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2582"><a href="#cb106-2582" aria-hidden="true" tabindex="-1"></a>运行服务器simulation.R</span>
<span id="cb106-2583"><a href="#cb106-2583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2584"><a href="#cb106-2584" aria-hidden="true" tabindex="-1"></a>注意per_abs检测用的是前百分之20各维度取beta后的中位数作为per全局beta( 否则效率太低，速度太慢)</span>
<span id="cb106-2585"><a href="#cb106-2585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2586"><a href="#cb106-2586" aria-hidden="true" tabindex="-1"></a>code：</span>
<span id="cb106-2587"><a href="#cb106-2587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2588"><a href="#cb106-2588" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-2589"><a href="#cb106-2589" aria-hidden="true" tabindex="-1"></a><span class="in">## =========================================================</span></span>
<span id="cb106-2590"><a href="#cb106-2590" aria-hidden="true" tabindex="-1"></a><span class="in">## 大板表导出脚本（与已定义的 run_experiments() 配套）</span></span>
<span id="cb106-2591"><a href="#cb106-2591" aria-hidden="true" tabindex="-1"></a><span class="in">## 放在你已有算法与函数定义之后再运行</span></span>
<span id="cb106-2592"><a href="#cb106-2592" aria-hidden="true" tabindex="-1"></a><span class="in">## =========================================================</span></span>
<span id="cb106-2593"><a href="#cb106-2593" aria-hidden="true" tabindex="-1"></a><span class="in">n_levels    &lt;- c(200)       # T</span></span>
<span id="cb106-2594"><a href="#cb106-2594" aria-hidden="true" tabindex="-1"></a><span class="in">d_levels    &lt;- c(100)        # 列大分组</span></span>
<span id="cb106-2595"><a href="#cb106-2595" aria-hidden="true" tabindex="-1"></a><span class="in">rho_levels  &lt;- c(0.5)      # 列中分组</span></span>
<span id="cb106-2596"><a href="#cb106-2596" aria-hidden="true" tabindex="-1"></a><span class="in">snr_levels  &lt;- c(1)       # 行内第二列（Δ/σ；这里 σ=1 ⇒ Δ=SNR）</span></span>
<span id="cb106-2597"><a href="#cb106-2597" aria-hidden="true" tabindex="-1"></a><span class="in">phi_levels  &lt;- c(0)         # 行大分组</span></span>
<span id="cb106-2598"><a href="#cb106-2598" aria-hidden="true" tabindex="-1"></a><span class="in">K_levels    &lt;- c(1,20) </span></span>
<span id="cb106-2599"><a href="#cb106-2599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2600"><a href="#cb106-2600" aria-hidden="true" tabindex="-1"></a><span class="in">#metrics_to_show    &lt;- c("F1","Haus","Rand","Ann","Time","DetProb")</span></span>
<span id="cb106-2601"><a href="#cb106-2601" aria-hidden="true" tabindex="-1"></a><span class="in">metrics_to_show    &lt;- c("F1","Haus")</span></span>
<span id="cb106-2602"><a href="#cb106-2602" aria-hidden="true" tabindex="-1"></a><span class="in">R_trials    &lt;- 10</span></span>
<span id="cb106-2603"><a href="#cb106-2603" aria-hidden="true" tabindex="-1"></a><span class="in">seed0       &lt;- 264783846</span></span>
<span id="cb106-2604"><a href="#cb106-2604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2605"><a href="#cb106-2605" aria-hidden="true" tabindex="-1"></a><span class="in">## ===== 与 run_experiments() 对齐的口径 =====</span></span>
<span id="cb106-2606"><a href="#cb106-2606" aria-hidden="true" tabindex="-1"></a><span class="in">min_size     &lt;- 5</span></span>
<span id="cb106-2607"><a href="#cb106-2607" aria-hidden="true" tabindex="-1"></a><span class="in">tol_match    &lt;- 3L</span></span>
<span id="cb106-2608"><a href="#cb106-2608" aria-hidden="true" tabindex="-1"></a><span class="in">abs_beta_min &lt;- 10;  abs_beta_max &lt;- 50; abs_beta_points &lt;- 70; p_abs &lt;- 2</span></span>
<span id="cb106-2609"><a href="#cb106-2609" aria-hidden="true" tabindex="-1"></a><span class="in">per_beta_min &lt;- 10;  per_beta_max &lt;- 50; per_beta_points &lt;- 70; p_per &lt;- 2</span></span>
<span id="cb106-2610"><a href="#cb106-2610" aria-hidden="true" tabindex="-1"></a><span class="in">elbow_window &lt;- 10</span></span>
<span id="cb106-2611"><a href="#cb106-2611" aria-hidden="true" tabindex="-1"></a><span class="in">representative &lt;- "mean"</span></span>
<span id="cb106-2612"><a href="#cb106-2612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2613"><a href="#cb106-2613" aria-hidden="true" tabindex="-1"></a><span class="in">## ===== 工具函数 =====</span></span>
<span id="cb106-2614"><a href="#cb106-2614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2615"><a href="#cb106-2615" aria-hidden="true" tabindex="-1"></a><span class="in"># 等距断点（与论文常见设定一致）</span></span>
<span id="cb106-2616"><a href="#cb106-2616" aria-hidden="true" tabindex="-1"></a><span class="in">make_cps &lt;- function(T, K) {</span></span>
<span id="cb106-2617"><a href="#cb106-2617" aria-hidden="true" tabindex="-1"></a><span class="in">  if (K &lt;= 0) return(integer(0))</span></span>
<span id="cb106-2618"><a href="#cb106-2618" aria-hidden="true" tabindex="-1"></a><span class="in">  as.integer(round(seq(from = T/(K+1), by = T/(K+1), length.out = K)))</span></span>
<span id="cb106-2619"><a href="#cb106-2619" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-2620"><a href="#cb106-2620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2621"><a href="#cb106-2621" aria-hidden="true" tabindex="-1"></a><span class="in"># 在一个条件 (T, d, rho, snr, phi, K) 下跑 R_trials 次并汇总</span></span>
<span id="cb106-2622"><a href="#cb106-2622" aria-hidden="true" tabindex="-1"></a><span class="in"># 变更点：PER 的 β 选取 = 仅用前 10% 维度各自自适应求 β，取中位数 β；</span></span>
<span id="cb106-2623"><a href="#cb106-2623" aria-hidden="true" tabindex="-1"></a><span class="in">#         随后用该“中位数 β”对所有维度做 BS（固定 β），再合并变点。</span></span>
<span id="cb106-2624"><a href="#cb106-2624" aria-hidden="true" tabindex="-1"></a><span class="in">run_condition &lt;- function(T, d, rho, snr, phi, K) {</span></span>
<span id="cb106-2625"><a href="#cb106-2625" aria-hidden="true" tabindex="-1"></a><span class="in">  cps_vec &lt;- make_cps(T, K)</span></span>
<span id="cb106-2626"><a href="#cb106-2626" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-2627"><a href="#cb106-2627" aria-hidden="true" tabindex="-1"></a><span class="in">  # 累计容器</span></span>
<span id="cb106-2628"><a href="#cb106-2628" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_f1 &lt;- per_f1 &lt;- numeric(R_trials)</span></span>
<span id="cb106-2629"><a href="#cb106-2629" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_haus &lt;- per_haus &lt;- numeric(R_trials)</span></span>
<span id="cb106-2630"><a href="#cb106-2630" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_rand &lt;- per_rand &lt;- numeric(R_trials)</span></span>
<span id="cb106-2631"><a href="#cb106-2631" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_ann &lt;- per_ann &lt;- numeric(R_trials)</span></span>
<span id="cb106-2632"><a href="#cb106-2632" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_time &lt;- per_time &lt;- numeric(R_trials)</span></span>
<span id="cb106-2633"><a href="#cb106-2633" aria-hidden="true" tabindex="-1"></a><span class="in">  det_abs &lt;- det_per &lt;- logical(R_trials)</span></span>
<span id="cb106-2634"><a href="#cb106-2634" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-2635"><a href="#cb106-2635" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed0)</span></span>
<span id="cb106-2636"><a href="#cb106-2636" aria-hidden="true" tabindex="-1"></a><span class="in">  for (r in seq_len(R_trials)) {</span></span>
<span id="cb106-2637"><a href="#cb106-2637" aria-hidden="true" tabindex="-1"></a><span class="in">    # 与 run_experiments() 的抽样口径一致：每次试验一个随机种子</span></span>
<span id="cb106-2638"><a href="#cb106-2638" aria-hidden="true" tabindex="-1"></a><span class="in">    s &lt;- sample.int(1e9, 1)</span></span>
<span id="cb106-2639"><a href="#cb106-2639" aria-hidden="true" tabindex="-1"></a><span class="in">    dat &lt;- simulate_dense(n = T, d = d, cps = cps_vec,</span></span>
<span id="cb106-2640"><a href="#cb106-2640" aria-hidden="true" tabindex="-1"></a><span class="in">                          rho = rho, delta = snr, sigma = 1.0, ar_phi = phi,</span></span>
<span id="cb106-2641"><a href="#cb106-2641" aria-hidden="true" tabindex="-1"></a><span class="in">                          same_sign = TRUE, seed = s)</span></span>
<span id="cb106-2642"><a href="#cb106-2642" aria-hidden="true" tabindex="-1"></a><span class="in">    Y &lt;- dat$Y; true_cp &lt;- dat$true_cp</span></span>
<span id="cb106-2643"><a href="#cb106-2643" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb106-2644"><a href="#cb106-2644" aria-hidden="true" tabindex="-1"></a><span class="in">    ## 1) ABS：自适应选 β，并得到 cp_abs</span></span>
<span id="cb106-2645"><a href="#cb106-2645" aria-hidden="true" tabindex="-1"></a><span class="in">    t_abs &lt;- system.time({</span></span>
<span id="cb106-2646"><a href="#cb106-2646" aria-hidden="true" tabindex="-1"></a><span class="in">      abs_res &lt;- adaptive_binary_segmentation(</span></span>
<span id="cb106-2647"><a href="#cb106-2647" aria-hidden="true" tabindex="-1"></a><span class="in">        Y, beta_min = abs_beta_min, beta_max = abs_beta_max, beta_points = abs_beta_points,</span></span>
<span id="cb106-2648"><a href="#cb106-2648" aria-hidden="true" tabindex="-1"></a><span class="in">        min_size = min_size, p = p_abs, elbow_window = elbow_window, verbose = FALSE</span></span>
<span id="cb106-2649"><a href="#cb106-2649" aria-hidden="true" tabindex="-1"></a><span class="in">      )</span></span>
<span id="cb106-2650"><a href="#cb106-2650" aria-hidden="true" tabindex="-1"></a><span class="in">      idx_abs &lt;- which.min(abs(abs_res$beta_list - abs_res$best_beta))</span></span>
<span id="cb106-2651"><a href="#cb106-2651" aria-hidden="true" tabindex="-1"></a><span class="in">      cp_abs  &lt;- sort(abs_res$results[[idx_abs]])</span></span>
<span id="cb106-2652"><a href="#cb106-2652" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb106-2653"><a href="#cb106-2653" aria-hidden="true" tabindex="-1"></a><span class="in">    abs_time[r] &lt;- as.numeric(t_abs["elapsed"])</span></span>
<span id="cb106-2654"><a href="#cb106-2654" aria-hidden="true" tabindex="-1"></a><span class="in">    det_abs[r]  &lt;- length(cp_abs) &gt; 0</span></span>
<span id="cb106-2655"><a href="#cb106-2655" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb106-2656"><a href="#cb106-2656" aria-hidden="true" tabindex="-1"></a><span class="in">    ## 2) PER：仅用前 10% 维度各自自适应求 β，取中位数 β；再用该 β 在所有维度上做 BS</span></span>
<span id="cb106-2657"><a href="#cb106-2657" aria-hidden="true" tabindex="-1"></a><span class="in">    t_per &lt;- system.time({</span></span>
<span id="cb106-2658"><a href="#cb106-2658" aria-hidden="true" tabindex="-1"></a><span class="in">      m &lt;- max(1L, floor(0.2 * d))          # 前 10% 维度数（至少 1）</span></span>
<span id="cb106-2659"><a href="#cb106-2659" aria-hidden="true" tabindex="-1"></a><span class="in">      idx_probe &lt;- seq_len(m)                # 取前 m 个维度</span></span>
<span id="cb106-2660"><a href="#cb106-2660" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb106-2661"><a href="#cb106-2661" aria-hidden="true" tabindex="-1"></a><span class="in">      # 在探测维度上自适应求 β</span></span>
<span id="cb106-2662"><a href="#cb106-2662" aria-hidden="true" tabindex="-1"></a><span class="in">      probe_betas &lt;- numeric(m)</span></span>
<span id="cb106-2663"><a href="#cb106-2663" aria-hidden="true" tabindex="-1"></a><span class="in">      for (jj in seq_along(idx_probe)) {</span></span>
<span id="cb106-2664"><a href="#cb106-2664" aria-hidden="true" tabindex="-1"></a><span class="in">        j &lt;- idx_probe[jj]</span></span>
<span id="cb106-2665"><a href="#cb106-2665" aria-hidden="true" tabindex="-1"></a><span class="in">        rj &lt;- per_dim_single_adaptive(</span></span>
<span id="cb106-2666"><a href="#cb106-2666" aria-hidden="true" tabindex="-1"></a><span class="in">          Y[, j],</span></span>
<span id="cb106-2667"><a href="#cb106-2667" aria-hidden="true" tabindex="-1"></a><span class="in">          beta_min = per_beta_min, beta_max = per_beta_max, beta_points = per_beta_points,</span></span>
<span id="cb106-2668"><a href="#cb106-2668" aria-hidden="true" tabindex="-1"></a><span class="in">          min_size = min_size, p = p_per, elbow_window = elbow_window</span></span>
<span id="cb106-2669"><a href="#cb106-2669" aria-hidden="true" tabindex="-1"></a><span class="in">        )</span></span>
<span id="cb106-2670"><a href="#cb106-2670" aria-hidden="true" tabindex="-1"></a><span class="in">        probe_betas[jj] &lt;- rj$best_beta</span></span>
<span id="cb106-2671"><a href="#cb106-2671" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb106-2672"><a href="#cb106-2672" aria-hidden="true" tabindex="-1"></a><span class="in">      median_beta &lt;- median(probe_betas, na.rm = TRUE)</span></span>
<span id="cb106-2673"><a href="#cb106-2673" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb106-2674"><a href="#cb106-2674" aria-hidden="true" tabindex="-1"></a><span class="in">      # 用中位数 β 在所有维度上做固定 β 的 BS，然后合并变点</span></span>
<span id="cb106-2675"><a href="#cb106-2675" aria-hidden="true" tabindex="-1"></a><span class="in">      dim_cps &lt;- vector("list", d)</span></span>
<span id="cb106-2676"><a href="#cb106-2676" aria-hidden="true" tabindex="-1"></a><span class="in">      for (j in seq_len(d)) {</span></span>
<span id="cb106-2677"><a href="#cb106-2677" aria-hidden="true" tabindex="-1"></a><span class="in">        Yj &lt;- matrix(Y[, j], ncol = 1)</span></span>
<span id="cb106-2678"><a href="#cb106-2678" aria-hidden="true" tabindex="-1"></a><span class="in">        Yj &lt;- .ensure_cumsum(Yj)</span></span>
<span id="cb106-2679"><a href="#cb106-2679" aria-hidden="true" tabindex="-1"></a><span class="in">        th &lt;- sort(binary_segmentation(</span></span>
<span id="cb106-2680"><a href="#cb106-2680" aria-hidden="true" tabindex="-1"></a><span class="in">          Yj, beta = median_beta, t0 = 0, t1 = nrow(Yj), min_size = min_size, p = p_per</span></span>
<span id="cb106-2681"><a href="#cb106-2681" aria-hidden="true" tabindex="-1"></a><span class="in">        ))</span></span>
<span id="cb106-2682"><a href="#cb106-2682" aria-hidden="true" tabindex="-1"></a><span class="in">        dim_cps[[j]] &lt;- th</span></span>
<span id="cb106-2683"><a href="#cb106-2683" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb106-2684"><a href="#cb106-2684" aria-hidden="true" tabindex="-1"></a><span class="in">      cp_per &lt;- merge_cps(dim_cps, tol = tol_match, representative = representative)</span></span>
<span id="cb106-2685"><a href="#cb106-2685" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb106-2686"><a href="#cb106-2686" aria-hidden="true" tabindex="-1"></a><span class="in">    per_time[r] &lt;- as.numeric(t_per["elapsed"])</span></span>
<span id="cb106-2687"><a href="#cb106-2687" aria-hidden="true" tabindex="-1"></a><span class="in">    det_per[r]  &lt;- length(cp_per) &gt; 0</span></span>
<span id="cb106-2688"><a href="#cb106-2688" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb106-2689"><a href="#cb106-2689" aria-hidden="true" tabindex="-1"></a><span class="in">    ## 3) 评价指标</span></span>
<span id="cb106-2690"><a href="#cb106-2690" aria-hidden="true" tabindex="-1"></a><span class="in">    abs_f1[r]   &lt;- f1_score(true_cp, cp_abs, tol = tol_match)</span></span>
<span id="cb106-2691"><a href="#cb106-2691" aria-hidden="true" tabindex="-1"></a><span class="in">    per_f1[r]   &lt;- f1_score(true_cp, cp_per, tol = tol_match)</span></span>
<span id="cb106-2692"><a href="#cb106-2692" aria-hidden="true" tabindex="-1"></a><span class="in">    abs_haus[r] &lt;- hausdorff(true_cp, cp_abs)</span></span>
<span id="cb106-2693"><a href="#cb106-2693" aria-hidden="true" tabindex="-1"></a><span class="in">    per_haus[r] &lt;- hausdorff(true_cp, cp_per)</span></span>
<span id="cb106-2694"><a href="#cb106-2694" aria-hidden="true" tabindex="-1"></a><span class="in">    abs_rand[r] &lt;- rand_index(true_cp, cp_abs, n = T)</span></span>
<span id="cb106-2695"><a href="#cb106-2695" aria-hidden="true" tabindex="-1"></a><span class="in">    per_rand[r] &lt;- rand_index(true_cp, cp_per, n = T)</span></span>
<span id="cb106-2696"><a href="#cb106-2696" aria-hidden="true" tabindex="-1"></a><span class="in">    abs_ann[r]  &lt;- annotation_error(true_cp, cp_abs)</span></span>
<span id="cb106-2697"><a href="#cb106-2697" aria-hidden="true" tabindex="-1"></a><span class="in">    per_ann[r]  &lt;- annotation_error(true_cp, cp_per)</span></span>
<span id="cb106-2698"><a href="#cb106-2698" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb106-2699"><a href="#cb106-2699" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-2700"><a href="#cb106-2700" aria-hidden="true" tabindex="-1"></a><span class="in">  m &lt;- function(x) mean(x, na.rm = TRUE)</span></span>
<span id="cb106-2701"><a href="#cb106-2701" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-2702"><a href="#cb106-2702" aria-hidden="true" tabindex="-1"></a><span class="in">  list(</span></span>
<span id="cb106-2703"><a href="#cb106-2703" aria-hidden="true" tabindex="-1"></a><span class="in">    F1      = c(ABS = m(abs_f1),         PER = m(per_f1)),</span></span>
<span id="cb106-2704"><a href="#cb106-2704" aria-hidden="true" tabindex="-1"></a><span class="in">    Haus    = c(ABS = median(abs_haus),  PER = median(per_haus)),</span></span>
<span id="cb106-2705"><a href="#cb106-2705" aria-hidden="true" tabindex="-1"></a><span class="in">    Rand    = c(ABS = m(abs_rand),       PER = m(per_rand)),</span></span>
<span id="cb106-2706"><a href="#cb106-2706" aria-hidden="true" tabindex="-1"></a><span class="in">    Ann     = c(ABS = m(abs_ann),        PER = m(per_ann)),</span></span>
<span id="cb106-2707"><a href="#cb106-2707" aria-hidden="true" tabindex="-1"></a><span class="in">    Time    = c(ABS = m(abs_time),       PER = m(per_time)),</span></span>
<span id="cb106-2708"><a href="#cb106-2708" aria-hidden="true" tabindex="-1"></a><span class="in">    DetProb = c(ABS = mean(det_abs),     PER = mean(det_per))</span></span>
<span id="cb106-2709"><a href="#cb106-2709" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-2710"><a href="#cb106-2710" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-2711"><a href="#cb106-2711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2712"><a href="#cb106-2712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2713"><a href="#cb106-2713" aria-hidden="true" tabindex="-1"></a><span class="in"># 生成一个 (T,K,metric) 的“宽表”数据 + 3 行表头（模拟 LaTeX multicolumn/multirow）</span></span>
<span id="cb106-2714"><a href="#cb106-2714" aria-hidden="true" tabindex="-1"></a><span class="in">build_plate_table &lt;- function(metric_name, T, K) {</span></span>
<span id="cb106-2715"><a href="#cb106-2715" aria-hidden="true" tabindex="-1"></a><span class="in">  # 列顺序：每个 d 大组内按 rho；每个 rho 下 ABS / PER 两列</span></span>
<span id="cb106-2716"><a href="#cb106-2716" aria-hidden="true" tabindex="-1"></a><span class="in">  col_blocks &lt;- unlist(lapply(d_levels, function(d)</span></span>
<span id="cb106-2717"><a href="#cb106-2717" aria-hidden="true" tabindex="-1"></a><span class="in">    unlist(lapply(rho_levels, function(rho)</span></span>
<span id="cb106-2718"><a href="#cb106-2718" aria-hidden="true" tabindex="-1"></a><span class="in">      c(sprintf("d=%s | rho=%.2f | ABS", d, rho),</span></span>
<span id="cb106-2719"><a href="#cb106-2719" aria-hidden="true" tabindex="-1"></a><span class="in">        sprintf("d=%s | rho=%.2f | PER", d, rho))</span></span>
<span id="cb106-2720"><a href="#cb106-2720" aria-hidden="true" tabindex="-1"></a><span class="in">    ))</span></span>
<span id="cb106-2721"><a href="#cb106-2721" aria-hidden="true" tabindex="-1"></a><span class="in">  ))</span></span>
<span id="cb106-2722"><a href="#cb106-2722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2723"><a href="#cb106-2723" aria-hidden="true" tabindex="-1"></a><span class="in">  # 初始化为 0 行数据框，避免“替换数据里有1行，但数据有0”的报错</span></span>
<span id="cb106-2724"><a href="#cb106-2724" aria-hidden="true" tabindex="-1"></a><span class="in">  dat &lt;- data.frame(phi = numeric(0), snr = numeric(0), stringsAsFactors = FALSE)</span></span>
<span id="cb106-2725"><a href="#cb106-2725" aria-hidden="true" tabindex="-1"></a><span class="in">  for (nm in col_blocks) dat[[nm]] &lt;- numeric(0)</span></span>
<span id="cb106-2726"><a href="#cb106-2726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2727"><a href="#cb106-2727" aria-hidden="true" tabindex="-1"></a><span class="in">  # 行块：phi × snr；为模拟 multirow，每个 phi 块首行填 phi，其余行留 NA</span></span>
<span id="cb106-2728"><a href="#cb106-2728" aria-hidden="true" tabindex="-1"></a><span class="in">  for (phi in phi_levels) {</span></span>
<span id="cb106-2729"><a href="#cb106-2729" aria-hidden="true" tabindex="-1"></a><span class="in">    first_row_in_phi &lt;- TRUE</span></span>
<span id="cb106-2730"><a href="#cb106-2730" aria-hidden="true" tabindex="-1"></a><span class="in">    for (snr in snr_levels) {</span></span>
<span id="cb106-2731"><a href="#cb106-2731" aria-hidden="true" tabindex="-1"></a><span class="in">      row_list &lt;- list(phi = if (first_row_in_phi) phi else NA, snr = snr)</span></span>
<span id="cb106-2732"><a href="#cb106-2732" aria-hidden="true" tabindex="-1"></a><span class="in">      for (d in d_levels) {</span></span>
<span id="cb106-2733"><a href="#cb106-2733" aria-hidden="true" tabindex="-1"></a><span class="in">        for (rho in rho_levels) {</span></span>
<span id="cb106-2734"><a href="#cb106-2734" aria-hidden="true" tabindex="-1"></a><span class="in">          cat(sprintf("  · 运行: T=%d, K=%d, metric=%s | d=%d, rho=%.2f, snr=%.2f, phi=%.2f, R=%d\n",</span></span>
<span id="cb106-2735"><a href="#cb106-2735" aria-hidden="true" tabindex="-1"></a><span class="in">                      T, K, metric_name, d, rho, snr, phi, R_trials))</span></span>
<span id="cb106-2736"><a href="#cb106-2736" aria-hidden="true" tabindex="-1"></a><span class="in">          cond_res &lt;- run_condition(T=T, d=d, rho=rho, snr=snr, phi=phi, K=K)</span></span>
<span id="cb106-2737"><a href="#cb106-2737" aria-hidden="true" tabindex="-1"></a><span class="in">          vals &lt;- cond_res[[metric_name]]</span></span>
<span id="cb106-2738"><a href="#cb106-2738" aria-hidden="true" tabindex="-1"></a><span class="in">          row_list[[sprintf("d=%s | rho=%.2f | ABS", d, rho)]] &lt;- vals["ABS"]</span></span>
<span id="cb106-2739"><a href="#cb106-2739" aria-hidden="true" tabindex="-1"></a><span class="in">          row_list[[sprintf("d=%s | rho=%.2f | PER", d, rho)]] &lt;- vals["PER"]</span></span>
<span id="cb106-2740"><a href="#cb106-2740" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb106-2741"><a href="#cb106-2741" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb106-2742"><a href="#cb106-2742" aria-hidden="true" tabindex="-1"></a><span class="in">      dat &lt;- rbind(dat, as.data.frame(row_list, check.names = FALSE, stringsAsFactors = FALSE))</span></span>
<span id="cb106-2743"><a href="#cb106-2743" aria-hidden="true" tabindex="-1"></a><span class="in">      first_row_in_phi &lt;- FALSE</span></span>
<span id="cb106-2744"><a href="#cb106-2744" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb106-2745"><a href="#cb106-2745" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb106-2746"><a href="#cb106-2746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2747"><a href="#cb106-2747" aria-hidden="true" tabindex="-1"></a><span class="in">  # 三行“分组表头”（用于 CSV 视觉上接近 LaTeX 的 multicolumn）</span></span>
<span id="cb106-2748"><a href="#cb106-2748" aria-hidden="true" tabindex="-1"></a><span class="in">  head1 &lt;- c(</span></span>
<span id="cb106-2749"><a href="#cb106-2749" aria-hidden="true" tabindex="-1"></a><span class="in">    sprintf("T=%d, K=%d", T, K), "",  # 对齐“phi, snr”两列</span></span>
<span id="cb106-2750"><a href="#cb106-2750" aria-hidden="true" tabindex="-1"></a><span class="in">    unlist(lapply(d_levels, function(d)</span></span>
<span id="cb106-2751"><a href="#cb106-2751" aria-hidden="true" tabindex="-1"></a><span class="in">      c(sprintf("d=%d", d), rep("", length(rho_levels)*2 - 1))</span></span>
<span id="cb106-2752"><a href="#cb106-2752" aria-hidden="true" tabindex="-1"></a><span class="in">    ))</span></span>
<span id="cb106-2753"><a href="#cb106-2753" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-2754"><a href="#cb106-2754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2755"><a href="#cb106-2755" aria-hidden="true" tabindex="-1"></a><span class="in">  head2 &lt;- c(</span></span>
<span id="cb106-2756"><a href="#cb106-2756" aria-hidden="true" tabindex="-1"></a><span class="in">    "", "",</span></span>
<span id="cb106-2757"><a href="#cb106-2757" aria-hidden="true" tabindex="-1"></a><span class="in">    unlist(lapply(d_levels, function(d)</span></span>
<span id="cb106-2758"><a href="#cb106-2758" aria-hidden="true" tabindex="-1"></a><span class="in">      unlist(lapply(rho_levels, function(rho) c(sprintf("ρ=%.2f", rho), "")))</span></span>
<span id="cb106-2759"><a href="#cb106-2759" aria-hidden="true" tabindex="-1"></a><span class="in">    ))</span></span>
<span id="cb106-2760"><a href="#cb106-2760" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-2761"><a href="#cb106-2761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2762"><a href="#cb106-2762" aria-hidden="true" tabindex="-1"></a><span class="in">  head3 &lt;- c("φ", "snr",</span></span>
<span id="cb106-2763"><a href="#cb106-2763" aria-hidden="true" tabindex="-1"></a><span class="in">             unlist(lapply(d_levels, function(d)</span></span>
<span id="cb106-2764"><a href="#cb106-2764" aria-hidden="true" tabindex="-1"></a><span class="in">               unlist(lapply(rho_levels, function(rho) c("ABS", "PER")))</span></span>
<span id="cb106-2765"><a href="#cb106-2765" aria-hidden="true" tabindex="-1"></a><span class="in">             )))</span></span>
<span id="cb106-2766"><a href="#cb106-2766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2767"><a href="#cb106-2767" aria-hidden="true" tabindex="-1"></a><span class="in">  list(data = dat, header1 = head1, header2 = head2, header3 = head3)</span></span>
<span id="cb106-2768"><a href="#cb106-2768" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-2769"><a href="#cb106-2769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2770"><a href="#cb106-2770" aria-hidden="true" tabindex="-1"></a><span class="in"># 以 UTF-8 + BOM 写 CSV，确保 Excel 正确识别</span></span>
<span id="cb106-2771"><a href="#cb106-2771" aria-hidden="true" tabindex="-1"></a><span class="in">write_plate_csv &lt;- function(table_obj, metric_name, T, K, dir_out = "tables") {</span></span>
<span id="cb106-2772"><a href="#cb106-2772" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!dir.exists(dir_out)) dir.create(dir_out, recursive = TRUE)</span></span>
<span id="cb106-2773"><a href="#cb106-2773" aria-hidden="true" tabindex="-1"></a><span class="in">  fn &lt;- sprintf("%s/plate_%s_T%d_K%d.csv", dir_out, metric_name, T, K)</span></span>
<span id="cb106-2774"><a href="#cb106-2774" aria-hidden="true" tabindex="-1"></a><span class="in">  cat(sprintf("&gt;&gt; 写出表格：%s\n", fn))</span></span>
<span id="cb106-2775"><a href="#cb106-2775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2776"><a href="#cb106-2776" aria-hidden="true" tabindex="-1"></a><span class="in">  # 1) 写到 UTF-8（无 BOM）的临时文件</span></span>
<span id="cb106-2777"><a href="#cb106-2777" aria-hidden="true" tabindex="-1"></a><span class="in">  tmp &lt;- tempfile(fileext = ".csv")</span></span>
<span id="cb106-2778"><a href="#cb106-2778" aria-hidden="true" tabindex="-1"></a><span class="in">  con &lt;- file(tmp, open = "wt", encoding = "UTF-8")</span></span>
<span id="cb106-2779"><a href="#cb106-2779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2780"><a href="#cb106-2780" aria-hidden="true" tabindex="-1"></a><span class="in">  write.table(t(table_obj$header1), file = con, sep = ",",</span></span>
<span id="cb106-2781"><a href="#cb106-2781" aria-hidden="true" tabindex="-1"></a><span class="in">              col.names = FALSE, row.names = FALSE, qmethod = "double")</span></span>
<span id="cb106-2782"><a href="#cb106-2782" aria-hidden="true" tabindex="-1"></a><span class="in">  write.table(t(table_obj$header2), file = con, sep = ",",</span></span>
<span id="cb106-2783"><a href="#cb106-2783" aria-hidden="true" tabindex="-1"></a><span class="in">              col.names = FALSE, row.names = FALSE, qmethod = "double", append = TRUE)</span></span>
<span id="cb106-2784"><a href="#cb106-2784" aria-hidden="true" tabindex="-1"></a><span class="in">  write.table(t(table_obj$header3), file = con, sep = ",",</span></span>
<span id="cb106-2785"><a href="#cb106-2785" aria-hidden="true" tabindex="-1"></a><span class="in">              col.names = FALSE, row.names = FALSE, qmethod = "double", append = TRUE)</span></span>
<span id="cb106-2786"><a href="#cb106-2786" aria-hidden="true" tabindex="-1"></a><span class="in">  write.table(table_obj$data,      file = con, sep = ",",</span></span>
<span id="cb106-2787"><a href="#cb106-2787" aria-hidden="true" tabindex="-1"></a><span class="in">              col.names = FALSE, row.names = FALSE, qmethod = "double", append = TRUE)</span></span>
<span id="cb106-2788"><a href="#cb106-2788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2789"><a href="#cb106-2789" aria-hidden="true" tabindex="-1"></a><span class="in">  flush(con)</span></span>
<span id="cb106-2790"><a href="#cb106-2790" aria-hidden="true" tabindex="-1"></a><span class="in">  close(con)   # 只关闭一次</span></span>
<span id="cb106-2791"><a href="#cb106-2791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2792"><a href="#cb106-2792" aria-hidden="true" tabindex="-1"></a><span class="in">  # 2) 目标文件先写入 BOM，再把临时文件二进制内容追加进去</span></span>
<span id="cb106-2793"><a href="#cb106-2793" aria-hidden="true" tabindex="-1"></a><span class="in">  out &lt;- file(fn, open = "wb")</span></span>
<span id="cb106-2794"><a href="#cb106-2794" aria-hidden="true" tabindex="-1"></a><span class="in">  writeBin(as.raw(c(0xEF, 0xBB, 0xBF)), out)   # UTF-8 BOM</span></span>
<span id="cb106-2795"><a href="#cb106-2795" aria-hidden="true" tabindex="-1"></a><span class="in">  close(out)</span></span>
<span id="cb106-2796"><a href="#cb106-2796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2797"><a href="#cb106-2797" aria-hidden="true" tabindex="-1"></a><span class="in">  rawtxt &lt;- readBin(tmp, what = "raw", n = file.info(tmp)$size)</span></span>
<span id="cb106-2798"><a href="#cb106-2798" aria-hidden="true" tabindex="-1"></a><span class="in">  out2 &lt;- file(fn, open = "ab")</span></span>
<span id="cb106-2799"><a href="#cb106-2799" aria-hidden="true" tabindex="-1"></a><span class="in">  writeBin(rawtxt, out2)</span></span>
<span id="cb106-2800"><a href="#cb106-2800" aria-hidden="true" tabindex="-1"></a><span class="in">  close(out2)</span></span>
<span id="cb106-2801"><a href="#cb106-2801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2802"><a href="#cb106-2802" aria-hidden="true" tabindex="-1"></a><span class="in">  unlink(tmp)</span></span>
<span id="cb106-2803"><a href="#cb106-2803" aria-hidden="true" tabindex="-1"></a><span class="in">  invisible(fn)</span></span>
<span id="cb106-2804"><a href="#cb106-2804" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-2805"><a href="#cb106-2805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2806"><a href="#cb106-2806" aria-hidden="true" tabindex="-1"></a><span class="in">## ===== 主控：遍历 (K, T, metric) 导出 =====</span></span>
<span id="cb106-2807"><a href="#cb106-2807" aria-hidden="true" tabindex="-1"></a><span class="in">run_all_plate &lt;- function() {</span></span>
<span id="cb106-2808"><a href="#cb106-2808" aria-hidden="true" tabindex="-1"></a><span class="in">  t0 &lt;- Sys.time()</span></span>
<span id="cb106-2809"><a href="#cb106-2809" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("=========== 表格导出开始 ===========\n")</span></span>
<span id="cb106-2810"><a href="#cb106-2810" aria-hidden="true" tabindex="-1"></a><span class="in">  cat(sprintf("Grid: T=%s | K=%s | d=%s | rho=%s | snr=%s | phi=%s | R=%d\n",</span></span>
<span id="cb106-2811"><a href="#cb106-2811" aria-hidden="true" tabindex="-1"></a><span class="in">              paste(n_levels, collapse=","), paste(K_levels, collapse=","),</span></span>
<span id="cb106-2812"><a href="#cb106-2812" aria-hidden="true" tabindex="-1"></a><span class="in">              paste(d_levels, collapse=","), paste(rho_levels, collapse=","),</span></span>
<span id="cb106-2813"><a href="#cb106-2813" aria-hidden="true" tabindex="-1"></a><span class="in">              paste(snr_levels, collapse=","), paste(phi_levels, collapse=","),</span></span>
<span id="cb106-2814"><a href="#cb106-2814" aria-hidden="true" tabindex="-1"></a><span class="in">              R_trials))</span></span>
<span id="cb106-2815"><a href="#cb106-2815" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("--------------------------------------\n")</span></span>
<span id="cb106-2816"><a href="#cb106-2816" aria-hidden="true" tabindex="-1"></a><span class="in">  for (K in K_levels) {</span></span>
<span id="cb106-2817"><a href="#cb106-2817" aria-hidden="true" tabindex="-1"></a><span class="in">    for (T in n_levels) {</span></span>
<span id="cb106-2818"><a href="#cb106-2818" aria-hidden="true" tabindex="-1"></a><span class="in">      for (metric in metrics_to_show) {</span></span>
<span id="cb106-2819"><a href="#cb106-2819" aria-hidden="true" tabindex="-1"></a><span class="in">        cat(sprintf("[生成] T=%d, K=%d, metric=%s\n", T, K, metric))</span></span>
<span id="cb106-2820"><a href="#cb106-2820" aria-hidden="true" tabindex="-1"></a><span class="in">        t1 &lt;- Sys.time()</span></span>
<span id="cb106-2821"><a href="#cb106-2821" aria-hidden="true" tabindex="-1"></a><span class="in">        tab &lt;- build_plate_table(metric, T, K)</span></span>
<span id="cb106-2822"><a href="#cb106-2822" aria-hidden="true" tabindex="-1"></a><span class="in">        write_plate_csv(tab, metric, T, K, dir_out = "tables")</span></span>
<span id="cb106-2823"><a href="#cb106-2823" aria-hidden="true" tabindex="-1"></a><span class="in">        t2 &lt;- Sys.time()</span></span>
<span id="cb106-2824"><a href="#cb106-2824" aria-hidden="true" tabindex="-1"></a><span class="in">        cat(sprintf("-&gt; 完成：%s，用时 %.2fs\n", metric, as.numeric(difftime(t2, t1, units="secs"))))</span></span>
<span id="cb106-2825"><a href="#cb106-2825" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb106-2826"><a href="#cb106-2826" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb106-2827"><a href="#cb106-2827" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb106-2828"><a href="#cb106-2828" aria-hidden="true" tabindex="-1"></a><span class="in">  t3 &lt;- Sys.time()</span></span>
<span id="cb106-2829"><a href="#cb106-2829" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("--------------------------------------\n")</span></span>
<span id="cb106-2830"><a href="#cb106-2830" aria-hidden="true" tabindex="-1"></a><span class="in">  cat(sprintf("=========== 全部完成，用时 %.2fs ==========\n", as.numeric(difftime(t3, t0, units="secs"))))</span></span>
<span id="cb106-2831"><a href="#cb106-2831" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-2832"><a href="#cb106-2832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2833"><a href="#cb106-2833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2834"><a href="#cb106-2834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2835"><a href="#cb106-2835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2836"><a href="#cb106-2836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2837"><a href="#cb106-2837" aria-hidden="true" tabindex="-1"></a>调参注意：</span>
<span id="cb106-2838"><a href="#cb106-2838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2839"><a href="#cb106-2839" aria-hidden="true" tabindex="-1"></a>K越多，min_size设置越小</span>
<span id="cb106-2840"><a href="#cb106-2840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2841"><a href="#cb106-2841" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-2842"><a href="#cb106-2842" aria-hidden="true" tabindex="-1"></a><span class="in">n_levels    &lt;- c(200)       # T</span></span>
<span id="cb106-2843"><a href="#cb106-2843" aria-hidden="true" tabindex="-1"></a><span class="in">d_levels    &lt;- c(10)        # 列大分组</span></span>
<span id="cb106-2844"><a href="#cb106-2844" aria-hidden="true" tabindex="-1"></a><span class="in">rho_levels  &lt;- c(0.5)      # 列中分组</span></span>
<span id="cb106-2845"><a href="#cb106-2845" aria-hidden="true" tabindex="-1"></a><span class="in">snr_levels  &lt;- c(1)       # 行内第二列（Δ/σ；这里 σ=1 ⇒ Δ=SNR）</span></span>
<span id="cb106-2846"><a href="#cb106-2846" aria-hidden="true" tabindex="-1"></a><span class="in">phi_levels  &lt;- c(0)         # 行大分组</span></span>
<span id="cb106-2847"><a href="#cb106-2847" aria-hidden="true" tabindex="-1"></a><span class="in">K_levels    &lt;- c(10) </span></span>
<span id="cb106-2848"><a href="#cb106-2848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2849"><a href="#cb106-2849" aria-hidden="true" tabindex="-1"></a><span class="in">#metrics_to_show    &lt;- c("F1","Haus","Rand","Ann","Time","DetProb")</span></span>
<span id="cb106-2850"><a href="#cb106-2850" aria-hidden="true" tabindex="-1"></a><span class="in">metrics_to_show    &lt;- c("F1","Haus")</span></span>
<span id="cb106-2851"><a href="#cb106-2851" aria-hidden="true" tabindex="-1"></a><span class="in">R_trials    &lt;- 10</span></span>
<span id="cb106-2852"><a href="#cb106-2852" aria-hidden="true" tabindex="-1"></a><span class="in">seed0       &lt;- 264783846</span></span>
<span id="cb106-2853"><a href="#cb106-2853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2854"><a href="#cb106-2854" aria-hidden="true" tabindex="-1"></a><span class="in">## ===== 与 run_experiments() 对齐的口径 =====</span></span>
<span id="cb106-2855"><a href="#cb106-2855" aria-hidden="true" tabindex="-1"></a><span class="in">min_size     &lt;- 3</span></span>
<span id="cb106-2856"><a href="#cb106-2856" aria-hidden="true" tabindex="-1"></a><span class="in">tol_match    &lt;- 3L</span></span>
<span id="cb106-2857"><a href="#cb106-2857" aria-hidden="true" tabindex="-1"></a><span class="in">abs_beta_min &lt;- 3;  abs_beta_max &lt;- 30; abs_beta_points &lt;- 70; p_abs &lt;- 2</span></span>
<span id="cb106-2858"><a href="#cb106-2858" aria-hidden="true" tabindex="-1"></a><span class="in">per_beta_min &lt;- 3;  per_beta_max &lt;- 30; per_beta_points &lt;- 70; p_per &lt;- 2</span></span>
<span id="cb106-2859"><a href="#cb106-2859" aria-hidden="true" tabindex="-1"></a><span class="in">elbow_window &lt;- 10</span></span>
<span id="cb106-2860"><a href="#cb106-2860" aria-hidden="true" tabindex="-1"></a><span class="in">representative &lt;- "mean"</span></span>
<span id="cb106-2861"><a href="#cb106-2861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2862"><a href="#cb106-2862" aria-hidden="true" tabindex="-1"></a><span class="in">## ===== 执行 =====</span></span>
<span id="cb106-2863"><a href="#cb106-2863" aria-hidden="true" tabindex="-1"></a><span class="in">run_all_plate()</span></span>
<span id="cb106-2864"><a href="#cb106-2864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2865"><a href="#cb106-2865" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2866"><a href="#cb106-2866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2867"><a href="#cb106-2867" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>当d和b都很小时（d=10，b=0.5信噪比），结果和逐维法都不是很好，但是随着d或b的增加，结果明显优于逐维法(密集模式导致)</span>
<span id="cb106-2868"><a href="#cb106-2868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2869"><a href="#cb106-2869" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>d和b相同时，rho越大越好（明显好于逐维法）</span>
<span id="cb106-2870"><a href="#cb106-2870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2871"><a href="#cb106-2871" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>d和b，rho对结果影响大</span>
<span id="cb106-2872"><a href="#cb106-2872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2873"><a href="#cb106-2873" aria-hidden="true" tabindex="-1"></a>F1:</span>
<span id="cb106-2874"><a href="#cb106-2874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2877"><a href="#cb106-2877" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-2878"><a href="#cb106-2878" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载 DT 包</span></span>
<span id="cb106-2879"><a href="#cb106-2879" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb106-2880"><a href="#cb106-2880" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb106-2881"><a href="#cb106-2881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2882"><a href="#cb106-2882" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">3</span>)  <span class="co"># 全局设置，小数点保留 3 位</span></span>
<span id="cb106-2883"><a href="#cb106-2883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2884"><a href="#cb106-2884" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb106-2885"><a href="#cb106-2885" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/F1"</span></span>
<span id="cb106-2886"><a href="#cb106-2886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2887"><a href="#cb106-2887" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb106-2888"><a href="#cb106-2888" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-2889"><a href="#cb106-2889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2890"><a href="#cb106-2890" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb106-2891"><a href="#cb106-2891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-2892"><a href="#cb106-2892" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2893"><a href="#cb106-2893" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb106-2894"><a href="#cb106-2894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2895"><a href="#cb106-2895" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb106-2896"><a href="#cb106-2896" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb106-2897"><a href="#cb106-2897" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-2898"><a href="#cb106-2898" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-2899"><a href="#cb106-2899" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2900"><a href="#cb106-2900" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb106-2901"><a href="#cb106-2901" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2902"><a href="#cb106-2902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2903"><a href="#cb106-2903" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2904"><a href="#cb106-2904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2905"><a href="#cb106-2905" aria-hidden="true" tabindex="-1"></a>Ann:</span>
<span id="cb106-2906"><a href="#cb106-2906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2909"><a href="#cb106-2909" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-2910"><a href="#cb106-2910" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb106-2911"><a href="#cb106-2911" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Ann"</span></span>
<span id="cb106-2912"><a href="#cb106-2912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2913"><a href="#cb106-2913" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb106-2914"><a href="#cb106-2914" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-2915"><a href="#cb106-2915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2916"><a href="#cb106-2916" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb106-2917"><a href="#cb106-2917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-2918"><a href="#cb106-2918" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2919"><a href="#cb106-2919" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb106-2920"><a href="#cb106-2920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2921"><a href="#cb106-2921" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb106-2922"><a href="#cb106-2922" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb106-2923"><a href="#cb106-2923" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-2924"><a href="#cb106-2924" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-2925"><a href="#cb106-2925" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2926"><a href="#cb106-2926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb106-2927"><a href="#cb106-2927" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2928"><a href="#cb106-2928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2929"><a href="#cb106-2929" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2930"><a href="#cb106-2930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2931"><a href="#cb106-2931" aria-hidden="true" tabindex="-1"></a>Haus:</span>
<span id="cb106-2932"><a href="#cb106-2932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2935"><a href="#cb106-2935" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-2936"><a href="#cb106-2936" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb106-2937"><a href="#cb106-2937" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Haus"</span></span>
<span id="cb106-2938"><a href="#cb106-2938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2939"><a href="#cb106-2939" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb106-2940"><a href="#cb106-2940" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-2941"><a href="#cb106-2941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2942"><a href="#cb106-2942" aria-hidden="true" tabindex="-1"></a><span class="co"># 遍历读取并展示</span></span>
<span id="cb106-2943"><a href="#cb106-2943" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb106-2944"><a href="#cb106-2944" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-2945"><a href="#cb106-2945" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2946"><a href="#cb106-2946" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb106-2947"><a href="#cb106-2947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2948"><a href="#cb106-2948" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb106-2949"><a href="#cb106-2949" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb106-2950"><a href="#cb106-2950" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-2951"><a href="#cb106-2951" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-2952"><a href="#cb106-2952" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2953"><a href="#cb106-2953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb106-2954"><a href="#cb106-2954" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2955"><a href="#cb106-2955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2956"><a href="#cb106-2956" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2957"><a href="#cb106-2957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2958"><a href="#cb106-2958" aria-hidden="true" tabindex="-1"></a>Rand:</span>
<span id="cb106-2959"><a href="#cb106-2959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2962"><a href="#cb106-2962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-2963"><a href="#cb106-2963" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置目录路径</span></span>
<span id="cb106-2964"><a href="#cb106-2964" aria-hidden="true" tabindex="-1"></a>folder_path <span class="ot">&lt;-</span> <span class="st">"C:/Users/86133/Desktop/software/changepoint/tables/tab/T200/Rand"</span></span>
<span id="cb106-2965"><a href="#cb106-2965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2966"><a href="#cb106-2966" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取目录下所有 csv 文件</span></span>
<span id="cb106-2967"><a href="#cb106-2967" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> folder_path, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-2968"><a href="#cb106-2968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2969"><a href="#cb106-2969" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> csv_files) {</span>
<span id="cb106-2970"><a href="#cb106-2970" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"正在读取文件:"</span>, file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-2971"><a href="#cb106-2971" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2972"><a href="#cb106-2972" aria-hidden="true" tabindex="-1"></a>  data[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(data, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">round</span>(x, <span class="dv">2</span>) <span class="cf">else</span> x)</span>
<span id="cb106-2973"><a href="#cb106-2973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2974"><a href="#cb106-2974" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb106-2975"><a href="#cb106-2975" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb106-2976"><a href="#cb106-2976" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-2977"><a href="#cb106-2977" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb106-2978"><a href="#cb106-2978" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-2979"><a href="#cb106-2979" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dt)   <span class="co"># ← 关键：在循环里必须 print</span></span>
<span id="cb106-2980"><a href="#cb106-2980" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-2981"><a href="#cb106-2981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2982"><a href="#cb106-2982" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2983"><a href="#cb106-2983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2984"><a href="#cb106-2984" aria-hidden="true" tabindex="-1"></a><span class="fu"># 各维度时间抖动</span></span>
<span id="cb106-2985"><a href="#cb106-2985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2986"><a href="#cb106-2986" aria-hidden="true" tabindex="-1"></a>多维/高维时间序列：</span>
<span id="cb106-2987"><a href="#cb106-2987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2988"><a href="#cb106-2988" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2989"><a href="#cb106-2989" aria-hidden="true" tabindex="-1"></a>Y_t \in \mathbb{R}^d, \quad t = 1, \ldots, T.</span>
<span id="cb106-2990"><a href="#cb106-2990" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2991"><a href="#cb106-2991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2992"><a href="#cb106-2992" aria-hidden="true" tabindex="-1"></a>令</span>
<span id="cb106-2993"><a href="#cb106-2993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2994"><a href="#cb106-2994" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2995"><a href="#cb106-2995" aria-hidden="true" tabindex="-1"></a>Y_t = \mu_t + \varepsilon_t,</span>
<span id="cb106-2996"><a href="#cb106-2996" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2997"><a href="#cb106-2997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2998"><a href="#cb106-2998" aria-hidden="true" tabindex="-1"></a>其中 $\mu_t$ 为分段常数，$\varepsilon_t$ 为噪声（可带 AR(1) 相关）</span>
<span id="cb106-2999"><a href="#cb106-2999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3000"><a href="#cb106-3000" aria-hidden="true" tabindex="-1"></a>**基线变点（用于标注/评估）**</span>
<span id="cb106-3001"><a href="#cb106-3001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3002"><a href="#cb106-3002" aria-hidden="true" tabindex="-1"></a>给定基线真变点个数 $K$ 与其位置</span>
<span id="cb106-3003"><a href="#cb106-3003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3004"><a href="#cb106-3004" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3005"><a href="#cb106-3005" aria-hidden="true" tabindex="-1"></a>C = <span class="sc">\{</span>c_1, \ldots, c_K<span class="sc">\}</span> \subset <span class="sc">\{</span>1, \ldots, T-1<span class="sc">\}</span>, </span>
<span id="cb106-3006"><a href="#cb106-3006" aria-hidden="true" tabindex="-1"></a>\quad 1 &lt; c_1 &lt; \cdots &lt; c_K &lt; T.</span>
<span id="cb106-3007"><a href="#cb106-3007" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3008"><a href="#cb106-3008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3009"><a href="#cb106-3009" aria-hidden="true" tabindex="-1"></a>**受影响维度**</span>
<span id="cb106-3010"><a href="#cb106-3010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3011"><a href="#cb106-3011" aria-hidden="true" tabindex="-1"></a>每个变点 $c_k$ 影响一部分维度 $S_k \subset <span class="sc">\{</span>1, \ldots, d<span class="sc">\}</span>$，满足</span>
<span id="cb106-3012"><a href="#cb106-3012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3013"><a href="#cb106-3013" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3014"><a href="#cb106-3014" aria-hidden="true" tabindex="-1"></a>\mathbb{E}<span class="co">[</span><span class="ot">|S_k|</span><span class="co">]</span> = \rho d, \qquad 0 &lt; \rho \leq 1.</span>
<span id="cb106-3015"><a href="#cb106-3015" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3016"><a href="#cb106-3016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3017"><a href="#cb106-3017" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**“共享子集”设定**：$S_k \equiv S$ 对所有 $k$ 相同；\</span>
<span id="cb106-3018"><a href="#cb106-3018" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**“独立子集”设定**：各 $k$ 独立抽样</span>
<span id="cb106-3019"><a href="#cb106-3019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3020"><a href="#cb106-3020" aria-hidden="true" tabindex="-1"></a>令每维的跃迁符号 $s_j \in <span class="sc">\{</span>+1, -1<span class="sc">\}</span>$；同号场景取 $s_j \equiv +1$。</span>
<span id="cb106-3021"><a href="#cb106-3021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3022"><a href="#cb106-3022" aria-hidden="true" tabindex="-1"></a>**先后错位（时间抖动）**</span>
<span id="cb106-3023"><a href="#cb106-3023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3024"><a href="#cb106-3024" aria-hidden="true" tabindex="-1"></a>受影响的维度 $j \in S_k$ 在第 $k$ 个基线变点附近各自发生实际变点：</span>
<span id="cb106-3025"><a href="#cb106-3025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3026"><a href="#cb106-3026" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3027"><a href="#cb106-3027" aria-hidden="true" tabindex="-1"></a>c_k^{(j)} = c_k + \delta_k^{(j)}, \qquad </span>
<span id="cb106-3028"><a href="#cb106-3028" aria-hidden="true" tabindex="-1"></a>\delta_k^{(j)} \sim \text{对称零均值分布 } (\text{如 } \mathcal{N}(0, \sigma_{\text{jit}}^2)),</span>
<span id="cb106-3029"><a href="#cb106-3029" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3030"><a href="#cb106-3030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3031"><a href="#cb106-3031" aria-hidden="true" tabindex="-1"></a>并裁剪到区间 $1, \ldots, T-1$ 内。</span>
<span id="cb106-3032"><a href="#cb106-3032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3033"><a href="#cb106-3033" aria-hidden="true" tabindex="-1"></a>其中 $\sigma_{\text{jit}}$ 是**抖动强度**</span>
<span id="cb106-3034"><a href="#cb106-3034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3035"><a href="#cb106-3035" aria-hidden="true" tabindex="-1"></a>**噪声模型**</span>
<span id="cb106-3036"><a href="#cb106-3036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3037"><a href="#cb106-3037" aria-hidden="true" tabindex="-1"></a>设各维度噪声满足</span>
<span id="cb106-3038"><a href="#cb106-3038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3039"><a href="#cb106-3039" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3040"><a href="#cb106-3040" aria-hidden="true" tabindex="-1"></a>\varepsilon_t^{(j)} = \phi \, \varepsilon_{t-1}^{(j)} + \eta_t^{(j)}, </span>
<span id="cb106-3041"><a href="#cb106-3041" aria-hidden="true" tabindex="-1"></a>\qquad </span>
<span id="cb106-3042"><a href="#cb106-3042" aria-hidden="true" tabindex="-1"></a>\eta_t^{(j)} \overset{i.i.d.}{\sim} \mathcal{N}(0,\sigma_\eta^2),</span>
<span id="cb106-3043"><a href="#cb106-3043" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3044"><a href="#cb106-3044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3045"><a href="#cb106-3045" aria-hidden="true" tabindex="-1"></a>其中</span>
<span id="cb106-3046"><a href="#cb106-3046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3047"><a href="#cb106-3047" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3048"><a href="#cb106-3048" aria-hidden="true" tabindex="-1"></a>\sigma_\eta^2 = \sigma^2(1-\phi^2).</span>
<span id="cb106-3049"><a href="#cb106-3049" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3050"><a href="#cb106-3050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3051"><a href="#cb106-3051" aria-hidden="true" tabindex="-1"></a>当 $\phi = 0$ 时，退化为独立同分布噪声：</span>
<span id="cb106-3052"><a href="#cb106-3052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3053"><a href="#cb106-3053" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3054"><a href="#cb106-3054" aria-hidden="true" tabindex="-1"></a>\varepsilon_t^{(j)} \sim \mathcal{N}(0,\sigma^2).</span>
<span id="cb106-3055"><a href="#cb106-3055" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3056"><a href="#cb106-3056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3057"><a href="#cb106-3057" aria-hidden="true" tabindex="-1"></a><span class="fu">## 跑评价</span></span>
<span id="cb106-3058"><a href="#cb106-3058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3059"><a href="#cb106-3059" aria-hidden="true" tabindex="-1"></a>**记号（单个基线变点** $k$**）**</span>
<span id="cb106-3060"><a href="#cb106-3060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3061"><a href="#cb106-3061" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**基线真变点**：$c_k$</span>
<span id="cb106-3062"><a href="#cb106-3062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3063"><a href="#cb106-3063" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**受影响的维度集合**：$S_k \subset <span class="sc">\{</span>1,\dots,d<span class="sc">\}</span>$</span>
<span id="cb106-3064"><a href="#cb106-3064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3065"><a href="#cb106-3065" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**每个受影响维度的实际发生时刻（有先有后）**：</span>
<span id="cb106-3066"><a href="#cb106-3066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3067"><a href="#cb106-3067" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb106-3068"><a href="#cb106-3068" aria-hidden="true" tabindex="-1"></a>    v_{j,k} \equiv c_k^{(j)},\quad j\in S_k</span>
<span id="cb106-3069"><a href="#cb106-3069" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb106-3070"><a href="#cb106-3070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3071"><a href="#cb106-3071" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**ABS 对该组错位变点的估计切点**：$\hat c_k$\</span>
<span id="cb106-3072"><a href="#cb106-3072" aria-hidden="true" tabindex="-1"></a>    （若检测出的断点数与 $K$ 不一致，先做次序保持的最近匹配，把第 $k$ 个检测点对齐到这组）</span>
<span id="cb106-3073"><a href="#cb106-3073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3074"><a href="#cb106-3074" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb106-3075"><a href="#cb106-3075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3076"><a href="#cb106-3076" aria-hidden="true" tabindex="-1"></a>ABS 在多维“先后错位”场景下，能否把一团分散的单维变点拉到同一中心？</span>
<span id="cb106-3077"><a href="#cb106-3077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3078"><a href="#cb106-3078" aria-hidden="true" tabindex="-1"></a>**1. 拉拢率 Pull-in rate（“小半径内收拢了多少”）**</span>
<span id="cb106-3079"><a href="#cb106-3079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3080"><a href="#cb106-3080" aria-hidden="true" tabindex="-1"></a>**定义（给定容差** $\tau$）：</span>
<span id="cb106-3081"><a href="#cb106-3081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3082"><a href="#cb106-3082" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3083"><a href="#cb106-3083" aria-hidden="true" tabindex="-1"></a>P_k(\tau)=\frac{1}{|S_k|}\sum_{j\in S_k}\mathbf{1}\left<span class="sc">\{</span>|v_{j,k}-\hat c_k|\le \tau\right<span class="sc">\}</span>.</span>
<span id="cb106-3084"><a href="#cb106-3084" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3085"><a href="#cb106-3085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3086"><a href="#cb106-3086" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>看 **ABS 的红线** 能在 **±**$\tau$ 的小窗口里覆盖到多少比例的**单维实际时刻**\</span>
<span id="cb106-3087"><a href="#cb106-3087" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**取值范围**：$<span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$，越大越好\</span>
<span id="cb106-3088"><a href="#cb106-3088" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**聚合**：$\overline{P(\tau)}=\frac{1}{K}\sum_k P_k(\tau)$；或对多次取平均</span>
<span id="cb106-3089"><a href="#cb106-3089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3090"><a href="#cb106-3090" aria-hidden="true" tabindex="-1"></a>**2.中心误差 Center error（“红线离‘云’中心多远”）**</span>
<span id="cb106-3091"><a href="#cb106-3091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3092"><a href="#cb106-3092" aria-hidden="true" tabindex="-1"></a>用**稳健的中心**：</span>
<span id="cb106-3093"><a href="#cb106-3093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3094"><a href="#cb106-3094" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3095"><a href="#cb106-3095" aria-hidden="true" tabindex="-1"></a>m_k=\operatorname{median}<span class="sc">\{</span>v_{j,k}:j\in S_k<span class="sc">\}</span>,\qquad</span>
<span id="cb106-3096"><a href="#cb106-3096" aria-hidden="true" tabindex="-1"></a>E_k=|\hat c_k-m_k|.</span>
<span id="cb106-3097"><a href="#cb106-3097" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3098"><a href="#cb106-3098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3099"><a href="#cb106-3099" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**直觉**：红线是否贴近“错位云”的中位中心\</span>
<span id="cb106-3100"><a href="#cb106-3100" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**聚合**：$\operatorname{median}_k E_k$ 或平均\</span>
<span id="cb106-3101"><a href="#cb106-3101" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**取值**：越小越好（常见目标：$E_k\in<span class="co">[</span><span class="ot">0,2</span><span class="co">]</span>$）</span>
<span id="cb106-3102"><a href="#cb106-3102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3103"><a href="#cb106-3103" aria-hidden="true" tabindex="-1"></a>**3. 云的宽度 Cloud width（“错位有多分散”）**</span>
<span id="cb106-3104"><a href="#cb106-3104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3105"><a href="#cb106-3105" aria-hidden="true" tabindex="-1"></a>度量“错位云”的散度：</span>
<span id="cb106-3106"><a href="#cb106-3106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3107"><a href="#cb106-3107" aria-hidden="true" tabindex="-1"></a>$$W_k=\operatorname{IQR}\big(<span class="sc">\{</span>v_{j,k}<span class="sc">\}</span>\big).</span>
<span id="cb106-3108"><a href="#cb106-3108" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3109"><a href="#cb106-3109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3110"><a href="#cb106-3110" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**直觉**：先后错位的强度\</span>
<span id="cb106-3111"><a href="#cb106-3111" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**难度指标**，本身不是好坏</span>
<span id="cb106-3112"><a href="#cb106-3112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3113"><a href="#cb106-3113" aria-hidden="true" tabindex="-1"></a>**4.归一化中心误差（规模无关）**</span>
<span id="cb106-3114"><a href="#cb106-3114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3115"><a href="#cb106-3115" aria-hidden="true" tabindex="-1"></a>用 $W_k$ 把 $E_k$ 规模化：</span>
<span id="cb106-3116"><a href="#cb106-3116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3117"><a href="#cb106-3117" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3118"><a href="#cb106-3118" aria-hidden="true" tabindex="-1"></a>R_k=\frac{E_k}{W_k+\varepsilon},\qquad (\varepsilon\ \text{很小，防 0 除}).</span>
<span id="cb106-3119"><a href="#cb106-3119" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-3120"><a href="#cb106-3120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3121"><a href="#cb106-3121" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**直觉**：在“云很宽”的情况下，ABS 仍应贴近中心 ,即 $R_k$ 仍然小\</span>
<span id="cb106-3122"><a href="#cb106-3122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3123"><a href="#cb106-3123" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**聚合**：$\operatorname{median}_k R_k$；\</span>
<span id="cb106-3124"><a href="#cb106-3124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3125"><a href="#cb106-3125" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**取值**：越小越好</span>
<span id="cb106-3126"><a href="#cb106-3126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3127"><a href="#cb106-3127" aria-hidden="true" tabindex="-1"></a>code:</span>
<span id="cb106-3128"><a href="#cb106-3128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3131"><a href="#cb106-3131" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-3132"><a href="#cb106-3132" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3133"><a href="#cb106-3133" aria-hidden="true" tabindex="-1"></a><span class="do">## 1) 生成“各维错位”的密集阶跃数据</span></span>
<span id="cb106-3134"><a href="#cb106-3134" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3135"><a href="#cb106-3135" aria-hidden="true" tabindex="-1"></a>simulate_staggered <span class="ot">&lt;-</span> <span class="cf">function</span>(n, d,</span>
<span id="cb106-3136"><a href="#cb106-3136" aria-hidden="true" tabindex="-1"></a>                               cps,               <span class="co"># 基线真断点（评估用它）</span></span>
<span id="cb106-3137"><a href="#cb106-3137" aria-hidden="true" tabindex="-1"></a>                               <span class="at">rho =</span> <span class="fl">0.6</span>,         <span class="co"># 受影响比例</span></span>
<span id="cb106-3138"><a href="#cb106-3138" aria-hidden="true" tabindex="-1"></a>                               <span class="at">delta =</span> <span class="fl">1.0</span>,       <span class="co"># SNR (σ=1)</span></span>
<span id="cb106-3139"><a href="#cb106-3139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sigma =</span> <span class="fl">1.0</span>,</span>
<span id="cb106-3140"><a href="#cb106-3140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ar_phi =</span> <span class="fl">0.0</span>,</span>
<span id="cb106-3141"><a href="#cb106-3141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">jitter_sd =</span> <span class="dv">0</span>L,    <span class="co"># ★ 抖动强度（索引单位，整数）</span></span>
<span id="cb106-3142"><a href="#cb106-3142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">same_sign =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-3143"><a href="#cb106-3143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">shared_subset =</span> <span class="cn">TRUE</span>,  <span class="co"># TRUE: 每个变点影响同一批维度</span></span>
<span id="cb106-3144"><a href="#cb106-3144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb106-3145"><a href="#cb106-3145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb106-3146"><a href="#cb106-3146" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb106-3147"><a href="#cb106-3147" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb106-3148"><a href="#cb106-3148" aria-hidden="true" tabindex="-1"></a>  Y   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3149"><a href="#cb106-3149" aria-hidden="true" tabindex="-1"></a>  mu  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3150"><a href="#cb106-3150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3151"><a href="#cb106-3151" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (shared_subset) {</span>
<span id="cb106-3152"><a href="#cb106-3152" aria-hidden="true" tabindex="-1"></a>    S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb106-3153"><a href="#cb106-3153" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3154"><a href="#cb106-3154" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-3155"><a href="#cb106-3155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3156"><a href="#cb106-3156" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(K)) {</span>
<span id="cb106-3157"><a href="#cb106-3157" aria-hidden="true" tabindex="-1"></a>    base_c <span class="ot">&lt;-</span> cps[k]</span>
<span id="cb106-3158"><a href="#cb106-3158" aria-hidden="true" tabindex="-1"></a>    Sk <span class="ot">&lt;-</span> <span class="cf">if</span> (shared_subset) S <span class="cf">else</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb106-3159"><a href="#cb106-3159" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> Sk) {</span>
<span id="cb106-3160"><a href="#cb106-3160" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="cf">if</span> (jitter_sd <span class="sc">&gt;</span> <span class="dv">0</span>L) <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, jitter_sd)) <span class="cf">else</span> <span class="dv">0</span>L</span>
<span id="cb106-3161"><a href="#cb106-3161" aria-hidden="true" tabindex="-1"></a>      cj  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">min</span>(n<span class="dv">-1</span>L, <span class="fu">as.integer</span>(base_c <span class="sc">+</span> eps)))</span>
<span id="cb106-3162"><a href="#cb106-3162" aria-hidden="true" tabindex="-1"></a>      step <span class="ot">&lt;-</span> signs[j] <span class="sc">*</span> delta</span>
<span id="cb106-3163"><a href="#cb106-3163" aria-hidden="true" tabindex="-1"></a>      Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="ot">&lt;-</span> Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="sc">+</span> step</span>
<span id="cb106-3164"><a href="#cb106-3164" aria-hidden="true" tabindex="-1"></a>      mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="ot">&lt;-</span> mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="sc">+</span> step</span>
<span id="cb106-3165"><a href="#cb106-3165" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-3166"><a href="#cb106-3166" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3167"><a href="#cb106-3167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3168"><a href="#cb106-3168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 噪声</span></span>
<span id="cb106-3169"><a href="#cb106-3169" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb106-3170"><a href="#cb106-3170" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb106-3171"><a href="#cb106-3171" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-3172"><a href="#cb106-3172" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3173"><a href="#cb106-3173" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb106-3174"><a href="#cb106-3174" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb106-3175"><a href="#cb106-3175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) eps[t, ] <span class="ot">&lt;-</span> ar_phi<span class="sc">*</span>eps[t<span class="dv">-1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb106-3176"><a href="#cb106-3176" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3177"><a href="#cb106-3177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3178"><a href="#cb106-3178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> mu <span class="sc">+</span> eps, <span class="at">true_cp =</span> cps, <span class="at">mu =</span> mu)</span>
<span id="cb106-3179"><a href="#cb106-3179" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3180"><a href="#cb106-3180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3181"><a href="#cb106-3181" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3182"><a href="#cb106-3182" aria-hidden="true" tabindex="-1"></a><span class="do">## 2) 只评估 ABS（每次 MC 的耗时=算法时间）</span></span>
<span id="cb106-3183"><a href="#cb106-3183" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3184"><a href="#cb106-3184" aria-hidden="true" tabindex="-1"></a>run_condition_abs <span class="ot">&lt;-</span> <span class="cf">function</span>(T, d, rho, snr, phi, K, <span class="at">jitter_sd =</span> <span class="dv">0</span>L,</span>
<span id="cb106-3185"><a href="#cb106-3185" aria-hidden="true" tabindex="-1"></a>                              <span class="at">min_size =</span> <span class="dv">5</span>,</span>
<span id="cb106-3186"><a href="#cb106-3186" aria-hidden="true" tabindex="-1"></a>                              <span class="at">abs_beta_min =</span> <span class="dv">10</span>, <span class="at">abs_beta_max =</span> <span class="dv">50</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-3187"><a href="#cb106-3187" aria-hidden="true" tabindex="-1"></a>                              <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-3188"><a href="#cb106-3188" aria-hidden="true" tabindex="-1"></a>                              <span class="at">R_trials =</span> <span class="dv">10</span>, <span class="at">seed0 =</span> <span class="dv">12345</span>) {</span>
<span id="cb106-3189"><a href="#cb106-3189" aria-hidden="true" tabindex="-1"></a>  cps_vec <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">seq</span>(<span class="at">from =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">by =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">length.out =</span> K)))</span>
<span id="cb106-3190"><a href="#cb106-3190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3191"><a href="#cb106-3191" aria-hidden="true" tabindex="-1"></a>  f1   <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb106-3192"><a href="#cb106-3192" aria-hidden="true" tabindex="-1"></a>  haus <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb106-3193"><a href="#cb106-3193" aria-hidden="true" tabindex="-1"></a>  rand <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb106-3194"><a href="#cb106-3194" aria-hidden="true" tabindex="-1"></a>  ann  <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb106-3195"><a href="#cb106-3195" aria-hidden="true" tabindex="-1"></a>  tm   <span class="ot">&lt;-</span> <span class="fu">numeric</span>(R_trials)</span>
<span id="cb106-3196"><a href="#cb106-3196" aria-hidden="true" tabindex="-1"></a>  det  <span class="ot">&lt;-</span> <span class="fu">logical</span>(R_trials)</span>
<span id="cb106-3197"><a href="#cb106-3197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3198"><a href="#cb106-3198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed0)</span>
<span id="cb106-3199"><a href="#cb106-3199" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="fu">seq_len</span>(R_trials)) {</span>
<span id="cb106-3200"><a href="#cb106-3200" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fl">1e9</span>, <span class="dv">1</span>)</span>
<span id="cb106-3201"><a href="#cb106-3201" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">simulate_staggered</span>(<span class="at">n =</span> T, <span class="at">d =</span> d, <span class="at">cps =</span> cps_vec,</span>
<span id="cb106-3202"><a href="#cb106-3202" aria-hidden="true" tabindex="-1"></a>                              <span class="at">rho =</span> rho, <span class="at">delta =</span> snr, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> phi,</span>
<span id="cb106-3203"><a href="#cb106-3203" aria-hidden="true" tabindex="-1"></a>                              <span class="at">jitter_sd =</span> jitter_sd, <span class="at">same_sign =</span> <span class="cn">TRUE</span>, <span class="at">shared_subset =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> s)</span>
<span id="cb106-3204"><a href="#cb106-3204" aria-hidden="true" tabindex="-1"></a>    Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp</span>
<span id="cb106-3205"><a href="#cb106-3205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3206"><a href="#cb106-3206" aria-hidden="true" tabindex="-1"></a>    t_abs <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb106-3207"><a href="#cb106-3207" aria-hidden="true" tabindex="-1"></a>      abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb106-3208"><a href="#cb106-3208" aria-hidden="true" tabindex="-1"></a>        Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb106-3209"><a href="#cb106-3209" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-3210"><a href="#cb106-3210" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-3211"><a href="#cb106-3211" aria-hidden="true" tabindex="-1"></a>      idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb106-3212"><a href="#cb106-3212" aria-hidden="true" tabindex="-1"></a>      cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb106-3213"><a href="#cb106-3213" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb106-3214"><a href="#cb106-3214" aria-hidden="true" tabindex="-1"></a>    tm[r]  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(t_abs[<span class="st">"elapsed"</span>])</span>
<span id="cb106-3215"><a href="#cb106-3215" aria-hidden="true" tabindex="-1"></a>    det[r] <span class="ot">&lt;-</span> <span class="fu">length</span>(cp_abs) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb106-3216"><a href="#cb106-3216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3217"><a href="#cb106-3217" aria-hidden="true" tabindex="-1"></a>    f1[r]   <span class="ot">&lt;-</span> <span class="fu">f1_score</span>(true_cp, cp_abs, <span class="at">tol =</span> <span class="dv">3</span>L)</span>
<span id="cb106-3218"><a href="#cb106-3218" aria-hidden="true" tabindex="-1"></a>    haus[r] <span class="ot">&lt;-</span> <span class="fu">hausdorff</span>(true_cp, cp_abs)</span>
<span id="cb106-3219"><a href="#cb106-3219" aria-hidden="true" tabindex="-1"></a>    rand[r] <span class="ot">&lt;-</span> <span class="fu">rand_index</span>(true_cp, cp_abs, <span class="at">n =</span> T)</span>
<span id="cb106-3220"><a href="#cb106-3220" aria-hidden="true" tabindex="-1"></a>    ann[r]  <span class="ot">&lt;-</span> <span class="fu">annotation_error</span>(true_cp, cp_abs)</span>
<span id="cb106-3221"><a href="#cb106-3221" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3222"><a href="#cb106-3222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3223"><a href="#cb106-3223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb106-3224"><a href="#cb106-3224" aria-hidden="true" tabindex="-1"></a>    <span class="at">F1_mean =</span> <span class="fu">mean</span>(f1),    <span class="at">F1_sd =</span> <span class="fu">sd</span>(f1),</span>
<span id="cb106-3225"><a href="#cb106-3225" aria-hidden="true" tabindex="-1"></a>    <span class="at">Haus_median =</span> <span class="fu">median</span>(haus),</span>
<span id="cb106-3226"><a href="#cb106-3226" aria-hidden="true" tabindex="-1"></a>    <span class="at">Rand_mean =</span> <span class="fu">mean</span>(rand), <span class="at">Rand_sd =</span> <span class="fu">sd</span>(rand),</span>
<span id="cb106-3227"><a href="#cb106-3227" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ann_mean =</span> <span class="fu">mean</span>(ann),  <span class="at">Ann_sd =</span> <span class="fu">sd</span>(ann),</span>
<span id="cb106-3228"><a href="#cb106-3228" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time_mean =</span> <span class="fu">mean</span>(tm),</span>
<span id="cb106-3229"><a href="#cb106-3229" aria-hidden="true" tabindex="-1"></a>    <span class="at">DetProb =</span> <span class="fu">mean</span>(det)     <span class="co"># 检出≥1个断点的比例</span></span>
<span id="cb106-3230"><a href="#cb106-3230" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-3231"><a href="#cb106-3231" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3232"><a href="#cb106-3232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3233"><a href="#cb106-3233" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3234"><a href="#cb106-3234" aria-hidden="true" tabindex="-1"></a><span class="do">## 3) 生成“ABS 专用大板表”（列=每个 d×ρ；行=φ×snr；另加 J=抖动强度）</span></span>
<span id="cb106-3235"><a href="#cb106-3235" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3236"><a href="#cb106-3236" aria-hidden="true" tabindex="-1"></a>build_abs_plate_table <span class="ot">&lt;-</span> <span class="cf">function</span>(metric_name, T, K, J,</span>
<span id="cb106-3237"><a href="#cb106-3237" aria-hidden="true" tabindex="-1"></a>                                  d_levels, rho_levels, snr_levels, phi_levels,</span>
<span id="cb106-3238"><a href="#cb106-3238" aria-hidden="true" tabindex="-1"></a>                                  R_trials, seed0,</span>
<span id="cb106-3239"><a href="#cb106-3239" aria-hidden="true" tabindex="-1"></a>                                  min_size,</span>
<span id="cb106-3240"><a href="#cb106-3240" aria-hidden="true" tabindex="-1"></a>                                  abs_beta_min, abs_beta_max, abs_beta_points, p_abs, elbow_window) {</span>
<span id="cb106-3241"><a href="#cb106-3241" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 每个 (d, rho) 只有一列（ABS）</span></span>
<span id="cb106-3242"><a href="#cb106-3242" aria-hidden="true" tabindex="-1"></a>  col_blocks <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb106-3243"><a href="#cb106-3243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho)</span>
<span id="cb106-3244"><a href="#cb106-3244" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | ABS"</span>, d, rho)</span>
<span id="cb106-3245"><a href="#cb106-3245" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb106-3246"><a href="#cb106-3246" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb106-3247"><a href="#cb106-3247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3248"><a href="#cb106-3248" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">phi =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">snr =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-3249"><a href="#cb106-3249" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (nm <span class="cf">in</span> col_blocks) dat[[nm]] <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb106-3250"><a href="#cb106-3250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3251"><a href="#cb106-3251" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (phi <span class="cf">in</span> phi_levels) {</span>
<span id="cb106-3252"><a href="#cb106-3252" aria-hidden="true" tabindex="-1"></a>    first_row_in_phi <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb106-3253"><a href="#cb106-3253" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (snr <span class="cf">in</span> snr_levels) {</span>
<span id="cb106-3254"><a href="#cb106-3254" aria-hidden="true" tabindex="-1"></a>      row_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">phi =</span> <span class="cf">if</span> (first_row_in_phi) phi <span class="cf">else</span> <span class="cn">NA</span>, <span class="at">snr =</span> snr)</span>
<span id="cb106-3255"><a href="#cb106-3255" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (d <span class="cf">in</span> d_levels) {</span>
<span id="cb106-3256"><a href="#cb106-3256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (rho <span class="cf">in</span> rho_levels) {</span>
<span id="cb106-3257"><a href="#cb106-3257" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  · ABS: T=%d, K=%d, J=%d | d=%d, rho=%.2f, snr=%.2f, phi=%.2f, R=%d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb106-3258"><a href="#cb106-3258" aria-hidden="true" tabindex="-1"></a>                      T, K, J, d, rho, snr, phi, R_trials))</span>
<span id="cb106-3259"><a href="#cb106-3259" aria-hidden="true" tabindex="-1"></a>          res <span class="ot">&lt;-</span> <span class="fu">run_condition_abs</span>(<span class="at">T=</span>T, <span class="at">d=</span>d, <span class="at">rho=</span>rho, <span class="at">snr=</span>snr, <span class="at">phi=</span>phi, <span class="at">K=</span>K, <span class="at">jitter_sd=</span>J,</span>
<span id="cb106-3260"><a href="#cb106-3260" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">min_size=</span>min_size,</span>
<span id="cb106-3261"><a href="#cb106-3261" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">abs_beta_min=</span>abs_beta_min, <span class="at">abs_beta_max=</span>abs_beta_max,</span>
<span id="cb106-3262"><a href="#cb106-3262" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">abs_beta_points=</span>abs_beta_points, <span class="at">p_abs=</span>p_abs,</span>
<span id="cb106-3263"><a href="#cb106-3263" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">elbow_window=</span>elbow_window,</span>
<span id="cb106-3264"><a href="#cb106-3264" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">R_trials=</span>R_trials, <span class="at">seed0=</span>seed0)</span>
<span id="cb106-3265"><a href="#cb106-3265" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 取某个指标的单值</span></span>
<span id="cb106-3266"><a href="#cb106-3266" aria-hidden="true" tabindex="-1"></a>          val <span class="ot">&lt;-</span> <span class="cf">switch</span>(metric_name,</span>
<span id="cb106-3267"><a href="#cb106-3267" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"F1"</span>   <span class="ot">=</span> res<span class="sc">$</span>F1_mean,</span>
<span id="cb106-3268"><a href="#cb106-3268" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Haus"</span> <span class="ot">=</span> res<span class="sc">$</span>Haus_median,</span>
<span id="cb106-3269"><a href="#cb106-3269" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Rand"</span> <span class="ot">=</span> res<span class="sc">$</span>Rand_mean,</span>
<span id="cb106-3270"><a href="#cb106-3270" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Ann"</span>  <span class="ot">=</span> res<span class="sc">$</span>Ann_mean,</span>
<span id="cb106-3271"><a href="#cb106-3271" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Time"</span> <span class="ot">=</span> res<span class="sc">$</span>Time_mean,</span>
<span id="cb106-3272"><a href="#cb106-3272" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"DetProb"</span> <span class="ot">=</span> res<span class="sc">$</span>DetProb,</span>
<span id="cb106-3273"><a href="#cb106-3273" aria-hidden="true" tabindex="-1"></a>                        <span class="cn">NA_real_</span>)</span>
<span id="cb106-3274"><a href="#cb106-3274" aria-hidden="true" tabindex="-1"></a>          row_list[[<span class="fu">sprintf</span>(<span class="st">"d=%s | rho=%.2f | ABS"</span>, d, rho)]] <span class="ot">&lt;-</span> val</span>
<span id="cb106-3275"><a href="#cb106-3275" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb106-3276"><a href="#cb106-3276" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb106-3277"><a href="#cb106-3277" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat, <span class="fu">as.data.frame</span>(row_list, <span class="at">check.names =</span> <span class="cn">FALSE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>))</span>
<span id="cb106-3278"><a href="#cb106-3278" aria-hidden="true" tabindex="-1"></a>      first_row_in_phi <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb106-3279"><a href="#cb106-3279" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-3280"><a href="#cb106-3280" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3281"><a href="#cb106-3281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3282"><a href="#cb106-3282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 三行表头（含 J）</span></span>
<span id="cb106-3283"><a href="#cb106-3283" aria-hidden="true" tabindex="-1"></a>  head1 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb106-3284"><a href="#cb106-3284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"T=%d, K=%d, J=%d"</span>, T, K, J), <span class="st">""</span>,</span>
<span id="cb106-3285"><a href="#cb106-3285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb106-3286"><a href="#cb106-3286" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">sprintf</span>(<span class="st">"d=%d"</span>, d), <span class="fu">rep</span>(<span class="st">""</span>, <span class="fu">length</span>(rho_levels)<span class="sc">*</span><span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span>))  <span class="co"># 每个 rho 只有 ABS 一列</span></span>
<span id="cb106-3287"><a href="#cb106-3287" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb106-3288"><a href="#cb106-3288" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-3289"><a href="#cb106-3289" aria-hidden="true" tabindex="-1"></a>  head2 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb106-3290"><a href="#cb106-3290" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>, <span class="st">""</span>,</span>
<span id="cb106-3291"><a href="#cb106-3291" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb106-3292"><a href="#cb106-3292" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho) <span class="fu">sprintf</span>(<span class="st">"ρ=%.2f"</span>, rho)))</span>
<span id="cb106-3293"><a href="#cb106-3293" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb106-3294"><a href="#cb106-3294" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-3295"><a href="#cb106-3295" aria-hidden="true" tabindex="-1"></a>  head3 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"φ"</span>, <span class="st">"snr"</span>,</span>
<span id="cb106-3296"><a href="#cb106-3296" aria-hidden="true" tabindex="-1"></a>             <span class="fu">unlist</span>(<span class="fu">lapply</span>(d_levels, <span class="cf">function</span>(d)</span>
<span id="cb106-3297"><a href="#cb106-3297" aria-hidden="true" tabindex="-1"></a>               <span class="fu">unlist</span>(<span class="fu">lapply</span>(rho_levels, <span class="cf">function</span>(rho) <span class="st">"ABS"</span>))</span>
<span id="cb106-3298"><a href="#cb106-3298" aria-hidden="true" tabindex="-1"></a>             )))</span>
<span id="cb106-3299"><a href="#cb106-3299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">data =</span> dat, <span class="at">header1 =</span> head1, <span class="at">header2 =</span> head2, <span class="at">header3 =</span> head3)</span>
<span id="cb106-3300"><a href="#cb106-3300" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3301"><a href="#cb106-3301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3302"><a href="#cb106-3302" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3303"><a href="#cb106-3303" aria-hidden="true" tabindex="-1"></a><span class="do">## 4) UTF-8 + BOM 写 CSV（Excel 不乱码）</span></span>
<span id="cb106-3304"><a href="#cb106-3304" aria-hidden="true" tabindex="-1"></a><span class="do">## =========================</span></span>
<span id="cb106-3305"><a href="#cb106-3305" aria-hidden="true" tabindex="-1"></a>write_plate_csv_abs <span class="ot">&lt;-</span> <span class="cf">function</span>(table_obj, metric_name, T, K, J, <span class="at">dir_out =</span> <span class="st">"tables_abs"</span>) {</span>
<span id="cb106-3306"><a href="#cb106-3306" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir_out)) <span class="fu">dir.create</span>(dir_out, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-3307"><a href="#cb106-3307" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s/ABS_%s_T%d_K%d_J%d.csv"</span>, dir_out, metric_name, T, K, J)</span>
<span id="cb106-3308"><a href="#cb106-3308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"&gt;&gt; 写出表格：%s</span><span class="sc">\n</span><span class="st">"</span>, fn))</span>
<span id="cb106-3309"><a href="#cb106-3309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3310"><a href="#cb106-3310" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".csv"</span>)</span>
<span id="cb106-3311"><a href="#cb106-3311" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(tmp, <span class="at">open =</span> <span class="st">"wt"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb106-3312"><a href="#cb106-3312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header1), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>)</span>
<span id="cb106-3313"><a href="#cb106-3313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header2), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-3314"><a href="#cb106-3314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(<span class="fu">t</span>(table_obj<span class="sc">$</span>header3), <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-3315"><a href="#cb106-3315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(table_obj<span class="sc">$</span>data,      <span class="at">file =</span> con, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">qmethod =</span> <span class="st">"double"</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-3316"><a href="#cb106-3316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flush</span>(con); <span class="fu">close</span>(con)</span>
<span id="cb106-3317"><a href="#cb106-3317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3318"><a href="#cb106-3318" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">file</span>(fn, <span class="at">open =</span> <span class="st">"wb"</span>); <span class="fu">writeBin</span>(<span class="fu">as.raw</span>(<span class="fu">c</span>(<span class="dv">0xEF</span>,<span class="dv">0xBB</span>,<span class="dv">0xBF</span>)), out); <span class="fu">close</span>(out)</span>
<span id="cb106-3319"><a href="#cb106-3319" aria-hidden="true" tabindex="-1"></a>  rawtxt <span class="ot">&lt;-</span> <span class="fu">readBin</span>(tmp, <span class="at">what =</span> <span class="st">"raw"</span>, <span class="at">n =</span> <span class="fu">file.info</span>(tmp)<span class="sc">$</span>size)</span>
<span id="cb106-3320"><a href="#cb106-3320" aria-hidden="true" tabindex="-1"></a>  out2 <span class="ot">&lt;-</span> <span class="fu">file</span>(fn, <span class="at">open =</span> <span class="st">"ab"</span>); <span class="fu">writeBin</span>(rawtxt, out2); <span class="fu">close</span>(out2)</span>
<span id="cb106-3321"><a href="#cb106-3321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(tmp)</span>
<span id="cb106-3322"><a href="#cb106-3322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(fn)</span>
<span id="cb106-3323"><a href="#cb106-3323" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3324"><a href="#cb106-3324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3325"><a href="#cb106-3325" aria-hidden="true" tabindex="-1"></a>run_all_abs_plates <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">out_dir =</span> <span class="st">"tables_abs"</span>) {</span>
<span id="cb106-3326"><a href="#cb106-3326" aria-hidden="true" tabindex="-1"></a>  t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb106-3327"><a href="#cb106-3327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=========== 仅 ABS 的大板表导出（含错位 J） ===========</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-3328"><a href="#cb106-3328" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (K <span class="cf">in</span> K_levels) {</span>
<span id="cb106-3329"><a href="#cb106-3329" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (T <span class="cf">in</span> n_levels) {</span>
<span id="cb106-3330"><a href="#cb106-3330" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (J <span class="cf">in</span> jitter_levels) {</span>
<span id="cb106-3331"><a href="#cb106-3331" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (metric <span class="cf">in</span> metrics_to_show) {</span>
<span id="cb106-3332"><a href="#cb106-3332" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"[生成] T=%d, K=%d, J=%d, metric=%s</span><span class="sc">\n</span><span class="st">"</span>, T, K, J, metric))</span>
<span id="cb106-3333"><a href="#cb106-3333" aria-hidden="true" tabindex="-1"></a>          tab <span class="ot">&lt;-</span> <span class="fu">build_abs_plate_table</span>(metric, T, K, J,</span>
<span id="cb106-3334"><a href="#cb106-3334" aria-hidden="true" tabindex="-1"></a>                                       d_levels, rho_levels, snr_levels, phi_levels,</span>
<span id="cb106-3335"><a href="#cb106-3335" aria-hidden="true" tabindex="-1"></a>                                       R_trials, seed0,</span>
<span id="cb106-3336"><a href="#cb106-3336" aria-hidden="true" tabindex="-1"></a>                                       min_size,</span>
<span id="cb106-3337"><a href="#cb106-3337" aria-hidden="true" tabindex="-1"></a>                                       abs_beta_min, abs_beta_max, abs_beta_points, p_abs, elbow_window)</span>
<span id="cb106-3338"><a href="#cb106-3338" aria-hidden="true" tabindex="-1"></a>          <span class="fu">write_plate_csv_abs</span>(tab, metric, T, K, J, <span class="at">dir_out =</span> out_dir)</span>
<span id="cb106-3339"><a href="#cb106-3339" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb106-3340"><a href="#cb106-3340" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb106-3341"><a href="#cb106-3341" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-3342"><a href="#cb106-3342" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3343"><a href="#cb106-3343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=========== 完成 ===========</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb106-3344"><a href="#cb106-3344" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3345"><a href="#cb106-3345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3346"><a href="#cb106-3346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-3347"><a href="#cb106-3347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3348"><a href="#cb106-3348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-3349"><a href="#cb106-3349" aria-hidden="true" tabindex="-1"></a><span class="in">## =========================</span></span>
<span id="cb106-3350"><a href="#cb106-3350" aria-hidden="true" tabindex="-1"></a><span class="in">## 5) 主控：只跑 ABS，多 J（抖动）层级</span></span>
<span id="cb106-3351"><a href="#cb106-3351" aria-hidden="true" tabindex="-1"></a><span class="in">## =========================</span></span>
<span id="cb106-3352"><a href="#cb106-3352" aria-hidden="true" tabindex="-1"></a><span class="in"># —— 参数网格（按需改）——</span></span>
<span id="cb106-3353"><a href="#cb106-3353" aria-hidden="true" tabindex="-1"></a><span class="in">n_levels    &lt;- c(200)</span></span>
<span id="cb106-3354"><a href="#cb106-3354" aria-hidden="true" tabindex="-1"></a><span class="in">K_levels    &lt;- c(1, 3)</span></span>
<span id="cb106-3355"><a href="#cb106-3355" aria-hidden="true" tabindex="-1"></a><span class="in">d_levels    &lt;- c(50, 200)</span></span>
<span id="cb106-3356"><a href="#cb106-3356" aria-hidden="true" tabindex="-1"></a><span class="in">rho_levels  &lt;- c(0.6, 0.8)</span></span>
<span id="cb106-3357"><a href="#cb106-3357" aria-hidden="true" tabindex="-1"></a><span class="in">snr_levels  &lt;- c(0.7, 1.0)</span></span>
<span id="cb106-3358"><a href="#cb106-3358" aria-hidden="true" tabindex="-1"></a><span class="in">phi_levels  &lt;- c(0, 0.25)</span></span>
<span id="cb106-3359"><a href="#cb106-3359" aria-hidden="true" tabindex="-1"></a><span class="in">jitter_levels &lt;- c(0L, 3L, 6L, 10L)</span></span>
<span id="cb106-3360"><a href="#cb106-3360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3361"><a href="#cb106-3361" aria-hidden="true" tabindex="-1"></a><span class="in">R_trials    &lt;- 10</span></span>
<span id="cb106-3362"><a href="#cb106-3362" aria-hidden="true" tabindex="-1"></a><span class="in">seed0       &lt;- 12345</span></span>
<span id="cb106-3363"><a href="#cb106-3363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3364"><a href="#cb106-3364" aria-hidden="true" tabindex="-1"></a><span class="in">min_size     &lt;- 5</span></span>
<span id="cb106-3365"><a href="#cb106-3365" aria-hidden="true" tabindex="-1"></a><span class="in">abs_beta_min &lt;- 10; abs_beta_max &lt;- 50; abs_beta_points &lt;- 70; p_abs &lt;- 2</span></span>
<span id="cb106-3366"><a href="#cb106-3366" aria-hidden="true" tabindex="-1"></a><span class="in">elbow_window &lt;- 10</span></span>
<span id="cb106-3367"><a href="#cb106-3367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3368"><a href="#cb106-3368" aria-hidden="true" tabindex="-1"></a><span class="in">metrics_to_show &lt;- c("F1","Haus","Rand","Ann","Time")  # 想精简可删</span></span>
<span id="cb106-3369"><a href="#cb106-3369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3370"><a href="#cb106-3370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3371"><a href="#cb106-3371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3372"><a href="#cb106-3372" aria-hidden="true" tabindex="-1"></a><span class="in">## 运行</span></span>
<span id="cb106-3373"><a href="#cb106-3373" aria-hidden="true" tabindex="-1"></a><span class="in"># run_all_abs_plates("D:/your/path/abs_only")  # 指定保存目录；不指定则写到 ./tables_abs</span></span>
<span id="cb106-3374"><a href="#cb106-3374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-3375"><a href="#cb106-3375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3376"><a href="#cb106-3376" aria-hidden="true" tabindex="-1"></a><span class="fu">## 跑可视化</span></span>
<span id="cb106-3377"><a href="#cb106-3377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3378"><a href="#cb106-3378" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**“共享子集”设定**：$S_k \equiv S$ 对所有 $k$ 相同</span>
<span id="cb106-3379"><a href="#cb106-3379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3382"><a href="#cb106-3382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-3383"><a href="#cb106-3383" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb106-3384"><a href="#cb106-3384" aria-hidden="true" tabindex="-1"></a><span class="do">## (1) 生成“各维错位”的密集阶跃数据</span></span>
<span id="cb106-3385"><a href="#cb106-3385" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb106-3386"><a href="#cb106-3386" aria-hidden="true" tabindex="-1"></a>simulate_staggered <span class="ot">&lt;-</span> <span class="cf">function</span>(n, d,</span>
<span id="cb106-3387"><a href="#cb106-3387" aria-hidden="true" tabindex="-1"></a>                               cps,</span>
<span id="cb106-3388"><a href="#cb106-3388" aria-hidden="true" tabindex="-1"></a>                               <span class="at">rho =</span> <span class="fl">0.6</span>,</span>
<span id="cb106-3389"><a href="#cb106-3389" aria-hidden="true" tabindex="-1"></a>                               <span class="at">delta =</span> <span class="fl">1.0</span>,</span>
<span id="cb106-3390"><a href="#cb106-3390" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sigma =</span> <span class="fl">1.0</span>,</span>
<span id="cb106-3391"><a href="#cb106-3391" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ar_phi =</span> <span class="fl">0.0</span>,</span>
<span id="cb106-3392"><a href="#cb106-3392" aria-hidden="true" tabindex="-1"></a>                               <span class="at">jitter_sd =</span> <span class="dv">0</span>L,</span>
<span id="cb106-3393"><a href="#cb106-3393" aria-hidden="true" tabindex="-1"></a>                               <span class="at">same_sign =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-3394"><a href="#cb106-3394" aria-hidden="true" tabindex="-1"></a>                               <span class="at">shared_subset =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-3395"><a href="#cb106-3395" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb106-3396"><a href="#cb106-3396" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb106-3397"><a href="#cb106-3397" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps)))</span>
<span id="cb106-3398"><a href="#cb106-3398" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb106-3399"><a href="#cb106-3399" aria-hidden="true" tabindex="-1"></a>  Y   <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3400"><a href="#cb106-3400" aria-hidden="true" tabindex="-1"></a>  mu  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3401"><a href="#cb106-3401" aria-hidden="true" tabindex="-1"></a>  affected <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)  <span class="co"># ★ 记录哪些维度发生过变点</span></span>
<span id="cb106-3402"><a href="#cb106-3402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3403"><a href="#cb106-3403" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (shared_subset) {</span>
<span id="cb106-3404"><a href="#cb106-3404" aria-hidden="true" tabindex="-1"></a>    S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb106-3405"><a href="#cb106-3405" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3406"><a href="#cb106-3406" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), d, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-3407"><a href="#cb106-3407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3408"><a href="#cb106-3408" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(K)) {</span>
<span id="cb106-3409"><a href="#cb106-3409" aria-hidden="true" tabindex="-1"></a>    base_c <span class="ot">&lt;-</span> cps[k]</span>
<span id="cb106-3410"><a href="#cb106-3410" aria-hidden="true" tabindex="-1"></a>    Sk <span class="ot">&lt;-</span> <span class="cf">if</span> (shared_subset) S <span class="cf">else</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho <span class="sc">*</span> d)), <span class="at">replace =</span> <span class="cn">FALSE</span>))</span>
<span id="cb106-3411"><a href="#cb106-3411" aria-hidden="true" tabindex="-1"></a>    affected[Sk] <span class="ot">&lt;-</span> <span class="cn">TRUE</span>  <span class="co"># ★ 并集</span></span>
<span id="cb106-3412"><a href="#cb106-3412" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> Sk) {</span>
<span id="cb106-3413"><a href="#cb106-3413" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="cf">if</span> (jitter_sd <span class="sc">&gt;</span> <span class="dv">0</span>L) <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, jitter_sd)) <span class="cf">else</span> <span class="dv">0</span>L</span>
<span id="cb106-3414"><a href="#cb106-3414" aria-hidden="true" tabindex="-1"></a>      cj  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">min</span>(n<span class="dv">-1</span>L, <span class="fu">as.integer</span>(base_c <span class="sc">+</span> eps)))</span>
<span id="cb106-3415"><a href="#cb106-3415" aria-hidden="true" tabindex="-1"></a>      step <span class="ot">&lt;-</span> signs[j] <span class="sc">*</span> delta</span>
<span id="cb106-3416"><a href="#cb106-3416" aria-hidden="true" tabindex="-1"></a>      Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="ot">&lt;-</span> Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="sc">+</span> step</span>
<span id="cb106-3417"><a href="#cb106-3417" aria-hidden="true" tabindex="-1"></a>      mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="ot">&lt;-</span> mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="sc">+</span> step</span>
<span id="cb106-3418"><a href="#cb106-3418" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-3419"><a href="#cb106-3419" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3420"><a href="#cb106-3420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3421"><a href="#cb106-3421" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 噪声</span></span>
<span id="cb106-3422"><a href="#cb106-3422" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb106-3423"><a href="#cb106-3423" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb106-3424"><a href="#cb106-3424" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-3425"><a href="#cb106-3425" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3426"><a href="#cb106-3426" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb106-3427"><a href="#cb106-3427" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb106-3428"><a href="#cb106-3428" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) eps[t, ] <span class="ot">&lt;-</span> ar_phi<span class="sc">*</span>eps[t<span class="dv">-1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb106-3429"><a href="#cb106-3429" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3430"><a href="#cb106-3430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3431"><a href="#cb106-3431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> mu <span class="sc">+</span> eps, <span class="at">true_cp =</span> cps, <span class="at">affected =</span> affected)</span>
<span id="cb106-3432"><a href="#cb106-3432" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3433"><a href="#cb106-3433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3434"><a href="#cb106-3434" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb106-3435"><a href="#cb106-3435" aria-hidden="true" tabindex="-1"></a><span class="do">## (2) 单次 ABS 检测（返回 Y、true_cp、cp_abs）</span></span>
<span id="cb106-3436"><a href="#cb106-3436" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb106-3437"><a href="#cb106-3437" aria-hidden="true" tabindex="-1"></a>detect_abs_once <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">T =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">50</span>, <span class="at">K =</span> <span class="dv">1</span>,</span>
<span id="cb106-3438"><a href="#cb106-3438" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">snr =</span> <span class="fl">0.8</span>, <span class="at">phi =</span> <span class="dv">0</span>,</span>
<span id="cb106-3439"><a href="#cb106-3439" aria-hidden="true" tabindex="-1"></a>                            <span class="at">jitter_sd =</span> <span class="dv">6</span>L,</span>
<span id="cb106-3440"><a href="#cb106-3440" aria-hidden="true" tabindex="-1"></a>                            <span class="at">min_size =</span> <span class="dv">5</span>,</span>
<span id="cb106-3441"><a href="#cb106-3441" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min =</span> <span class="dv">10</span>, <span class="at">abs_beta_max =</span> <span class="dv">50</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-3442"><a href="#cb106-3442" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-3443"><a href="#cb106-3443" aria-hidden="true" tabindex="-1"></a>                            <span class="at">seed =</span> <span class="dv">123</span>) {</span>
<span id="cb106-3444"><a href="#cb106-3444" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">seq</span>(<span class="at">from =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">by =</span> T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">length.out =</span> K)))</span>
<span id="cb106-3445"><a href="#cb106-3445" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_staggered</span>(<span class="at">n =</span> T, <span class="at">d =</span> d, <span class="at">cps =</span> cps,</span>
<span id="cb106-3446"><a href="#cb106-3446" aria-hidden="true" tabindex="-1"></a>                            <span class="at">rho =</span> rho, <span class="at">delta =</span> snr, <span class="at">sigma =</span> <span class="fl">1.0</span>, <span class="at">ar_phi =</span> phi,</span>
<span id="cb106-3447"><a href="#cb106-3447" aria-hidden="true" tabindex="-1"></a>                            <span class="at">jitter_sd =</span> jitter_sd, <span class="at">same_sign =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-3448"><a href="#cb106-3448" aria-hidden="true" tabindex="-1"></a>                            <span class="at">shared_subset =</span> <span class="cn">TRUE</span>, <span class="at">seed =</span> seed)</span>
<span id="cb106-3449"><a href="#cb106-3449" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp; affected <span class="ot">&lt;-</span> dat<span class="sc">$</span>affected</span>
<span id="cb106-3450"><a href="#cb106-3450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3451"><a href="#cb106-3451" aria-hidden="true" tabindex="-1"></a>  abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb106-3452"><a href="#cb106-3452" aria-hidden="true" tabindex="-1"></a>    Y, <span class="at">beta_min =</span> abs_beta_min, <span class="at">beta_max =</span> abs_beta_max, <span class="at">beta_points =</span> abs_beta_points,</span>
<span id="cb106-3453"><a href="#cb106-3453" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_size =</span> min_size, <span class="at">p =</span> p_abs, <span class="at">elbow_window =</span> elbow_window, <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb106-3454"><a href="#cb106-3454" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-3455"><a href="#cb106-3455" aria-hidden="true" tabindex="-1"></a>  idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb106-3456"><a href="#cb106-3456" aria-hidden="true" tabindex="-1"></a>  cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb106-3457"><a href="#cb106-3457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3458"><a href="#cb106-3458" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> Y, <span class="at">true_cp =</span> true_cp, <span class="at">cp_abs =</span> cp_abs, <span class="at">affected =</span> affected,</span>
<span id="cb106-3459"><a href="#cb106-3459" aria-hidden="true" tabindex="-1"></a>       <span class="at">params =</span> <span class="fu">list</span>(<span class="at">T=</span>T, <span class="at">d=</span>d, <span class="at">K=</span>K, <span class="at">rho=</span>rho, <span class="at">snr=</span>snr, <span class="at">phi=</span>phi, <span class="at">jitter_sd=</span>jitter_sd))</span>
<span id="cb106-3460"><a href="#cb106-3460" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3461"><a href="#cb106-3461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3462"><a href="#cb106-3462" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb106-3463"><a href="#cb106-3463" aria-hidden="true" tabindex="-1"></a><span class="do">## (3) 画图：各维并列（不重叠），蓝虚线=真实变点，红虚线=检测变点</span></span>
<span id="cb106-3464"><a href="#cb106-3464" aria-hidden="true" tabindex="-1"></a><span class="do">## -----------------------------------------</span></span>
<span id="cb106-3465"><a href="#cb106-3465" aria-hidden="true" tabindex="-1"></a>plot_multidim_with_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, true_cp, detected_cp,</span>
<span id="cb106-3466"><a href="#cb106-3466" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">affected_dims =</span> <span class="cn">NULL</span>,          <span class="co"># ★ 逻辑/索引：哪些维度发生过变点</span></span>
<span id="cb106-3467"><a href="#cb106-3467" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">main =</span> <span class="st">"ABS detection (stacked per-dimension)"</span>,</span>
<span id="cb106-3468"><a href="#cb106-3468" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">xlab =</span> <span class="st">"time"</span>, <span class="at">ylab =</span> <span class="st">"dimension (stacked)"</span>,</span>
<span id="cb106-3469"><a href="#cb106-3469" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">col_normal =</span> <span class="st">"grey30"</span>,</span>
<span id="cb106-3470"><a href="#cb106-3470" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">col_affected =</span> <span class="st">"lightblue"</span>) {  <span class="co"># ★ 淡蓝色</span></span>
<span id="cb106-3471"><a href="#cb106-3471" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Y); d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb106-3472"><a href="#cb106-3472" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(affected_dims)) affected_dims <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)</span>
<span id="cb106-3473"><a href="#cb106-3473" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.numeric</span>(affected_dims)) {</span>
<span id="cb106-3474"><a href="#cb106-3474" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d); tmp[affected_dims] <span class="ot">&lt;-</span> <span class="cn">TRUE</span>; affected_dims <span class="ot">&lt;-</span> tmp</span>
<span id="cb106-3475"><a href="#cb106-3475" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3476"><a href="#cb106-3476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3477"><a href="#cb106-3477" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 去中心 + 计算层间距</span></span>
<span id="cb106-3478"><a href="#cb106-3478" aria-hidden="true" tabindex="-1"></a>  Yc <span class="ot">&lt;-</span> <span class="fu">scale</span>(Y, <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-3479"><a href="#cb106-3479" aria-hidden="true" tabindex="-1"></a>  amp <span class="ot">&lt;-</span> <span class="fu">apply</span>(Yc, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">diff</span>(<span class="fu">range</span>(x)))</span>
<span id="cb106-3480"><a href="#cb106-3480" aria-hidden="true" tabindex="-1"></a>  gap <span class="ot">&lt;-</span> <span class="fu">max</span>(amp); <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(gap) <span class="sc">||</span> gap <span class="sc">&lt;=</span> <span class="dv">0</span>) gap <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb106-3481"><a href="#cb106-3481" aria-hidden="true" tabindex="-1"></a>  gap <span class="ot">&lt;-</span> gap <span class="sc">*</span> <span class="fl">1.3</span></span>
<span id="cb106-3482"><a href="#cb106-3482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3483"><a href="#cb106-3483" aria-hidden="true" tabindex="-1"></a>  ylim_top <span class="ot">&lt;-</span> (d <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> gap</span>
<span id="cb106-3484"><a href="#cb106-3484" aria-hidden="true" tabindex="-1"></a>  op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">no.readonly =</span> <span class="cn">TRUE</span>); <span class="fu">on.exit</span>(<span class="fu">par</span>(op), <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-3485"><a href="#cb106-3485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="fl">2.5</span>, <span class="dv">1</span>))</span>
<span id="cb106-3486"><a href="#cb106-3486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="cn">NA</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">1</span>, T), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span>gap<span class="sc">*</span><span class="fl">0.5</span>, ylim_top <span class="sc">+</span> gap<span class="sc">*</span><span class="fl">0.5</span>),</span>
<span id="cb106-3487"><a href="#cb106-3487" aria-hidden="true" tabindex="-1"></a>       <span class="at">xaxs =</span> <span class="st">"i"</span>, <span class="at">yaxs =</span> <span class="st">"i"</span>, <span class="at">xlab =</span> xlab, <span class="at">ylab =</span> ylab, <span class="at">main =</span> main,</span>
<span id="cb106-3488"><a href="#cb106-3488" aria-hidden="true" tabindex="-1"></a>       <span class="at">yaxt =</span> <span class="st">"n"</span>)  <span class="co"># 关闭默认 y 轴刻度</span></span>
<span id="cb106-3489"><a href="#cb106-3489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3490"><a href="#cb106-3490" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 逐维绘制（发生变点=淡蓝；否则灰）</span></span>
<span id="cb106-3491"><a href="#cb106-3491" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb106-3492"><a href="#cb106-3492" aria-hidden="true" tabindex="-1"></a>    yoff <span class="ot">&lt;-</span> (j <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> gap</span>
<span id="cb106-3493"><a href="#cb106-3493" aria-hidden="true" tabindex="-1"></a>    cc <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">isTRUE</span>(affected_dims[j])) col_affected <span class="cf">else</span> col_normal</span>
<span id="cb106-3494"><a href="#cb106-3494" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(<span class="fu">seq_len</span>(T), Yc[, j] <span class="sc">+</span> yoff, <span class="at">col =</span> cc, <span class="at">lwd =</span> <span class="fl">1.2</span>)</span>
<span id="cb106-3495"><a href="#cb106-3495" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3496"><a href="#cb106-3496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3497"><a href="#cb106-3497" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 左侧自定义维度刻度</span></span>
<span id="cb106-3498"><a href="#cb106-3498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at =</span> (<span class="dv">0</span><span class="sc">:</span>(d<span class="dv">-1</span>)) <span class="sc">*</span> gap, <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="st">"dim "</span>, <span class="dv">1</span><span class="sc">:</span>d), <span class="at">las =</span> <span class="dv">2</span>, <span class="at">cex.axis =</span> <span class="fl">0.7</span>)</span>
<span id="cb106-3499"><a href="#cb106-3499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3500"><a href="#cb106-3500" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 蓝色虚线：真实断点；红色虚线：检出断点</span></span>
<span id="cb106-3501"><a href="#cb106-3501" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp))  <span class="cf">for</span> (v <span class="cf">in</span> true_cp)   <span class="fu">abline</span>(<span class="at">v =</span> v, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-3502"><a href="#cb106-3502" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(detected_cp)) <span class="cf">for</span> (v <span class="cf">in</span> detected_cp) <span class="fu">abline</span>(<span class="at">v =</span> v, <span class="at">col =</span> <span class="st">"red"</span>,  <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb106-3503"><a href="#cb106-3503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3504"><a href="#cb106-3504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>,</span>
<span id="cb106-3505"><a href="#cb106-3505" aria-hidden="true" tabindex="-1"></a>         <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"affected dim"</span>, <span class="st">"true cp"</span>, <span class="st">"detected cp"</span>),</span>
<span id="cb106-3506"><a href="#cb106-3506" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(col_affected, <span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">lwd =</span> <span class="fu">c</span>(<span class="fl">1.2</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb106-3507"><a href="#cb106-3507" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3508"><a href="#cb106-3508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3509"><a href="#cb106-3509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3510"><a href="#cb106-3510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3511"><a href="#cb106-3511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-3512"><a href="#cb106-3512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3513"><a href="#cb106-3513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-3514"><a href="#cb106-3514" aria-hidden="true" tabindex="-1"></a><span class="in">res &lt;- detect_abs_once(</span></span>
<span id="cb106-3515"><a href="#cb106-3515" aria-hidden="true" tabindex="-1"></a><span class="in">  T = 200, d = 10, K = 3,</span></span>
<span id="cb106-3516"><a href="#cb106-3516" aria-hidden="true" tabindex="-1"></a><span class="in">  rho = 0.7, snr = 2, phi = 0.0,</span></span>
<span id="cb106-3517"><a href="#cb106-3517" aria-hidden="true" tabindex="-1"></a><span class="in">  jitter_sd = 6L,</span></span>
<span id="cb106-3518"><a href="#cb106-3518" aria-hidden="true" tabindex="-1"></a><span class="in">  min_size = 3,</span></span>
<span id="cb106-3519"><a href="#cb106-3519" aria-hidden="true" tabindex="-1"></a><span class="in">  abs_beta_min = 3, abs_beta_max = 30, abs_beta_points = 70, p_abs = 2,</span></span>
<span id="cb106-3520"><a href="#cb106-3520" aria-hidden="true" tabindex="-1"></a><span class="in">  elbow_window = 10,</span></span>
<span id="cb106-3521"><a href="#cb106-3521" aria-hidden="true" tabindex="-1"></a><span class="in">  seed = 397492</span></span>
<span id="cb106-3522"><a href="#cb106-3522" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-3523"><a href="#cb106-3523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3524"><a href="#cb106-3524" aria-hidden="true" tabindex="-1"></a><span class="in">plot_multidim_with_cps(</span></span>
<span id="cb106-3525"><a href="#cb106-3525" aria-hidden="true" tabindex="-1"></a><span class="in">  Y = res$Y,</span></span>
<span id="cb106-3526"><a href="#cb106-3526" aria-hidden="true" tabindex="-1"></a><span class="in">  true_cp = res$true_cp,</span></span>
<span id="cb106-3527"><a href="#cb106-3527" aria-hidden="true" tabindex="-1"></a><span class="in">  detected_cp = res$cp_abs,</span></span>
<span id="cb106-3528"><a href="#cb106-3528" aria-hidden="true" tabindex="-1"></a><span class="in">  affected_dims = res$affected,   </span></span>
<span id="cb106-3529"><a href="#cb106-3529" aria-hidden="true" tabindex="-1"></a><span class="in">  main = sprintf("ABS (T=%d, d=%d, K=%d, jitter=%d)",</span></span>
<span id="cb106-3530"><a href="#cb106-3530" aria-hidden="true" tabindex="-1"></a><span class="in">                 res$params$T, res$params$d, res$params$K, res$params$jitter_sd)</span></span>
<span id="cb106-3531"><a href="#cb106-3531" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-3532"><a href="#cb106-3532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3533"><a href="#cb106-3533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-3534"><a href="#cb106-3534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3535"><a href="#cb106-3535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb106-3536"><a href="#cb106-3536" aria-hidden="true" tabindex="-1"></a><span class="in"># 生成 100 个 N(0, 12) 的随机数</span></span>
<span id="cb106-3537"><a href="#cb106-3537" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)</span></span>
<span id="cb106-3538"><a href="#cb106-3538" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- rnorm(100, mean = 0, sd = sqrt(12))</span></span>
<span id="cb106-3539"><a href="#cb106-3539" aria-hidden="true" tabindex="-1"></a><span class="in">head(x)  # 查看前6个</span></span>
<span id="cb106-3540"><a href="#cb106-3540" aria-hidden="true" tabindex="-1"></a><span class="in">summary(x)  # 查看基本统计量</span></span>
<span id="cb106-3541"><a href="#cb106-3541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-3542"><a href="#cb106-3542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3543"><a href="#cb106-3543" aria-hidden="true" tabindex="-1"></a>ABS 在多维“先后错位”场景下，能否把一团分散的单维变点拉到同一中心？</span>
<span id="cb106-3544"><a href="#cb106-3544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3547"><a href="#cb106-3547" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-3548"><a href="#cb106-3548" aria-hidden="true" tabindex="-1"></a>simulate_staggered <span class="ot">&lt;-</span> <span class="cf">function</span>(n, d, cps, <span class="at">rho=</span><span class="fl">0.6</span>, <span class="at">delta=</span><span class="dv">1</span>, <span class="at">sigma=</span><span class="dv">1</span>, <span class="at">ar_phi=</span><span class="dv">0</span>,</span>
<span id="cb106-3549"><a href="#cb106-3549" aria-hidden="true" tabindex="-1"></a>                               <span class="at">jitter_sd=</span><span class="dv">0</span>L, <span class="at">same_sign=</span><span class="cn">TRUE</span>, <span class="at">shared_subset=</span><span class="cn">TRUE</span>, <span class="at">seed=</span><span class="cn">NULL</span>) {</span>
<span id="cb106-3550"><a href="#cb106-3550" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb106-3551"><a href="#cb106-3551" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">as.integer</span>(cps))); K <span class="ot">&lt;-</span> <span class="fu">length</span>(cps)</span>
<span id="cb106-3552"><a href="#cb106-3552" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d); mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3553"><a href="#cb106-3553" aria-hidden="true" tabindex="-1"></a>  affected <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)</span>
<span id="cb106-3554"><a href="#cb106-3554" aria-hidden="true" tabindex="-1"></a>  cp_per_dim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_integer_</span>, <span class="at">nrow=</span>d, <span class="at">ncol=</span>K)   <span class="co"># 每维在第 k 个基线变点的实际时刻</span></span>
<span id="cb106-3555"><a href="#cb106-3555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3556"><a href="#cb106-3556" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (shared_subset) S <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size=</span><span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho<span class="sc">*</span>d)), <span class="at">replace=</span><span class="cn">FALSE</span>))</span>
<span id="cb106-3557"><a href="#cb106-3557" aria-hidden="true" tabindex="-1"></a>  signs <span class="ot">&lt;-</span> <span class="cf">if</span> (same_sign) <span class="fu">rep</span>(<span class="dv">1</span>, d) <span class="cf">else</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), d, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb106-3558"><a href="#cb106-3558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3559"><a href="#cb106-3559" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(K)) {</span>
<span id="cb106-3560"><a href="#cb106-3560" aria-hidden="true" tabindex="-1"></a>    base_c <span class="ot">&lt;-</span> cps[k]</span>
<span id="cb106-3561"><a href="#cb106-3561" aria-hidden="true" tabindex="-1"></a>    Sk <span class="ot">&lt;-</span> <span class="cf">if</span> (shared_subset) S <span class="cf">else</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(d, <span class="at">size=</span><span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(rho<span class="sc">*</span>d)), <span class="at">replace=</span><span class="cn">FALSE</span>))</span>
<span id="cb106-3562"><a href="#cb106-3562" aria-hidden="true" tabindex="-1"></a>    affected[Sk] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb106-3563"><a href="#cb106-3563" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> Sk) {</span>
<span id="cb106-3564"><a href="#cb106-3564" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="cf">if</span> (jitter_sd <span class="sc">&gt;</span> <span class="dv">0</span>L) <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, jitter_sd)) <span class="cf">else</span> <span class="dv">0</span>L</span>
<span id="cb106-3565"><a href="#cb106-3565" aria-hidden="true" tabindex="-1"></a>      cj  <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, <span class="fu">min</span>(n<span class="dv">-1</span>L, <span class="fu">as.integer</span>(base_c <span class="sc">+</span> eps)))</span>
<span id="cb106-3566"><a href="#cb106-3566" aria-hidden="true" tabindex="-1"></a>      cp_per_dim[j, k] <span class="ot">&lt;-</span> cj       <span class="co"># 记录该维的实际变点时刻</span></span>
<span id="cb106-3567"><a href="#cb106-3567" aria-hidden="true" tabindex="-1"></a>      step <span class="ot">&lt;-</span> signs[j] <span class="sc">*</span> delta</span>
<span id="cb106-3568"><a href="#cb106-3568" aria-hidden="true" tabindex="-1"></a>      Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="ot">&lt;-</span> Y[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j]  <span class="sc">+</span> step</span>
<span id="cb106-3569"><a href="#cb106-3569" aria-hidden="true" tabindex="-1"></a>      mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="ot">&lt;-</span> mu[(cj<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n, j] <span class="sc">+</span> step</span>
<span id="cb106-3570"><a href="#cb106-3570" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-3571"><a href="#cb106-3571" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3572"><a href="#cb106-3572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3573"><a href="#cb106-3573" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 噪声</span></span>
<span id="cb106-3574"><a href="#cb106-3574" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">abs</span>(ar_phi) <span class="sc">&lt;</span> <span class="fl">1e-12</span>) {</span>
<span id="cb106-3575"><a href="#cb106-3575" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>d, <span class="dv">0</span>, sigma), n, d)</span>
<span id="cb106-3576"><a href="#cb106-3576" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb106-3577"><a href="#cb106-3577" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, d)</span>
<span id="cb106-3578"><a href="#cb106-3578" aria-hidden="true" tabindex="-1"></a>    innov_sd <span class="ot">&lt;-</span> sigma <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ar_phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb106-3579"><a href="#cb106-3579" aria-hidden="true" tabindex="-1"></a>    eps[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, sigma)</span>
<span id="cb106-3580"><a href="#cb106-3580" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) eps[t, ] <span class="ot">&lt;-</span> ar_phi<span class="sc">*</span>eps[t<span class="dv">-1</span>, ] <span class="sc">+</span> <span class="fu">rnorm</span>(d, <span class="dv">0</span>, innov_sd)</span>
<span id="cb106-3581"><a href="#cb106-3581" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3582"><a href="#cb106-3582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3583"><a href="#cb106-3583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y =</span> mu <span class="sc">+</span> eps, <span class="at">true_cp =</span> cps, <span class="at">affected =</span> affected, <span class="at">cp_per_dim =</span> cp_per_dim)</span>
<span id="cb106-3584"><a href="#cb106-3584" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3585"><a href="#cb106-3585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3586"><a href="#cb106-3586" aria-hidden="true" tabindex="-1"></a>detect_abs_once <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">T=</span><span class="dv">200</span>, <span class="at">d=</span><span class="dv">50</span>, <span class="at">K=</span><span class="dv">1</span>, <span class="at">rho=</span><span class="fl">0.7</span>, <span class="at">snr=</span><span class="fl">0.8</span>, <span class="at">phi=</span><span class="dv">0</span>,</span>
<span id="cb106-3587"><a href="#cb106-3587" aria-hidden="true" tabindex="-1"></a>                            <span class="at">jitter_sd=</span><span class="dv">6</span>L, <span class="at">min_size=</span><span class="dv">5</span>,</span>
<span id="cb106-3588"><a href="#cb106-3588" aria-hidden="true" tabindex="-1"></a>                            <span class="at">abs_beta_min=</span><span class="dv">10</span>, <span class="at">abs_beta_max=</span><span class="dv">50</span>, <span class="at">abs_beta_points=</span><span class="dv">70</span>, <span class="at">p_abs=</span><span class="dv">2</span>,</span>
<span id="cb106-3589"><a href="#cb106-3589" aria-hidden="true" tabindex="-1"></a>                            <span class="at">elbow_window=</span><span class="dv">10</span>, <span class="at">seed=</span><span class="dv">123</span>) {</span>
<span id="cb106-3590"><a href="#cb106-3590" aria-hidden="true" tabindex="-1"></a>  cps <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">seq</span>(<span class="at">from=</span>T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">by=</span>T<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>), <span class="at">length.out=</span>K)))</span>
<span id="cb106-3591"><a href="#cb106-3591" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">simulate_staggered</span>(T, d, cps, rho, snr, <span class="fl">1.0</span>, phi, jitter_sd, <span class="cn">TRUE</span>, <span class="cn">TRUE</span>, seed)</span>
<span id="cb106-3592"><a href="#cb106-3592" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> dat<span class="sc">$</span>Y; true_cp <span class="ot">&lt;-</span> dat<span class="sc">$</span>true_cp; affected <span class="ot">&lt;-</span> dat<span class="sc">$</span>affected; cp_per_dim <span class="ot">&lt;-</span> dat<span class="sc">$</span>cp_per_dim</span>
<span id="cb106-3593"><a href="#cb106-3593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3594"><a href="#cb106-3594" aria-hidden="true" tabindex="-1"></a>  abs_res <span class="ot">&lt;-</span> <span class="fu">adaptive_binary_segmentation</span>(</span>
<span id="cb106-3595"><a href="#cb106-3595" aria-hidden="true" tabindex="-1"></a>    Y, <span class="at">beta_min=</span>abs_beta_min, <span class="at">beta_max=</span>abs_beta_max, <span class="at">beta_points=</span>abs_beta_points,</span>
<span id="cb106-3596"><a href="#cb106-3596" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_size=</span>min_size, <span class="at">p=</span>p_abs, <span class="at">elbow_window=</span>elbow_window, <span class="at">verbose=</span><span class="cn">FALSE</span></span>
<span id="cb106-3597"><a href="#cb106-3597" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-3598"><a href="#cb106-3598" aria-hidden="true" tabindex="-1"></a>  idx_abs <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(abs_res<span class="sc">$</span>beta_list <span class="sc">-</span> abs_res<span class="sc">$</span>best_beta))</span>
<span id="cb106-3599"><a href="#cb106-3599" aria-hidden="true" tabindex="-1"></a>  cp_abs  <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs_res<span class="sc">$</span>results[[idx_abs]])</span>
<span id="cb106-3600"><a href="#cb106-3600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3601"><a href="#cb106-3601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Y=</span>Y, <span class="at">true_cp=</span>true_cp, <span class="at">cp_abs=</span>cp_abs, <span class="at">affected=</span>affected, <span class="at">cp_per_dim=</span>cp_per_dim,</span>
<span id="cb106-3602"><a href="#cb106-3602" aria-hidden="true" tabindex="-1"></a>       <span class="at">params=</span><span class="fu">list</span>(<span class="at">T=</span>T,<span class="at">d=</span>d,<span class="at">K=</span>K,<span class="at">rho=</span>rho,<span class="at">snr=</span>snr,<span class="at">phi=</span>phi,<span class="at">jitter_sd=</span>jitter_sd))</span>
<span id="cb106-3603"><a href="#cb106-3603" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3604"><a href="#cb106-3604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3605"><a href="#cb106-3605" aria-hidden="true" tabindex="-1"></a>plot_multidim_with_cps <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, true_cp, detected_cp,</span>
<span id="cb106-3606"><a href="#cb106-3606" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">affected_dims=</span><span class="cn">NULL</span>, <span class="at">cp_per_dim=</span><span class="cn">NULL</span>,   <span class="co"># ★ 新增</span></span>
<span id="cb106-3607"><a href="#cb106-3607" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">main=</span><span class="st">"ABS detection (stacked per-dimension)"</span>,</span>
<span id="cb106-3608"><a href="#cb106-3608" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">xlab=</span><span class="st">"time"</span>, <span class="at">ylab=</span><span class="st">"dimension (stacked)"</span>,</span>
<span id="cb106-3609"><a href="#cb106-3609" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">col_normal=</span><span class="st">"grey70"</span>, <span class="at">col_affected=</span><span class="st">"lightblue"</span>) {</span>
<span id="cb106-3610"><a href="#cb106-3610" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Y); d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Y)</span>
<span id="cb106-3611"><a href="#cb106-3611" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(affected_dims)) affected_dims <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d)</span>
<span id="cb106-3612"><a href="#cb106-3612" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.numeric</span>(affected_dims)) { tmp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">FALSE</span>, d); tmp[affected_dims] <span class="ot">&lt;-</span> <span class="cn">TRUE</span>; affected_dims <span class="ot">&lt;-</span> tmp }</span>
<span id="cb106-3613"><a href="#cb106-3613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3614"><a href="#cb106-3614" aria-hidden="true" tabindex="-1"></a>  Yc <span class="ot">&lt;-</span> <span class="fu">scale</span>(Y, <span class="at">center=</span><span class="cn">TRUE</span>, <span class="at">scale=</span><span class="cn">FALSE</span>)</span>
<span id="cb106-3615"><a href="#cb106-3615" aria-hidden="true" tabindex="-1"></a>  amp <span class="ot">&lt;-</span> <span class="fu">apply</span>(Yc, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">diff</span>(<span class="fu">range</span>(x))); gap <span class="ot">&lt;-</span> <span class="fu">max</span>(amp); <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(gap)<span class="sc">||</span>gap<span class="sc">&lt;=</span><span class="dv">0</span>) gap <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb106-3616"><a href="#cb106-3616" aria-hidden="true" tabindex="-1"></a>  gap <span class="ot">&lt;-</span> gap <span class="sc">*</span> <span class="fl">1.3</span>; ylim_top <span class="ot">&lt;-</span> (d<span class="dv">-1</span>)<span class="sc">*</span>gap</span>
<span id="cb106-3617"><a href="#cb106-3617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3618"><a href="#cb106-3618" aria-hidden="true" tabindex="-1"></a>  op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">no.readonly=</span><span class="cn">TRUE</span>); <span class="fu">on.exit</span>(<span class="fu">par</span>(op), <span class="at">add=</span><span class="cn">TRUE</span>); <span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="fl">2.5</span>,<span class="dv">1</span>))</span>
<span id="cb106-3619"><a href="#cb106-3619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="cn">NA</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>,T), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span>gap<span class="sc">*</span><span class="fl">0.5</span>, ylim_top<span class="sc">+</span>gap<span class="sc">*</span><span class="fl">0.5</span>),</span>
<span id="cb106-3620"><a href="#cb106-3620" aria-hidden="true" tabindex="-1"></a>       <span class="at">xaxs=</span><span class="st">"i"</span>, <span class="at">yaxs=</span><span class="st">"i"</span>, <span class="at">xlab=</span>xlab, <span class="at">ylab=</span>ylab, <span class="at">main=</span>main, <span class="at">yaxt=</span><span class="st">"n"</span>)</span>
<span id="cb106-3621"><a href="#cb106-3621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3622"><a href="#cb106-3622" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(d)) {</span>
<span id="cb106-3623"><a href="#cb106-3623" aria-hidden="true" tabindex="-1"></a>    yoff <span class="ot">&lt;-</span> (j<span class="dv">-1</span>)<span class="sc">*</span>gap</span>
<span id="cb106-3624"><a href="#cb106-3624" aria-hidden="true" tabindex="-1"></a>    cc <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">isTRUE</span>(affected_dims[j])) col_affected <span class="cf">else</span> col_normal</span>
<span id="cb106-3625"><a href="#cb106-3625" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(<span class="fu">seq_len</span>(T), Yc[,j] <span class="sc">+</span> yoff, <span class="at">col=</span>cc, <span class="at">lwd=</span><span class="fl">1.2</span>)</span>
<span id="cb106-3626"><a href="#cb106-3626" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 画该维的错位刻度（若提供）</span></span>
<span id="cb106-3627"><a href="#cb106-3627" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cp_per_dim)) {</span>
<span id="cb106-3628"><a href="#cb106-3628" aria-hidden="true" tabindex="-1"></a>      v <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(cp_per_dim[j, ])</span>
<span id="cb106-3629"><a href="#cb106-3629" aria-hidden="true" tabindex="-1"></a>      v <span class="ot">&lt;-</span> v[<span class="fu">is.finite</span>(v)]</span>
<span id="cb106-3630"><a href="#cb106-3630" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(v)) {</span>
<span id="cb106-3631"><a href="#cb106-3631" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 画短横：在 yoff 附近一小段（± 0.15*gap）</span></span>
<span id="cb106-3632"><a href="#cb106-3632" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (x0 <span class="cf">in</span> v) <span class="fu">segments</span>(x0, yoff<span class="fl">-0.15</span><span class="sc">*</span>gap, x0, yoff<span class="fl">+0.15</span><span class="sc">*</span>gap, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="cb106-3633"><a href="#cb106-3633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3634"><a href="#cb106-3634" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb106-3635"><a href="#cb106-3635" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-3636"><a href="#cb106-3636" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3637"><a href="#cb106-3637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3638"><a href="#cb106-3638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at=</span>(<span class="dv">0</span><span class="sc">:</span>(d<span class="dv">-1</span>))<span class="sc">*</span>gap, <span class="at">labels=</span><span class="fu">paste0</span>(<span class="st">"dim "</span>,<span class="dv">1</span><span class="sc">:</span>d), <span class="at">las=</span><span class="dv">2</span>, <span class="at">cex.axis=</span><span class="fl">0.7</span>)</span>
<span id="cb106-3639"><a href="#cb106-3639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3640"><a href="#cb106-3640" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(true_cp))     <span class="cf">for</span> (v <span class="cf">in</span> true_cp)   <span class="fu">abline</span>(<span class="at">v=</span>v, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb106-3641"><a href="#cb106-3641" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(detected_cp)) <span class="cf">for</span> (v <span class="cf">in</span> detected_cp) <span class="fu">abline</span>(<span class="at">v=</span>v, <span class="at">col=</span><span class="st">"red"</span>,  <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb106-3642"><a href="#cb106-3642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3643"><a href="#cb106-3643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>,</span>
<span id="cb106-3644"><a href="#cb106-3644" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"ABS cp"</span>, <span class="st">"true cp"</span>, <span class="st">"per-dim jitter cp"</span>, <span class="st">"affected dim"</span>),</span>
<span id="cb106-3645"><a href="#cb106-3645" aria-hidden="true" tabindex="-1"></a>       <span class="at">col    =</span> <span class="fu">c</span>(<span class="st">"red"</span>,    <span class="st">"blue"</span>,    <span class="st">"blue"</span>,             col_affected),</span>
<span id="cb106-3646"><a href="#cb106-3646" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty    =</span> <span class="fu">c</span>(<span class="dv">2</span>,        <span class="dv">2</span>,         <span class="cn">NA</span>,                 <span class="dv">1</span>),</span>
<span id="cb106-3647"><a href="#cb106-3647" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch    =</span> <span class="fu">c</span>(<span class="cn">NA</span>,       <span class="cn">NA</span>,        <span class="dv">124</span>,                <span class="cn">NA</span>),</span>
<span id="cb106-3648"><a href="#cb106-3648" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd    =</span> <span class="fu">c</span>(<span class="dv">2</span>,        <span class="dv">2</span>,         <span class="cn">NA</span>,                 <span class="fl">1.2</span>),</span>
<span id="cb106-3649"><a href="#cb106-3649" aria-hidden="true" tabindex="-1"></a>       <span class="at">pt.cex =</span> <span class="fu">c</span>(<span class="cn">NA</span>,       <span class="cn">NA</span>,        <span class="fl">1.5</span>,                <span class="cn">NA</span>),</span>
<span id="cb106-3650"><a href="#cb106-3650" aria-hidden="true" tabindex="-1"></a>       <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb106-3651"><a href="#cb106-3651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3652"><a href="#cb106-3652" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3653"><a href="#cb106-3653" aria-hidden="true" tabindex="-1"></a><span class="do">########“聚拢度”指标（单次）</span></span>
<span id="cb106-3654"><a href="#cb106-3654" aria-hidden="true" tabindex="-1"></a>cohesion_metrics_abs <span class="ot">&lt;-</span> <span class="cf">function</span>(cp_abs, cp_per_dim, <span class="at">tol=</span><span class="dv">3</span>L) {</span>
<span id="cb106-3655"><a href="#cb106-3655" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cp_per_dim: d × K, NA 表示该维未受影响</span></span>
<span id="cb106-3656"><a href="#cb106-3656" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(cp_per_dim); d <span class="ot">&lt;-</span> <span class="fu">nrow</span>(cp_per_dim)</span>
<span id="cb106-3657"><a href="#cb106-3657" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(cp_abs) <span class="sc">!=</span> K) <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pull_in=</span><span class="cn">NA</span>, <span class="at">center_err=</span><span class="cn">NA</span>, <span class="at">cloud_iqr=</span><span class="cn">NA</span>))</span>
<span id="cb106-3658"><a href="#cb106-3658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3659"><a href="#cb106-3659" aria-hidden="true" tabindex="-1"></a>  pull_in <span class="ot">&lt;-</span> <span class="fu">numeric</span>(K); center_err <span class="ot">&lt;-</span> <span class="fu">numeric</span>(K); cloud_iqr <span class="ot">&lt;-</span> <span class="fu">numeric</span>(K)</span>
<span id="cb106-3660"><a href="#cb106-3660" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb106-3661"><a href="#cb106-3661" aria-hidden="true" tabindex="-1"></a>    vk <span class="ot">&lt;-</span> cp_per_dim[,k]; vk <span class="ot">&lt;-</span> vk[<span class="sc">!</span><span class="fu">is.na</span>(vk)]   <span class="co"># 受影响的维度</span></span>
<span id="cb106-3662"><a href="#cb106-3662" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(vk)) { pull_in[k] <span class="ot">&lt;-</span> <span class="cn">NA</span>; center_err[k] <span class="ot">&lt;-</span> <span class="cn">NA</span>; cloud_iqr[k] <span class="ot">&lt;-</span> <span class="cn">NA</span>; <span class="cf">next</span> }</span>
<span id="cb106-3663"><a href="#cb106-3663" aria-hidden="true" tabindex="-1"></a>    pull_in[k]   <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(vk <span class="sc">-</span> cp_abs[k]) <span class="sc">&lt;=</span> tol)            <span class="co"># 拉拢率</span></span>
<span id="cb106-3664"><a href="#cb106-3664" aria-hidden="true" tabindex="-1"></a>    center_err[k] <span class="ot">&lt;-</span> <span class="fu">abs</span>(cp_abs[k] <span class="sc">-</span> <span class="fu">median</span>(vk))                <span class="co"># 与“云中位数”的偏差</span></span>
<span id="cb106-3665"><a href="#cb106-3665" aria-hidden="true" tabindex="-1"></a>    cloud_iqr[k]  <span class="ot">&lt;-</span> <span class="fu">IQR</span>(vk)                                    <span class="co"># “云的宽度”</span></span>
<span id="cb106-3666"><a href="#cb106-3666" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-3667"><a href="#cb106-3667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">pull_in =</span> <span class="fu">mean</span>(pull_in, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb106-3668"><a href="#cb106-3668" aria-hidden="true" tabindex="-1"></a>       <span class="at">center_err =</span> <span class="fu">median</span>(center_err, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb106-3669"><a href="#cb106-3669" aria-hidden="true" tabindex="-1"></a>       <span class="at">cloud_iqr =</span> <span class="fu">median</span>(cloud_iqr, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb106-3670"><a href="#cb106-3670" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-3671"><a href="#cb106-3671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3672"><a href="#cb106-3672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-3673"><a href="#cb106-3673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3676"><a href="#cb106-3676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-3677"><a href="#cb106-3677" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">detect_abs_once</span>(</span>
<span id="cb106-3678"><a href="#cb106-3678" aria-hidden="true" tabindex="-1"></a>  <span class="at">T =</span> <span class="dv">200</span>, <span class="at">d =</span> <span class="dv">10</span>, <span class="at">K =</span> <span class="dv">3</span>,</span>
<span id="cb106-3679"><a href="#cb106-3679" aria-hidden="true" tabindex="-1"></a>  <span class="at">rho =</span> <span class="fl">0.7</span>, <span class="at">snr =</span> <span class="dv">2</span>, <span class="at">phi =</span> <span class="fl">0.0</span>,</span>
<span id="cb106-3680"><a href="#cb106-3680" aria-hidden="true" tabindex="-1"></a>  <span class="at">jitter_sd =</span> <span class="dv">6</span>L,</span>
<span id="cb106-3681"><a href="#cb106-3681" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_size =</span> <span class="dv">3</span>,</span>
<span id="cb106-3682"><a href="#cb106-3682" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_beta_min =</span> <span class="dv">3</span>, <span class="at">abs_beta_max =</span> <span class="dv">30</span>, <span class="at">abs_beta_points =</span> <span class="dv">70</span>, <span class="at">p_abs =</span> <span class="dv">2</span>,</span>
<span id="cb106-3683"><a href="#cb106-3683" aria-hidden="true" tabindex="-1"></a>  <span class="at">elbow_window =</span> <span class="dv">10</span>,</span>
<span id="cb106-3684"><a href="#cb106-3684" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">397492</span></span>
<span id="cb106-3685"><a href="#cb106-3685" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-3686"><a href="#cb106-3686" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_multidim_with_cps</span>(res<span class="sc">$</span>Y, res<span class="sc">$</span>true_cp, res<span class="sc">$</span>cp_abs, <span class="at">affected_dims=</span>res<span class="sc">$</span>affected, <span class="at">cp_per_dim=</span>res<span class="sc">$</span>cp_per_dim,</span>
<span id="cb106-3687"><a href="#cb106-3687" aria-hidden="true" tabindex="-1"></a>                       <span class="at">main=</span><span class="fu">sprintf</span>(<span class="st">"ABS (T=%d, d=%d, K=%d, jitter=%d)"</span>, </span>
<span id="cb106-3688"><a href="#cb106-3688" aria-hidden="true" tabindex="-1"></a>                                    res<span class="sc">$</span>params<span class="sc">$</span>T, res<span class="sc">$</span>params<span class="sc">$</span>d, res<span class="sc">$</span>params<span class="sc">$</span>K, res<span class="sc">$</span>params<span class="sc">$</span>jitter_sd))</span>
<span id="cb106-3689"><a href="#cb106-3689" aria-hidden="true" tabindex="-1"></a>coh <span class="ot">&lt;-</span> <span class="fu">cohesion_metrics_abs</span>(res<span class="sc">$</span>cp_abs, res<span class="sc">$</span>cp_per_dim, <span class="at">tol=</span><span class="dv">3</span>L)</span>
<span id="cb106-3690"><a href="#cb106-3690" aria-hidden="true" tabindex="-1"></a>coh</span>
<span id="cb106-3691"><a href="#cb106-3691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3692"><a href="#cb106-3692" aria-hidden="true" tabindex="-1"></a><span class="co"># $pull_in   ~ 0.8~0.95   （越高越好）</span></span>
<span id="cb106-3693"><a href="#cb106-3693" aria-hidden="true" tabindex="-1"></a><span class="co"># $center_err~ 0~1        （越小越好）</span></span>
<span id="cb106-3694"><a href="#cb106-3694" aria-hidden="true" tabindex="-1"></a><span class="co"># $cloud_iqr ~ 4~12       （云很宽，但 ABS 仍抓住中心）</span></span>
<span id="cb106-3695"><a href="#cb106-3695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3696"><a href="#cb106-3696" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>